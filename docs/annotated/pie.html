<!DOCTYPE html>

<html>
<head>
  <title>pie.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>pie.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* jshint indent:false */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(window)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="pie">Pie</h1>
<p>The top level namespace of the framework.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> pie = <span class="hljs-built_in">window</span>.pie = {

  apps: {},

  <span class="hljs-comment">/* native extensions */</span>
  array: {},
  browser: {},
  date: {},
  dom: {},
  fn: {},
  math: {},
  object: {},
  string: {},

  <span class="hljs-comment">/* extensions to be used within pie apps. */</span>
  mixins: {},

  __pieId: <span class="hljs-number">1</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><strong> pie.guid </strong></p>
<p>Generate a globally unique id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  guid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> r, v;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'</span>.replace(<span class="hljs-regexp">/[xy]/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span> </span>{
      r = <span class="hljs-built_in">Math</span>.random()*<span class="hljs-number">16</span>|<span class="hljs-number">0</span>,
      v = c === <span class="hljs-string">'x'</span> ? r : (r&amp;<span class="hljs-number">0x3</span>|<span class="hljs-number">0x8</span>);
      <span class="hljs-keyword">return</span> v.toString(<span class="hljs-number">16</span>);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><strong> pie.ns </strong></p>
<p>If it’s not already present, build a path on <code>base</code>.
By default, <code>base</code> is the global <code>window</code>.
The deepest namespace object is returned so you can immediately use it.</p>
<pre><code>pie.ns(<span class="hljs-string">'lib.foo.bar'</span>).baz = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{};
<span class="hljs-comment">//=&gt; generates { lib: { foo: { bar: { baz: function(){} } } } }</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  ns: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, base)</span> </span>{
    base = base || <span class="hljs-built_in">window</span>;
    <span class="hljs-keyword">return</span> pie.object.getPath(base, path) || pie.object.setPath(base, path, {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><strong> pie.qs </strong></p>
<p>Alias for <code>document.querySelector</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  qs: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.querySelector.apply(<span class="hljs-built_in">document</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><strong> pie.qsa </strong></p>
<p>Alias for <code>document.querySelectorAll</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  qsa: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.querySelectorAll.apply(<span class="hljs-built_in">document</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><strong> pie.uid </strong></p>
<p>Set the <code>__pieId</code> of <code>obj</code> if it isn’t already present.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  uid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> obj.__pieId = obj.__pieId || pie.unique();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><strong> pie.unique </strong></p>
<p>Provide a unique integer not yet used by pie.
This is good for unique local ids.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unique: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>(<span class="hljs-keyword">this</span>.__pieId++);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><strong> pie.util </strong></p>
<p>Provide a util object for your app which utilizes pie’s features.</p>
<pre><code><span class="hljs-built_in">window</span>._ = pie.util();
_.a.detect(<span class="hljs-comment">/* .. */</span>);
_.o.merge(a, b);
_.unique(); <span class="hljs-comment">//=&gt; '95'</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  util: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> o = {};

    o.a   = pie.array;
    o.b   = pie.browser;
    o.d   = pie.date;
    o.$   = pie.dom;
    o.fn  = pie.fn;
    o.m   = pie.math;
    o.o   = pie.object;
    o.s   = pie.string;
    o.x   = pie.mixins;

    o.guid    = pie.guid;
    o.ns      = pie.ns;
    o.qs      = pie.qs;
    o.qsa     = pie.qsa;
    o.setUid  = pie.uid;
    o.unique  = pie.unique;

    <span class="hljs-keyword">return</span> o;
  },

  _debugArgs: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg)</span> </span>{
    <span class="hljs-keyword">return</span> [<span class="hljs-string">"%c[pie] %c"</span> + msg, <span class="hljs-string">"color: orange; font-weight: bold;"</span>, <span class="hljs-string">"color: inherit; font-weight: inherit;"</span>];
  }

};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h1 id="pie-array-utilities">Pie Array Utilities</h1>
<p>A series of helpful methods for working with arrays.</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><strong> pie.array.areAll </strong></p>
<p>Provides a way to test if all items of <code>a</code> match the function <code>f</code>.
Since this uses <code>pie.object.getValue</code> you can pass an attribute name for <code>f</code> as well.</p>
<pre><code>pie.array.areAll([<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>{ <span class="hljs-keyword">return</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; });
<span class="hljs-comment">//=&gt; false</span>

pie.array.areAll([o1,o2], <span class="hljs-string">'computed'</span>)
<span class="hljs-comment">//=&gt; !!(o1.computed &amp;&amp; o2.computed)</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.areAll = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  a = pie.array.from(a);
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(;i &lt; a.length; i++) {
    <span class="hljs-keyword">if</span>(!pie.object.getValue(a[i], f)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><strong> pie.array.areAny </strong></p>
<p>Tests whether any items of <code>a</code> match the function <code>f</code>.
Since this uses <code>pie.object.getValue</code> you can pass an attribute name for <code>f</code> as well.</p>
<pre><code>pie.array.areAny([<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>{ <span class="hljs-keyword">return</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; });
<span class="hljs-comment">//=&gt; true</span>

pie.array.areAny([o1,o2], <span class="hljs-string">'computed'</span>)
<span class="hljs-comment">// =&gt; !!(o1.computed || o2.computed)</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.areAny = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  a = pie.array.from(a);
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(;i &lt; a.length; i++) {
    <span class="hljs-keyword">if</span>(pie.object.getValue(a[i], f)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><strong> pie.array.avg </strong></p>
<p>Find the average of a series of numbers.</p>
<pre><code>pie.array.avg([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8</span>])
<span class="hljs-comment">//=&gt; 3.8333</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.avg = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  a = pie.array.from(a);
  <span class="hljs-keyword">var</span> s = pie.array.sum(a), l = a.length;
  <span class="hljs-keyword">return</span> l ? (s / l) : <span class="hljs-number">0</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><strong> pie.array.change </strong></p>
<p>Change an array by many <code>pie.array</code> utilities.</p>
<pre><code>pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>, <span class="hljs-string">'unique'</span>);
<span class="hljs-comment">// is equivalent to:</span>
arr = pie.array.from(<span class="hljs-built_in">arguments</span>);
arr = pie.array.flatten(arr);
arr = pie.array.compact(arr);
arr = pie.array.unique(arr);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.change = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
  arr = args.shift();
  args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
    arr = pie.array[m](arr);
  });

  <span class="hljs-keyword">return</span> arr;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><strong> pie.array.compact </strong></p>
<p>Remove all null or undefined items.
Optionally remove all falsy values by providing true for <code>removeAllFalsy</code>.</p>
<pre><code>pie.array.compact([<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>])
<span class="hljs-comment">//=&gt; [true, false, 1, 0]</span>

pie.array.compact([<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>], <span class="hljs-literal">true</span>)
<span class="hljs-comment">//=&gt; [true, 1]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.compact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, removeAllFalsy)</span></span>{
  a = pie.array.from(a);
  <span class="hljs-keyword">return</span> a.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{
    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">return</span> removeAllFalsy ? !!i : (i != <span class="hljs-literal">null</span>);
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><strong> pie.array.count </strong></p>
<p>Count the number of items that match a given criteria defined by <code>f</code>.</p>
<pre><code>pie.array.count([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{ <span class="hljs-keyword">return</span> i % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; });
<span class="hljs-comment">//=&gt; 2</span>

pie.array.count([<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'q'</span>, <span class="hljs-string">'ux'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{ <span class="hljs-keyword">return</span> i.length === <span class="hljs-number">3</span>; })
<span class="hljs-comment">//=&gt; 2</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.count = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  <span class="hljs-keyword">var</span> cnt = <span class="hljs-number">0</span>;
  pie.array.from(a).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{
    <span class="hljs-keyword">if</span>(pie.object.getValue(i, f)) cnt++;
  });
  <span class="hljs-keyword">return</span> cnt;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><strong> pie.array.detect </strong></p>
<p>Return the first item where the provided function evaluates to a truthy value.
If a function is not provided, the second argument will be assumed to be an attribute check.</p>
<pre><code>pie.array.detect([<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> e % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; })
<span class="hljs-comment">//=&gt; 4</span>

pie.array.detect([{foo: <span class="hljs-string">'bar'</span>}, {baz: <span class="hljs-string">'foo'</span>}], <span class="hljs-string">'baz'</span>)
<span class="hljs-comment">//=&gt; {baz: 'foo'}</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.detect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  a = pie.array.from(a);
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = a.length;
  <span class="hljs-keyword">for</span>(;i&lt;l;i++) {
    <span class="hljs-keyword">if</span>(pie.object.getValue(a[i], f)) {
      <span class="hljs-keyword">return</span> a[i];
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><strong> pie.array.detectLast </strong></p>
<p>Return the last item where the provided function evaluates to a truthy value.
If a function is not provided, the second argument will be assumed to be an attribute check.</p>
<pre><code>pie.array.detectLast([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> e % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; })
<span class="hljs-comment">//=&gt; 4</span>


pie.array.detectLast([{foo: <span class="hljs-string">'bar'</span>}, {baz: <span class="hljs-string">'foo'</span>}], <span class="hljs-string">'baz'</span>)
<span class="hljs-comment">//=&gt; {baz: 'foo'}</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.detectLast = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  a = pie.array.from(a);
  <span class="hljs-keyword">var</span> i = a.length-<span class="hljs-number">1</span>, l = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(;i&gt;=l;i--) {
    <span class="hljs-keyword">if</span>(pie.object.getValue(a[i], f)) {
      <span class="hljs-keyword">return</span> a[i];
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><strong> pie.array.dup </strong></p>
<p>Return a new array containing the same values of the provided array <code>a</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.dup = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">return</span> pie.array.from(a).slice(<span class="hljs-number">0</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><strong> pie.array.each </strong></p>
<p>Invoke <code>f</code> on each item of a.
<code>f</code> can be a function or the name of a function to invoke.</p>
<pre><code>pie.array.each(arr, <span class="hljs-string">'send'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.each = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  <span class="hljs-keyword">return</span> pie.array._each(a, f, <span class="hljs-literal">true</span>, <span class="hljs-string">'forEach'</span>);
};

pie.array._each = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f, callInternalFunction, via)</span> </span>{
  <span class="hljs-keyword">var</span> callingF;

  <span class="hljs-keyword">if</span>(!pie.object.isFunction(f)) {
    callingF = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
      <span class="hljs-keyword">var</span> ef = e[f];

      <span class="hljs-keyword">if</span>(callInternalFunction &amp;&amp; pie.object.isFunction(ef))
        <span class="hljs-keyword">return</span> ef.apply(e);
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> ef;
    };
  } <span class="hljs-keyword">else</span> {
    callingF = f;
  }

  <span class="hljs-keyword">return</span> pie.array.from(a)[via](<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> callingF(e); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p><strong> pie.array.filter </strong></p>
<p>Return the elements of the array that match <code>fn</code>.
The <code>fn</code> can be a function or attribut of the elements.</p>
<pre><code><span class="hljs-keyword">var</span> arr = [<span class="hljs-string">''</span>, <span class="hljs-string">' '</span>, <span class="hljs-string">'foo'</span>];
pie.array.filter(arr, <span class="hljs-string">'length'</span>);
<span class="hljs-comment">//=&gt; [' ', 'foo']</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.filter = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, fn)</span> </span>{
  <span class="hljs-keyword">return</span> pie.array.from(arr).filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{
    <span class="hljs-keyword">return</span> pie.object.getValue(i, fn);
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><strong> pie.array.flatten </strong></p>
<p>Flattens an array of arrays or elements into a single depth array</p>
<pre><code>pie.array.flatten([<span class="hljs-string">'a'</span>, [<span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]])
<span class="hljs-comment">//=&gt; ['a', 'b', 'c']</span>
</code></pre><p>You may also restrict the depth of the flattening:</p>
<pre><code>pie.array.flatten([[<span class="hljs-string">'a'</span>], [<span class="hljs-string">'b'</span>, [<span class="hljs-string">'c'</span>]]], <span class="hljs-number">1</span>)
<span class="hljs-comment">//=&gt; ['a', 'b', ['c']]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.flatten = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, depth, into)</span> </span>{
  into = into || [];

  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(a) &amp;&amp; depth !== -<span class="hljs-number">1</span>) {

    <span class="hljs-keyword">if</span>(depth != <span class="hljs-literal">null</span>) depth--;

    a.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
      pie.array.flatten(e, depth, into);
    });

  } <span class="hljs-keyword">else</span> {
    into.push(a);
  }

  <span class="hljs-keyword">return</span> into;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><strong> pie.array.from </strong></p>
<p>Return an array from a value. if the value is an array it will be returned.
If the value is a NodeList or an HTMLCollection, you will get back an array.
If the value is undefined or null, you’ll get back an empty array.</p>
<pre><code>pie.array.from(<span class="hljs-literal">null</span>)
<span class="hljs-comment">//=&gt; []</span>

pie.array.from([<span class="hljs-string">'foo'</span>])
<span class="hljs-comment">//=&gt; ['foo']</span>

pie.array.from(<span class="hljs-string">'value'</span>)
<span class="hljs-comment">//=&gt; ['value']</span>

pie.array.from(<span class="hljs-built_in">document</span>.querySelectorAll(<span class="hljs-string">'body'</span>))
<span class="hljs-comment">//=&gt; [&lt;body&gt;]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.from = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(value)) <span class="hljs-keyword">return</span> value;
  <span class="hljs-keyword">if</span>(pie.object.isArguments(value) || pie.object.instanceOf(value, <span class="hljs-string">'NodeList'</span>) || pie.object.instanceOf(value, <span class="hljs-string">'HTMLCollection'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.prototype.slice.call(value, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> pie.array.compact([value], <span class="hljs-literal">false</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><strong> pie.array.get </strong></p>
<p>Retrieve a value or a range of values from an array.
Negative values are allowed and are considered to be relative to the end of the array.</p>
<pre><code>arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>]
pie.array.get(arr, <span class="hljs-number">1</span>)
<span class="hljs-comment">//=&gt; 'b'</span>

pie.array.get(arr, -<span class="hljs-number">2</span>)
<span class="hljs-comment">//=&gt; 'd'</span>

pie.array.get(arr, -<span class="hljs-number">1</span>)
<span class="hljs-comment">//=&gt; 'e'</span>

pie.array.get(arr, <span class="hljs-number">1</span>, -<span class="hljs-number">2</span>)
<span class="hljs-comment">//=&gt; ['b', 'c', 'd']</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.get = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, startIdx, endIdx)</span> </span>{
  arr = pie.array.from(arr);
  <span class="hljs-keyword">if</span>(startIdx &lt; <span class="hljs-number">0</span>) startIdx += arr.length;

  <span class="hljs-keyword">if</span>(endIdx !== <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">if</span>(endIdx &lt; <span class="hljs-number">0</span>) endIdx += arr.length;
    <span class="hljs-keyword">return</span> arr.slice(startIdx, endIdx + <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> arr[startIdx];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><strong> pie.array.grep </strong></p>
<p>Return string based matches of <code>regex</code> from the provided array <code>arr</code>.</p>
<pre><code>arr = [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'too'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'too'</span>]
pie.array.grep(arr, <span class="hljs-regexp">/oo/</span>)
<span class="hljs-comment">//=&gt; ['foo', 'too', 'too']</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.grep = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, regex)</span> </span>{
  <span class="hljs-keyword">return</span> pie.array.from(arr).filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span></span>{ <span class="hljs-keyword">return</span> regex.test(<span class="hljs-built_in">String</span>(a)); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><strong> pie.array.groupBy </strong></p>
<p>Construct an object of arrays representing the items grouped by <code>groupingF</code>.
The grouping function can be a function or an attribute of the objects.</p>
<pre><code>arr = [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]
fn = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>{ <span class="hljs-keyword">return</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; }
pie.array.groupBy(arr, fn)
<span class="hljs-comment">//=&gt; { true : [0, 2, 4], false : [1, 3, 5] }</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.groupBy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, groupingF)</span> </span>{
  <span class="hljs-keyword">var</span> h = {}, g;
  pie.array.from(arr).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span></span>{

    g = pie.object.getValue(a, groupingF);

    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">if</span>(g != <span class="hljs-literal">null</span>) {
      h[g] = h[g] || [];
      h[g].push(a);
    }
  });

  <span class="hljs-keyword">return</span> h;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><strong> pie.array.hasAll </strong></p>
<p>Determine if the given array <code>a</code> has all of the provided values.
```
arr = [“foo”, “bar”, “baz”]
pie.array.hasAll(arr, “foo”)
//=&gt; true
pie.array.hasAll(arr, “foo”, “bar”)
//=&gt; true
pie.array.hasAll(arr, [“food”, “bar”])
//=&gt; false
pie.array.hasAll(arr, “qux”)
//=&gt; false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.hasAll = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* a, *values */</span>)</span> </span>{
  <span class="hljs-keyword">var</span> a = pie.array.from(<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]),
  values = pie.array.get(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>), i;
  values = pie.array.flatten(values);
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;values.length;i++) {
    <span class="hljs-keyword">if</span>(!~a.indexOf(values[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><strong> pie.array.hasAny </strong></p>
<p>Determine if the given array <code>a</code> has any of the provided values.
```
arr = [“foo”, “bar”, “baz”]
pie.array.hasAny(arr, “foo”)
//=&gt; true
pie.array.hasAny(arr, [“food”, “bar”])
//=&gt; true
pie.array.hasAny(arr, “qux”)
//=&gt; false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.hasAny = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* a, *values */</span>)</span> </span>{
  <span class="hljs-keyword">var</span> a = pie.array.from(<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]),
  values = pie.array.get(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>), i;
  values = pie.array.flatten(values);
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;values.length;i++) {
    <span class="hljs-keyword">if</span>(~a.indexOf(values[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> !values.length;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><strong> pie.array.indexOf </strong></p>
<p>Find the first index of the item that matches <code>f</code>.
The function <code>f</code> can be a function or an attribute.</p>
<pre><code>arr = [{foo: <span class="hljs-literal">true</span>}, {bar: <span class="hljs-literal">true</span>}, {bar: <span class="hljs-literal">true</span>, foo: <span class="hljs-literal">true</span>}]
pie.array.indexOf(arr, <span class="hljs-string">'foo'</span>)
<span class="hljs-comment">//=&gt; 0</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.indexOf = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f, startIdx)</span> </span>{
  a = pie.array.from(a);
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = (startIdx || <span class="hljs-number">0</span>); i &lt; a.length; i++) {
    <span class="hljs-keyword">if</span>(pie.object.getValue(a[i], f)) {
      <span class="hljs-keyword">return</span> i;
    }
  }

  <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p><strong> pie.array.lastIndexOf </strong></p>
<p>Find the last index of the item that matches <code>f</code>.
The function <code>f</code> can be a function or an attribute.</p>
<pre><code>arr = [{foo: <span class="hljs-literal">true</span>}, {bar: <span class="hljs-literal">true</span>}, {bar: <span class="hljs-literal">true</span>, foo: <span class="hljs-literal">true</span>}]
pie.array.lastIndexOf(arr, <span class="hljs-string">'foo'</span>)
<span class="hljs-comment">//=&gt; 2</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.lastIndexOf = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f, startIdx)</span> </span>{
  a = pie.array.from(a);
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = (startIdx === <span class="hljs-literal">undefined</span> ? a.length - <span class="hljs-number">1</span> : startIdx); i &gt;= <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">if</span>(pie.object.getValue(a[i], f)) {
      <span class="hljs-keyword">return</span> i;
    }
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p><strong> pie.array.inGroupsOf </strong></p>
<p>Break the array into groups of the desired count.
If the length is not divisible by the desired count,
the last group will be shorter.</p>
<pre><code><span class="hljs-keyword">var</span> a = [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>];
pie.array.inGroupsOf(a, <span class="hljs-number">3</span>);
<span class="hljs-comment">//=&gt; [[0,1,2], [3,4,5], [6,7]];</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.inGroupsOf = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, count)</span> </span>{
  a = pie.array.from(a);
  <span class="hljs-keyword">var</span> out = [], sub;
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; a.length; i++) {

    <span class="hljs-keyword">if</span>(i % count === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span>(sub) out.push(sub);
      sub = [];
    }

    sub.push(a[i]);
  }

  <span class="hljs-keyword">if</span>(sub.length) out.push(sub);

  <span class="hljs-keyword">return</span> out;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p><strong> pie.array.intersect </strong></p>
<p>Retrieve the intersection of two arrays <code>a</code> and <code>b</code>.</p>
<pre><code>a = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
b = [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>]
pie.array.intersect(a, b)
<span class="hljs-comment">//=&gt; [0, 2, 4]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.intersect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
  b = pie.array.from(b);
  <span class="hljs-keyword">return</span> pie.array.from(a).filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span> </span>{ <span class="hljs-keyword">return</span> ~b.indexOf(i); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p><strong> pie.array.last </strong></p>
<p>Retrieve the last item of the array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.last = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr)</span> </span>{
  arr = arr &amp;&amp; pie.array.from(arr);
  <span class="hljs-keyword">if</span>(arr &amp;&amp; arr.length) <span class="hljs-keyword">return</span> arr[arr.length - <span class="hljs-number">1</span>];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><strong> pie.array.map </strong></p>
<p>Return an array filled with the return values of <code>f</code>.
If f is not a function, it will be assumed to be a key of the item.
If the resulting value is a function, it can be invoked by passing true as the third argument.</p>
<pre><code>pie.array.map([<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> e.toUpperCase(); })
<span class="hljs-comment">//=&gt; ["A", "B", "C"]</span>

pie.array.map([<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>], <span class="hljs-string">'length'</span>)
<span class="hljs-comment">//=&gt; [1, 1, 1]</span>

pie.array.map([<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-string">'toFixed'</span>)
<span class="hljs-comment">//=&gt; [toFixed(){}, toFixed(){}, toFixed(){}]</span>

pie.array.map([<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-string">'toFixed'</span>, <span class="hljs-literal">true</span>)
<span class="hljs-comment">//=&gt; ["0", "1", "2"]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.map = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f, callInternalFunction)</span></span>{
  <span class="hljs-keyword">return</span> pie.array._each(a, f, callInternalFunction, <span class="hljs-string">'map'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><strong>pie.array.partition</strong></p>
<p>Partition an array based on a set of functions. You will end up with an array of arrays the length of which
will be fns.length + 1.</p>
<pre><code><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];
<span class="hljs-keyword">var</span> results = pie.array.partition(arr, isOdd);
<span class="hljs-keyword">var</span> odds = results[<span class="hljs-number">0</span>];
<span class="hljs-comment">//=&gt; [1, 3]</span>
<span class="hljs-keyword">var</span> evens = results[<span class="hljs-number">1</span>];
<span class="hljs-comment">//=&gt; [0, 2, 4]</span>
</code></pre><pre><code><span class="hljs-keyword">var</span> arr = [<span class="hljs-string">"a"</span>, <span class="hljs-number">4</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"b"</span>];
<span class="hljs-keyword">var</span> results = pie.array.partition(arr, pie.object.isString, pie.object.isNumber);
<span class="hljs-keyword">var</span> strings = results[<span class="hljs-number">0</span>];
<span class="hljs-comment">//=&gt; ["a", "b"]</span>
<span class="hljs-keyword">var</span> numbers = results[<span class="hljs-number">1</span>];
<span class="hljs-comment">//=&gt; [4, 5]</span>
<span class="hljs-keyword">var</span> others = results[<span class="hljs-number">2</span>];
<span class="hljs-comment">//=&gt; [true, false]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.partition = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* a, fn1, fn2 */</span>)</span> </span>{
  <span class="hljs-keyword">var</span> out = [],
  fns = pie.array.from(<span class="hljs-built_in">arguments</span>),
  arr = pie.array.from(fns.shift());

  fns.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn, j)</span></span>{
    out[j] = [];
    out[j+<span class="hljs-number">1</span>] = out[j+<span class="hljs-number">1</span>] || [];
    arr.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
      <span class="hljs-keyword">if</span>(!!pie.object.getValue(e, fn)) out[j].push(e);
      <span class="hljs-keyword">else</span> out[j+<span class="hljs-number">1</span>].push(e);
    });

    arr = pie.array.dup(out[j+<span class="hljs-number">1</span>]);
  });

  <span class="hljs-keyword">return</span> out;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p><strong>pie.array.partitionAt</strong></p>
<p>Split an array up at the first occurrence where fn evaluates to true.</p>
<pre><code>arr = [a(), b(), <span class="hljs-string">"string"</span>, <span class="hljs-string">"string"</span>, c()]
pie.array.partitionAt(arr, pie.object.isNotFunction)
<span class="hljs-comment">//=&gt; [ [a(), b()], ["string", "string", c()] ]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.partitionAt = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, fn)</span> </span>{
  <span class="hljs-keyword">var</span> a = [], b = [], stillA = <span class="hljs-literal">true</span>;

  pie.array.from(arr).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{
    <span class="hljs-keyword">if</span>(stillA &amp;&amp; !!pie.object.getValue(i, fn)) stillA = <span class="hljs-literal">false</span>;
    (stillA ? a : b).push(i);
  });

  <span class="hljs-keyword">return</span> [a, b];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p><strong> pie.array.remove </strong></p>
<p>Remove all occurences of object <code>o</code> from array <code>a</code>.
```
a = [0, 1, 3, 5, 0, 2, 4, 0]
pie.array.remove(a, 0)
//=&gt; [1, 3, 5, 2, 4]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.remove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, o)</span> </span>{
  a = pie.array.from(a);
  <span class="hljs-keyword">var</span> idx;
  <span class="hljs-keyword">while</span>(~(idx = a.indexOf(o))) {
    a.splice(idx, <span class="hljs-number">1</span>);
  }
  <span class="hljs-keyword">return</span> a;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p><strong> pie.array.subtract </strong></p>
<p>Return an array that consists of any <code>a</code> elements that <code>b</code> does not contain.
```
a = [0, 1, 2, 3, 4]
b = [0, 2, 4, 6, 8]
pie.array.subtract(a, b)
//=&gt; [1, 3]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.subtract = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> pie.array.from(a).filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span> </span>{ <span class="hljs-keyword">return</span> !~b.indexOf(i); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p><strong> pie.array.sum </strong></p>
<p>Sum the values of <code>a</code> and return a float.</p>
<pre><code>arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>]
pie.array.sum(arr)
<span class="hljs-comment">//=&gt; 8.0</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.sum = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">return</span> pie.array.from(a).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span>{ <span class="hljs-keyword">return</span> a + <span class="hljs-built_in">parseFloat</span>(b); }, <span class="hljs-number">0</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p><strong> pie.array.sortBy </strong></p>
<p>Sort the array based on the value dictated by the function <code>sortF</code>.
The function can also be an attribute of the array’s items.</p>
<pre><code>arr = [{name: <span class="hljs-string">'Doug'</span>}, {name: <span class="hljs-string">'Alex'</span>}, {name: <span class="hljs-string">'Bill'</span>}]
pie.array.sortBy(arr, <span class="hljs-string">'name'</span>)
<span class="hljs-comment">//=&gt; [{name: 'Alex'}, {name: 'Bill'}, {name: 'Doug'}]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.sortBy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, sortF)</span></span>{
  <span class="hljs-keyword">var</span> aVal, bVal;
  <span class="hljs-keyword">return</span> pie.array.from(arr).sort(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
    aVal = pie.object.getValue(a, sortF);
    bVal = pie.object.getValue(b, sortF);
    <span class="hljs-keyword">if</span>(aVal === bVal) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(aVal &lt; bVal) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p><strong> pie.array.toSentence </strong></p>
<p>Convert a series of words into a human readable sentence.
Available options:</p>
<ul>
<li><strong>i18n</strong> - the i18n instance to be used for lookups. Defaults to <code>pie.appInstance.i18n</code>.</li>
<li><strong>delimeter</strong> - the delimeter to be placed between the 0 - N-1 items. Defaults to <code>&#39;, &#39;</code>.</li>
<li><strong>conjunction</strong> - the conjunction to be placed between the last two items. Defaults to <code>&#39; and &#39;</code>.</li>
<li><strong>punctuate</strong> - the punctuation to be added to the end. If <code>true</code> is provided, a <code>&#39;.&#39;</code> will be used. Defaults to none.</li>
</ul>
<pre><code>words = [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]
pie.array.toSentence(words)
<span class="hljs-string">"foo, bar and baz"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.toSentence = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, options)</span> </span>{
  arr = pie.array.from(arr);
  <span class="hljs-keyword">if</span>(!arr.length) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;

  options = pie.object.merge({
    i18n: pie.object.getPath(pie, <span class="hljs-string">'appInstance.i18n'</span>)
  }, options);

  options.delimeter = options.delimeter || options.i18n &amp;&amp; options.i18n.t(<span class="hljs-string">'app.sentence.delimeter'</span>, {<span class="hljs-keyword">default</span>: <span class="hljs-string">', '</span>});
  options.conjunction = options.conjunction || options.i18n &amp;&amp; options.i18n.t(<span class="hljs-string">'app.sentence.conjunction'</span>, {<span class="hljs-keyword">default</span>: <span class="hljs-string">' and '</span>});
  options.punctuate = options.punctuate === <span class="hljs-literal">true</span> ? <span class="hljs-string">'.'</span> : options.punctuate;

  <span class="hljs-keyword">if</span>(arr.length &gt; <span class="hljs-number">2</span>) arr = [arr.slice(<span class="hljs-number">0</span>,arr.length-<span class="hljs-number">1</span>).join(options.delimeter), arr.slice(arr.length-<span class="hljs-number">1</span>)];

  <span class="hljs-keyword">var</span> sentence = arr.join(options.conjunction);
  <span class="hljs-keyword">if</span>(options.punctuate &amp;&amp; !pie.string.endsWith(sentence, options.punctuate)) sentence += options.punctuate;

  <span class="hljs-keyword">return</span> sentence;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><strong> pie.array.union </strong></p>
<p>Return the union of N provided arrays.
a = [1, 2]
b = [2, 3, 4]
c = [3, 4, 5]
pie.array.union(a, b, c)
//=&gt; [1, 2, 3, 4, 5]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.union = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> arrs = pie.array.from(<span class="hljs-built_in">arguments</span>);
  arrs = pie.array.compact(arrs, <span class="hljs-literal">true</span>);
  arrs = pie.array.flatten(arrs);
  arrs = pie.array.unique(arrs);
  <span class="hljs-keyword">return</span> arrs;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p><strong> pie.array.unique </strong></p>
<p>Remove any duplicate values from the provided array <code>arr</code>.</p>
<pre><code>arr = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>]
pie.array.unique(arr)
[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>]
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.unique = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr)</span> </span>{
  <span class="hljs-keyword">return</span> pie.array.from(arr).filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, i)</span></span>{ <span class="hljs-keyword">return</span> arr.indexOf(e) === i; });
};
<span class="hljs-comment">/* From old jQuery */</span>
pie.browser.agent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span>(pie.browser.__agent) <span class="hljs-keyword">return</span> pie.browser.__agent;

  <span class="hljs-keyword">var</span> ua = navigator.userAgent.toLowerCase(),
  match = <span class="hljs-regexp">/(chrome)[ \/]([\w.]+)/</span>.exec( ua ) ||
    <span class="hljs-regexp">/(webkit)[ \/]([\w.]+)/</span>.exec( ua ) ||
    <span class="hljs-regexp">/(opera)(?:.*version|)[ \/]([\w.]+)/</span>.exec( ua ) ||
    <span class="hljs-regexp">/(msie) ([\w.]+)/</span>.exec( ua ) ||
    ua.indexOf(<span class="hljs-string">"compatible"</span>) &lt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-regexp">/(mozilla)(?:.*? rv:([\w.]+)|)/</span>.exec( ua ) ||
    [];

  <span class="hljs-keyword">var</span> b = {
    browser: match[ <span class="hljs-number">1</span> ] || <span class="hljs-string">""</span>,
    version: match[ <span class="hljs-number">2</span> ] || <span class="hljs-string">"0"</span>
  };

  <span class="hljs-keyword">if</span>(b.browser) {
    b[b.browser] = <span class="hljs-literal">true</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Chrome is Webkit, but Webkit is also Safari.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> ( b.chrome ) {
    b.webkit = <span class="hljs-literal">true</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( b.webkit ) {
    b.safari = <span class="hljs-literal">true</span>;
  }

  match = <span class="hljs-regexp">/(ipad|ipod|iphone)/</span>.exec( ua );
  
  <span class="hljs-keyword">if</span> (match &amp;&amp; match[<span class="hljs-number">1</span>]) {
    b.iDevice = match[<span class="hljs-number">1</span>];
    b[b.iDevice] = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">return</span> pie.browser.__agent = b;
};

pie.browser.getCookie = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span> </span>{
  <span class="hljs-keyword">var</span> decode = options &amp;&amp; options.raw ? <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(s)</span> </span>{ <span class="hljs-keyword">return</span> s; } : <span class="hljs-built_in">decodeURIComponent</span>,
  pairs = <span class="hljs-built_in">document</span>.cookie.split(<span class="hljs-string">'; '</span>),
  pair;

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; pairs.length; i++) {
    pair = pairs[i];
    <span class="hljs-keyword">if</span>(!pair) <span class="hljs-keyword">continue</span>;

    pair = pair.split(<span class="hljs-string">'='</span>);
    <span class="hljs-keyword">if</span>(decode(pair[<span class="hljs-number">0</span>]) === key) <span class="hljs-keyword">return</span> decode(pair[<span class="hljs-number">1</span>] || <span class="hljs-string">''</span>);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};


pie.browser.isRetina = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.devicePixelRatio &gt; <span class="hljs-number">1</span>;
};


pie.browser.isTouchDevice = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> pie.object.has(<span class="hljs-built_in">window</span>, <span class="hljs-string">'ontouchstart'</span>) ||
    pie.object.instanceOf(<span class="hljs-built_in">document</span>, <span class="hljs-string">'DocumentTouch'</span>) ||
    navigator.MaxTouchPoints &gt; <span class="hljs-number">0</span> ||
    navigator.msMaxTouchPoints &gt; <span class="hljs-number">0</span>;
};

pie.browser.testMediaQuery = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(query)</span> </span>{
  query = pie.browser.mediaQueries[query] || query;
  <span class="hljs-keyword">var</span> matchMedia = <span class="hljs-built_in">window</span>.matchMedia || <span class="hljs-built_in">window</span>.msMatchMedia;
  <span class="hljs-keyword">if</span>(matchMedia) <span class="hljs-keyword">return</span> matchMedia(query).matches;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
};

pie.browser.orientation = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">window</span>.orientation) {
  <span class="hljs-keyword">case</span> <span class="hljs-number">90</span>:
  <span class="hljs-keyword">case</span> -<span class="hljs-number">90</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-string">'landscape'</span>;
  <span class="hljs-keyword">default</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-string">'portrait'</span>;
  }
};

pie.browser.setCookie = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, options)</span> </span>{
  options = pie.object.merge({}, options);

  <span class="hljs-comment">/* jslint eqnull:true */</span>
  <span class="hljs-keyword">if</span>(value == <span class="hljs-literal">null</span>) options.expires = -<span class="hljs-number">1</span>;

  <span class="hljs-keyword">if</span> (pie.object.isNumber(options.expires)) {
    <span class="hljs-keyword">var</span> days = options.expires;
    options.expires = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    options.expires.setDate(options.expires.getDate() + days);
  }

  value = <span class="hljs-built_in">String</span>(value);

  <span class="hljs-keyword">var</span> cookieValue = [
    <span class="hljs-built_in">encodeURIComponent</span>(key), <span class="hljs-string">'='</span>, options.raw ? value : <span class="hljs-built_in">encodeURIComponent</span>(value),
    options.expires ? <span class="hljs-string">'; expires='</span> + options.expires.toUTCString() : <span class="hljs-string">''</span>, <span class="hljs-comment">// use expires attribute, max-age is not supported by IE</span>
    options.path    ? <span class="hljs-string">'; path='</span> + options.path : <span class="hljs-string">''</span>,
    options.domain  ? <span class="hljs-string">'; domain='</span> + options.domain : <span class="hljs-string">''</span>,
    options.secure  ? <span class="hljs-string">'; secure'</span> : <span class="hljs-string">''</span>
  ].join(<span class="hljs-string">''</span>);

  <span class="hljs-built_in">document</span>.cookie = cookieValue;
  <span class="hljs-keyword">return</span> cookieValue;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>takes a iso date string and converts to a local time representing 12:00am, on that date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.date.dateFromISO = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(isoDateString)</span> </span>{
  <span class="hljs-keyword">if</span>(!isoDateString) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> parts = isoDateString.split(<span class="hljs-regexp">/T|\s/</span>)[<span class="hljs-number">0</span>].split(<span class="hljs-string">'-'</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(parts[<span class="hljs-number">0</span>], parts[<span class="hljs-number">1</span>] - <span class="hljs-number">1</span>, parts[<span class="hljs-number">2</span>]);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>current timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.date.now = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(secondsPlease)</span> </span>{
  <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
  <span class="hljs-keyword">if</span>(secondsPlease) t = <span class="hljs-built_in">parseInt</span>(t / <span class="hljs-number">1000</span>, <span class="hljs-number">10</span>);
  <span class="hljs-keyword">return</span> t;
};

<span class="hljs-comment">/**
 * STOLEN FROM HERE:
 * Date.parse with progressive enhancement for ISO 8601 &lt;https://github.com/csnover/js-iso8601&gt;
 * © 2011 Colin Snover &lt;http://zetafleet.com&gt;
 * Released under MIT license.
 */</span>

pie.date.timeFromISO = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

  <span class="hljs-keyword">var</span> numericKeys = [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>];

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date)</span> </span>{
    <span class="hljs-keyword">if</span>(!date) <span class="hljs-keyword">return</span> <span class="hljs-literal">NaN</span>;
    <span class="hljs-keyword">if</span>(!<span class="hljs-regexp">/T|\s/</span>.test(date)) <span class="hljs-keyword">return</span> pie.date.dateFromISO(date);

    <span class="hljs-keyword">var</span> timestamp, struct, minutesOffset = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>ES5 §15.9.4.2 states that the string should attempt to be parsed as a Date Time String Format string
before falling back to any implementation-specific date parsing, so that’s what we do, even if native
implementations could be faster
             1 YYYY                2 MM       3 DD           4 HH    5 mm       6 ss        7 msec        8 Z 9 ±    10 tzHH    11 tzmm</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> ((struct = <span class="hljs-regexp">/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/</span>.exec(date))) {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>avoid NaN timestamps caused by “undefined” values being passed to Date.UTC</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, k; (k = numericKeys[i]); ++i) {
        struct[k] = +struct[k] || <span class="hljs-number">0</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>allow undefined days and months</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      struct[<span class="hljs-number">2</span>] = (+struct[<span class="hljs-number">2</span>] || <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>;
      struct[<span class="hljs-number">3</span>] = +struct[<span class="hljs-number">3</span>] || <span class="hljs-number">1</span>;

      <span class="hljs-keyword">if</span> (struct[<span class="hljs-number">8</span>] !== <span class="hljs-string">'Z'</span> &amp;&amp; struct[<span class="hljs-number">9</span>] !== <span class="hljs-literal">undefined</span>) {
        minutesOffset = struct[<span class="hljs-number">10</span>] * <span class="hljs-number">60</span> + struct[<span class="hljs-number">11</span>];

        <span class="hljs-keyword">if</span> (struct[<span class="hljs-number">9</span>] === <span class="hljs-string">'+'</span>) {
          minutesOffset = <span class="hljs-number">0</span> - minutesOffset;
        }
      }

      timestamp = <span class="hljs-built_in">Date</span>.UTC(struct[<span class="hljs-number">1</span>], struct[<span class="hljs-number">2</span>], struct[<span class="hljs-number">3</span>], struct[<span class="hljs-number">4</span>], struct[<span class="hljs-number">5</span>] + minutesOffset, struct[<span class="hljs-number">6</span>], struct[<span class="hljs-number">7</span>]);
    } <span class="hljs-keyword">else</span> {
      timestamp = <span class="hljs-literal">NaN</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(timestamp);
  };

})();</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h1 id="pie-dom-utilities">Pie DOM Utilities</h1>
<p>A series of helpful methods for working with DOM elements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
pie.dom._all = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(originalArgs, returnValues)</span> </span>{
  <span class="hljs-keyword">var</span> nodes = pie.array.from(originalArgs[<span class="hljs-number">0</span>]),
  meths = originalArgs[<span class="hljs-number">1</span>].split(<span class="hljs-string">'.'</span>),
  args = <span class="hljs-built_in">Array</span>.prototype.slice.call(originalArgs, <span class="hljs-number">2</span>),
  meth = meths[meths.length-<span class="hljs-number">1</span>],
  assign = <span class="hljs-regexp">/=$/</span>.test(meth),
  r, f, i, v;

  <span class="hljs-keyword">if</span>(assign) meth = meth.substr(<span class="hljs-number">0</span>,meth.length-<span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span>(returnValues) r = [];

  nodes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i &lt; meths.length-<span class="hljs-number">1</span>;i++) {
      f = e[meths[i]];
      e = pie.fn.valueFrom(f);
    }
    <span class="hljs-keyword">if</span>(assign) v = e[meth] = args[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">else</span> {
      f = e[meth];
      v = pie.fn.valueFrom(f, e, args);
    }

    <span class="hljs-keyword">if</span>(returnValues) r.push(v);
  });

  <span class="hljs-keyword">return</span> returnValues ? r : <span class="hljs-literal">undefined</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p><strong>pie.dom.all</strong></p>
<p>Invokes the provided method or method chain with the provided arguments to all elements in the nodeList.
<code>nodeList</code> can either be a node, nodeList, or an array of nodes.
<code>methodName</code> can be a string representing a method name, an attribute, or a property. Can be chained with periods. Can end in a <code>=</code> to invoke an assignment.</p>
<pre><code>pie.dom.all(nodeList, <span class="hljs-string">'setAttribute'</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>);
pie.dom.all(nodeList, <span class="hljs-string">'classList.add'</span>, <span class="hljs-string">'active'</span>);
pie.dom.all(nodeList, <span class="hljs-string">'clicked='</span>, <span class="hljs-literal">true</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.all = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* nodeList, methodName[, arg1, arg2, ...] */</span>)</span> </span>{
  <span class="hljs-keyword">return</span> pie.dom._all(<span class="hljs-built_in">arguments</span>, <span class="hljs-literal">false</span>);
};


(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> mod = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method, originalArgs)</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.from(originalArgs);
    <span class="hljs-keyword">var</span> el = args.shift();
    <span class="hljs-keyword">var</span> classes = pie.array.flatten(args).join(<span class="hljs-string">' '</span>).split(<span class="hljs-regexp">/[\s,]+/</span>);
    classes = pie.array.map(classes, <span class="hljs-string">'trim'</span>, <span class="hljs-literal">true</span>);
    classes = pie.array.compact(classes, <span class="hljs-literal">true</span>);
    classes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span>{ el.classList[method](c); });
  };

  pie.dom.addClass = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* el, class1, class2 */</span>)</span> </span>{
    mod(<span class="hljs-string">'add'</span>, <span class="hljs-built_in">arguments</span>);
  };

  pie.dom.removeClass = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* el, class1, class2 */</span>)</span> </span>{
    mod(<span class="hljs-string">'remove'</span>, <span class="hljs-built_in">arguments</span>);
  };
})();


pie.dom.attrs = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, setters, prefix)</span> </span>{
  prefix = prefix || <span class="hljs-string">''</span>;

  <span class="hljs-keyword">if</span>(setters) {
    pie.object.forEach(setters, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
      <span class="hljs-keyword">if</span>(v == <span class="hljs-literal">null</span>) {
        el.removeAttribute(prefix + k);
      } <span class="hljs-keyword">else</span> {
        el.setAttribute(prefix + k);
      }
    });
  }

  <span class="hljs-keyword">var</span> out = {};

  pie.object.forEach(el.attributes, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
    <span class="hljs-keyword">if</span>(!prefix || k.indexOf(prefix) === <span class="hljs-number">0</span>) {
      out[k.substr(prefix.length)] = v;
    }
  });

  <span class="hljs-keyword">return</span> out;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p><strong>pie.dom.closest</strong></p>
<p>Retrieve the closest ancestor of <code>el</code> which matches the provided <code>sel</code>.</p>
<pre><code><span class="hljs-keyword">var</span> form = pie.dom.closest(input, <span class="hljs-string">'form'</span>);
form.submit();
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.closest = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, sel)</span> </span>{
  <span class="hljs-keyword">while</span>((el = el.parentNode) &amp;&amp; !pie.dom.isDocument(el)) {
    <span class="hljs-keyword">if</span>(pie.dom.matches(el, sel)) <span class="hljs-keyword">return</span> el;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p><strong>pie.dom.createElement</strong></p>
<p>Create an element based on the string content provided.</p>
<pre><code><span class="hljs-keyword">var</span> el = pie.dom.createElement(<span class="hljs-string">'&lt;div class="foo"&gt;&lt;strong&gt;Hi&lt;/strong&gt;, John&lt;/div&gt;'</span>)
el.innerHTML
<span class="hljs-comment">//=&gt; "&lt;strong&gt;Hi&lt;/strong&gt;, John"</span>
el.classList
<span class="hljs-comment">//=&gt; ['foo']</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.createElement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">var</span> wrap = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
  wrap.innerHTML = str;
  <span class="hljs-keyword">return</span> wrap.removeChild(wrap.firstElementChild);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p><strong>pie.dom.cache</strong></p>
<p>A cache created solely for caching element specific information,
easier for cleanup via <code>pie.dom.remove()</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.cache = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  pie.elementCache = pie.elementCache || pie.cache.create();
  <span class="hljs-keyword">return</span> pie.elementCache;
};

pie.dom.data = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, setters)</span> </span>{
  <span class="hljs-keyword">return</span> pie.dom.attrs(el, setters, <span class="hljs-string">'data-'</span>);

};</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p><strong>pie.dom.getAll</strong></p>
<p>Has the same method signature of <code>pie.dom.all</code> but returns the values of the result</p>
<pre><code>pie.dom.getAll(nodeList, <span class="hljs-string">'clicked'</span>)
<span class="hljs-comment">//=&gt; [true, true, false]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.getAll = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> pie.dom._all(<span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p><strong>pie.dom.isDocument</strong></p>
<p>Determine whether the <code>el</code> is a document node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.isDocument = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
  <span class="hljs-keyword">return</span> el &amp;&amp; el.nodeType === el.DOCUMENT_NODE;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p><strong>pie.dom.isWindow</strong></p>
<p>Determine whether the provided <code>el</code> is the <code>window</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.isWindow = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
  <span class="hljs-keyword">return</span> el === <span class="hljs-built_in">window</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p><strong>pie.dom.matches</strong></p>
<p>Test whether an element matches a given selector.</p>
<pre><code>pie.dom.matches(form, <span class="hljs-string">'input'</span>);
<span class="hljs-comment">//=&gt; false</span>
pie.dom.matches(form, <span class="hljs-string">'form'</span>);
<span class="hljs-comment">//=&gt; true</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.matches = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, sel)</span> </span>{
  <span class="hljs-keyword">if</span>(pie.object.isDom(sel)) <span class="hljs-keyword">return</span> el === sel;

  <span class="hljs-keyword">var</span> fn = pie.dom.prefixed(el, <span class="hljs-string">'matches'</span>);
  <span class="hljs-keyword">if</span>(fn) <span class="hljs-keyword">return</span> fn(sel);

  fn = pie.dom.prefixed(el, <span class="hljs-string">'matchesSelector'</span>);
  <span class="hljs-keyword">if</span>(fn) <span class="hljs-keyword">return</span> fn(sel);

  <span class="hljs-keyword">var</span> parent = el.parentNode || el.document;
  <span class="hljs-keyword">if</span>(!parent || !parent.querySelector) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  pie.uid(el);
  el.setAttribute(<span class="hljs-string">'data-pie-id'</span>, pie.uid(el));

  sel += <span class="hljs-string">'[data-pie-id="'</span> + pie.uid(el) + <span class="hljs-string">'"]'</span>;
  <span class="hljs-keyword">return</span> parent.querySelector(sel) === el;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p><strong>pie.dom.off</strong></p>
<p>Remove an observer from an element. The more information provided the more tests will be run to determine
whether the observer is a match. Support of namespaces are the same as <code>pie.dom.on</code>, however, in the case
of <code>off</code>, <code>&quot;*&quot;</code> can be provided to remove all events within a namespace.</p>
<pre><code>pie.dom.off(document.body, &#39;click&#39;);
pie.dom.off(document.body&#39;, &#39;click.fooNs&#39;);
pie.dom.off(document.body&#39;, &#39;*.fooNs&#39;);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
pie.dom.off = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, event, fn, selector, cap)</span> </span>{
  <span class="hljs-keyword">var</span> eventSplit = event.split(<span class="hljs-string">'.'</span>),
    namespace, all, events, compactNeeded;

  pie.uid(el);
  event = eventSplit.shift();
  namespace = eventSplit.join(<span class="hljs-string">'.'</span>);
  all = event === <span class="hljs-string">'*'</span>;

  events = pie.dom.cache().getOrSet(<span class="hljs-string">'element-'</span> + pie.uid(el) + <span class="hljs-string">'.dom-events'</span>, {});

  (all ? <span class="hljs-built_in">Object</span>.keys(events) : [event]).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    compactNeeded = <span class="hljs-literal">false</span>;

    pie.array.from(events[k]).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, i, ary)</span> </span>{
      <span class="hljs-keyword">if</span>(cap == <span class="hljs-literal">null</span> &amp;&amp; (k === <span class="hljs-string">'focus'</span> || k === <span class="hljs-string">'blur'</span>) &amp;&amp; obj.sel) cap = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">if</span>((namespace == <span class="hljs-literal">null</span> || namespace === obj.ns) &amp;&amp;
          (fn == <span class="hljs-literal">null</span> || fn === obj.fn) &amp;&amp;
          (selector == <span class="hljs-literal">null</span> || selector === obj.sel) &amp;&amp;
          (cap === obj.cap)) {
        el.removeEventListener(k, obj.cb, obj.cap);
        <span class="hljs-keyword">delete</span> ary[i];
        compactNeeded = <span class="hljs-literal">true</span>;
      }
    });

    <span class="hljs-keyword">if</span>(compactNeeded) events[k] = pie.array.compact(events[k]);

  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p><strong>pie.dom.on</strong></p>
<p>Observe an event on a particular <code>el</code>.</p>
<pre><code><span class="hljs-keyword">var</span> handler = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
  <span class="hljs-keyword">var</span> btn = e.delegateTarget;
  btn.classList.toggle(<span class="hljs-string">'is-loading'</span>);
}
pie.dom.on(pie.qs(<span class="hljs-string">'.btn'</span>), <span class="hljs-string">'click'</span>, handler);
<span class="hljs-comment">// =&gt; all events on the first .btn will be observed.</span>
</code></pre><p>Optionally, the event can be filtered by a <code>selector</code>.
If a selector is provided, a <code>delegateTarget</code> which represents the
matching target as defined by <code>selector</code> will be placed
on the event. The event is then provided to <code>fn</code>.</p>
<pre><code>pie.dom.on(<span class="hljs-built_in">document</span>.body, <span class="hljs-string">'click'</span>, handler, <span class="hljs-string">'.btn'</span>);
<span class="hljs-comment">//=&gt; all events that bubble to document.body and pass through or</span>
<span class="hljs-comment">//=&gt; originate from a .btn, will be observed.</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.on = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, event, fn, selector, capture)</span> </span>{
  <span class="hljs-keyword">var</span> eventSplit = event.split(<span class="hljs-string">'.'</span>),
      cb, namespace, events;

  event = eventSplit.shift();
  namespace = eventSplit.join(<span class="hljs-string">'.'</span>);
  pie.uid(el);</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>we force capture so that delegation works.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!capture &amp;&amp; (event === <span class="hljs-string">'focus'</span> || event === <span class="hljs-string">'blur'</span>) &amp;&amp; selector) capture = <span class="hljs-literal">true</span>;

  events = pie.dom.cache().getOrSet(<span class="hljs-string">'element-'</span> + pie.uid(el)  + <span class="hljs-string">'.dom-events'</span>, {});
  events[event] = events[event] || [];

  cb = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    <span class="hljs-keyword">var</span> targ, qel;

    <span class="hljs-keyword">if</span>(namespace) {
      e.namespace = namespace;
    }

    <span class="hljs-keyword">if</span>(!selector) {
      fn.call(el, e);
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>if the target matches the selector, it is the delegateTarget.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      targ = pie.dom.matches(e.target, selector) ? e.target : <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>othwerwise, try to find a parent that is a child of el which matches the selector.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(!targ) {
        qel = pie.dom.closest(e.target, selector);
        <span class="hljs-keyword">if</span>(qel &amp;&amp; el.contains(qel)) targ = qel;
      }

      <span class="hljs-keyword">if</span>(targ) {
        e.delegateTarget = targ;
        fn.call(targ, e);
      }
    }
  };

  events[event].push({
    ns: namespace,
    sel: selector,
    cb: cb,
    fn: fn,
    cap: capture
  });

  el.addEventListener(event, cb, capture);
  <span class="hljs-keyword">return</span> cb;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p><strong>pie.dom.parseForm</strong></p>
<p>Given a form element <code>el</code> parse the names &amp; values from it.
Optionally, the fields to parse can be filtered by providing a list of names.</p>
<p>Given the markup:</p>
<pre><code>&lt;form&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"fullName"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"email"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">select</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"interest"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-title">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span></span>
</code></pre><p>We can retrieve the fields using <code>parseForm</code>.</p>
<pre><code>pie.dom.parseForm(form)
<span class="hljs-comment">//=&gt; {fullName: 'foo', email: 'foo@bar.com', interest: 'user'}</span>
pie.dom.parseForm(form, <span class="hljs-string">'fullName'</span>)
<span class="hljs-comment">//=&gt; {fullName: 'foo'}</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.parseForm = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* el, *fields */</span>)</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
  form = args.shift(),
  names = pie.array.flatten(args),
  inputs = form.querySelectorAll(<span class="hljs-string">'input[name], select[name], textarea[name]'</span>),
  o = {},
  origLength;

  inputs = pie.array.groupBy(inputs, <span class="hljs-string">'name'</span>);

  pie.object.forEach(inputs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name,fields)</span> </span>{
    <span class="hljs-keyword">if</span>(names.length &amp;&amp; names.indexOf(name) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    origLength = fields.length;

    <span class="hljs-keyword">if</span>(fields[<span class="hljs-number">0</span>].type === <span class="hljs-string">'radio'</span>) {
      origLength = <span class="hljs-number">1</span>;
      fields = fields.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span></span>{ <span class="hljs-keyword">return</span> f.checked; });
    } <span class="hljs-keyword">else</span> {
      fields = fields.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span></span>{ <span class="hljs-keyword">return</span> f.type === <span class="hljs-string">'checkbox'</span> ? f.checked : <span class="hljs-literal">true</span>; });
    }


    <span class="hljs-keyword">if</span>(origLength &gt; <span class="hljs-number">1</span>) o[name] = pie.array.map(fields, <span class="hljs-string">'value'</span>);
    <span class="hljs-keyword">else</span> o[name] = fields[<span class="hljs-number">0</span>] &amp;&amp; fields[<span class="hljs-number">0</span>].value;
  });

  <span class="hljs-keyword">return</span> o;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p><strong>pie.dom.prependChild</strong></p>
<p>Insert a child at the top of the parent.</p>
<pre><code><span class="hljs-comment">// el = &lt;div&gt;&lt;p&gt;Things&lt;/p&gt;&lt;/div&gt;</span>
<span class="hljs-comment">// child = &lt;h3&gt;Title&lt;/h3&gt;</span>
pie.dom.prependChild(el, child)
<span class="hljs-comment">// el = &lt;div&gt;&lt;h3&gt;Title&lt;/h3&gt;&lt;p&gt;Things&lt;/p&gt;&lt;/div&gt;</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.prependChild = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, child)</span> </span>{
  el.insertBefore(child, el.firstChild);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p><strong>pie.dom.remove</strong></p>
<p>Remove <code>el</code> from the dom, clearing any cache we’ve constructed.
If you intend on adding the element back into the dom you should
remove <code>el</code> manually, not via <code>pie.dom.remove</code>.</p>
<pre><code>pie.dom.remove(el)
<span class="hljs-comment">// =&gt; el.parentNode == null;</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.remove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
  pie.uid(el);
  pie.dom.cache().set(<span class="hljs-string">'element-'</span> + pie.uid(el), <span class="hljs-literal">undefined</span>);
  <span class="hljs-keyword">if</span>(el.parentNode) el.parentNode.removeChild(el);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p><strong>pie.dom.scrollParents</strong></p>
<p>Find all the parent elements of <code>el</code> that have a scroll property.
Useful for spying on scroll and determing element position.
Optionally, you can provide the following options:</p>
<ul>
<li>direction = ‘x’ or ‘y’, defaults to null (both)</li>
<li>includeSelf - if <code>true</code> it will evaluate <code>el</code>‘s scroll property and include it in the parent list.</li>
<li>closest - if <code>true</code> it will return the first scroll parent instead of all of them.</li>
</ul>
<pre><code>pie.dom.scrollParents(el)
<span class="hljs-comment">//=&gt; document.body</span>
</code></pre><p><strong>Note</strong> window will not be included in the response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.scrollParents = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> regex = <span class="hljs-regexp">/scroll|auto/</span>,
  prop = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, dir)</span> </span>{
    <span class="hljs-keyword">var</span> style = getComputedStyle(el),
    flow = style.getPropertyValue(<span class="hljs-string">'overflow'</span>);
    <span class="hljs-keyword">if</span>(!dir || dir === <span class="hljs-string">'x'</span>) flow += style.getPropertyValue(<span class="hljs-string">'overflow-x'</span>);
    <span class="hljs-keyword">if</span>(!dir || dir === <span class="hljs-string">'y'</span>) flow += style.getPropertyValue(<span class="hljs-string">'overflow-y'</span>);
    <span class="hljs-keyword">return</span> flow;
  };

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, options)</span> </span>{
    <span class="hljs-keyword">var</span> parents = options &amp;&amp; options.closest ? <span class="hljs-literal">undefined</span> : [],
    style;

    <span class="hljs-keyword">if</span>(!options || !options.includeSelf) el = el.parentNode;

    <span class="hljs-keyword">while</span>(el &amp;&amp; !pie.dom.isDocument(el)) {
      style = prop(el, options &amp;&amp; options.direction);

      <span class="hljs-keyword">if</span>(regex.test(style)) {
        <span class="hljs-keyword">if</span>(options &amp;&amp; options.closest) <span class="hljs-keyword">return</span> el;
        parents.unshift(el);
      }

      el = el.parentNode;
    }

    <span class="hljs-keyword">return</span> parents;
  };
})();</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p><strong>pie.dom.scrollTo</strong></p>
<p>Scroll the page to <code>sel</code>.
If <code>sel</code> is a string it will find the first occurrence via a querySelector within the provided container.
If <code>sel</code> is a dom node, the nodes position will be used.
If <code>sel</code> is a number, it will scroll to that position.
Available options:</p>
<ul>
<li>container - the container to scroll, defaults to document.body</li>
<li>cb - the callback to invoke when scrolling is finished.</li>
<li>onlyUp - only scrolls if the element is above the current position.</li>
<li>onlyDown - only scrolls if the element is below the current position.</li>
<li>gravity - where the element should appear in the viewport,</li>
<li><ul>
<li><ul>
<li>any option available in pie.fn.ease</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>```
pie.dom.scrollTo(‘header’, {onlyUp: true, cb: fn, name: ‘easeInQuart’});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.scrollTo = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sel, options)</span> </span>{
  <span class="hljs-keyword">var</span> position = <span class="hljs-number">0</span>,
  container = options &amp;&amp; options.container || pie.dom.rootScrollElement(),
  cb = options &amp;&amp; options.cb,
  gravity = options &amp;&amp; options.gravity || <span class="hljs-string">'top'</span>,
  quit = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">if</span>(pie.object.isNumber(sel)) {
    position = sel;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isString(sel)) {
    sel = container.querySelector(sel);
  }

  <span class="hljs-keyword">if</span>(sel) {</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>ep is the elements position on the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ep = pie.dom.position(sel, container),</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>cp is the containers position on the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cp = pie.dom.position(container);

    <span class="hljs-keyword">if</span>(gravity === <span class="hljs-string">'center'</span>) {
      position = (ep.top + (ep.height / <span class="hljs-number">2</span>)) - (cp.height / <span class="hljs-number">2</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(gravity === <span class="hljs-string">'bottom'</span>) {
      position = (ep.bottom - cp.height);
    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// top</span>
      position = ep.top;
    }
  }

  <span class="hljs-keyword">if</span>(options) {
    <span class="hljs-keyword">if</span>(options.onlyUp &amp;&amp; container.scrollTop &lt;= position) quit = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(options.onlyDown &amp;&amp; container.scrollTop &gt;= position) quit = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">if</span>(position === container.scrollTop) quit = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">if</span>(quit) {
    <span class="hljs-keyword">if</span>(cb) cb();
    <span class="hljs-keyword">return</span>;
  }

  options = pie.object.merge({
    from: container.scrollTop,
    to: position,
    name: <span class="hljs-string">'easeInOutCubic'</span>,
    duration: <span class="hljs-number">250</span>,
    animation: <span class="hljs-literal">true</span>
  }, options);

  <span class="hljs-keyword">delete</span> options.cb;
  <span class="hljs-keyword">delete</span> options.container;
  <span class="hljs-keyword">delete</span> options.onlyUp;
  <span class="hljs-keyword">delete</span> options.onlyDown;
  <span class="hljs-keyword">delete</span> options.gravity;

  pie.fn.ease(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span></span>{
    container.scrollTop = p;
  }, options, cb);

};</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p><strong>pie.dom.rootScrollElement</strong></p>
<p>Returns either the html or body element depending on which one
is in charge of scrolling the page. If no determination can be
made the html element is returned since that’s what the spec
states is correct.</p>
<p>This is why you’ll often see $(‘body, html’).animate() in jquery apps.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.rootScrollElement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> body = <span class="hljs-built_in">document</span>.body,
  html = <span class="hljs-built_in">document</span>.documentElement;

  <span class="hljs-keyword">if</span>(body.scrollTop) <span class="hljs-keyword">return</span> body;
  <span class="hljs-keyword">if</span>(html.scrollTop) <span class="hljs-keyword">return</span> html;

  <span class="hljs-keyword">var</span> correct;</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>both are zero, so try to change it by 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  body.scrollTop = html.scrollTop = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">if</span>(body.scrollTop) correct = body;
  <span class="hljs-keyword">else</span> correct = html;

  body.scrollTop = html.scrollTop = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">return</span> correct;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p><strong>pie.dom.trigger</strong></p>
<p>Trigger an event <code>e</code> on <code>el</code>.
If the event is a click, it will invoke the click() handler instead of creating
a dom event. This is for browser compatability reasons (certain versions of FF).
If you want to force an event, pass true as the third argument.</p>
<pre><code>pie.dom.trigger(el, <span class="hljs-string">'click'</span>);
pie.dom.trigger(el, <span class="hljs-string">'foo.bar'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.trigger = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, e, forceEvent)</span> </span>{

  <span class="hljs-keyword">if</span>(!forceEvent &amp;&amp; e === <span class="hljs-string">'click'</span>) <span class="hljs-keyword">return</span> el.click();

  <span class="hljs-keyword">var</span> event = <span class="hljs-built_in">document</span>.createEvent(<span class="hljs-string">'Event'</span>);
  event.initEvent(e, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">return</span> el.dispatchEvent(event);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p><strong>pie.dom.prefixed</strong></p>
<p>Find the first available version of the desired function, including browser specific implementations.</p>
<pre><code>pie.dom.prefixed(el, <span class="hljs-string">'matches'</span>);
pie.dom.prefixed(el, <span class="hljs-string">'matchesSelector'</span>);
pie.dom.prefixed(getComputedStyle(<span class="hljs-built_in">document</span>.body), <span class="hljs-string">'animation-delay'</span>)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.prefixed = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> prefixes = [<span class="hljs-string">''</span>, <span class="hljs-string">'webkit'</span>, <span class="hljs-string">'moz'</span>, <span class="hljs-string">'ms'</span>, <span class="hljs-string">'o'</span>],
  returnVal = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, el, standard)</span></span>{
    pie.dom.cache().set(<span class="hljs-string">'browserPrefix.'</span> + standard, val);
    <span class="hljs-keyword">return</span> pie.object.isFunction(val) ? val.bind(el) : val;
  };

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, standardName)</span> </span>{

    <span class="hljs-keyword">var</span> cacheHit = pie.dom.cache().get(<span class="hljs-string">'browserPrefix.'</span> + standardName);
    <span class="hljs-keyword">if</span>(cacheHit) <span class="hljs-keyword">return</span> returnVal(cacheHit, el, standardName);

    <span class="hljs-keyword">var</span> prefix, i = <span class="hljs-number">0</span>,
    capd = pie.string.capitalize(standardName);

    <span class="hljs-keyword">for</span>(; i &lt; prefixes.length; i++) {
      prefix = prefixes[i];

      <span class="hljs-keyword">if</span>(el[prefix + standardName]) <span class="hljs-keyword">return</span> returnVal(el[prefix + standardName], el, standardName);
      <span class="hljs-keyword">if</span>(el[<span class="hljs-string">'-'</span> + prefix + <span class="hljs-string">'-'</span> + standardName]) <span class="hljs-keyword">return</span> returnVal(el[<span class="hljs-string">'-'</span> + prefix + <span class="hljs-string">'-'</span> + standardName], el, standardName);
      <span class="hljs-keyword">if</span>(el[prefix + capd]) <span class="hljs-keyword">return</span> returnVal(el[prefix + capd], el, standardName);
    }
  };
})();

pie.dom.viewportPosition = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> windowW = <span class="hljs-built_in">Math</span>.max(<span class="hljs-built_in">document</span>.documentElement.clientWidth, <span class="hljs-built_in">window</span>.innerWidth || <span class="hljs-number">0</span>),
  windowH = <span class="hljs-built_in">Math</span>.max(<span class="hljs-built_in">document</span>.documentElement.clientHeight, <span class="hljs-built_in">window</span>.innerHeight || <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> {
    top: <span class="hljs-built_in">window</span>.scrollY,
    bottom: <span class="hljs-built_in">window</span>.scrollY + windowH,
    height: windowH,
    left: <span class="hljs-built_in">window</span>.scrollX,
    right: <span class="hljs-built_in">window</span>.scrollX + windowW,
    width: windowW
  };
};

pie.dom.position = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, container)</span> </span>{

  <span class="hljs-keyword">if</span>(pie.dom.isWindow(el)) <span class="hljs-keyword">return</span> pie.dom.viewportPosition(el);

  <span class="hljs-keyword">var</span>   top = <span class="hljs-number">0</span>,
  left = <span class="hljs-number">0</span>,
  w = el.offsetWidth,
  h = el.offsetHeight;

  container = container || <span class="hljs-built_in">document</span>.body;

  <span class="hljs-keyword">while</span>(el &amp;&amp; el !== container) {
    top += (el.offsetTop - el.scrollTop);
    left += (el.offsetLeft - el.scrollLeft);
    el = el.offsetParent;
  }

  <span class="hljs-keyword">return</span> {
    width: w,
    height: h,
    top: top,
    left: left,
    right: left + w,
    bottom: top + h
  };
};

pie.dom.inViewport = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, threshold, vLoc)</span> </span>{
  <span class="hljs-keyword">var</span> viewportLoc = vLoc || pie.dom.viewportPosition(),
  t = threshold || <span class="hljs-number">0</span>,
  elLoc = pie.dom.position(el);

  <span class="hljs-keyword">return</span>  elLoc.bottom &gt;= viewportLoc.top - t &amp;&amp;
          elLoc.top &lt;= viewportLoc.bottom + t &amp;&amp;
          elLoc.right &gt;= viewportLoc.left - t &amp;&amp;
          elLoc.left &lt;= viewportLoc.right + t;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p><strong>pie.fn.async</strong></p>
<p>Invoke all <code>fns</code> and when they have completed their execution, invoke the callback <code>cb</code>.
Each provided function is expected to invoke a callback supplied as it’s first argument.</p>
<pre><code><span class="hljs-keyword">var</span> a = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'hey'</span>); cb(); };
<span class="hljs-keyword">var</span> b = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{ app.ajax.get(...).complete(cb); };
<span class="hljs-keyword">var</span> complete = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'complete!'</span>); };

pie.fn.async([a, b], complete);
<span class="hljs-comment">//=&gt; "hey" is logged, ajax is completed, then "complete!" is logged.</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
pie.fn.async = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fns, cb, counterObserver)</span> </span>{

  <span class="hljs-keyword">if</span>(!fns.length) {
    cb();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">var</span> completeCount = fns.length,
  completed = <span class="hljs-number">0</span>,
  counter = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fnAsyncCounter</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(counterObserver) counterObserver.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">if</span>(++completed === completeCount) {
      <span class="hljs-keyword">if</span>(cb) cb();
    }
  };

  fns.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fnAsyncIterator</span><span class="hljs-params">(fn)</span> </span>{ fn(counter); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p><strong>pie.fn.debounce</strong></p>
<p>Returns a function, that, as long as it continues to be invoked, will not
be triggered. The function will be called after it stops being called for
N milliseconds. If <code>immediate</code> is passed, trigger the function on the
leading edge, instead of the trailing.
Lifted from underscore.js</p>
<pre><code>pie.fn.debounce(submitForm, <span class="hljs-number">500</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.fn.debounce = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func, wait, immediate)</span> </span>{
  <span class="hljs-keyword">var</span> timeout, args, context, timestamp, result;

  <span class="hljs-keyword">var</span> later = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> last = pie.date.now() - timestamp;

    <span class="hljs-keyword">if</span> (last &lt; wait &amp;&amp; last &gt; <span class="hljs-number">0</span>) {
      timeout = setTimeout(later, wait - last);
    } <span class="hljs-keyword">else</span> {
      timeout = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">if</span> (!immediate) {
        result = func.apply(context, args);
        <span class="hljs-keyword">if</span> (!timeout) context = args = <span class="hljs-literal">null</span>;
      }
    }
  };

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    context = <span class="hljs-keyword">this</span>;
    args = <span class="hljs-built_in">arguments</span>;
    timestamp = pie.date.now();
    <span class="hljs-keyword">var</span> callNow = immediate &amp;&amp; !timeout;
    <span class="hljs-keyword">if</span> (!timeout) timeout = setTimeout(later, wait);
    <span class="hljs-keyword">if</span> (callNow) {
      result = func.apply(context, args);
      context = args = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">return</span> result;
  };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p><strong>pie.fn.delay</strong></p>
<p>Delay an invocation until some time has passed. Once that time has passed, any invocation will occur immediately.
Invocations 2-N that occur before the delay period are ignored.</p>
<pre><code>fn = pie.fn.delay(fn, <span class="hljs-number">250</span>)
fn(); <span class="hljs-comment">// doesn't happen but is scheduled for 250ms from now.</span>
<span class="hljs-comment">// 249ms passes</span>
fn(); <span class="hljs-comment">// doesn't happen, not scheduled either.</span>
<span class="hljs-comment">// 1ms passes</span>
<span class="hljs-comment">// one invocation is triggered.</span>
<span class="hljs-comment">// N ms passes</span>
fn(); <span class="hljs-comment">// happens immediately</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.fn.delay = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn, delay)</span> </span>{
  <span class="hljs-keyword">if</span>(!delay) <span class="hljs-keyword">return</span> fn;

  <span class="hljs-keyword">var</span> threshold = pie.date.now() + delay;
  <span class="hljs-keyword">var</span> scheduled = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> now = pie.date.now();
    <span class="hljs-keyword">if</span>(now &lt; threshold) {
      <span class="hljs-keyword">if</span>(!scheduled) {
        scheduled = <span class="hljs-literal">true</span>;
        setTimeout(fn, threshold - now);
      }
    } <span class="hljs-keyword">else</span> {
      fn();
    }
  };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p><strong>pie.fn.ease</strong></p>
<p>Invoke a callback <code>cb</code> with the coordinates of an easing function.
The callback will receive the <code>y</code> &amp; <code>t</code> values where t ranges from 0 to 1 and <code>y</code> ranges
from the <code>from</code> and to the <code>to</code> options. The easing function can be described by passing
a name option which coincides with the easing functions defined in <code>pie.math</code>.</p>
<pre><code>pie.fn.ease(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(y, t)</span></span>{
  <span class="hljs-built_in">window</span>.scrollTo(<span class="hljs-number">0</span>, y);
}, { from: <span class="hljs-number">0</span>, to: <span class="hljs-number">300</span>, name: <span class="hljs-string">'easeOutCubic'</span> });
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.fn.ease = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(each, o, complete)</span> </span>{
  o = pie.object.merge({
    name: <span class="hljs-string">'linear'</span>,
    duration: <span class="hljs-number">250</span>,
    from: <span class="hljs-number">0</span>,
    to: <span class="hljs-number">1</span>,
    delay: <span class="hljs-number">0</span>,
    animation: <span class="hljs-literal">false</span>
  }, o);

  <span class="hljs-keyword">if</span>(o.name === <span class="hljs-string">'none'</span>) {
    each(o.to, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span>(complete) complete();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">var</span> via = o.animation ? pie.fn._easeAnimation : pie.fn._easeInterval,
  start = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ via(each, o, complete); };

  <span class="hljs-keyword">if</span>(o.delay) start = pie.fn.delay(start, o.delay);

  start();
};

<span class="hljs-comment">/* ease using an interval (non-ui stuff) */</span>
pie.fn._easeInterval = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(each, o, complete)</span> </span>{
  o.steps = o.steps || <span class="hljs-built_in">Math</span>.max(o.duration / <span class="hljs-number">16</span>, <span class="hljs-number">12</span>);

  <span class="hljs-comment">/* the easing function */</span>
  <span class="hljs-keyword">var</span> fn = pie.math.easing[o.name],
  <span class="hljs-comment">/* the current "time" 0 to 1. */</span>
  t = <span class="hljs-number">0</span>,
  delta = (o.to - o.from),
  dt = (<span class="hljs-number">1</span> / o.steps),
  dy,
  y,
  pid,
  runner = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">easeIntervalRunner</span><span class="hljs-params">()</span></span>{
    dy = fn(t);
    y = o.from + (dy * delta);
    each(y, t);
    <span class="hljs-keyword">if</span>(t &gt;= <span class="hljs-number">1</span>) {
      t = <span class="hljs-number">1</span>;
      clearInterval(pid);
      <span class="hljs-keyword">if</span>(complete) complete();
    } <span class="hljs-keyword">else</span> t += dt;</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>return ourself so we can invoke as part of setInterval</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> runner;
  };

  pid = setInterval(runner(), o.duration / o.steps);
  <span class="hljs-keyword">return</span> pid;
};

<span class="hljs-comment">/* ease using the animation frame (ui stuff) */</span>
pie.fn._easeAnimation = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(each, o, complete)</span> </span>{

  <span class="hljs-keyword">var</span> animate = pie.dom.prefixed(<span class="hljs-built_in">window</span>, <span class="hljs-string">'requestAnimationFrame'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>just in case the browser doesn’t support the animation frame.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!animate) <span class="hljs-keyword">return</span> pie.fn._easeInterval(each, o, complete);

  <span class="hljs-comment">/* the easing function */</span>
  <span class="hljs-keyword">var</span> fn = pie.math.easing[o.name],</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>the current “time” 0 to 1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  x = <span class="hljs-number">0</span>,
  startT,
  endT,
  delta = (o.to - o.from),
  dy,
  y,
  runner = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">easeAnimationRunner</span><span class="hljs-params">(bigT)</span></span>{

    <span class="hljs-keyword">if</span>(!startT) {
      startT = bigT;
      endT = startT + o.duration;
    }

    x = (bigT - startT) / (endT - startT);
    dy = fn(x);
    y = o.from + (dy * delta);
    each(y, x);

    <span class="hljs-keyword">if</span>(bigT &gt;= endT) {
      <span class="hljs-keyword">if</span>(y !== o.to) each(o.to, <span class="hljs-number">1</span>);
      <span class="hljs-keyword">if</span>(complete) complete();
    } <span class="hljs-keyword">else</span> {
      animate(runner);
    }
  };

  animate(runner);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p><strong>pie.fn.once</strong></p>
<p>Only ever invoke the function <code>f</code> once. The return value will always be the same.
```
var count = 0;</p>

            </div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>var f = pie.fn.once(function(){
  count++;
  return count;
});</p>
<p>f();
//=&gt; 1
f();
//=&gt; 1
```</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.fn.once = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span> </span>{
  <span class="hljs-keyword">var</span> called = <span class="hljs-literal">false</span>,
  result;

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">if</span>(!called) {
      called = <span class="hljs-literal">true</span>;
      result = f.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
    }

    <span class="hljs-keyword">return</span> result;
  };
};

pie.fn.noop = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{};</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p><strong>pie.fn.throttle</strong></p>
<p>Trigger an event no more than the specified rate.
Note that the functions do not pile up and continue executing,
they only execute at the rate specified while still being invoked.</p>
<pre><code>fn = pie.fn.throttle(fn, <span class="hljs-number">250</span>);
fn(); fn();
<span class="hljs-comment">//=&gt; fires once</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.fn.throttle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn, threshold, scope)</span> </span>{
  threshold = threshold || <span class="hljs-number">250</span>;
  <span class="hljs-keyword">var</span> last, deferTimer;

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> context = scope || <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> now = pie.date.now(),
        args = <span class="hljs-built_in">arguments</span>;

    <span class="hljs-keyword">if</span> (last &amp;&amp; now &lt; last + threshold) {
      clearTimeout(deferTimer);
      deferTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        last = now;
        fn.apply(context, args);
      }, threshold);
    } <span class="hljs-keyword">else</span> {
      last = now;
      fn.apply(context, args);
    }
  };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p><strong>pie.fn.valueFrom</strong></p>
<p>If a function is provided, it will be invoked otherwise the provided value will be returned.</p>
<pre><code>pie.fn.valueFrom(<span class="hljs-number">4</span>)
<span class="hljs-comment">//=&gt; 4</span>
pie.fn.valueFrom(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>; });
<span class="hljs-comment">//=&gt; 5</span>
pie.fn.valueFrom(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>); }, {<span class="hljs-string">'foo'</span> : <span class="hljs-string">'bar'</span>});
<span class="hljs-comment">//=&gt; ["foo"];</span>
pie.fn.valueFrom(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(o); }, <span class="hljs-literal">null</span>, {<span class="hljs-string">'foo'</span> : <span class="hljs-string">'bar'</span>});
<span class="hljs-comment">//=&gt; ["foo"];</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.fn.valueFrom = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f, binding, args)</span> </span>{
  <span class="hljs-keyword">if</span>(pie.object.isFunction(f)) <span class="hljs-keyword">return</span> f.apply(binding, args) ;
  <span class="hljs-keyword">return</span> f;
};
pie.math.precision = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(number, places)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.round(number * <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, places)) / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, places);
};

pie.math.easing = {</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>no easing, no acceleration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  linear: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>just get us to the end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  none: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* t */</span>)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; },</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>accelerating from zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInQuad: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>decelerating to zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeOutQuad: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t*(<span class="hljs-number">2</span>-t); },</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>acceleration until halfway, then deceleration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInOutQuad: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t&lt;<span class="hljs-number">0.5</span> ? <span class="hljs-number">2</span>*t*t : -<span class="hljs-number">1</span>+(<span class="hljs-number">4</span>-<span class="hljs-number">2</span>*t)*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>accelerating from zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInCubic: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>decelerating to zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeOutCubic: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> (--t)*t*t+<span class="hljs-number">1</span>; },</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>acceleration until halfway, then deceleration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInOutCubic: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t&lt;<span class="hljs-number">0.5</span> ? <span class="hljs-number">4</span>*t*t*t : (t-<span class="hljs-number">1</span>)*(<span class="hljs-number">2</span>*t-<span class="hljs-number">2</span>)*(<span class="hljs-number">2</span>*t-<span class="hljs-number">2</span>)+<span class="hljs-number">1</span>; },</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>accelerating from zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInQuart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t*t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>decelerating to zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeOutQuart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>-(--t)*t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>acceleration until halfway, then deceleration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInOutQuart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t&lt;<span class="hljs-number">0.5</span> ? <span class="hljs-number">8</span>*t*t*t*t : <span class="hljs-number">1</span>-<span class="hljs-number">8</span>*(--t)*t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>accelerating from zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInQuint: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t*t*t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>decelerating to zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeOutQuint: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>+(--t)*t*t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>acceleration until halfway, then deceleration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInOutQuint: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t&lt;<span class="hljs-number">0.5</span> ? <span class="hljs-number">16</span>*t*t*t*t*t : <span class="hljs-number">1</span>+<span class="hljs-number">16</span>*(--t)*t*t*t*t; }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>deletes all undefined and null values.
returns a new object less any empty key/values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.compact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, removeEmpty)</span></span>{
  <span class="hljs-keyword">var</span> b = pie.object.merge({}, a);
  <span class="hljs-built_in">Object</span>.keys(b).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    <span class="hljs-comment">/* jslint eqnull:true */</span>
    <span class="hljs-keyword">if</span>(b[k] == <span class="hljs-literal">null</span> || (removeEmpty &amp;&amp; b[k].toString().length === <span class="hljs-number">0</span>)) <span class="hljs-keyword">delete</span> b[k];
  });
  <span class="hljs-keyword">return</span> b;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>deep merge. Does not preserve identity of inner objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.deepMerge = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
      targ = args.shift(),
      obj;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn</span><span class="hljs-params">(k)</span> </span>{

    <span class="hljs-keyword">if</span>(pie.object.has(targ, k) &amp;&amp; pie.object.isPlainObject(targ[k])) {
      targ[k] = pie.object.deepMerge({}, targ[k], obj[k]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isPlainObject(obj[k])) {
      targ[k] = pie.object.deepMerge({}, obj[k]);
    } <span class="hljs-keyword">else</span> {
      targ[k] = obj[k];
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>iterate over each passed in obj remaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (; args.length;) {
    obj = args.shift();
    <span class="hljs-keyword">if</span>(obj) <span class="hljs-built_in">Object</span>.keys(obj).forEach(fn);
  }
  <span class="hljs-keyword">return</span> targ;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>delete a path,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.deletePath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, path, propagate)</span> </span>{

  <span class="hljs-keyword">if</span>(!~path.indexOf(<span class="hljs-string">'.'</span>)) {
    <span class="hljs-keyword">delete</span> obj[path];
  }

  <span class="hljs-keyword">var</span> steps = pie.string.pathSteps(path), attr, subObj;

  <span class="hljs-keyword">while</span>(steps.length) {
    attr = pie.array.last(steps.shift().split(<span class="hljs-string">'.'</span>));
    subObj = pie.object.getPath(obj, steps[<span class="hljs-number">0</span>]);
    <span class="hljs-keyword">if</span>(!subObj) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">delete</span> subObj[attr];
    <span class="hljs-keyword">if</span>(!propagate || !pie.object.isEmpty(subObj)) <span class="hljs-keyword">return</span>;
  }

};

pie.object.dup = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, deep)</span> </span>{
  <span class="hljs-keyword">return</span> pie.object[deep ? <span class="hljs-string">'deepMerge'</span> : <span class="hljs-string">'merge'</span>]({}, obj);
};

pie.object.eq = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b, strict)</span> </span>{
  <span class="hljs-keyword">var</span> i;

  <span class="hljs-comment">/* jslint eqeq:true */</span>
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(a) &amp;&amp; <span class="hljs-built_in">Array</span>.isArray(b)) {
    <span class="hljs-keyword">if</span>(a.length !== b.length) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; a.length; i++) {
      <span class="hljs-keyword">if</span>(!pie.object.eq(a[i], b[i], strict)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">if</span>(pie.object.isObject(a) &amp;&amp; pie.object.isObject(b)) {
    <span class="hljs-keyword">var</span> aKeys = <span class="hljs-built_in">Object</span>.keys(a).sort(), bKeys = <span class="hljs-built_in">Object</span>.keys(b).sort();

    <span class="hljs-keyword">if</span>(!pie.object.eq(aKeys, bKeys, strict)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; aKeys.length; i++) {
      <span class="hljs-keyword">if</span>(!pie.object.eq(a[aKeys[i]], b[aKeys[i]], strict)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">return</span> strict ? a === b : a == b;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>grab the sub-object from the provided object less the provided keys.
pie.object.except({foo: ‘bar’, biz: ‘baz’}, ‘biz’) =&gt; {‘foo’: ‘bar’}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.except = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> keys = pie.array.from(<span class="hljs-built_in">arguments</span>),
  a = keys.shift(),
  b = {};

  keys = pie.array.flatten(keys);

  <span class="hljs-built_in">Object</span>.keys(a).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
    <span class="hljs-keyword">if</span>(keys.indexOf(k) &lt; <span class="hljs-number">0</span>) b[k] = a[k];
  });

  <span class="hljs-keyword">return</span> b;
};

pie.object.expand = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> </span>{
  <span class="hljs-keyword">var</span> out = {};
  pie.object.forEach(o, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k, v)</span></span>{
    pie.object.setPath(out, k, v);
  });
  <span class="hljs-keyword">return</span> out;
};

pie.object.flatten = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, prefix, object)</span> </span>{
  <span class="hljs-keyword">var</span> b = object || {};
  prefix = prefix || <span class="hljs-string">''</span>;

  pie.object.forEach(a, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
    <span class="hljs-keyword">if</span>(pie.object.isPlainObject(v) &amp;&amp; !pie.object.isEmpty(v)) {
      pie.object.flatten(v, prefix + k + <span class="hljs-string">'.'</span>, b);
    } <span class="hljs-keyword">else</span> {
      b[prefix + k] = v;
    }
  });

  <span class="hljs-keyword">return</span> b;
};

pie.object.prefix = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, prefix)</span> </span>{
  <span class="hljs-keyword">var</span> b = {};
  pie.object.forEach(a, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
    b[prefix + k] = v;
  });
  <span class="hljs-keyword">return</span> b;
};

pie.object.isWindow = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> obj &amp;&amp; <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">"object"</span> &amp;&amp; <span class="hljs-string">"setInterval"</span> <span class="hljs-keyword">in</span> obj;
};

pie.object.isEmpty = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">if</span>(!obj) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> k;
  <span class="hljs-comment">/* jshint forin:false */</span>
  <span class="hljs-keyword">for</span>(k <span class="hljs-keyword">in</span> obj) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};


<span class="hljs-comment">/* From jQuery */</span>
pie.object.isPlainObject = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{

  <span class="hljs-keyword">if</span> ( !obj || !pie.object.isObject(obj) || obj.nodeType || pie.object.isWindow(obj) || obj.__notPlain || obj.__pieRole ) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> ( obj.constructor &amp;&amp;
    !pie.object.has(obj, <span class="hljs-string">"constructor"</span>) &amp;&amp;
    !pie.object.has(obj.constructor.prototype, <span class="hljs-string">"isPrototypeOf"</span>) ) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Own properties are enumerated firstly, so to speed up,
if last one is own, then all properties are own.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> key;
  <span class="hljs-keyword">for</span> ( key <span class="hljs-keyword">in</span> obj ) {}
  <span class="hljs-keyword">return</span> key === <span class="hljs-literal">undefined</span> || pie.object.has(obj, key);
};

[<span class="hljs-string">'Object'</span>, <span class="hljs-string">'Arguments'</span>, <span class="hljs-string">'Function'</span>, <span class="hljs-string">'String'</span>, <span class="hljs-string">'Number'</span>, <span class="hljs-string">'Date'</span>, <span class="hljs-string">'RegExp'</span>, <span class="hljs-string">'Boolean'</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
  pie.object[<span class="hljs-string">'is'</span> + name] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(obj) === <span class="hljs-string">'[object '</span> + name + <span class="hljs-string">']'</span>;
  };
});

(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">if</span>(!pie.object.isArguments(<span class="hljs-built_in">arguments</span>)) {
    pie.object.isArguments = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
      <span class="hljs-keyword">return</span> obj &amp;&amp; obj.hasOwnProperty(<span class="hljs-string">'callee'</span>);
    };
  }
})();

pie.object.isUndefined = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> obj === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
};

pie.object.isNode = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">instanceof</span> Node;
};

pie.object.isDom = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> pie.object.isNode(obj) || pie.object.isWindow(obj);
};

pie.object.isModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> obj &amp;&amp; obj.__pieRole === <span class="hljs-string">'model'</span>;
};

pie.object.isView = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> obj &amp;&amp; obj.__pieRole === <span class="hljs-string">'view'</span>;
};

pie.object.isPromise = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> obj &amp;&amp; obj.__pieRole === <span class="hljs-string">'promise'</span>;
};

pie.object.isApp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> obj &amp;&amp; obj.__pieRole === <span class="hljs-string">'app'</span>;
};

(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> regex = <span class="hljs-regexp">/^is(.+)/</span>;

  <span class="hljs-built_in">Object</span>.keys(pie.object).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    <span class="hljs-keyword">var</span> match = k.match(regex);
    <span class="hljs-keyword">if</span>(match) {
      pie.object[<span class="hljs-string">'isNot'</span> + match[<span class="hljs-number">1</span>]] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> !pie.object[<span class="hljs-string">'is'</span> + match[<span class="hljs-number">1</span>]];
      };
    }
  });

})();</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>shallow merge</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.merge = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
      targ = args.shift() || {},
      obj;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn</span><span class="hljs-params">(k)</span> </span>{
    targ[k] = obj[k];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>iterate over each passed in obj remaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (; args.length; ) {
    obj = args.shift();
    <span class="hljs-keyword">if</span>(obj) <span class="hljs-built_in">Object</span>.keys(obj).forEach(fn);
  }

  <span class="hljs-keyword">return</span> targ;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>yield each key value pair to a function
pie.object.forEach({‘foo’ : ‘bar’}, function(k,v){ console.log(k, v); });</p>
<p>=&gt; foo, bar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.forEach = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o, f)</span> </span>{
  <span class="hljs-keyword">if</span>(!o) <span class="hljs-keyword">return</span>;

  <span class="hljs-built_in">Object</span>.keys(o).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    f(k, o[k]);
  });
};


pie.object.getPath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, path)</span> </span>{
  <span class="hljs-keyword">if</span>(!path) <span class="hljs-keyword">return</span> obj;
  <span class="hljs-keyword">if</span>(!~path.indexOf(<span class="hljs-string">'.'</span>)) <span class="hljs-keyword">return</span> obj[path];

  <span class="hljs-keyword">var</span> p = path.split(<span class="hljs-string">'.'</span>), key;
  <span class="hljs-keyword">while</span>(p.length) {
    <span class="hljs-keyword">if</span>(!obj) <span class="hljs-keyword">return</span> obj;
    key = p.shift();
    <span class="hljs-keyword">if</span> (!p.length) <span class="hljs-keyword">return</span> obj[key];
    <span class="hljs-keyword">else</span> obj = obj[key];
  }
  <span class="hljs-keyword">return</span> obj;
};


pie.object.getValue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o, attribute)</span> </span>{
  <span class="hljs-keyword">if</span>(pie.object.isFunction(attribute))          <span class="hljs-keyword">return</span> attribute.call(<span class="hljs-literal">null</span>, o);
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span>)                           <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isFunction(o[attribute]))  <span class="hljs-keyword">return</span> o[attribute].call(o);
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.has(o, attribute, <span class="hljs-literal">true</span>))   <span class="hljs-keyword">return</span> o[attribute];
  <span class="hljs-keyword">else</span>                                          <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
};

pie.object.has = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, key, includeInherited)</span> </span>{
  <span class="hljs-keyword">return</span> obj &amp;&amp; (obj.hasOwnProperty(key) || (includeInherited &amp;&amp; (key <span class="hljs-keyword">in</span> obj)));
};

pie.object.hasAny = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* obj, *keys */</span>)</span> </span>{
  <span class="hljs-keyword">var</span> obj = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>], checks;
  <span class="hljs-keyword">if</span>(!obj) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> !pie.object.isEmpty(obj);

  checks = pie.array.flatten(pie.array.get(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>));
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;checks.length;i++) {
    <span class="hljs-keyword">if</span>(pie.object.has(obj, checks[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>does the object have the described path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.hasPath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, path)</span> </span>{
  <span class="hljs-keyword">if</span>(!~path.indexOf(<span class="hljs-string">'.'</span>)) <span class="hljs-keyword">return</span> pie.object.has(obj, path);

  <span class="hljs-keyword">var</span> parts = path.split(<span class="hljs-string">'.'</span>), part;
  <span class="hljs-keyword">while</span>(part = parts.shift()) {

    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">if</span>(pie.object.has(obj, part)) {
      obj = obj[part];
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};

pie.object.instanceOf = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(instance, nameOfClass)</span> </span>{
  <span class="hljs-keyword">var</span> klass = pie.object.getPath(<span class="hljs-built_in">window</span>, nameOfClass);
  <span class="hljs-keyword">return</span> klass &amp;&amp; instance <span class="hljs-keyword">instanceof</span> klass;
};

pie.object.reopen = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

  <span class="hljs-keyword">var</span> fnTest = <span class="hljs-regexp">/xyz/</span>.test(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-string">"xyz"</span>; });
  fnTest = fnTest ? <span class="hljs-regexp">/\b_super\b/</span> : <span class="hljs-regexp">/.*/</span>;

  <span class="hljs-keyword">var</span> wrap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newF, oldF)</span> </span>{
    <span class="hljs-comment">/* jslint eqnull:true */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>if we’re not defining anything new, return the old definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(newF == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> oldF;</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>if there is no old definition</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(oldF == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> newF;</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>if we’re not overriding with a function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!pie.object.isFunction(newF)) <span class="hljs-keyword">return</span> newF;</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>if we’re not overriding a function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!pie.object.isFunction(oldF)) <span class="hljs-keyword">return</span> newF;</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>if it doesn’t call _super, don’t bother wrapping.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!fnTest.test(newF)) <span class="hljs-keyword">return</span> newF;

    <span class="hljs-keyword">if</span>(oldF === newF) <span class="hljs-keyword">return</span> newF;

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">superWrapper</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> ret, sup = <span class="hljs-keyword">this</span>._super;
      <span class="hljs-keyword">this</span>._super = oldF;
      ret = newF.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
      <span class="hljs-keyword">if</span>(!sup) <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._super;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>._super = sup;
      <span class="hljs-keyword">return</span> ret;
    };
  };

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* target, *extensions */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> extensions = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>, <span class="hljs-string">'unique'</span>),
    target = extensions.shift(),
    extender = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,fn)</span> </span>{
      target[k] = wrap(fn, target[k]);
    }.bind(<span class="hljs-keyword">this</span>);

    extensions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      pie.object.forEach(e, extender);
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> target;
  };
})();

pie.object.reverseMerge = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* args */</span>)</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>);
  args.reverse();
  <span class="hljs-keyword">return</span> pie.object.merge.apply(<span class="hljs-literal">null</span>, args);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>serialize object into query string
{foo: ‘bar’} =&gt; foo=bar
{foo: {inner: ‘bar’}} =&gt; foo[inner]=bar
{foo: [3]} =&gt; foo[]=3
{foo: [{inner: ‘bar’}]} =&gt; foo[][inner]=bar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.serialize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, removeEmpty)</span> </span>{
  <span class="hljs-keyword">var</span> s = [], append, appendEmpty, build, rbracket = <span class="hljs-regexp">/\[\]$/</span>;

  append = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span></span>{
    v = pie.fn.valueFrom(v);
    <span class="hljs-keyword">if</span>(removeEmpty &amp;&amp; !rbracket.test(k) &amp;&amp; (v == <span class="hljs-literal">null</span> || !v.toString().length)) <span class="hljs-keyword">return</span>;
    s.push(<span class="hljs-built_in">encodeURIComponent</span>(k) + <span class="hljs-string">'='</span> + <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">String</span>(v)));
  };

  appendEmpty = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    s.push(<span class="hljs-built_in">encodeURIComponent</span>(k) + <span class="hljs-string">'='</span>);
  };

  build = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(prefix, o, append)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(o)) {
      o.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span> </span>{
        build(prefix + <span class="hljs-string">'[]'</span>, v, append);
      });
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isPlainObject(o)) {
      <span class="hljs-built_in">Object</span>.keys(o).sort().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
        build(prefix + <span class="hljs-string">'['</span> + k + <span class="hljs-string">']'</span>, o[k], append);
      });
    } <span class="hljs-keyword">else</span> {
      append(prefix, o);
    }
  };

  <span class="hljs-built_in">Object</span>.keys(obj).sort().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    build(k, obj[k], append);
  });

  <span class="hljs-keyword">return</span> s.join(<span class="hljs-string">'&amp;'</span>);
};


pie.object.setPath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, path, value)</span> </span>{
  <span class="hljs-keyword">if</span>(!~path.indexOf(<span class="hljs-string">'.'</span>)) <span class="hljs-keyword">return</span> obj[path] = value;

  <span class="hljs-keyword">var</span> p = path.split(<span class="hljs-string">'.'</span>), key;
  <span class="hljs-keyword">while</span>(p.length) {
    key = p.shift();
    <span class="hljs-keyword">if</span> (!p.length) <span class="hljs-keyword">return</span> obj[key] = value;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj[key]) obj = obj[key];
    <span class="hljs-keyword">else</span> obj = obj[key] = {};
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>grab a sub-object from the provided object.
pie.object.slice({foo: ‘bar’, biz: ‘baz’}, ‘biz’) =&gt; {‘biz’: ‘baz’}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.slice = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> keys = pie.array.from(<span class="hljs-built_in">arguments</span>),
  a = keys.shift(),
  b = {};

  keys = pie.array.flatten(keys);
  keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
    <span class="hljs-keyword">if</span>(pie.object.has(a, k)) b[k] = a[k];
  });

  <span class="hljs-keyword">return</span> b;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>return all the values of the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.values = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(a).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{ <span class="hljs-keyword">return</span> a[k]; });
};
pie.string.PROTOCOL_TEST = <span class="hljs-regexp">/\w+:\/\//</span>;

pie.string.capitalize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.charAt(<span class="hljs-number">0</span>).toUpperCase() + str.slice(<span class="hljs-number">1</span>);
};


pie.string.change = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
  str = args.shift();
  args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
    str = pie.string[m](str);
  });

  <span class="hljs-keyword">return</span> str;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>deserialize query string into object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.deserialize = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseQueryValue</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'null'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'true'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'false'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/^-?\d*(\.\d+)?$/</span>.test(value)) {
      <span class="hljs-keyword">var</span> f = <span class="hljs-built_in">parseFloat</span>(value, <span class="hljs-number">10</span>),
          i = <span class="hljs-built_in">parseInt</span>(f, <span class="hljs-number">10</span>);
      <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isNaN</span>(f) &amp;&amp; f % <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> f;
      <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isNaN</span>(i)) <span class="hljs-keyword">return</span> i;
    }
    <span class="hljs-keyword">return</span> value;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>foo[][0][thing]=bar
=&gt; [{‘0’ : {thing: ‘bar’}}]
foo[]=thing&amp;foo[]=bar
=&gt; {foo: [thing, bar]}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">applyValue</span><span class="hljs-params">(key, value, params)</span> </span>{
    <span class="hljs-keyword">var</span> pieces = key.split(<span class="hljs-string">'['</span>),
    segmentRegex = <span class="hljs-regexp">/^\[(.+)?\]$/</span>,
    match, piece, target;

    key = pieces.shift();
    pieces = pieces.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">'['</span> + p; });

    target = params;

    <span class="hljs-keyword">while</span>(piece = pieces.shift()) {
      match = piece.match(segmentRegex);</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>obj</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(match[<span class="hljs-number">1</span>]) {
        target[key] = target[key] || {};
        target = target[key];
        key = match[<span class="hljs-number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {
        target[key] = target[key] || [];
        target = target[key];
        key = target.length;
      }
    }

    target[key] = value;

    <span class="hljs-keyword">return</span> params;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, parse)</span> </span>{
    <span class="hljs-keyword">var</span> params = {}, idx, pieces, segments, key, value;

    <span class="hljs-keyword">if</span>(!str) <span class="hljs-keyword">return</span> params;

    idx = str.indexOf(<span class="hljs-string">'?'</span>);
    <span class="hljs-keyword">if</span>(~idx) str = str.slice(idx+<span class="hljs-number">1</span>);

    pieces = str.split(<span class="hljs-string">'&amp;'</span>);
    pieces.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(piece)</span></span>{
      segments = piece.split(<span class="hljs-string">'='</span>);
      key = <span class="hljs-built_in">decodeURIComponent</span>(segments[<span class="hljs-number">0</span>] || <span class="hljs-string">''</span>);
      value = <span class="hljs-built_in">decodeURIComponent</span>((segments[<span class="hljs-number">1</span>] || <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/\+/g</span>, <span class="hljs-string">'%20'</span>));

      <span class="hljs-keyword">if</span>(parse) value = parseQueryValue(value);

      applyValue(key, value, params);
    });

    <span class="hljs-keyword">return</span> params;
  };
})();

pie.string.downcase = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.toLowerCase();
};


pie.string.escapeRegex = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/[-\/\\^$*+?.()|[\]{}]/g</span>, <span class="hljs-string">'\\$&amp;'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Escapes a string for HTML interpolation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.escapeHtml = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> encMap = {
    <span class="hljs-string">"&lt;"</span>   : <span class="hljs-string">"&amp;lt;"</span>,
    <span class="hljs-string">"&gt;"</span>   : <span class="hljs-string">"&amp;gt;"</span>,
    <span class="hljs-string">"&amp;"</span>   : <span class="hljs-string">"&amp;amp;"</span>,
    <span class="hljs-string">"\""</span>  : <span class="hljs-string">"&amp;quot;"</span>,
    <span class="hljs-string">"'"</span>   : <span class="hljs-string">"&amp;#39;"</span>
  };
  <span class="hljs-keyword">var</span> encReg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">"["</span> + pie.string.escapeRegex(<span class="hljs-built_in">Object</span>.keys(encMap).join(<span class="hljs-string">''</span>)) + <span class="hljs-string">"]"</span>, <span class="hljs-string">'g'</span>);
  <span class="hljs-keyword">var</span> replacer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span>{
    <span class="hljs-keyword">return</span> encMap[c] || <span class="hljs-string">""</span>;
  };

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
    <span class="hljs-comment">/* jslint eqnull: true */</span>
    <span class="hljs-keyword">if</span>(str == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> str;
    <span class="hljs-keyword">return</span> (<span class="hljs-string">""</span> + str).replace(encReg, replacer);
  };
})();

pie.string.endsWith = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, suffix)</span> </span>{
  <span class="hljs-keyword">return</span> str.indexOf(suffix, str.length - suffix.length) !== -<span class="hljs-number">1</span>;
};

pie.string.startsWith = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, prefix)</span> </span>{
  <span class="hljs-keyword">return</span> str.indexOf(prefix) === <span class="hljs-number">0</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>designed to be used with the “%{expression}” placeholders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.expand = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, data, raiseOnMiss)</span> </span>{
  data = data || {};
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/\%\{(.+?)\}/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, key)</span> </span>{
    <span class="hljs-keyword">if</span>(raiseOnMiss &amp;&amp; !pie.object.has(data, key)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Missing interpolation argument `"</span> + key + <span class="hljs-string">"` for '"</span> + str + <span class="hljs-string">"'"</span>);
    <span class="hljs-keyword">return</span> data[key];
  });
};


pie.string.humanize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/_id$/</span>, <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/([a-z][A-Z]|[a-z]_[a-z])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a)</span></span>{ <span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>] + <span class="hljs-string">' '</span> + a[a.length-<span class="hljs-number">1</span>]; });
};


pie.string.lowerize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.charAt(<span class="hljs-number">0</span>).toLowerCase() + str.slice(<span class="hljs-number">1</span>);
};

pie.string.matches = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, regex)</span> </span>{
  <span class="hljs-keyword">var</span> flags = <span class="hljs-string">"g"</span>;
  <span class="hljs-keyword">if</span>(regex.ignoreCase) flags += <span class="hljs-string">"i"</span>;
  <span class="hljs-keyword">if</span>(regex.multiline) flags += <span class="hljs-string">"m"</span>;

  regex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(regex.source, flags);

  <span class="hljs-keyword">var</span> matches = [], match = regex.exec(str);
  <span class="hljs-keyword">while</span> (match != <span class="hljs-literal">null</span>) {
    matches.push(match[<span class="hljs-number">1</span>]);
    match = regex.exec(str);
  }
  <span class="hljs-keyword">return</span> matches;
};

pie.string.modularize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/([^_])_([^_])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a, b)</span></span>{ <span class="hljs-keyword">return</span> a + b.toUpperCase(); });
};

pie.string.normalizeUrl =  <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>ensure there’s a leading slash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!pie.string.PROTOCOL_TEST.test(path) &amp;&amp; path.charAt(<span class="hljs-number">0</span>) !== <span class="hljs-string">'/'</span>) {
    path = <span class="hljs-string">'/'</span> + path;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>normalize the path portion of a url if a query is present</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(path.indexOf(<span class="hljs-string">'?'</span>) &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">var</span> split = path.split(<span class="hljs-string">'?'</span>);
    path = pie.string.normalizeUrl(split.shift());
    split.unshift(path);
    path = split.join(<span class="hljs-string">'?'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>remove any double slashes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  path = path.replace(<span class="hljs-regexp">/(^|[^:])\/\//g</span>, <span class="hljs-string">"$1/"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>remove trailing hashtags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(path.charAt(path.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'#'</span>) {
    path = path.substr(<span class="hljs-number">0</span>, path.length - <span class="hljs-number">1</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>remove trailing question marks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(path.charAt(path.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'?'</span>) {
    path = path.substr(<span class="hljs-number">0</span>, path.length - <span class="hljs-number">1</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>remove trailing slashes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(path.length &gt; <span class="hljs-number">1</span> &amp;&amp; path.charAt(path.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'/'</span>) {
    path = path.substr(<span class="hljs-number">0</span>, path.length - <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> path;
};

pie.string.pluralize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, count)</span> </span>{
  <span class="hljs-keyword">if</span>(count === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> str;
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/ss$/i</span>.test(str)) <span class="hljs-keyword">return</span> str + <span class="hljs-string">'es'</span>;
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/s$/i</span>.test(str)) <span class="hljs-keyword">return</span> str;
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/[a-z]$/i</span>.test(str)) <span class="hljs-keyword">return</span> str + <span class="hljs-string">'s'</span>;
  <span class="hljs-keyword">return</span> str;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>todo: i18n</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.possessive = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/s$/i</span>.test(str)) <span class="hljs-keyword">return</span> str + <span class="hljs-string">"'"</span>;
  <span class="hljs-keyword">return</span> str + <span class="hljs-string">"'s"</span>;
};


pie.string.setTemplateSettings = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(begin, end, escape, interp, evalr, splitter)</span> </span>{
  splitter = splitter || <span class="hljs-string">'~~pie-interp~~'</span>;
  <span class="hljs-built_in">escape</span> = <span class="hljs-built_in">escape</span> || <span class="hljs-string">'-'</span>;
  interp = interp || <span class="hljs-string">'='</span>;
  evalr = evalr || <span class="hljs-string">''</span>;

  <span class="hljs-keyword">var</span> escapedBegin = pie.string.escapeRegex(begin),
  escapedEnd = pie.string.escapeRegex(end),
  escapedEndFirstChar = pie.string.escapeRegex(end[<span class="hljs-number">0</span>]),
  escapedInterp = pie.string.escapeRegex(interp),
  escapedEscape = pie.string.escapeRegex(<span class="hljs-built_in">escape</span>),
  escapedEvalr  = pie.string.escapeRegex(evalr),
  escapedSplitter = pie.string.escapeRegex(splitter);

  pie.string._templateSettings = {
    begin: begin,
    end: end,
    interp: interp,
    <span class="hljs-built_in">escape</span>: <span class="hljs-built_in">escape</span>,
    <span class="hljs-built_in">eval</span>: evalr,
    splitter: splitter,
    interpRegex:      <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(escapedBegin + <span class="hljs-string">'(['</span> + pie.array.compact([escapedInterp, escapedEscape, escapedEvalr], <span class="hljs-literal">true</span>).join(<span class="hljs-string">''</span>) + <span class="hljs-string">']?)(.+?)'</span> + escapedEnd, <span class="hljs-string">'g'</span>),
    interpLookahead:  <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">"'(?=[^"</span> + escapedEndFirstChar + <span class="hljs-string">"]*"</span> + escapedEnd + <span class="hljs-string">")"</span>, <span class="hljs-string">'g'</span>),
    splitterRegex:    <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(escapedSplitter, <span class="hljs-string">'g'</span>),
  };
};

pie.string.setTemplateSettings(<span class="hljs-string">'[%'</span>, <span class="hljs-string">'%]'</span>, <span class="hljs-string">'-'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">''</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p><strong>pie.string.template</strong></p>
<p>Resig style microtemplating. Preserves whitespace, and only uses string manipulation.
There is no array construction. Allows an optional variables string <code>varString</code> which enables
custom variable definition inside of the templating function.</p>
<pre><code><span class="hljs-keyword">var</span> template = pie.string.template(<span class="hljs-string">"Hi, [%= data.first_name %]. You have [%= data.count %] [%= pie.string.pluralize('messages', data.count) %]"</span>);
template({first_name: <span class="hljs-string">'John'</span>, count: <span class="hljs-number">4</span>});
<span class="hljs-comment">//=&gt; "Hi, John. You have 4 messages."</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.template = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, varString)</span> </span>{
  <span class="hljs-keyword">var</span> conf = pie.string._templateSettings,
  strFunc = <span class="hljs-string">"var __p='', __s = function(v, e){ return v == null ? '' : (e ? pie.string.escapeHtml(v) : v); };\n"</span> ;
  <span class="hljs-keyword">if</span>(varString) strFunc += varString + <span class="hljs-string">";\n"</span>;
  strFunc += <span class="hljs-string">"__p += '"</span>;

  <span class="hljs-comment">/**** preserve format by allowing multiline strings. ****/</span>
  strFunc += str.replace(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">"\\n\\\n"</span>)
  <span class="hljs-comment">/**** EX: "... __p += '[% data.foo = 1 %]text's content[%- data.foo %]more text[%= data['foo'] + 1 %]" ****/</span>

  <span class="hljs-comment">/**** replace all interpolation single quotes with a unique identifier. ****/</span>
  .replace(conf.interpLookahead, conf.splitter)
  <span class="hljs-comment">/**** EX: "... __p += '[% data.foo = 1 %]text's content[%- data.foo %]more text[%= data[~~pie-interp~~foo~~pie-interp~~] + 1 %]" ****/</span>

  <span class="hljs-comment">/**** now replace all quotes with an escaped quote. ****/</span>
  .replace(<span class="hljs-regexp">/'/g</span>, <span class="hljs-string">"\\'"</span>)
  <span class="hljs-comment">/**** EX: "... __p += '[% data.foo = 1 %]text\'s content[%- data.foo %]more text[%= data[~~pie-interp~~foo~~pie-interp~~] + 1 %]" ****/</span>

  <span class="hljs-comment">/**** and reapply the single quotes in the interpolated content. ****/</span>
  .replace(conf.splitterRegex, <span class="hljs-string">"'"</span>)
  <span class="hljs-comment">/**** EX: "... __p += '[% data.foo = 1 %]text\'s content[%- data.foo %]more text[%= data['foo'] + 1 %]" ****/</span>

  <span class="hljs-comment">/**** escape, interpolate, and evaluate ****/</span>
  .replace(conf.interpRegex, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, action, content)</span> </span>{
    action = action || <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span>(action === conf.escape) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"' + __s("</span> + content + <span class="hljs-string">", true) + '"</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action === conf.interp) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"' + __s("</span> + content + <span class="hljs-string">", false) + '"</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action === conf.eval) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"'; "</span> + content + <span class="hljs-string">"; __p+='"</span>;
    }
  });
  <span class="hljs-comment">/**** EX: "... __p += ''; data.foo = 1; __p+='text\'s content' + __s(data.foo, true) + 'more text' + __s(data['foo'] + 1) + '" ****/</span>

  <span class="hljs-comment">/**** terminate the string ****/</span>
  strFunc += <span class="hljs-string">"';"</span>;
  <span class="hljs-comment">/**** EX: "... __p +=''; data.foo = 1; __p+='text\'s content' + __s(data.foo, true) + 'more text' + __s(data['foo'] + 1) + '';" ****/</span>

  <span class="hljs-comment">/**** final result. ****/</span>
  strFunc += <span class="hljs-string">"return __p;"</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">"data"</span>, strFunc);
};

pie.string.titleize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/(^| )([a-z])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a, b)</span></span>{ <span class="hljs-keyword">return</span> a + b.toUpperCase(); });
};

pie.string.pathSteps = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">var</span> split = path.split(<span class="hljs-string">'.'</span>),
  steps = [];

  <span class="hljs-keyword">while</span>(split.length) {
    steps.push(split.join(<span class="hljs-string">'.'</span>));
    split.pop();
  }

  <span class="hljs-keyword">return</span> steps;
};

pie.string.underscore = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/([a-z])([A-Z])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a, b)</span></span>{ <span class="hljs-keyword">return</span> a + <span class="hljs-string">'_'</span> + b.toLowerCase(); }).toLowerCase();
};

pie.string.upcase = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.toUpperCase();
};


pie.string.urlConcat = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.compact(pie.array.from(<span class="hljs-built_in">arguments</span>), <span class="hljs-literal">true</span>),
  base = args.shift(),
  query = args.join(<span class="hljs-string">'&amp;'</span>);

  <span class="hljs-keyword">if</span>(!query.length) <span class="hljs-keyword">return</span> base;</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>we always throw a question mark on the end of base</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(base.indexOf(<span class="hljs-string">'?'</span>) &lt; <span class="hljs-number">0</span>) base += <span class="hljs-string">'?'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>we replace all question marks in the query with &amp;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(query.indexOf(<span class="hljs-string">'?'</span>) === <span class="hljs-number">0</span>) query = query.replace(<span class="hljs-string">'?'</span>, <span class="hljs-string">'&amp;'</span>);
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(query.indexOf(<span class="hljs-string">'&amp;'</span>) !== <span class="hljs-number">0</span>) query = <span class="hljs-string">'&amp;'</span> + query;

  base += query;
  base = base.replace(<span class="hljs-string">'?&amp;'</span>, <span class="hljs-string">'?'</span>).replace(<span class="hljs-string">'&amp;&amp;'</span>, <span class="hljs-string">'&amp;'</span>).replace(<span class="hljs-string">'??'</span>, <span class="hljs-string">'?'</span>);
  <span class="hljs-keyword">if</span>(base.indexOf(<span class="hljs-string">'?'</span>) === base.length - <span class="hljs-number">1</span>) base = base.substr(<span class="hljs-number">0</span>, base.length - <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> base;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <h1 id="bindings-mixin">Bindings Mixin</h1>
<p>A mixin to provide two way data binding between a model and dom elements.
This mixin should be used with a pie view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.mixins.bindings = {</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>The registration &amp; configuration of bindings is kept in this._bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._bindings = [];
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._super) <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">this</span>.options.bindingAttribute = <span class="hljs-keyword">this</span>.options.bindingAttribute || <span class="hljs-string">'data-bind'</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>If we have an emitter, tap into the render:after event and initialize the dom
with our model values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.eon(<span class="hljs-string">'render:after'</span>, <span class="hljs-string">'initBindings'</span>);

    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Register 1+ bindings within the view.</p>
<p><code>this.bind({ attr: &#39;first_name&#39; }, { attr: &#39;last_name&#39; })</code>;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bind: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> opts;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++) {
      opts = <span class="hljs-built_in">arguments</span>[i];
      <span class="hljs-keyword">if</span>(!opts.model) opts.model = <span class="hljs-keyword">this</span>.model;
      <span class="hljs-keyword">if</span>(pie.object.isString(opts.model)) opts.model = <span class="hljs-keyword">this</span>[opts.model];
      <span class="hljs-keyword">if</span>(pie.object.isString(opts.decorator)) opts.decorator = <span class="hljs-keyword">this</span>[opts.decorator] || <span class="hljs-keyword">this</span>.app.helpers.fetch(opts.decorator);
      <span class="hljs-keyword">this</span>._bindings.push(pie.binding.create(<span class="hljs-keyword">this</span>, opts.model, opts));
    }
  },

  setupDomBindings: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.options.bindingAttribute) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>.removeUnattachedBindings();

    <span class="hljs-keyword">var</span> nodes = <span class="hljs-keyword">this</span>.qsa(<span class="hljs-string">'['</span> + <span class="hljs-keyword">this</span>.options.bindingAttribute + <span class="hljs-string">']'</span>), stringOpts, node, opts;

    <span class="hljs-keyword">var</span> binder = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
      <span class="hljs-keyword">if</span>(str.indexOf(<span class="hljs-string">'='</span>) === -<span class="hljs-number">1</span>) opts = {attr: str};
      <span class="hljs-keyword">else</span> opts = <span class="hljs-keyword">this</span>.parseStringBinding(str);
      opts.sel = node;
      <span class="hljs-keyword">this</span>.bind(opts);
    }.bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; nodes.length; i++) {
      node = nodes[i];
      stringOpts = node.getAttribute(<span class="hljs-keyword">this</span>.options.bindingAttribute);
      stringOpts.split(<span class="hljs-string">';'</span>).forEach(binder);
    }
  },

  removeUnattachedBindings: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> compactNeeded = <span class="hljs-literal">false</span>, b;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>._bindings.length; i++) {
      b = <span class="hljs-keyword">this</span>._bindings[i];
      <span class="hljs-keyword">if</span>(pie.object.isNode(b.sel) &amp;&amp; !<span class="hljs-built_in">document</span>.contains(b.sel)) {
        <span class="hljs-keyword">this</span>._bindings[i] = <span class="hljs-literal">undefined</span>;
        b.teardown();
        compactNeeded = <span class="hljs-literal">true</span>;
      }
    }

    <span class="hljs-keyword">if</span>(compactNeeded) <span class="hljs-keyword">this</span>._bindings = pie.array.compact(<span class="hljs-keyword">this</span>._bindings);
  },

  parseStringBinding: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(inputString)</span> </span>{
    <span class="hljs-keyword">var</span> opts = pie.object.expand(pie.string.deserialize(inputString));
    <span class="hljs-keyword">return</span> opts;
  },

  initBindings: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>look for dom-defined bindings and add them to our _bindings list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.setupDomBindings();</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>Iterate each binding and propagate the model value to the dom.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pie.array.each(<span class="hljs-keyword">this</span>._bindings, <span class="hljs-string">'toView'</span>, <span class="hljs-literal">true</span>);
  },


  <span class="hljs-comment">/* Iterate each binding and propagate the dom value to the model. */</span>
  <span class="hljs-comment">/* A single set of change records will be produced (`__version` will only increment by 1). */</span>
  readBoundFields: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> opts = {skipObservers: <span class="hljs-literal">true</span>}, models;
    <span class="hljs-keyword">this</span>._bindings.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(binding)</span> </span>{ binding.readFields(opts); });
    models = pie.array.unique(pie.array.map(<span class="hljs-keyword">this</span>._bindings, <span class="hljs-string">'model'</span>));
    pie.array.each(models, <span class="hljs-string">'deliverChangeRecords'</span>, <span class="hljs-literal">true</span>);
  }
};
pie.mixins.changeSet = {

  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.query({name: name});
  },

  has: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">var</span> glob = pie.string.endsWith(name, <span class="hljs-string">'.*'</span>) ? name.replace(<span class="hljs-string">'.*'</span>, <span class="hljs-string">''</span>) : <span class="hljs-literal">undefined</span>;
    
    <span class="hljs-keyword">return</span> pie.array.areAny(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(change)</span> </span>{
      <span class="hljs-keyword">return</span> glob ? pie.string.startsWith(change.name, glob + <span class="hljs-string">'.'</span>) : change.name === name;
    });
  },

  hasAny: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++) {
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-built_in">arguments</span>[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },

  hasAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++) {
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.has(<span class="hljs-built_in">arguments</span>[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  query: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._query(<span class="hljs-string">'detectLast'</span>, options);
  },

  queryAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._query(<span class="hljs-string">'filter'</span>, options);
  },

  _query: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arrayFn, options)</span> </span>{
    <span class="hljs-keyword">var</span> names = pie.array.from(options.names || options.name),
    types = pie.array.from(options.types || options.type);

    <span class="hljs-keyword">return</span> pie.array[arrayFn](<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(change)</span> </span>{
      <span class="hljs-keyword">return</span> (!names.length || ~names.indexOf(change.name)) &amp;&amp;
             (!types.length || ~types.indexOf(change.type));
    });
  }

};
pie.mixins.container = {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.children = [];
    <span class="hljs-keyword">this</span>.childNames = {};
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._super) <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  addChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, child, idx)</span> </span>{
    <span class="hljs-keyword">var</span> append = idx == <span class="hljs-literal">null</span>;
    idx = append ? <span class="hljs-keyword">this</span>.children.length : idx;
    <span class="hljs-keyword">this</span>.children.splice(idx, <span class="hljs-number">0</span>, child);

    <span class="hljs-keyword">this</span>.childNames[name] = idx;
    child._indexWithinParent = idx;
    child._nameWithinParent = name;
    child.parent = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span>(!append) <span class="hljs-keyword">this</span>.sortChildren();

    <span class="hljs-keyword">if</span>(pie.object.has(child, <span class="hljs-string">'addedToParent'</span>, <span class="hljs-literal">true</span>)) child.addedToParent.call(child);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  addChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    pie.object.forEach(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, child)</span> </span>{
      <span class="hljs-keyword">this</span>.addChild(name, child);
    }.bind(<span class="hljs-keyword">this</span>));
  },

  getChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, recurse)</span> </span>{
    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">if</span>(obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(obj._nameWithinParent) <span class="hljs-keyword">return</span> obj;

    <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>.childNames[obj];
    <span class="hljs-keyword">if</span>(idx == <span class="hljs-literal">null</span>) idx = obj;

    <span class="hljs-keyword">if</span>(recurse === <span class="hljs-literal">undefined</span>) recurse = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>It’s a path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(recurse &amp;&amp; <span class="hljs-built_in">String</span>(idx).match(<span class="hljs-regexp">/\./</span>)) {
      <span class="hljs-keyword">var</span> steps = idx.split(<span class="hljs-string">'.'</span>),
      child = <span class="hljs-keyword">this</span>, step;
      <span class="hljs-keyword">while</span>(step = steps.shift()) {
        child = child.getChild(step);
        <span class="hljs-keyword">if</span>(!child) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
        <span class="hljs-comment">/* dig as far as we can go, if we have non-container child we're done */</span>
        <span class="hljs-keyword">if</span>(steps.length &amp;&amp; !child.getChild) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
      }

      <span class="hljs-keyword">return</span> child;
    }

    <span class="hljs-keyword">return</span> ~idx &amp;&amp; <span class="hljs-keyword">this</span>.children[idx] || <span class="hljs-literal">undefined</span>;
  },

  bubble: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
    fname = args.shift(),
    obj = <span class="hljs-keyword">this</span>.parent;

    <span class="hljs-keyword">while</span>(obj &amp;&amp; !pie.object.has(obj, fname, <span class="hljs-literal">true</span>)) {
      obj = obj.parent;
    }

    <span class="hljs-keyword">if</span>(obj) <span class="hljs-keyword">return</span> obj[fname].apply(obj, args);
  },

  sendToChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* fnName, arg1, arg2 */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> allArgs = pie.array.from(<span class="hljs-built_in">arguments</span>),
    fnName = allArgs[<span class="hljs-number">0</span>],
    args = allArgs.slice(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">this</span>.children.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span></span>{
      <span class="hljs-keyword">if</span>(pie.object.has(child, fnName, <span class="hljs-literal">true</span>)) child[fnName].apply(child, args);
      <span class="hljs-keyword">if</span>(pie.object.has(child, <span class="hljs-string">'sendToChildren'</span>, <span class="hljs-literal">true</span>)) child.sendToChildren.apply(child, allArgs);
    }.bind(<span class="hljs-keyword">this</span>));
  },

  removeChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> child = <span class="hljs-keyword">this</span>.getChild(obj), i;

    <span class="hljs-keyword">if</span>(child) {
      i = child._indexWithinParent;
      <span class="hljs-keyword">this</span>.children.splice(i, <span class="hljs-number">1</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>clean up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.childNames[child._nameWithinParent];
      <span class="hljs-keyword">delete</span> child._indexWithinParent;
      <span class="hljs-keyword">delete</span> child._nameWithinParent;
      <span class="hljs-keyword">delete</span> child.parent;

      <span class="hljs-keyword">this</span>.sortChildren();

      <span class="hljs-keyword">if</span>(pie.object.has(child, <span class="hljs-string">'removedFromParent'</span>, <span class="hljs-literal">true</span>)) child.removedFromParent.call(child, <span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  removeChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> child;

    <span class="hljs-keyword">while</span>(child = <span class="hljs-keyword">this</span>.children[<span class="hljs-keyword">this</span>.children.length-<span class="hljs-number">1</span>]) {
      <span class="hljs-keyword">this</span>.removeChild(child);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  sortChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span> </span>{
    <span class="hljs-keyword">if</span>(fn) <span class="hljs-keyword">this</span>.children.sort(fn);
    <span class="hljs-keyword">this</span>.children.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c, i)</span> </span>{
      c._indexWithinParent = i;
      <span class="hljs-keyword">this</span>.childNames[c._nameWithinParent] = i;
    }.bind(<span class="hljs-keyword">this</span>));
  },

  __tree: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(indent)</span> </span>{
    indent = indent || <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> pad = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(s, i)</span></span>{
      <span class="hljs-keyword">if</span>(!i) <span class="hljs-keyword">return</span> s;
      <span class="hljs-keyword">while</span>(i-- &gt; <span class="hljs-number">0</span>) s = <span class="hljs-string">" "</span> + s;
      <span class="hljs-keyword">return</span> s;
    };
    <span class="hljs-keyword">var</span> str = <span class="hljs-string">"\n"</span>, nextIndent = indent + (indent ? <span class="hljs-number">4</span> : <span class="hljs-number">1</span>);
    str += pad((indent ? <span class="hljs-string">'|- '</span> : <span class="hljs-string">''</span>) + (<span class="hljs-keyword">this</span>._nameWithinParent || <span class="hljs-keyword">this</span>._indexWithinParent || <span class="hljs-keyword">this</span>.__className) + <span class="hljs-string">' ('</span> + (<span class="hljs-keyword">this</span>.__className || pie.uid(<span class="hljs-keyword">this</span>)) + <span class="hljs-string">')'</span>, indent);

    <span class="hljs-keyword">this</span>.children.slice(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
      str += <span class="hljs-string">"\n"</span> + pad(<span class="hljs-string">'|'</span>, nextIndent);
      str += child.__tree(nextIndent);
    });

    <span class="hljs-keyword">if</span>(!indent) str += <span class="hljs-string">"\n"</span>;

    <span class="hljs-keyword">return</span> str;
  }
};
pie.mixins.validatable = {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.validations = [];
    <span class="hljs-keyword">this</span>.validationStrategy = <span class="hljs-string">'dirty'</span>;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._super) <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'isValid'</span>, <span class="hljs-string">'validationErrors'</span>);
  },

  isValid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> pie.object.isEmpty(<span class="hljs-keyword">this</span>.data.validationErrors);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>default to a model implementation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reportValidationError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, errors)</span> </span>{
    errors = errors &amp;&amp; errors.length ? errors : <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'validationErrors.'</span> + key, errors);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>validates({name: ‘presence’});
validates({name: {presence: true}});
validates({name: [‘presence’, {format: /[a]/}]})</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validates: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, validationStrategy)</span> </span>{
    <span class="hljs-keyword">var</span> configs, resultConfigs;

    <span class="hljs-keyword">this</span>.validations = <span class="hljs-keyword">this</span>.validations || {};

    <span class="hljs-built_in">Object</span>.keys(obj).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>always convert to an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      configs = pie.array.from(obj[k]);
      resultConfigs = [];

      configs.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(conf)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>if it’s a string or a function, throw it in directly, with no options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(pie.object.isString(conf)) {
          resultConfigs.push({type: conf, options: {}});</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>if it’s a function, make it a type function, then provide the function as an option</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isFunction(conf)){
          resultConfigs.push({type: <span class="hljs-string">'fn'</span>, options: {fn: conf}});</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>otherwise, we have an object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(conf) {</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>iterate the keys, adding a validation for each</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-built_in">Object</span>.keys(conf).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(confKey)</span></span>{
            <span class="hljs-keyword">if</span> (pie.object.isObject(conf[confKey])) {
              resultConfigs.push({type: confKey, options: conf[confKey]});</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>in this case, we convert the value to an option
{presence: true} -&gt; {type: ‘presence’, {presence: true}}
{format: /.+/} -&gt; {type: ‘format’, {format: /.+/}}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(conf[confKey]) {
              resultConfigs.push({
                type: confKey,
                options: pie.object.merge({}, conf)
              });
            }
          });
        }

      });


      <span class="hljs-keyword">if</span>(resultConfigs.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>append the validations to the existing ones</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.validations[k] = <span class="hljs-keyword">this</span>.validations[k] || [];
        <span class="hljs-keyword">this</span>.validations[k] = <span class="hljs-keyword">this</span>.validations[k].concat(resultConfigs);

        <span class="hljs-keyword">this</span>.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span></span>{
          <span class="hljs-keyword">var</span> change = changes.get(k);
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.validationChangeObserver(change);
        }.bind(<span class="hljs-keyword">this</span>), k);
      }

    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">if</span>(validationStrategy !== <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">this</span>.validationStrategy = validationStrategy;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>Invoke validateAll and receive a promise in return.
this.validateAll().then(function(){ alert(‘Success!’); }, function(){ alert(‘Errors!’); });
validateAll will perform all registered validations, asynchronously. When all validations have completed, the promise
will be resolved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validateAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> promises = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.validations).map(<span class="hljs-keyword">this</span>.validate.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">return</span> pie.promise.all(promises);
  },


  validationChangeObserver: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(change)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.validationStrategy === <span class="hljs-string">'validate'</span>) {
      <span class="hljs-keyword">this</span>.validate(change.name);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.validationStrategy === <span class="hljs-string">'dirty'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>for speed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'validationErrors.'</span> + change.name + <span class="hljs-string">'.length'</span>)) {
        <span class="hljs-keyword">this</span>.reportValidationError(change.name, <span class="hljs-literal">undefined</span>);
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>validate a specific key and optionally invoke a callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    <span class="hljs-keyword">var</span> validators = <span class="hljs-keyword">this</span>.app.validator,
    validations = pie.array.from(<span class="hljs-keyword">this</span>.validations[k]),
    value = <span class="hljs-keyword">this</span>.get(k),

    promises = validations.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(validation)</span> </span>{
      <span class="hljs-keyword">return</span> pie.promise.create(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve, reject)</span> </span>{

        <span class="hljs-keyword">var</span> validator = validators[validation.type];</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>reject the promise with the error message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> wrappedReject = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
          reject(validators.errorMessage(validation.type, validation.options));
        };

        <span class="hljs-keyword">var</span> response = validator.call(validators, value, validation.options);</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>validators should return true, false, or a promise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(response === <span class="hljs-literal">true</span>) resolve();
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response === <span class="hljs-literal">false</span>) wrappedReject();
        <span class="hljs-keyword">else</span> response.then(resolve, wrappedReject);
      });
    });

    <span class="hljs-keyword">var</span> promise = pie.promise.all(promises);

    promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">this</span>.reportValidationError(k, <span class="hljs-literal">undefined</span>);
    }.bind(<span class="hljs-keyword">this</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(errorMessages)</span></span>{
      <span class="hljs-keyword">this</span>.reportValidationError(k, errorMessages);
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> promise;
  }
};
pie.base = {

  __schema: [{

    init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      pie.uid(<span class="hljs-keyword">this</span>);
    },

    __pieRole: <span class="hljs-string">'object'</span>,

    reopen: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">var</span> extensions = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>);
      pie.object.reopen(<span class="hljs-keyword">this</span>, extensions);
      extensions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ext)</span> </span>{
        <span class="hljs-keyword">if</span>(ext.init) ext.init.call(<span class="hljs-keyword">this</span>);
      }.bind(<span class="hljs-keyword">this</span>));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

  }],

  __pieRole: <span class="hljs-string">'class'</span>,

  create: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> pie.base._create(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  extend: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>,
    extensions = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>),
    name = pie.object.isString(extensions[<span class="hljs-number">0</span>]) ? extensions.shift() : <span class="hljs-literal">null</span>;

    extensions = pie.array.flatten(extensions.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
      <span class="hljs-keyword">if</span>(e.__pieRole === <span class="hljs-string">'class'</span>) <span class="hljs-keyword">return</span> e.__schema;
      <span class="hljs-keyword">return</span> e;
    }));

    <span class="hljs-keyword">var</span> schema = pie.array.unique([<span class="hljs-keyword">this</span>.__schema, extensions, {__className: name}]);

    <span class="hljs-keyword">var</span> o = {
      __className: name
    };

    o.__schema = schema;
    o.__pieRole = <span class="hljs-string">'class'</span>;

    o.extend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> that.extend.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>); };
    o.create = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> that.create.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>); };
    o.reopen = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> that.reopen.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>); };

    <span class="hljs-keyword">return</span> o;
  },

  reopen: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> extensions = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>);
    extensions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
      <span class="hljs-keyword">this</span>.__schema.push(e);
    }.bind(<span class="hljs-keyword">this</span>));
  },

  _create: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(clazz, args)</span> </span>{
    <span class="hljs-keyword">var</span> schema = clazz.__schema;

    <span class="hljs-keyword">var</span> o = {};
    pie.uid(o);

    pie.object.reopen(o, schema);

    o.init.apply(o, args);
    o.__class = clazz;

    <span class="hljs-keyword">if</span>(!o.app) {
      <span class="hljs-keyword">if</span>(o.options &amp;&amp; o.options.app) o.app = o.options.app;
      <span class="hljs-keyword">else</span> o.app = pie.appInstance;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>This enables objects to be assigned to a global variable to assist with debugging
Any pie object can define a debugName attribute or function and the value will be the name of the global
variable to which this object is assigned.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(o.debugName) {
      <span class="hljs-built_in">window</span>.pieDebug = <span class="hljs-built_in">window</span>.pieDebug || {};
      <span class="hljs-built_in">window</span>.pieDebug[pie.fn.valueFrom(o.debugName)] = o;
    }

    <span class="hljs-keyword">return</span> o;
  }
};
pie.promise = pie.base.extend({

  __pieRole: <span class="hljs-string">'promise'</span>,

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolver)</span> </span>{

    <span class="hljs-keyword">this</span>.resolves = [];
    <span class="hljs-keyword">this</span>.rejects  = [];

    <span class="hljs-keyword">this</span>.result   = <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">this</span>.state    = <span class="hljs-string">'UNFULFILLED'</span>;
    <span class="hljs-keyword">this</span>.ctxt     = <span class="hljs-literal">undefined</span>;

    <span class="hljs-keyword">if</span>(resolver) {
      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">promiseResolverWrapper</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">try</span> {
          resolver(<span class="hljs-keyword">this</span>.resolve.bind(<span class="hljs-keyword">this</span>), <span class="hljs-keyword">this</span>.reject.bind(<span class="hljs-keyword">this</span>));
        } <span class="hljs-keyword">catch</span>(ex) {
          <span class="hljs-keyword">this</span>.reject(ex);
        }
      }.bind(<span class="hljs-keyword">this</span>), <span class="hljs-number">0</span>);
    }
  },

  bind: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(binding)</span> </span>{
    <span class="hljs-keyword">this</span>.ctxt = binding;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  then: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(onResolve, onReject)</span> </span>{
    <span class="hljs-keyword">var</span> child = <span class="hljs-keyword">this</span>.__class.create();
    child.bind(<span class="hljs-keyword">this</span>.ctxt);

    <span class="hljs-keyword">this</span>.resolves.push([onResolve, child]);
    <span class="hljs-keyword">this</span>.rejects.push([onReject, child]);

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.state !== <span class="hljs-string">'UNFULFILLED'</span>) {
      setTimeout(<span class="hljs-keyword">this</span>._flush.bind(<span class="hljs-keyword">this</span>), <span class="hljs-number">0</span>);
    }

    <span class="hljs-keyword">return</span> child;
  },

  <span class="hljs-keyword">catch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(reject)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-literal">undefined</span>, reject);
  },

  reject: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">this</span>._transition(<span class="hljs-string">'FAILED'</span>, value);
  },

  resolve: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">this</span>._transition(<span class="hljs-string">'FULFILLED'</span>, value);
  },

  _transition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(state, value)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.state === <span class="hljs-string">'UNFULFILLED'</span>) {
      <span class="hljs-keyword">this</span>.state = state;
      <span class="hljs-keyword">this</span>.result = value;
      <span class="hljs-keyword">this</span>._flush();
    }
  },

  _flush: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">this</span>.state === <span class="hljs-string">'FULFILLED'</span> ? <span class="hljs-keyword">this</span>.resolves : <span class="hljs-keyword">this</span>.rejects;
    <span class="hljs-keyword">var</span> tuple, callback, promise, result;

    <span class="hljs-keyword">while</span>(list.length) {
      tuple = list.pop();
      callback = tuple[<span class="hljs-number">0</span>];
      promise = tuple[<span class="hljs-number">1</span>];
      result = <span class="hljs-keyword">this</span>.result;

      <span class="hljs-keyword">if</span>(promise.ctxt) {
        <span class="hljs-keyword">if</span>(pie.object.isString(callback)) {
          callback = promise.ctxt[callback].bind(promise.ctxt);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pie.object.isFunction(callback)) {
          callback = callback.bind(promise.ctxt);
        }
      }

      <span class="hljs-keyword">if</span>(pie.object.isFunction(callback)) {
        <span class="hljs-keyword">try</span> {
          result = callback(<span class="hljs-keyword">this</span>.result);
        } <span class="hljs-keyword">catch</span>(e) {
          promise.reject(e);
          <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span>(result === promise) {
          promise.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"The result of a promise's callback cannot be the promise. [2.3.1]"</span>));
          <span class="hljs-keyword">continue</span>;
        }

      }

      <span class="hljs-keyword">if</span>(pie.object.isPromise(result)) {
        result.then(promise.resolve.bind(promise), promise.reject.bind(promise));
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.state === <span class="hljs-string">'FULFILLED'</span>) {
        promise.resolve(result);
      } <span class="hljs-keyword">else</span> {
        promise.reject(result);
      }
    }
  }
});

pie.promise.from = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(thing)</span> </span>{
  <span class="hljs-keyword">if</span>(pie.object.isPromise(thing)) <span class="hljs-keyword">return</span> thing;
  <span class="hljs-keyword">if</span>(pie.object.isFunction(thing)) <span class="hljs-keyword">return</span> pie.promise.create(thing);
  <span class="hljs-keyword">return</span> pie.promise.resolve(thing);
};

pie.promise.all = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(iteratable)</span> </span>{
  <span class="hljs-keyword">var</span> instance = pie.promise.create(),
  promises = [],
  values = [],
  cnt = <span class="hljs-number">0</span>,
  total;

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> iteratable) {
    <span class="hljs-keyword">if</span>(iteratable.hasOwnProperty(k)) {
      promises.push(pie.promise.from(iteratable[k]));
    }
  }

  total = promises.length;

  <span class="hljs-keyword">if</span>(total) {
    promises.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allPromiseIterator</span><span class="hljs-params">(p, i)</span> </span>{
      p.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allPromiseCallback</span><span class="hljs-params">(val)</span> </span>{
        values[i] = val;
        cnt++;
        <span class="hljs-keyword">if</span>(cnt === total) instance.resolve(values);
      }, instance.reject.bind(instance));
    });
  } <span class="hljs-keyword">else</span> {
    instance.resolve(values);
  }

  <span class="hljs-keyword">return</span> instance;
};

pie.promise.race = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(iteratable)</span> </span>{
  <span class="hljs-keyword">var</span> instance = pie.promise.create();

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> iteratable) {
    <span class="hljs-keyword">if</span>(iteratable.hasOwnProperty(k)) {
      pie.promise.from(iteratable[k]).then(instance.resolve.bind(<span class="hljs-keyword">this</span>), instance.reject.bind(<span class="hljs-keyword">this</span>));
    }
  }
  <span class="hljs-keyword">return</span> instance;
};

pie.promise.resolve = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val)</span> </span>{
  <span class="hljs-keyword">var</span> p = pie.promise.create();
  p.state = <span class="hljs-string">'FULFILLED'</span>;
  p.result = val;
  <span class="hljs-keyword">return</span> p;
};

pie.promise.reject = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val)</span> </span>{
  <span class="hljs-keyword">var</span> p = pie.promise.create();
  p.state = <span class="hljs-string">'FAILED'</span>;
  p.result = val;
  <span class="hljs-keyword">return</span> p;
};
pie.pathHelper = pie.base.extend(<span class="hljs-string">'pathHelper'</span>, {

  hostRegex: <span class="hljs-regexp">/^(https?:\/\/)([^\/]+)(.+)/</span>,

  currentHost: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.location.host;
  },

  isCurrentHost: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(incoming)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentHost() === incoming;
  },

  stripHost: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(incoming, options)</span> </span>{
    <span class="hljs-keyword">var</span> m = incoming.match(<span class="hljs-keyword">this</span>.hostRegex);
    <span class="hljs-keyword">if</span>(!m) <span class="hljs-keyword">return</span> incoming;
    <span class="hljs-keyword">if</span>(options &amp;&amp; options.onlyCurrent &amp;&amp; <span class="hljs-keyword">this</span>.isCurrentHost(m[<span class="hljs-number">1</span>])) <span class="hljs-keyword">return</span> m[<span class="hljs-number">3</span>];
    <span class="hljs-keyword">if</span>(options &amp;&amp; options.onlyOther &amp;&amp; !<span class="hljs-keyword">this</span>.isCurrentHost(m[<span class="hljs-number">1</span>])) <span class="hljs-keyword">return</span> m[<span class="hljs-number">3</span>];
    <span class="hljs-keyword">return</span> m[<span class="hljs-number">3</span>];
  },

  hasHost: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(incoming)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.hostRegex.test(incoming);
  },

  pathAndQuery: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, query)</span> </span>{
    <span class="hljs-keyword">var</span> o = {
      path: path,
      query: query
    };

    <span class="hljs-keyword">if</span>(path &amp;&amp; path.indexOf(<span class="hljs-string">'?'</span>) &gt;= <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> split = path.split(<span class="hljs-string">'?'</span>);
      o.query = pie.object.merge(pie.string.deserialize(split[<span class="hljs-number">1</span>]), query);
      o.path = split[<span class="hljs-number">0</span>];
    }

    <span class="hljs-keyword">return</span> o;
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <h1 id="pie-app">Pie App</h1>
<p>The app class is the entry point of your application. It acts as the container in charge of managing the page’s context.
It provides access to application utilities, routing, templates, i18n, etc.
It observes browser and link navigation and changes the page’s context automatically.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app = pie.base.extend(<span class="hljs-string">'app'</span>, {

  __pieRole: <span class="hljs-string">'app'</span>,

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{

    <span class="hljs-comment">/* `pie.base.create` handles the setting of an app, */</span>
    <span class="hljs-comment">/* but we don't want a reference to another app within this app. */</span>
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.app;

    <span class="hljs-comment">/* Set a global instance which can be used as a backup within the pie library. */</span>
    pie.appInstance = pie.appInstance || <span class="hljs-keyword">this</span>;

    <span class="hljs-comment">/* Register with pie to allow for nifty global lookups. */</span>
    pie.apps[pie.uid(<span class="hljs-keyword">this</span>)] = <span class="hljs-keyword">this</span>;

    <span class="hljs-comment">/* Default application options. */</span>
    <span class="hljs-keyword">this</span>.options = pie.object.deepMerge({
      uiTarget: <span class="hljs-string">'body'</span>,
      unsupportedPath: <span class="hljs-string">'/browser/unsupported'</span>,
      verifySupport: <span class="hljs-literal">true</span>
    }, options);

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.verifySupport &amp;&amp; !<span class="hljs-keyword">this</span>.verifySupport()) {
      <span class="hljs-built_in">window</span>.location.href = <span class="hljs-keyword">this</span>.options.unsupportedPath;
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p><code>classOption</code> allows class configurations to be provided in the following formats:</p>
<pre><code>pie.app.create({
  i18n: myCustomI18nClass,
  i18nOptions: {foo: <span class="hljs-string">'bar'</span>}
});
</code></pre><p>which will result in <code>this.i18n = myCustomI18nClass.create(this, {foo: &#39;bar&#39;});</code></p>
<p>Alternatively you can provide instances as the option.</p>
<pre><code><span class="hljs-keyword">var</span> instance = myCustomI18nClass.create();
pie.app.create({
  i18n: instance,
});
</code></pre><p>which will result in <code>this.i18n = instance; this.i18n.app = this;</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> classOption = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, _default)</span></span>{
      <span class="hljs-keyword">var</span> k = <span class="hljs-keyword">this</span>.options[key],
      opt = <span class="hljs-keyword">this</span>.options[key + <span class="hljs-string">'Options'</span>] || {};

      <span class="hljs-keyword">if</span>(k === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;

      k = k || _default;

      <span class="hljs-keyword">if</span>(k.__pieRole === <span class="hljs-string">'class'</span>) {
        <span class="hljs-keyword">return</span> k.create(<span class="hljs-keyword">this</span>, opt);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pie.object.isFunction(k)) {
        <span class="hljs-keyword">return</span> k(<span class="hljs-keyword">this</span>, opt);
      } <span class="hljs-keyword">else</span> {
        k.app = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> k;
      }
    }.bind(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>The model that represents the current state of the app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.state = pie.appState.create();</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p><code>app.config</code> is a model used to manage configuration objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.config = classOption(<span class="hljs-string">'config'</span>, pie.config);</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p><code>app.cache</code> is a centralized cache store to be used by anyone.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.cache = classOption(<span class="hljs-string">'cache'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">return</span> pie.cache.create({}, {app: <span class="hljs-keyword">this</span>});
    }.bind(<span class="hljs-keyword">this</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p><code>app.storage</code> is used for local, session, cache, etc storage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.storage = classOption(<span class="hljs-string">'storage'</span>, pie.dataStore);</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p><code>app.emitter</code> is an interface for subscribing and observing app events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.emitter = classOption(<span class="hljs-string">'emitter'</span>, pie.emitter);</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p><code>app.i18n</code> is the translation functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.i18n = classOption(<span class="hljs-string">'i18n'</span>, pie.i18n);</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p><code>app.ajax</code> is ajax interface + app specific functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.ajax = classOption(<span class="hljs-string">'ajax'</span>, pie.ajax);</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p><code>app.notifier</code> is the object responsible for showing page-level notifications, alerts, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.notifier = classOption(<span class="hljs-string">'notifier'</span>, pie.notifier);</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p><code>app.errorHandler</code> is the object responsible for</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.errorHandler = classOption(<span class="hljs-string">'errorHandler'</span>, pie.errorHandler);</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p><code>app.router</code> is used to determine which view should be rendered based on the url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.router = classOption(<span class="hljs-string">'router'</span>, pie.router);</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p><code>app.routeHandler</code> extracts information from the current route and determines what to do with it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.routeHandler = classOption(<span class="hljs-string">'routeHandler'</span>, pie.routeHandler);</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p><code>app.navigator</code> observes app.state and updates the browser.
it is imperative that the router is created before the navigator since
the navigator observes both state.id and state.route;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.navigator = classOption(<span class="hljs-string">'navigator'</span>, pie.navigator);</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p><code>app.resources</code> is used for managing the loading of external resources.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.resources = classOption(<span class="hljs-string">'resources'</span>, pie.resources);</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>Template helper methods are evaluated to the local variable <code>h</code> in templates.
Any methods registered with this helpers module will be available in templates
rendered by this app’s <code>templates</code> object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.helpers = classOption(<span class="hljs-string">'helpers'</span>, pie.helpers);</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p><code>app.templates</code> is used to manage and render application templates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.templates = classOption(<span class="hljs-string">'templates'</span>, pie.templates);</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p><code>app.validator</code> a validator intance to be used in conjunction with this app’s model activity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.validator = classOption(<span class="hljs-string">'validator'</span>, pie.validator);

    <span class="hljs-keyword">this</span>.pathHelper = classOption(<span class="hljs-string">'pathHelper'</span>, pie.pathHelper);</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Before we get going, observe link navigation &amp; show any notifications stored
in app.storage.
Wrapped in a function for testing purposes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.emitter.once(<span class="hljs-string">'start:before'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">this</span>.setupSinglePageLinks(); }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.options.noAutoStart) {</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>Once the dom is loaded, start the app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-keyword">this</span>.start.bind(<span class="hljs-keyword">this</span>));
    }

    <span class="hljs-keyword">this</span>._super();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Just in case the client wants to override the standard confirmation dialog.
Eventually this could create a confirmation view and provide options to it.
The dialog should return a promise which is resolved if the dialog is confirmed
and rejected if the dialog is denied.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  confirm: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(text)</span> </span>{
    <span class="hljs-keyword">return</span> pie.promise.create(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve, reject)</span></span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.confirm(text)) resolve();
      <span class="hljs-keyword">else</span> reject();
    });
  },

  debug: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.console &amp;&amp; <span class="hljs-built_in">window</span>.console.log) {
      <span class="hljs-built_in">window</span>.console.log.apply(<span class="hljs-built_in">window</span>.console, <span class="hljs-built_in">arguments</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>Use this to build paths.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  path: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, query)</span> </span>{

    <span class="hljs-keyword">if</span>(pie.object.isObject(path)) {
      query = path;
      path = <span class="hljs-literal">undefined</span>;
    }

    <span class="hljs-keyword">if</span>(!pie.object.isObject(query)) query = <span class="hljs-literal">undefined</span>;

    <span class="hljs-keyword">var</span> pq = <span class="hljs-keyword">this</span>.pathHelper.pathAndQuery(path, query);</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>if we don’t know our path but have been given a query, try to build a path based on the existing route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(pq.path == <span class="hljs-literal">null</span> &amp;&amp; pq.query) {
      <span class="hljs-keyword">var</span> currentRoute = <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'__route'</span>);

      <span class="hljs-keyword">if</span>(currentRoute) {
        pq.path = currentRoute.get(<span class="hljs-string">'pathTemplate'</span>);
        pq.query = pie.object.merge({}, <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'__query'</span>), <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'__interpolations'</span>), pq.query);
      }
    }

    pq.path = pq.path || <span class="hljs-string">'/'</span>;
    pq.path = <span class="hljs-keyword">this</span>.pathHelper.stripHost(pq.path, {onlyCurrent: <span class="hljs-literal">true</span>});</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>if a router is present and we’re dealing with a relative path we can allow the passing of named routes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.pathHelper.hasHost(pq.path) &amp;&amp; <span class="hljs-keyword">this</span>.router) pq.path = <span class="hljs-keyword">this</span>.router.path(pq.path, pq.query);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!pie.object.isEmpty(pq.query)) pq.path = pie.string.urlConcat(pq.path, pie.object.serialize(pq.query));

    <span class="hljs-keyword">return</span> pq.path;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>Use this to navigate around the app.</p>
<pre><code>app.go(<span class="hljs-string">'/test-url'</span>);
app.go(<span class="hljs-string">'namedUrl'</span>);
app.go({foo: <span class="hljs-string">'bar'</span>});
app.go(<span class="hljs-string">'/things/:id'</span>, {id: <span class="hljs-number">4</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  go: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* path?, query?, skipHistory? */</span>)</span></span>{
    <span class="hljs-keyword">var</span> id = <span class="hljs-keyword">this</span>.path.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">var</span> skipHistory = pie.array.last(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">if</span>(!pie.object.isBoolean(skipHistory)) skipHistory = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">this</span>.state.transition(id, skipHistory);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>Callback for when a link is clicked in our app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  handleSinglePageLinkClick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>If the link is targeting something else, let the browser take over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(e.delegateTarget.getAttribute(<span class="hljs-string">'target'</span>)) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>If the user is trying to do something beyond simple navigation, let the browser take over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(e.ctrlKey || e.metaKey || e.button &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>Extract the location from the link.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> href = e.delegateTarget.getAttribute(<span class="hljs-string">'href'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>If we’re going nowhere, somewhere else, or to an anchor on the page, let the browser take over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!href || <span class="hljs-regexp">/^(#|[a-z]+:\/\/)/</span>.test(href)) <span class="hljs-keyword">return</span>;

    e.preventDefault();
    <span class="hljs-keyword">this</span>.go(href, !!e.delegateTarget.getAttribute(<span class="hljs-string">'data-replace-state'</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>When a link is clicked, go there without a refresh if we recognize the route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setupSinglePageLinks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> target = pie.qs(<span class="hljs-keyword">this</span>.routeHandler.options.uiTarget);
    pie.dom.on(target, <span class="hljs-string">'click'</span>, <span class="hljs-keyword">this</span>.handleSinglePageLinkClick.bind(<span class="hljs-keyword">this</span>), <span class="hljs-string">'a[href]'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>Start the app by starting the navigator (which we have observed).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  start: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'start'</span>);
  },

  verifySupport: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> el = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'_'</span>);

    <span class="hljs-keyword">return</span> !!(el.classList &amp;&amp;
      <span class="hljs-built_in">window</span>.history.pushState &amp;&amp;
      <span class="hljs-built_in">Date</span>.prototype.toISOString &amp;&amp;
      <span class="hljs-built_in">Array</span>.isArray &amp;&amp;
      <span class="hljs-built_in">Array</span>.prototype.forEach &amp;&amp;
      <span class="hljs-built_in">Object</span>.keys &amp;&amp;
      <span class="hljs-built_in">Number</span>.prototype.toFixed);
  },


}, pie.mixins.container);</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <h1 id="pie-model">Pie Model</h1>
<h3 id="setters-and-getters">Setters and Getters</h3>
<p>pie.model provides a basic interface for object management and observation.</p>
<p><em>example:</em></p>
<pre><code><span class="hljs-keyword">var</span> user = pie.model.create();
user.set(<span class="hljs-string">'first_name'</span>, <span class="hljs-string">'Doug'</span>);
user.get(<span class="hljs-string">'first_name'</span>) <span class="hljs-comment">//=&gt; 'Doug'</span>
user.sets({
  first_name: <span class="hljs-string">'Douglas'</span>,
  last_name: <span class="hljs-string">'Wilson'</span>
});
user.get(<span class="hljs-string">'last_name'</span>) <span class="hljs-comment">//= 'Wilson'</span>

user.set(<span class="hljs-string">'location.city'</span>, <span class="hljs-string">'Miami'</span>)
user.get(<span class="hljs-string">'location.city'</span>) <span class="hljs-comment">//=&gt; 'Miami'</span>
user.get(<span class="hljs-string">'location'</span>) <span class="hljs-comment">//=&gt; {city: 'Miami'}</span>
</code></pre><h3 id="observers">Observers</h3>
<p>Observers can be added by invoking the model’s <code>observe()</code> function.
<code>pie.model.observe()</code> optionally accepts 2+ arguments which are used as filters for the observer.</p>
<p><em>example:</em></p>
<pre><code><span class="hljs-keyword">var</span> o = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span></span>{ <span class="hljs-built_in">console</span>.log(changes); };
<span class="hljs-keyword">var</span> user = pie.model.create();
user.observe(o, <span class="hljs-string">'first_name'</span>);
user.sets({first_name: <span class="hljs-string">'first'</span>, last_name: <span class="hljs-string">'last'</span>});
<span class="hljs-comment">// =&gt; o is called and the following is logged:</span>
[{...}, {
  name: <span class="hljs-string">'first_name'</span>,
  type: <span class="hljs-string">'new'</span>,
  oldValue:
  <span class="hljs-literal">undefined</span>,
  value: <span class="hljs-string">'first'</span>,
  object: {...}
}]
</code></pre><p>Note that the changes are extended with the <code>pie.mixin.changeSet</code> functionality, so check that out too.</p>
<h3 id="computed-properties">Computed Properties</h3>
<p><code>pie.models</code> can observe themselves and compute properties. The computed properties can be observed
just like any other property.</p>
<p><em>example:</em></p>
<pre><code><span class="hljs-keyword">var</span> fullName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'first_name'</span>) + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'last_name'</span>); };
<span class="hljs-keyword">var</span> user = pie.model.create({first_name: <span class="hljs-string">'Doug'</span>, last_name: <span class="hljs-string">'Wilson'</span>});
user.compute(<span class="hljs-string">'full_name'</span>, fullName, <span class="hljs-string">'first_name'</span>, <span class="hljs-string">'last_name'</span>);
user.get(<span class="hljs-string">'full_name'</span>) <span class="hljs-comment">//=&gt; 'Doug Wilson'</span>
user.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span></span>{ <span class="hljs-built_in">console</span>.log(changes); }, <span class="hljs-string">'full_name'</span>);
user.set(<span class="hljs-string">'first_name'</span>, <span class="hljs-string">'Douglas'</span>);
<span class="hljs-comment">// =&gt; the observer is invoked and console.log provides:</span>
[{..}, {
  name: <span class="hljs-string">'full_name'</span>,
  oldValue: <span class="hljs-string">'Doug Wilson'</span>,
  value: <span class="hljs-string">'Douglas Wilson'</span>,
  type: <span class="hljs-string">'update'</span>,
  object: {...}
}]
</code></pre><p>If a function is not provided as the definition of the computed property, it will look
for a matching function name within the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

pie.model = pie.base.extend(<span class="hljs-string">'model'</span>, {

  __pieRole: <span class="hljs-string">'model'</span>,

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d, options)</span> </span>{

    <span class="hljs-keyword">if</span>(d &amp;&amp; d.__pieRole === <span class="hljs-string">'model'</span>) d = d.data;

    <span class="hljs-keyword">this</span>.data = pie.object.deepMerge({__version: <span class="hljs-number">1</span>}, d);
    <span class="hljs-keyword">this</span>.options = options || {};
    <span class="hljs-keyword">this</span>.app = <span class="hljs-keyword">this</span>.app || <span class="hljs-keyword">this</span>.options.app || pie.appInstance;
    <span class="hljs-keyword">this</span>.observations = {};
    <span class="hljs-keyword">this</span>.observedKeyCounts = {};
    <span class="hljs-keyword">this</span>.changeRecords = [];
    <span class="hljs-keyword">this</span>.deliveringRecords = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">this</span>._super();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p><strong> pie.model.compute </strong></p>
<p>Register a computed property which is accessible via <code>name</code> and defined by <code>fn</code>.
Provide all properties which invalidate the definition.
If the definition of the property is defined by a function of the same name, the function can be ommitted.</p>
<pre><code>Model.reopen({fullName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-comment">/*...*/</span> }});
model.compute(<span class="hljs-string">'fullName'</span>, <span class="hljs-string">'first_name'</span>, <span class="hljs-string">'last_name'</span>);
model.compute(<span class="hljs-string">'displayName'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{}, <span class="hljs-string">'fullName'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  compute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* name, fn?[, prop1, prop2 ] */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> props = pie.array.from(<span class="hljs-built_in">arguments</span>),
    name = props.shift(),
    fn = props.shift(),
    wrap;

    props = pie.array.flatten(props);

    <span class="hljs-keyword">if</span>(!pie.object.isFunction(fn)) {
      props.unshift(fn);
      fn = <span class="hljs-keyword">this</span>[name].bind(<span class="hljs-keyword">this</span>);
    }

    wrap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* changes */</span>)</span></span>{
      <span class="hljs-keyword">this</span>.set(name, fn.call(<span class="hljs-keyword">this</span>), {skipObservers: <span class="hljs-literal">true</span>});
    }.bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.observe(wrap, props);
    <span class="hljs-keyword">this</span>.observations[pie.uid(wrap)].computed = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">/* Initialize the computed properties value immediately. */</span>
    <span class="hljs-keyword">this</span>.set(name, fn.call(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p><strong>pie.model.addChangeRecord</strong></p>
<p>Add a change record to this model. If a change record of the same name already exists,
update the existing value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addChangeRecord: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, type, oldValue, value, extras)</span> </span>{

    <span class="hljs-keyword">this</span>.isDirty = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.shouldAddChangeRecordForAttribute(name)) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> existing = !<span class="hljs-regexp">/\*$/</span>.test(name) &amp;&amp; pie.array.detect(<span class="hljs-keyword">this</span>.changeRecords, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span></span>{ <span class="hljs-keyword">return</span> r &amp;&amp; r.name === name; });

    <span class="hljs-keyword">if</span>(existing) {
      <span class="hljs-keyword">var</span> remove = <span class="hljs-literal">false</span>;
      existing.value = value;</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>if we previously deleted this value but it’s been added back in, just report an update.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(existing.type === <span class="hljs-string">'delete'</span> &amp;&amp; type === <span class="hljs-string">'add'</span>) existing.type = <span class="hljs-string">'update'</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(existing.type === <span class="hljs-string">'add'</span> &amp;&amp; type === <span class="hljs-string">'delete'</span>) remove = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>if we previously delete this value but have now added an object, report a path update.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(existing.type === <span class="hljs-string">'delete'</span> &amp;&amp; type === <span class="hljs-string">'pathUpdate'</span>) existing.type = <span class="hljs-string">'pathUpdate'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>if we previously deleted this value but have now changed it, inherit the new type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'delete'</span>) existing.type = type;</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>if the result is an update but the values are identical, remove the change record.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(existing.type === <span class="hljs-string">'update'</span> &amp;&amp; existing.oldValue === existing.value) remove = <span class="hljs-literal">true</span>;

      <span class="hljs-keyword">if</span>(remove) {
        <span class="hljs-keyword">this</span>.changeRecords = pie.array.remove(<span class="hljs-keyword">this</span>.changeRecords, existing);
      }

      <span class="hljs-keyword">if</span>(extras) pie.object.merge(existing, extras);

      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> change = {
      name: name,
      type: type,
      value: value,
      object: <span class="hljs-keyword">this</span>
    };

    <span class="hljs-keyword">if</span>(oldValue != <span class="hljs-literal">null</span>) change.oldValue = oldValue;
    <span class="hljs-keyword">if</span>(extras) pie.object.merge(change, extras);

    <span class="hljs-keyword">this</span>.changeRecords.push(change);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p><strong> pie.model.deliverChangeRecords </strong></p>
<p>After updates have been made we deliver our change records to our observers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deliverChangeRecords: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.isDirty) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.deliveringRecords) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

    <span class="hljs-comment">/* This is where the version tracking is incremented. */</span>
    <span class="hljs-keyword">if</span>(!options || !options.skipVersionTracking) <span class="hljs-keyword">this</span>.trackVersion();


    <span class="hljs-keyword">var</span> changeSet = <span class="hljs-keyword">this</span>.changeRecords,
    emptyChangeSet = <span class="hljs-keyword">this</span>.observedKeyCounts[<span class="hljs-string">'~'</span>] ? pie.object.merge([], pie.mixins.changeSet) : <span class="hljs-literal">undefined</span>,
    observers = pie.object.values(<span class="hljs-keyword">this</span>.observations),
    invoker = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">changeRecordDelivery</span><span class="hljs-params">(obj)</span> </span>{
      <span class="hljs-keyword">if</span>(~obj.keys.indexOf(<span class="hljs-string">'*'</span>)) obj.fn.call(<span class="hljs-literal">null</span>, changeSet);
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(changeSet.hasAny.apply(changeSet, obj.keys)) obj.fn.call(<span class="hljs-literal">null</span>, changeSet);
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(~obj.keys.indexOf(<span class="hljs-string">'~'</span>)) obj.fn.call(<span class="hljs-literal">null</span>, emptyChangeSet);
    }.bind(<span class="hljs-keyword">this</span>),
    o, idx;

    <span class="hljs-comment">/* We modify the `changeSet` array with the `pie.mixins.changeSet`. */</span>
    pie.object.merge(changeSet, pie.mixins.changeSet);


    <span class="hljs-comment">/* Deliver change records to all computed properties first. */</span>
    <span class="hljs-comment">/* This will ensure that the change records include the computed property changes */</span>
    <span class="hljs-comment">/* along with the original property changes. */</span>
    <span class="hljs-keyword">while</span>(~(idx = pie.array.indexOf(observers, <span class="hljs-string">'computed'</span>))) {
      o = observers[idx];
      observers.splice(idx, <span class="hljs-number">1</span>);
      invoker(o);
    }

    <span class="hljs-comment">/* Now we reset the changeRecords on this model. */</span>
    <span class="hljs-keyword">this</span>.changeRecords = [];

    <span class="hljs-comment">/* We increment our deliveringRecords flag to ensure records are delivered in the correct order */</span>
    <span class="hljs-keyword">this</span>.deliveringRecords++;

    <span class="hljs-comment">/* And deliver the changeSet to each observer. */</span>
    observers.forEach(invoker);

    <span class="hljs-comment">/* Now we can decrement our deliveringRecords flag and attempt to deliver any leftover records */</span>
    <span class="hljs-keyword">this</span>.deliveringRecords--;
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.changeRecords.length) <span class="hljs-keyword">this</span>.deliverChangeRecords(options);

    <span class="hljs-keyword">this</span>.isDirty = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p><strong> pie.model.get </strong></p>
<p>Access the value stored at data[key]
Key can be multiple levels deep by providing a dot separated key.</p>
<pre><code>model.get(<span class="hljs-string">'foo'</span>)
<span class="hljs-comment">//=&gt; 'bar'</span>
model.get(<span class="hljs-string">'bar.baz'</span>)
<span class="hljs-comment">//=&gt; undefined</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">return</span> pie.object.getPath(<span class="hljs-keyword">this</span>.data, key);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p><strong> pie.model.getOrSet </strong></p>
<p>Retrieve or set a key within the model.
The <code>defaultValue</code> will only be used if the value at <code>key</code> is <code>== null</code>.</p>
<pre><code>model.getOrSet(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'theFirstValue'</span>);
<span class="hljs-comment">//=&gt; 'theFirstValue'</span>
model.getOrSet(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'theSecondValue'</span>);
<span class="hljs-comment">//=&gt; 'theFirstValue'</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  getOrSet: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, defaultValue)</span> </span>{
    <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.get(key);
    <span class="hljs-keyword">if</span>(val != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> val;

    <span class="hljs-keyword">this</span>.set(key, defaultValue);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(key);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p><strong> pie.model.gets </strong></p>
<p>Retrieve multiple values at once.
Returns an object of names &amp; values.
Path keys will be transformed into objects.</p>
<pre><code>model.gets(<span class="hljs-string">'foo.baz'</span>, <span class="hljs-string">'bar'</span>);
<span class="hljs-comment">//=&gt; {foo: {baz: 'fooBazValue'}, bar: 'barValue'}</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  gets: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>),
    o = {};

    args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getsIterator</span><span class="hljs-params">(arg)</span></span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(arg)) {
        pie.object.setPath(o, arg, <span class="hljs-keyword">this</span>.get(arg));
      }
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> o;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p><strong> pie.model.has </strong></p>
<p>Determines whether a path exists in our data.</p>
<pre><code>model.has(<span class="hljs-string">'foo.bar'</span>)
<span class="hljs-comment">//=&gt; true | false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  has: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">return</span> !!pie.object.hasPath(<span class="hljs-keyword">this</span>.data, path);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p><strong> pie.model.hasAll </strong></p>
<p>Determines whether all paths exist in our data.</p>
<pre><code>model.hasAll(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>)
<span class="hljs-comment">//=&gt; true | false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  hasAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>), i;

    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; args.length; i++) {
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.has(args[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p><strong> pie.model.hasAny </strong></p>
<p>Determines whether any key given exists</p>
<pre><code>model.hasAny(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>)
<span class="hljs-comment">//=&gt; true | false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  hasAny: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>), i;

    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; args.length; i++) {
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(args[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> !args.length;
  },

  shouldAddChangeRecordForAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">if</span>(!!<span class="hljs-keyword">this</span>.observedKeyCounts[<span class="hljs-string">'*'</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(!!<span class="hljs-keyword">this</span>.observedKeyCounts[key]) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">if</span>(~key.indexOf(<span class="hljs-string">'.'</span>)) {
      <span class="hljs-keyword">var</span> paths = pie.string.pathSteps(key).slice(<span class="hljs-number">1</span>);
      <span class="hljs-keyword">if</span>(pie.array.areAny(paths, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">changeRecordApplicabilityChecker</span><span class="hljs-params">(p)</span></span>{ <span class="hljs-keyword">return</span> !!<span class="hljs-keyword">this</span>.observedKeyCounts[p + <span class="hljs-string">'.*'</span>]; }.bind(<span class="hljs-keyword">this</span>))) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p><strong> pie.model.is </strong></p>
<p>Boolean check the value at <code>path</code>.</p>
<pre><code>model.is(<span class="hljs-string">'foo.bar'</span>)
<span class="hljs-comment">//=&gt; true | false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  is: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">return</span> !!<span class="hljs-keyword">this</span>.get(path);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p><strong> pie.model.merge </strong></p>
<p>Set keys, but do so by merging with the current values
```
model.set(‘location.city’, “San Francisco”)
model.set(‘location.lat’, 0);
model.set(‘location.lng’, 0);
model.merge({location: {lat: 37.77, lng: -122.44}})
model.get(‘location’)
//=&gt; {city: “San Francico”, lat: 37.77, lng: -122.44}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  merge: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* objs */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> obj = <span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">1</span> ? pie.object.deepMerge.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>) : <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>];
    obj = pie.object.flatten(obj);
    <span class="hljs-keyword">this</span>.sets(obj);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p><strong> pie.model.observe </strong></p>
<p>Register an observer and optionally filter by key.
If no keys are provided, any change will result in the observer being triggered.</p>
<pre><code>model.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changeSet)</span></span>{
  <span class="hljs-built_in">console</span>.log(changeSet);
});
</code></pre><pre><code>model.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changeSet)</span></span>{
  <span class="hljs-built_in">console</span>.log(changeSet);
}, <span class="hljs-string">'fullName'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  observe: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* fn1[, fn2, fn3[, key1, key2, key3]] */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>),
    part = pie.array.partition(args, pie.object.isFunction),
    fns = part[<span class="hljs-number">0</span>],
    keys = part[<span class="hljs-number">1</span>],
    cnt;

    <span class="hljs-keyword">if</span>(!keys.length) keys = [<span class="hljs-string">'~'</span>];

    keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">observedKeyCountIncrementer</span><span class="hljs-params">(k)</span> </span>{
      cnt = <span class="hljs-keyword">this</span>.observedKeyCounts[k];
      <span class="hljs-keyword">this</span>.observedKeyCounts[k] = (cnt || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;
    }.bind(<span class="hljs-keyword">this</span>));

    fns.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">observerStorer</span><span class="hljs-params">(fn)</span></span>{

      <span class="hljs-comment">/* Setting the uid is needed because we'll want to manage unobservation effectively. */</span>
      pie.uid(fn);

      <span class="hljs-keyword">this</span>.observations[pie.uid(fn)] = {
        fn: fn,
        keys: keys
      };

    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p><strong> pie.model.reset </strong></p>
<p>Reset a model to it’s empty state, without affecting the <code>__version</code> attribute.
Optionally, you can pass any options which are valid to <code>sets</code>.</p>
<pre><code>model.reset({skipObservers: <span class="hljs-literal">true</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.data), o = {};

    keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resetIterator</span><span class="hljs-params">(k)</span></span>{
      <span class="hljs-keyword">if</span>(k === <span class="hljs-string">'__version'</span>) <span class="hljs-keyword">return</span>;
      o[k] = <span class="hljs-literal">undefined</span>;
    });

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sets(o, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p><strong> pie.model.set </strong></p>
<p>Set a <code>value</code> on the model at the specified <code>key</code>.
Valid options are:</p>
<ul>
<li>skipObservers - when true, observers will not be triggered.</li>
<li>skipParents   - when true, parent change records will not be sent.</li>
<li>skipChildren  - when true, child change records will not be sent.</li>
</ul>
<p><em>Note: skipping observation does not stop <code>changeRecords</code> from accruing.</em></p>
<pre><code>model.set(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>);
model.set(<span class="hljs-string">'foo.baz'</span>, <span class="hljs-string">'bar'</span>);
model.set(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, {skipObservers: <span class="hljs-literal">true</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, options)</span> </span>{

    <span class="hljs-keyword">if</span>(pie.object.isPlainObject(value) &amp;&amp; !pie.object.isEmpty(value)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>since we’re overriding an object we need to unset it.
we add change records for the children, but don’t worry about the parents
since the sets() will take care of that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.set(key, <span class="hljs-literal">undefined</span>, pie.object.merge({}, options, {
        skipObservers: <span class="hljs-literal">true</span>,
        skipParents: <span class="hljs-literal">true</span>
      }));

      value = pie.object.flatten(value, key + <span class="hljs-string">'.'</span>);
      <span class="hljs-keyword">this</span>.sets(value, options);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> changeName = key,
    changeType, changeOldValue, changeValue;

    changeOldValue = pie.object.getPath(<span class="hljs-keyword">this</span>.data, key);

    <span class="hljs-comment">/* If we haven't actually changed, don't bother doing anything. */</span>
    <span class="hljs-keyword">if</span>((!options || !options.force) &amp;&amp; value === changeOldValue) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span>(changeOldValue !== <span class="hljs-literal">undefined</span>) {
      changeType = <span class="hljs-string">'update'</span>;
    }

    <span class="hljs-keyword">var</span> parentKeys = (!options || !options.skipParents) &amp;&amp; ~key.indexOf(<span class="hljs-string">'.'</span>) ? pie.string.pathSteps(key).slice(<span class="hljs-number">1</span>) : <span class="hljs-literal">null</span>,
    childKeys, nestedOpts, i;


    <span class="hljs-keyword">if</span>((!options || !options.skipChildren) &amp;&amp; pie.object.isPlainObject(changeOldValue)) {
      childKeys = <span class="hljs-built_in">Object</span>.keys(pie.object.flatten(changeOldValue, key + <span class="hljs-string">'.'</span>));
    }

    nestedOpts = childKeys || parentKeys ? pie.object.merge({}, options, {skipChildren: <span class="hljs-literal">true</span>, skipParents: <span class="hljs-literal">true</span>}) : <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span>(childKeys &amp;&amp; childKeys.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>add change records for the deleted children.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; childKeys.length; i++) {
        <span class="hljs-keyword">this</span>.set(childKeys[i], <span class="hljs-literal">undefined</span>, nestedOpts);
      }
    }

    changeValue = value;

    <span class="hljs-comment">/* If we are "unsetting" the value, delete the path from `this.data`. */</span>
    <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span>) {
      changeType = <span class="hljs-string">'delete'</span>;
      pie.object.deletePath(<span class="hljs-keyword">this</span>.data, key);

    <span class="hljs-comment">/* Otherwise, we set the value within `this.data`. */</span>
    } <span class="hljs-keyword">else</span> {
      pie.object.setPath(<span class="hljs-keyword">this</span>.data, key, value);
      changeType = changeType || <span class="hljs-string">'add'</span>;
    }

    <span class="hljs-keyword">if</span>(parentKeys &amp;&amp; parentKeys.length) {
      <span class="hljs-keyword">var</span> parentVal;

      <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; parentKeys.length; i++) {

        parentVal = <span class="hljs-keyword">this</span>.get(parentKeys[i]);

        <span class="hljs-keyword">if</span>(changeType === <span class="hljs-string">'delete'</span> &amp;&amp; pie.object.isObject(parentVal) &amp;&amp; pie.object.isEmpty(parentVal)) {
          <span class="hljs-keyword">this</span>.set(parentKeys[i], <span class="hljs-literal">undefined</span>, nestedOpts);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">this</span>.addChangeRecord(parentKeys[i], <span class="hljs-string">'pathUpdate'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>);
        }
      }
    }

    <span class="hljs-comment">/* Add the change to the `changeRecords`. */</span>
    <span class="hljs-keyword">this</span>.addChangeRecord(changeName, changeType, changeOldValue, changeValue);


    <span class="hljs-keyword">if</span>(options &amp;&amp; options.skipObservers) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deliverChangeRecords(options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p><strong> pie.model.setData </strong></p>
<p>Update data to contain only the keys defined by obj.
Results in the same data value as a <code>reset</code> + <code>sets</code> BUT change records will reflect
the updates, not the removal + the additions.</p>
<pre><code>model.setData({foo: <span class="hljs-string">'bar'</span>, bar: <span class="hljs-string">'baz'</span>})
model.setData({bar: <span class="hljs-string">'foo'</span>})
<span class="hljs-comment">//=&gt; change records will include a deleted foo, and an updated bar.</span>
model.data
<span class="hljs-comment">//=&gt; {__version: 3, bar: 'foo'}</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  setData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, options)</span> </span>{
    <span class="hljs-keyword">var</span> existing = <span class="hljs-built_in">Object</span>.keys(pie.object.flatten(<span class="hljs-keyword">this</span>.data)),
    given = <span class="hljs-built_in">Object</span>.keys(pie.object.flatten(obj)),
    removed = pie.array.subtract(existing, given),
    rmOptions = pie.object.merge({}, options, {skipObservers: <span class="hljs-literal">true</span>});

    removed = pie.array.remove(removed, <span class="hljs-string">'__version'</span>);

    removed.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setDataRemover</span><span class="hljs-params">(rm)</span></span>{
      <span class="hljs-keyword">this</span>.set(rm, <span class="hljs-literal">undefined</span>, rmOptions);
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sets(obj, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p><strong> pie.model.sets </strong></p>
<p>Set a bunch of stuff at once.
Change records will not be delivered until all keys have been set.</p>
<pre><code>model.sets({foo: <span class="hljs-string">'bar'</span>, baz: <span class="hljs-string">'qux'</span>}, {skipObservers: treu});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  sets: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, options)</span> </span>{
    <span class="hljs-keyword">var</span> innerOpts = pie.object.merge({}, options, {skipObservers: <span class="hljs-literal">true</span>});
    pie.object.forEach(obj, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setsIterator</span><span class="hljs-params">(k,v)</span> </span>{
      <span class="hljs-keyword">this</span>.set(k, v, innerOpts);
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">if</span>(options &amp;&amp; options.skipObservers) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deliverChangeRecords(options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <p><strong> pie.model.test </strong></p>
<p>Test a <code>value</code> against the value at <code>path</code>.
If <code>value</code> is a regular expression it will stringify the path’s value and test against the regex.</p>
<pre><code>model.test(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>);
model.test(<span class="hljs-string">'firstName'</span>, <span class="hljs-string">'Douglas'</span>);
model.test(<span class="hljs-string">'firstName'</span>, <span class="hljs-regexp">/doug/i</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  test: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, value)</span> </span>{
    <span class="hljs-keyword">var</span> owned = <span class="hljs-keyword">this</span>.get(path);
    <span class="hljs-keyword">if</span>(owned === value) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(owned == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pie.object.isRegExp(value)) <span class="hljs-keyword">return</span> value.test(<span class="hljs-built_in">String</span>(owned));
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },

  tests: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.test(k, obj[k])) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p><strong> pie.model.touch </strong></p>
<p>Bumps the <strong>version by 1 and delivers change records to observers of </strong>version</p>
<pre><code>model.touch();
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  touch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.trackVersion();
    <span class="hljs-keyword">this</span>.deliverChangeRecords({skipVersionTracking: <span class="hljs-literal">true</span>});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p><strong> pie.model.trackVersion </strong></p>
<p>Increment the <code>__version</code> of this model.
Observers are skipped since this is invoked while change records are delivered.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  trackVersion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> oldVal = <span class="hljs-keyword">this</span>.data.__version,
    newVal = oldVal + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.data.__version = newVal;
    <span class="hljs-keyword">this</span>.addChangeRecord(<span class="hljs-string">'__version'</span>, <span class="hljs-string">'update'</span>, oldVal, newVal);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p><strong> pie.model.unobserve </strong></p>
<p>Unregister an observer. Optionally for specific keys.
If a subset of the original keys are provided it will only unregister
for those provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unobserve: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* fn1[, fn2, fn3[, key1, key2, key3]] */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>),
    part = pie.array.partition(args, pie.object.isFunction),
    fns = part[<span class="hljs-number">0</span>],
    keys = part[<span class="hljs-number">1</span>],
    observation,
    cnt;

    keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">observedKeyCountDecrementer</span><span class="hljs-params">(k)</span> </span>{
      cnt = <span class="hljs-keyword">this</span>.observedKeyCounts[k];
      <span class="hljs-keyword">if</span>(cnt) <span class="hljs-keyword">this</span>.observedKeyCounts[k] = cnt - <span class="hljs-number">1</span>;
    }.bind(<span class="hljs-keyword">this</span>));

    fns.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">observerRemoverer</span><span class="hljs-params">(fn)</span></span>{
      pie.uid(fn);

      observation = <span class="hljs-keyword">this</span>.observations[pie.uid(fn)];
      <span class="hljs-keyword">if</span>(!observation) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">if</span>(!keys.length) {
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.observations[pie.uid(fn)];
        <span class="hljs-keyword">return</span>;
      }

      observation.keys = pie.array.subtract(observation.keys, keys);

      <span class="hljs-keyword">if</span>(!observation.keys.length) {
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.observations[pie.uid(fn)];
        <span class="hljs-keyword">return</span>;
      }
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },
});</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <h1 id="pie-config">Pie Config</h1>
<p>A place to store app configuration information.
It allows for dynamic subconfigs to be defined as well.</p>
<pre><code>app.config.set(<span class="hljs-string">'googleMapsKey'</span>, <span class="hljs-string">'xyz'</span>);
app.config.dynamic(<span class="hljs-string">'env'</span>, {
  <span class="hljs-string">"defaults"</span> : {
    analyticsEnabled: <span class="hljs-literal">false</span>
  },
  <span class="hljs-string">"production"</span> : {
    analyticsEnabled: <span class="hljs-literal">true</span>
  }
});

app.config.get(<span class="hljs-string">'googleMapsKey'</span>)
<span class="hljs-comment">//=&gt; 'xyz'</span>

app.config.get(<span class="hljs-string">'analyticsEnabled'</span>);
<span class="hljs-comment">//=&gt; false</span>

app.config.set(<span class="hljs-string">'env'</span>, <span class="hljs-string">'production'</span>);
app.config.get(<span class="hljs-string">'analyticsEnabled'</span>);
<span class="hljs-comment">//=&gt; true</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.config = pie.model.extend(<span class="hljs-string">'config'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    options = options || {};
    options.app = app;

    <span class="hljs-keyword">this</span>._super({}, options);
    <span class="hljs-keyword">this</span>.dynamicKeys = {};
  },

  _onDynamicChange: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dynamic)</span> </span>{
    <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.get(dynamic),
    defaults, conf;

    defaults = <span class="hljs-keyword">this</span>.get(dynamic + <span class="hljs-string">'Config.defaults'</span>);
    conf = val &amp;&amp; <span class="hljs-keyword">this</span>.get(dynamic + <span class="hljs-string">'Config.'</span> + val);

    <span class="hljs-keyword">this</span>.sets(pie.object.deepMerge({}, defaults, conf));
  },

  dynamic: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dynamic, obj)</span> </span>{
    <span class="hljs-keyword">var</span> current = <span class="hljs-keyword">this</span>.get(dynamic + <span class="hljs-string">'Config'</span>) || {};
    <span class="hljs-keyword">this</span>.set(dynamic + <span class="hljs-string">'Config'</span>, pie.object.deepMerge(current, obj));

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.dynamicKeys[dynamic]) {
      <span class="hljs-keyword">this</span>.dynamicKeys[dynamic] = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">this</span>._onDynamicChange(dynamic);
      }.bind(<span class="hljs-keyword">this</span>), dynamic);
    }

    <span class="hljs-keyword">this</span>._onDynamicChange(dynamic);
  }

});
pie.cache = pie.model.extend(<span class="hljs-string">'cache'</span>, {

  fetch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, fn)</span> </span>{
    <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.get(path);
    <span class="hljs-keyword">if</span>(value !== <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span> value;
    value = pie.fn.valueFrom(fn);
    <span class="hljs-keyword">this</span>.set(path, value);
    <span class="hljs-keyword">return</span> value;
  }

});
pie.dataStore = pie.base.extend(<span class="hljs-string">'dataStore'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>.app = app;
    <span class="hljs-keyword">this</span>.options = pie.object.merge({
      primary: <span class="hljs-string">'sessionStorage'</span>,
      backup: <span class="hljs-string">'backup'</span>
    }, options);

    <span class="hljs-keyword">this</span>._super();

    <span class="hljs-keyword">this</span>.backupModel = pie.model.create({});
  },

  primary: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._store(<span class="hljs-keyword">this</span>.options.primary);
  },

  backup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._store(<span class="hljs-keyword">this</span>.options.backup);
  },

  _store: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">if</span>(pie.object.isString(name)) <span class="hljs-keyword">return</span> pie.dataStore.adapters[name];
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> name;
  },


  clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">this</span>.primary().clear(key, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.primary().clear(key, <span class="hljs-keyword">this</span>);
  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span> </span>{
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">this</span>.primary().get(key, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">if</span>(result === pie.dataStore.ACCESS_ERROR) result = <span class="hljs-keyword">this</span>.backup().get(key, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">if</span>(!options || (options.clear === <span class="hljs-literal">undefined</span> || options.clear)) {
      <span class="hljs-keyword">this</span>.clear(key);
    }

    <span class="hljs-keyword">return</span> result;
  },

  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>clear from all stores so we don’t get out of sync.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.clear(key);

    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">this</span>.primary().set(key, value, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">if</span>(result === pie.dataStore.ACCESS_ERROR) result = <span class="hljs-keyword">this</span>.backup().set(key, value, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">return</span> result;
  }

});

pie.dataStore.ACCESS_ERROR = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"~~PIE_ACCESS_ERROR~~"</span>);
pie.dataStore.adapters = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

  <span class="hljs-keyword">var</span> storageGet = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(storeName, key)</span> </span>{

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">window</span>[storeName]) <span class="hljs-keyword">return</span> pie.dataStore.ACCESS_ERROR;

      <span class="hljs-keyword">var</span> encoded = <span class="hljs-built_in">window</span>[storeName].getItem(key);
      <span class="hljs-keyword">return</span> encoded != <span class="hljs-literal">null</span> ? <span class="hljs-built_in">JSON</span>.parse(encoded) : encoded;
    } <span class="hljs-keyword">catch</span>(err) {
      <span class="hljs-keyword">this</span>.app.errorHandler.reportError(err, {
        handledBy: <span class="hljs-string">"pie.dataStore."</span> + storeName + <span class="hljs-string">"#get"</span>,
        key: key
      });

      <span class="hljs-keyword">return</span> pie.dataStore.ACCESS_ERROR;
    }
  };

  <span class="hljs-keyword">var</span> storageSet = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(storeName, key, value)</span> </span>{

    <span class="hljs-keyword">var</span> str;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">window</span>[storeName]) <span class="hljs-keyword">return</span> pie.dataStore.ACCESS_ERROR;

      str = <span class="hljs-built_in">JSON</span>.stringify(value);
      <span class="hljs-built_in">window</span>[storeName].setItem(key, str);

      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">catch</span>(err) {
      <span class="hljs-keyword">this</span>.app.errorHandler.reportError(err, {
        handledBy: <span class="hljs-string">"pie.dataStore."</span> + storeName + <span class="hljs-string">"#get"</span>,
        key: key,
        data: str
      });

      <span class="hljs-keyword">return</span> pie.dataStore.ACCESS_ERROR;
    }
  };

  <span class="hljs-keyword">var</span> storageClear = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(storeName, key)</span> </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">window</span>[storeName]) <span class="hljs-keyword">return</span> pie.dataStore.ACCESS_ERROR;
      <span class="hljs-built_in">window</span>[storeName].removeItem(key);
    } <span class="hljs-keyword">catch</span>(err) {
      <span class="hljs-keyword">this</span>.app.errorHandler.reportError(err, {
        handledBy: <span class="hljs-string">"pie.dataStore."</span> + storeName + <span class="hljs-string">"#clear"</span>,
        key: key
      });

      <span class="hljs-keyword">return</span> pie.dataStore.ACCESS_ERROR;
    }
  };

  <span class="hljs-keyword">return</span> {

    sessionStorage: {

      clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, parentStore)</span> </span>{
        <span class="hljs-keyword">return</span> storageClear.call(parentStore, <span class="hljs-string">'sessionStorage'</span>, key);
      },

      get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, parentStore)</span> </span>{
        <span class="hljs-keyword">return</span> storageGet.call(parentStore, <span class="hljs-string">'sessionStorage'</span>, key);
      },
      set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, parentStore)</span> </span>{
        <span class="hljs-keyword">return</span> storageSet.call(parentStore, <span class="hljs-string">'sessionStorage'</span>, key, value);
      }
    },

    localStorage: {

      clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, parentStore)</span> </span>{
        <span class="hljs-keyword">return</span> storageClear.call(parentStore, <span class="hljs-string">'localStorage'</span>, key);
      },

      get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, parentStore)</span> </span>{
        <span class="hljs-keyword">return</span> storageGet.call(parentStore, <span class="hljs-string">'localStorage'</span>, key);
      },
      set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, parentStore)</span> </span>{
        <span class="hljs-keyword">return</span> storageSet.call(parentStore, <span class="hljs-string">'localStorage'</span>, key, value);
      }

    },

    cookie: {

      clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">return</span> pie.browser.setCookie(key, <span class="hljs-literal">null</span>);
        } <span class="hljs-keyword">catch</span>(e) {
          <span class="hljs-keyword">return</span> pie.dataStore.ACCESS_ERROR;
        }
      },

      get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">var</span> json = pie.browser.getCookie(key);
          <span class="hljs-keyword">return</span> json != <span class="hljs-literal">null</span> ? <span class="hljs-built_in">JSON</span>.parse(json) : json;
        } <span class="hljs-keyword">catch</span>(e) {
          <span class="hljs-keyword">return</span> pie.dataStore.ACCESS_ERROR;
        }
      },

      set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value)</span> </span>{
        <span class="hljs-keyword">try</span>{
          <span class="hljs-keyword">var</span> json = <span class="hljs-built_in">JSON</span>.stringify(value);
          pie.browser.setCookie(key, json);
        } <span class="hljs-keyword">catch</span>(e) {
          <span class="hljs-keyword">return</span> pie.dataStore.ACCESS_ERROR;
        }
      }

    },

    backup: {

      clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, parentStore)</span> </span>{
        parentStore.backupModel.set(key, <span class="hljs-literal">undefined</span>);
      },

      get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, parentStore)</span> </span>{
        parentStore.backupModel.get(key);
      },

      set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, parentStore)</span> </span>{
        parentStore.backupModel.set(key, value);
      }

    }
  };
})();</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <h1 id="pie-view">Pie View</h1>
<p>Views are objects which wrap and interact with DOM. They hold reference to a single element via <code>this.el</code>. All
event obsrevation, delegation, and querying is conducted within the scope of the view’s <code>el</code>.</p>
<p>Views are equipped with an emitter. The emitter can be utilized for observing any type of lifecycle activity.
View lifecycle:</p>
<ul>
<li>init - the constructor</li>
<li>setup - if <code>setup: true</code> is provided to the constructor this will happen immediately after instantiation, otherwise this needs to be invoked.</li>
<li>attach - the stage in which the view’s el is added to the DOM.</li>
<li>user interaction</li>
<li>teardown - removes any added events from the dom elements, removes any model observations, removes the el from the dom, etc.</li>
<li>detach - when the view’s el is removed from the DOM.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view = pie.base.extend(<span class="hljs-string">'view'</span>, {

  __pieRole: <span class="hljs-string">'view'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p><strong>pie.view.init</strong></p>
<p>Options:</p>
<ul>
<li>el - (optional) the root element of the views control. if not provided, a new <div> will be created. <code>el</code> can be provided as an object. The tagName attribute will be use</li>
<li>app - (optional) the app this view is associated with.</li>
<li>uiTarget - (optional) element to attach to. if provided, after this view is set up it will automatically attach this element.</li>
<li>setup - (option) if truthy, this view’s setup function will be called directly after initialization.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">this</span>.options = options || {},
    <span class="hljs-keyword">this</span>.app = <span class="hljs-keyword">this</span>.options.app || pie.appInstance;

    <span class="hljs-keyword">if</span>(pie.object.isPlainObject(<span class="hljs-keyword">this</span>.options.el)) {
      <span class="hljs-keyword">this</span>.el = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-keyword">this</span>.options.el.tagName || <span class="hljs-string">'div'</span>);
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.options.el) {
        <span class="hljs-keyword">if</span>(key !== <span class="hljs-string">'tagName'</span>) {
          <span class="hljs-keyword">if</span>(key === <span class="hljs-string">'classes'</span>) {
            pie.dom.addClass(<span class="hljs-keyword">this</span>.el, <span class="hljs-keyword">this</span>.options.el[key]);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.el.setAttribute(key, <span class="hljs-keyword">this</span>.options.el[key]);
        }
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.el = <span class="hljs-keyword">this</span>.options.el || <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
    }

    <span class="hljs-keyword">this</span>.eventedEls = [];
    <span class="hljs-keyword">this</span>.changeCallbacks = {};

    <span class="hljs-keyword">this</span>.emitter = pie.emitter.create();

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.uiTarget) {
      <span class="hljs-keyword">this</span>.eonce(<span class="hljs-string">'setup:after'</span>, <span class="hljs-keyword">this</span>.addToDom.bind(<span class="hljs-keyword">this</span>));
    }

    <span class="hljs-keyword">this</span>._super();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p><strong>pie.view.addedToParent</strong></p>
<p>Accommodates the <code>addedToParent</code> hook event in pie.container.
Emits the event via the emitter, meaning this can be subscribed to in the init or setup process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addedToParent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'addedToParent'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p><strong>pie.view.addToDom</strong></p>
<p>A function which adds the view’s el to the DOM within target (or this.options.uiTarget).
An “attach” sequence is fired so views can control how they enter the DOM.
By default the element will be appended, if <code>prependInstead</code> is true the element will be
prepended. If preprendInstead is an element, the child will be prepended before target.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addToDom: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(target, prependInstead)</span> </span>{
    target = target || <span class="hljs-keyword">this</span>.options.uiTarget;
    <span class="hljs-keyword">if</span>(target !== <span class="hljs-keyword">this</span>.el.parentNode) {
      <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'attach'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">viewAttach</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">if</span>(prependInstead === <span class="hljs-literal">true</span> &amp;&amp; target.firstChild) target.insertBefore(<span class="hljs-keyword">this</span>.el, target.firstChild);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(prependInstead &amp;&amp; prependInstead !== <span class="hljs-literal">true</span>) target.insertBefore(<span class="hljs-keyword">this</span>.el, prependInstead);
        <span class="hljs-keyword">else</span> target.appendChild(<span class="hljs-keyword">this</span>.el);
      }.bind(<span class="hljs-keyword">this</span>));
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p><strong>pie.view.consumeEvent</strong></p>
<p>A utility method for consuming an event, and optionally immediately stopping propagation.</p>
<pre><code>clickCallback: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
  <span class="hljs-keyword">this</span>.consumeEvent(e);
  <span class="hljs-built_in">console</span>.log(e.delegateTarget.href);
}
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  consumeEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, immediate)</span> </span>{
    <span class="hljs-keyword">if</span>(e) {
      e.preventDefault();
      e.stopPropagation();
      <span class="hljs-keyword">if</span>(immediate) e.stopImmediatePropagation();
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p><strong>pie.view.eon</strong></p>
<p>Register an event with the emitter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  eon: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-keyword">this</span>._normalizedEmitterArgs(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emitter.on.apply(<span class="hljs-keyword">this</span>.emitter, args);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p><strong>pie.view.eoff</strong></p>
<p>Unregister an event from the emitter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  eoff: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(uid)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emitter.off(uid);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p><strong>pie.view.eonce</strong></p>
<p>Register an event once with the emitter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  eonce: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-keyword">this</span>._normalizedEmitterArgs(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">this</span>.emitter.once.apply(<span class="hljs-keyword">this</span>.emitter, args);
  },

  ewait: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-keyword">this</span>._normalizedEmitterArgs(<span class="hljs-built_in">arguments</span>, <span class="hljs-built_in">arguments</span>.length-<span class="hljs-number">1</span>);
    <span class="hljs-keyword">this</span>.emitter.waitUntil.apply(<span class="hljs-keyword">this</span>.emitter, args);
  },

  eprepend: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-keyword">this</span>._normalizedEmitterArgs(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">this</span>.emitter.prepend.apply(<span class="hljs-keyword">this</span>.emitter, args);
  },

  eprependonce: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-keyword">this</span>._normalizedEmitterArgs(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">this</span>.emitter.prependOnce.apply(<span class="hljs-keyword">this</span>.emitter, args);
  },

  _normalizedEmitterArgs: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args, fnStartIdx)</span> </span>{
    <span class="hljs-keyword">return</span> pie.array.from(args).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arg, i)</span> </span>{
      <span class="hljs-keyword">if</span>(pie.object.isString(arg) &amp;&amp; i &gt;= fnStartIdx) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[arg].bind(<span class="hljs-keyword">this</span>);
      <span class="hljs-keyword">return</span> arg;
    }.bind(<span class="hljs-keyword">this</span>));
  },

  isInApp: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> node = <span class="hljs-keyword">this</span>.parent;
    <span class="hljs-keyword">while</span>(node) {
      <span class="hljs-keyword">if</span>(pie.object.isApp(node)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      node = node.parent;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p><strong>pie.view.eventNamespace</strong></p>
<p>The namespace used for this view’s events. All views have a separate namespace to ensure
event triggers are propagated efficiently.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  eventNamespace: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">'view'</span>+ pie.uid(<span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p><strong>pie.view.on</strong></p>
<p>Observe a dom event and invoke the provided functions.
By default all events are delegated to this.el, but if you pass in an element as the last argument
that will be used. If the functions are provided as strings, they will be looked up on <code>this</code>.</p>
<pre><code>view.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-keyword">this</span>.handleClick.bind(<span class="hljs-keyword">this</span>), <span class="hljs-keyword">this</span>.trackClickEvent.bind(<span class="hljs-keyword">this</span>));
view.on(<span class="hljs-string">'submit'</span>, <span class="hljs-string">'form'</span>, <span class="hljs-string">'handleSubmit'</span>);
view.on(<span class="hljs-string">'resize'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'onResize'</span>, <span class="hljs-built_in">window</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  on: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* e, sel, f1, f2, f3, el */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> fns = pie.array.from(<span class="hljs-built_in">arguments</span>),
        events = fns.shift(),
        sel = fns.shift(),
        ns = <span class="hljs-keyword">this</span>.eventNamespace(),
        f2, el;

    el = pie.object.isDom(pie.array.last(fns)) ? fns.pop() : <span class="hljs-keyword">this</span>.el;

    <span class="hljs-keyword">if</span>(!~<span class="hljs-keyword">this</span>.eventedEls.indexOf(el)) <span class="hljs-keyword">this</span>.eventedEls.push(el);

    events = events.split(<span class="hljs-string">' '</span>);

    fns.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">viewOnIterator</span><span class="hljs-params">(fn)</span> </span>{
      fn = pie.object.isString(fn) ? <span class="hljs-keyword">this</span>[fn].bind(<span class="hljs-keyword">this</span>) : fn;

      f2 = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">viewEventNamespaceVerifier</span><span class="hljs-params">(e)</span></span>{
        <span class="hljs-keyword">if</span>(e.namespace === ns) {
          <span class="hljs-keyword">return</span> fn.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
        }
      };

      events.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">viewOnSubscriber</span><span class="hljs-params">(ev)</span> </span>{
        ev += <span class="hljs-string">"."</span> + ns;
        pie.dom.on(el, ev, f2, sel);
      }.bind(<span class="hljs-keyword">this</span>));

    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p><strong>pie.view.observe</strong></p>
<p>Observe changes of a model, unobserving them when the view is removed.
If the object is not observable, an error will be thrown.
The first argument is the observable model OR the function to be executed.
If the first argument is not a model, the model will be assumed to be <code>this.model</code>.
The next arguments (first or second) should be a function name or a function.
The remaining arguments are optional filter keys.</p>
<pre><code>view.observe(user, <span class="hljs-keyword">this</span>.onNameChange.bind(<span class="hljs-keyword">this</span>), <span class="hljs-string">'firstName'</span>, <span class="hljs-string">'lastName'</span>);
view.observe(context, <span class="hljs-keyword">this</span>.onContextChange.bind(<span class="hljs-keyword">this</span>));
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  observe: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
    observable = pie.object.isModel(args[<span class="hljs-number">0</span>]) ? args.shift() : <span class="hljs-keyword">this</span>.model;

    <span class="hljs-keyword">if</span>(!pie.object.has(observable, <span class="hljs-string">'observe'</span>, <span class="hljs-literal">true</span>)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Observable does not respond to observe"</span>);

    <span class="hljs-keyword">if</span>(pie.object.isString(args[<span class="hljs-number">0</span>])) args[<span class="hljs-number">0</span>] = <span class="hljs-keyword">this</span>[args[<span class="hljs-number">0</span>]].bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">var</span> callback = {
      observable: observable,
      args: args
    };

    <span class="hljs-keyword">var</span> uid = pie.uid(callback);

    <span class="hljs-keyword">this</span>.changeCallbacks[uid] = callback;

    observable.observe.apply(observable, args);

    <span class="hljs-keyword">return</span> uid;
  },

  unobserve: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(uid)</span> </span>{
    <span class="hljs-keyword">var</span> a = <span class="hljs-keyword">this</span>.changeCallbacks[uid];
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.changeCallbacks[uid];
    a.observable.unobserve.apply(a.observable, a.args);
  },

  onChange: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.app.debug.apply(<span class="hljs-keyword">this</span>.app, pie._debugArgs(<span class="hljs-string">"view#onChange is deprected. Please use view#observe instead."</span>));
    <span class="hljs-keyword">this</span>.observe.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p><strong>pie.view.qs</strong></p>
<p>Shortcut for this.el.querySelector</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  qs: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(selector)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.el.querySelector(selector);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p><strong>pie.view.qsa</strong></p>
<p>shortcut for this.el.querySelectorAll</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  qsa: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(selector)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.el.querySelectorAll(selector);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p><strong>pie.view.removeFromDom</strong></p>
<p>Assuming the view’s el is in the DOM, a detach sequence will be invoked, resulting in the el being removed.
Note we don’t use pie.dom.remove since we know we’re cleaning up our events. Multiple views could be associated
with the same el.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removeFromDom: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.el.parentNode) {
      <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'detach'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">viewDetach</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.el.parentNode.removeChild(<span class="hljs-keyword">this</span>.el);
      }.bind(<span class="hljs-keyword">this</span>));
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p><strong>pie.view.removedFromParent</strong></p>
<p>Accommodates the <code>removedFromParent</code> hook event in pie.container.
It emits a <code>removedFromParent</code> event which can be observed in the setup process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removedFromParent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'removedFromParent'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p><strong>pie.view.setup</strong></p>
<p>Placeholder for default functionality.
By default, the setup event is triggered on the emitter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'setup'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p><strong>pie.view.cancelSetup</strong></p>
<p>Sometimes when a view is being set up it determines that the app has to redirect and/or it’s
no longer relevant to the page. If you do not conduct a full setup process this function will
short circuit the process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cancelSetup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'setup:after'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p><strong>pie.view.teardown</strong></p>
<p>This function should be invoked when it’s ready to dismiss the view.
Upon invocation, a <code>teardown</code> sequence is emitted.
When teardown runs, the view’s <code>el</code> is removed from the dom, all observations are removed,
and all children have teardown invoked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  teardown: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'teardown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">viewTeardown</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">this</span>.removeFromDom();

      <span class="hljs-keyword">this</span>._unobserveEvents();
      <span class="hljs-keyword">this</span>._unobserveChangeCallbacks();

      <span class="hljs-keyword">this</span>.teardownChildren();
      <span class="hljs-comment">/* views remove their children upon removal to ensure all irrelevant observations are cleaned up. */</span>
      <span class="hljs-keyword">this</span>.removeChildren();

    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p><strong>pie.view.teardownChildren</strong></p>
<p>Invokes teardown on each child that responds to it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  teardownChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.children.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">viewChildrenTeardown</span><span class="hljs-params">(child)</span> </span>{
      <span class="hljs-keyword">if</span>(pie.object.has(child, <span class="hljs-string">'teardown'</span>, <span class="hljs-literal">true</span>)) child.teardown();
    });
  },

  <span class="hljs-comment">/* release all observed events. */</span>
  _unobserveEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> key = <span class="hljs-string">'*.'</span> + <span class="hljs-keyword">this</span>.eventNamespace();
    <span class="hljs-keyword">this</span>.eventedEls.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
      pie.dom.off(el, key);
    });
  },

  <span class="hljs-comment">/* release all change callbacks. */</span>
  _unobserveChangeCallbacks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.changeCallbacks).forEach(<span class="hljs-keyword">this</span>.unobserve.bind(<span class="hljs-keyword">this</span>));
  }

}, pie.mixins.container);


<span class="hljs-comment">/* true create function overriden to invoke setup after init() is finished if `setup:true` was provided as an option */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> existing = pie.view.create;
  pie.view.create = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> instance = existing.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">if</span>(instance.options.setup) instance.setup();
    <span class="hljs-keyword">return</span> instance;
  };
})();
pie.activeView = pie.view.extend(<span class="hljs-string">'activeView'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">if</span>(pie.object.isString(options)) options = {template: options};
    <span class="hljs-keyword">this</span>._super(options);
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.model &amp;&amp; <span class="hljs-keyword">this</span>.options.model) <span class="hljs-keyword">this</span>.model = <span class="hljs-keyword">this</span>.options.model;
    <span class="hljs-keyword">this</span>.refs = {};
  },

  setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.autoRender &amp;&amp; <span class="hljs-keyword">this</span>.model) {
      <span class="hljs-keyword">var</span> field = pie.object.isString(<span class="hljs-keyword">this</span>.options.autoRender) ? <span class="hljs-keyword">this</span>.options.autoRender : <span class="hljs-string">'__version'</span>;
      <span class="hljs-keyword">this</span>.observe(<span class="hljs-keyword">this</span>.model, <span class="hljs-string">'render'</span>, field);
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.renderOnSetup || <span class="hljs-keyword">this</span>.options.renderOnSetup === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">this</span>.eonce(<span class="hljs-string">'setup'</span>, <span class="hljs-string">'render'</span>);
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.refs) {
      <span class="hljs-keyword">this</span>.setupRefs();
      <span class="hljs-keyword">this</span>.eprepend(<span class="hljs-string">'render:after'</span>, <span class="hljs-string">'clearRefCache'</span>);
    }

    <span class="hljs-keyword">this</span>.eon(<span class="hljs-string">'render'</span>, <span class="hljs-string">'_renderTemplateToEl'</span>);

    <span class="hljs-keyword">this</span>._super();
  },

  hasChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">var</span> f = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boundRenderChild</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._renderChild(options); }.bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">var</span> events = options.events;
    <span class="hljs-keyword">if</span>(events === <span class="hljs-literal">undefined</span>) events = [<span class="hljs-string">'render:after'</span>];

    pie.array.from(events).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
      <span class="hljs-keyword">this</span>.eon(e, f);
    }.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">return</span> f;
  },

  _renderChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.isInApp()) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> factory = options.factory,
    transitionClass = options.viewTransitionClass || pie.simpleViewTransition,
    childName = options.name,
    current = <span class="hljs-keyword">this</span>.getChild(childName),
    instance = current,
    target = options.sel,
    filter = pie.object.isString(options.filter) ? <span class="hljs-keyword">this</span>[options.filter].bind(<span class="hljs-keyword">this</span>) : options.filter,
    blocker = pie.object.isString(options.blocker) ? <span class="hljs-keyword">this</span>[options.blocker].bind(<span class="hljs-keyword">this</span>) : options.blocker,
    info = {
      childName: childName,
      current: <span class="hljs-keyword">this</span>.getChild(childName),
    },
    trans;

    <span class="hljs-keyword">if</span>(pie.object.isString(target)) target = <span class="hljs-keyword">this</span>.qs(target);

    info.target = target;</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>if we have no place to put our view or we’ve been filtered, remove the current child</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!target || (filter &amp;&amp; filter() === <span class="hljs-literal">false</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>if there is a current view, make sure we tear this dude down.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(current) {
        <span class="hljs-keyword">this</span>.removeChild(current);
        current.teardown();
      }

      <span class="hljs-keyword">this</span>.emitter.fire(childName + <span class="hljs-string">':teardown'</span>, info);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.emitter.fire(childName + <span class="hljs-string">':manage:before'</span>, info);

    <span class="hljs-keyword">var</span> aroundTrigger = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">this</span>.emitter.fireAround(childName + <span class="hljs-string">':manage:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">activeViewRenderChild</span><span class="hljs-params">()</span> </span>{

        instance = factory(current);

        <span class="hljs-keyword">if</span>(!current &amp;&amp; !instance) <span class="hljs-keyword">return</span>;

        info.instance = instance;</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>if we are dealing with the same instance, make sure we don’t remove it, only add it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(current === instance) {</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>if we’re still attached to the previous render, move us to the new one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>(!target.contains(current.el)) current.addToDom(target);
          <span class="hljs-keyword">this</span>.emitter.fire(childName + <span class="hljs-string">':manage'</span>, info);
          <span class="hljs-keyword">this</span>.emitter.fire(childName + <span class="hljs-string">':manage:after'</span>, info);
          <span class="hljs-keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>there’s a child and a target.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        trans = transitionClass.create(<span class="hljs-keyword">this</span>, pie.object.merge(options.viewTransitionOptions, {
          targetEl: target,
          childName: childName,
          oldChild: current,
          newChild: instance
        }));


        info.transition = trans;
        <span class="hljs-keyword">this</span>.emitter.fire(childName + <span class="hljs-string">':manage'</span>, info);

        trans.transition(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
          <span class="hljs-keyword">this</span>.emitter.fire(childName + <span class="hljs-string">':manage:after'</span>, info);
        }.bind(<span class="hljs-keyword">this</span>));

      }.bind(<span class="hljs-keyword">this</span>));
    }.bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">if</span>(blocker) blocker(aroundTrigger);
    <span class="hljs-keyword">else</span> aroundTrigger();
  },

  _renderTemplateToEl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> templateName = pie.fn.valueFrom(<span class="hljs-keyword">this</span>.templateName, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">if</span>(templateName) {
      <span class="hljs-keyword">this</span>.app.templates.renderAsync(templateName, <span class="hljs-keyword">this</span>.renderData(), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">activeViewOnTemplateReady</span><span class="hljs-params">(content)</span></span>{
        <span class="hljs-keyword">this</span>.el.innerHTML = content;
        <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'render:after'</span>);
      }.bind(<span class="hljs-keyword">this</span>));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'render:after'</span>);
    }
  },

  renderData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.model) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.model.data;
    }

    <span class="hljs-keyword">return</span> {};
  },

  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'render:before'</span>);
    <span class="hljs-keyword">this</span>.emitter.fireAround(<span class="hljs-string">'render:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">activeViewRender</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>render:after should be fired by the render implementation.
There’s the possibility that a template needs to be fetched from a remote source.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'render'</span>);
    }.bind(<span class="hljs-keyword">this</span>));
  },

  templateName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.options.template;
  },

  setupRefs: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> refs = {};
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-built_in">Object</span>.defineProperty(refs, <span class="hljs-string">'_cache'</span>, {
      iteratable: <span class="hljs-literal">false</span>,
      writable: <span class="hljs-literal">true</span>
    });

    refs.fetch = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span></span>{
      <span class="hljs-keyword">delete</span> refs._cache[name];
      <span class="hljs-keyword">return</span> refs[name];
    };

    refs._cache = {};

    pie.object.forEach(self.options.refs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{

      <span class="hljs-built_in">Object</span>.defineProperty(refs, k, {
        iteratable: <span class="hljs-literal">false</span>,
        get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">if</span>(pie.object.has(refs._cache, k)) <span class="hljs-keyword">return</span> refs._cache[k];
          <span class="hljs-keyword">return</span> refs._cache[k] = self.qs(v);
        }
      });

    });

    self[self.options.refsName || <span class="hljs-string">'dom'</span>] = refs;
  },

  clearRefCache: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>[<span class="hljs-keyword">this</span>.options.refsName || <span class="hljs-string">'dom'</span>]._cache = {};
  }

});
pie.ajaxRequest = pie.model.extend(<span class="hljs-string">'ajaxRequest'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super(data, options);

    <span class="hljs-keyword">this</span>.getOrSet(<span class="hljs-string">'headers'</span>, {});

    <span class="hljs-keyword">this</span>.xhr = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.emitter = pie.emitter.create();

    <span class="hljs-keyword">this</span>.validates({
      url: { presence: <span class="hljs-literal">true</span> },
      verb: { inclusion: { <span class="hljs-keyword">in</span>: pie.object.values(<span class="hljs-keyword">this</span>.VERBS) }}
    }, <span class="hljs-literal">null</span>);
  },

  VERBS: {
    del: <span class="hljs-string">'DELETE'</span>,
    get: <span class="hljs-string">'GET'</span>,
    patch: <span class="hljs-string">'PATCH'</span>,
    post: <span class="hljs-string">'POST'</span>,
    put: <span class="hljs-string">'PUT'</span>
  },

  _append: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, fns, immediate)</span> </span>{
    fns = pie.array.change(fns, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>);
    fns.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span></span>{
      <span class="hljs-keyword">this</span>.emitter.on(name, fn, {immediate: immediate});
    }.bind(<span class="hljs-keyword">this</span>));
  },

  _onDataSuccess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'dataSuccess'</span>, data);
  },

  _onSetModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'setModel'</span>, data);
  },

  _onSuccess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, xhr)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'success'</span>, data, xhr);
  },

  _onComplete: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'complete'</span>, xhr);
  },

  _onError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'error'</span>, xhr);
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'extraError'</span>, xhr);
  },

  _onProgress: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'progress'</span>, event);
  },

  _onUploadProgress: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'uploadProgress'</span>, event);
  },

  _parseOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">if</span>(!options) <span class="hljs-keyword">return</span>;

    options = pie.object.merge({}, options);

    [<span class="hljs-string">'setup'</span>, <span class="hljs-string">'complete'</span>, <span class="hljs-string">'dataSuccess'</span>, <span class="hljs-string">'error'</span>, <span class="hljs-string">'extraError'</span>, <span class="hljs-string">'progress'</span>, <span class="hljs-string">'success'</span>, <span class="hljs-string">'uploadProgress'</span>, <span class="hljs-string">'setModel'</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span></span>{
      <span class="hljs-keyword">if</span>(options[n]) {

        pie.array.from(options[n]).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span></span>{
          <span class="hljs-keyword">this</span>[n](fn);
        }.bind(<span class="hljs-keyword">this</span>));

        <span class="hljs-keyword">delete</span> options[n];
      }
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">this</span>.sets(options);
  },

  _validateOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>upcase before we validate inclusion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'verb'</span>)) <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'verb'</span>, <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'verb'</span>).toUpperCase());

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.validateAll().catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'validationErrors'</span>)));
    }.bind(<span class="hljs-keyword">this</span>));
  },

  _applyHeaders: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{

    <span class="hljs-keyword">var</span> accept = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'accept'</span>),
    contentType = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'contentType'</span>),
    headers = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'headers'</span>),
    data = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'data'</span>);

    <span class="hljs-keyword">this</span>._applyCsrfToken(xhr);

    <span class="hljs-keyword">if</span>(accept) {
      headers[<span class="hljs-string">'Accept'</span>] = accept;
    }

    <span class="hljs-keyword">if</span>(contentType !== <span class="hljs-literal">false</span>) {

      <span class="hljs-keyword">if</span>(contentType) {
        headers[<span class="hljs-string">'Content-Type'</span>] = contentType;
      }

      <span class="hljs-keyword">if</span>(!headers[<span class="hljs-string">'Content-Type'</span>]) {
        <span class="hljs-keyword">if</span>(pie.object.isString(data) || pie.object.instanceOf(data, <span class="hljs-string">'FormData'</span>)) {
          headers[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'application/x-www-form-urlencoded'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>if we aren’t already sending a string, we will encode to json.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {
          headers[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'application/json'</span>;
        }
      }

    }

    <span class="hljs-keyword">if</span>(!headers[<span class="hljs-string">'X-Requested-With'</span>]) {
      headers[<span class="hljs-string">'X-Requested-With'</span>] = <span class="hljs-string">'XMLHttpRequest'</span>;
    }

    pie.object.forEach(headers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
      xhr.setRequestHeader(k, v);
    });

  },

  _applyCsrfToken: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{

    <span class="hljs-keyword">var</span> token = pie.fn.valueFrom(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'csrfToken'</span>)) || <span class="hljs-keyword">this</span>.app.cache.fetch(<span class="hljs-string">'csrfToken'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">var</span> el = pie.qs(<span class="hljs-string">'meta[name="csrf-token"]'</span>);
      <span class="hljs-keyword">return</span> el ? el.getAttribute(<span class="hljs-string">'content'</span>) : <span class="hljs-literal">null</span>;
    });

    <span class="hljs-keyword">if</span>(token) {
      xhr.setRequestHeader(<span class="hljs-string">'X-CSRF-Token'</span>, token);
    }
  },

  _parseResponse: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
    <span class="hljs-keyword">var</span> accept = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'accept'</span>),
    parser = accept &amp;&amp; <span class="hljs-keyword">this</span>.responseParsers[accept] || <span class="hljs-keyword">this</span>.responseParsers.default;
    xhr.data = <span class="hljs-keyword">this</span>.response = parser.call(<span class="hljs-keyword">this</span>, xhr);
  },

  responseParsers: {

    <span class="hljs-string">"application/json"</span> : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
      <span class="hljs-keyword">try</span>{
        <span class="hljs-keyword">return</span> xhr.responseText.trim().length ? <span class="hljs-built_in">JSON</span>.parse(xhr.responseText) : {};
      } <span class="hljs-keyword">catch</span>(err) {
        <span class="hljs-keyword">this</span>.app.debug.apply(<span class="hljs-keyword">this</span>.app, pie._debugArgs(<span class="hljs-string">"could not parse JSON response: "</span> + err));
        <span class="hljs-keyword">return</span> {};
      }
    },

    <span class="hljs-string">"default"</span> : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
      <span class="hljs-keyword">return</span> xhr.responseText;
    }
  },

  _buildXhr: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest(),
    url = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'url'</span>),
    verb = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'verb'</span>),
    data = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'data'</span>),
    tracker = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'tracker'</span>),
    timeout = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'timeout'</span>),
    self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span>(verb === <span class="hljs-keyword">this</span>.VERBS.get &amp;&amp; data) {
      url = pie.string.urlConcat(url, pie.object.serialize(data));
    }

    url = pie.string.normalizeUrl(url);

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.hasCallback(<span class="hljs-string">'progress'</span>)) {
      xhr.addEventListener(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">this</span>._onProgress.bind(<span class="hljs-keyword">this</span>), <span class="hljs-literal">false</span>);
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.hasCallback(<span class="hljs-string">'uploadProgress'</span>)) {
      xhr.upload.addEventListener(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">this</span>._onUploadProgress.bind(<span class="hljs-keyword">this</span>), <span class="hljs-literal">false</span>);
    }

    xhr.open(verb, url, <span class="hljs-literal">true</span>);

    <span class="hljs-keyword">this</span>._applyHeaders(xhr);
    <span class="hljs-keyword">if</span>(timeout) xhr.timeout = timeout;

    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'setup'</span>, xhr, <span class="hljs-keyword">this</span>);


    xhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span>(tracker) tracker(xhr, self);

      self._parseResponse(xhr);

      <span class="hljs-keyword">if</span>(xhr.status &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.status &lt; <span class="hljs-number">300</span> || xhr.status === <span class="hljs-number">304</span>) {
        self._onDataSuccess(self.response);
        self._onSetModel(self.response);
        self._onSuccess(self.response, xhr);
      } <span class="hljs-keyword">else</span> {
        self._onError(xhr);
      }

      self._onComplete(xhr);
    };

    xhr.onerror = xhr.ontimeout = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      self._onError(xhr);
      self._onComplete(xhr);
    };

    <span class="hljs-keyword">this</span>.xhr = xhr;

    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'xhrBuilt'</span>);

    <span class="hljs-keyword">return</span> xhr;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>Validate the options and build the xhr object.
By default, it immediately sends the request.
By passing <code>skipSend = false</code> you can manage the <code>send()</code> invocation manually.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  build: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    <span class="hljs-keyword">this</span>._parseOptions(options);
    <span class="hljs-keyword">this</span>._validateOptions().then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">this</span>._buildXhr();
      <span class="hljs-keyword">if</span>(!skipSend) <span class="hljs-keyword">this</span>.send();
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>Send the xhr. Assumes build() has been called.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  send: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'data'</span>), d;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'verb'</span>) !== <span class="hljs-keyword">this</span>.VERBS.get) {

      <span class="hljs-keyword">if</span>(pie.object.isString(data) || pie.object.instanceOf(data, <span class="hljs-string">'FormData'</span>)) {
        d = data;
      } <span class="hljs-keyword">else</span> {
        d = <span class="hljs-built_in">JSON</span>.stringify(pie.object.compact(data));
      }
    }

    <span class="hljs-keyword">this</span>.xhr.send(d);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>Check if a callback is registered for a specific event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasCallback: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emitter.hasCallback(eventName);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>Register callbacks to be invoked as part of the setup process.
Callbacks are provided with the xhr &amp; the request object (this).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'setup'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>Utility method for clearing previous / default events out
request.clear(‘error’).error(myErrorHandler);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.clear(eventName);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <p>Register a callback for when the request is complete.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  complete: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'complete'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <p>Register a callback which will only receive the parsed data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dataSuccess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'dataSuccess'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p>Register a callback when the request is unsuccessful.
<code>app.ajax</code> will provide a default error callback as long as the <code>error</code> callbacks are empty.
If you would like the default &amp; your error callback, use extraError.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'error'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <p>Register a callback when the request is unsuccessful.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  extraError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'extraError'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  setModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> fns = pie.array.from(<span class="hljs-built_in">arguments</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span></span>{ <span class="hljs-keyword">return</span> m.sets.bind(m); });
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'setModel'</span>, fns, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <p>Register a callback when the request succeeds.
Callbacks are invoked with the parsed response &amp; the xhr object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'success'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p>Register a callback to be invoked when progress events are triggered from the request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  progress: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'progress'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>Register a callback to be invoked when upload progress events are triggered from the request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  uploadProgress: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'uploadProgress'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  promise: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._promise) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._promise;
    <span class="hljs-keyword">this</span>._promise = pie.promise.create(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve, reject)</span> </span>{
      <span class="hljs-keyword">this</span>.dataSuccess(resolve);
      <span class="hljs-keyword">this</span>.error(reject);
    }.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._promise;
  }

}, pie.mixins.validatable);
pie.ajax = pie.base.extend(<span class="hljs-string">'ajax'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span></span>{
    <span class="hljs-keyword">this</span>.app = app;
    <span class="hljs-keyword">this</span>._super();
  },

  defaultAjaxOptions: {
    verb: <span class="hljs-string">'GET'</span>,
    accept: <span class="hljs-string">'application/json'</span>,
    headers: {}
  },

  _normalizeOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">if</span>(pie.object.isString(options)) options = {url: options};
    <span class="hljs-keyword">return</span> options;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p>Interface for conducting ajax requests.
Returns a pie.ajaxRequest object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ajax: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.deepMerge({}, <span class="hljs-keyword">this</span>.defaultAjaxOptions, <span class="hljs-keyword">this</span>._normalizeOptions(options));

    <span class="hljs-keyword">var</span> request = pie.ajaxRequest.create({}, { app: <span class="hljs-keyword">this</span>.app });
    request.build(options, skipSend);

    <span class="hljs-comment">/* add a default error handler if the user hasn't provided one. */</span>
    <span class="hljs-keyword">if</span>(!request.emitter.hasCallback(<span class="hljs-string">'error'</span>)) {
      request.error(<span class="hljs-keyword">this</span>.app.errorHandler.handleXhrError.bind(<span class="hljs-keyword">this</span>.app.errorHandler));
    }

    <span class="hljs-keyword">return</span> request;
  },


  del: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.merge({verb: <span class="hljs-string">'DELETE'</span>}, <span class="hljs-keyword">this</span>._normalizeOptions(options));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options, skipSend);
  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.merge({verb: <span class="hljs-string">'GET'</span>}, <span class="hljs-keyword">this</span>._normalizeOptions(options));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options, skipSend);
  },

  patch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.merge({verb: <span class="hljs-string">'PATCH'</span>}, <span class="hljs-keyword">this</span>._normalizeOptions(options));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options, skipSend);
  },

  post: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.merge({verb: <span class="hljs-string">'POST'</span>}, <span class="hljs-keyword">this</span>._normalizeOptions(options));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options, skipSend);
  },

  put: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.merge({verb: <span class="hljs-string">'PUT'</span>}, <span class="hljs-keyword">this</span>._normalizeOptions(options));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options, skipSend);
  }

});
pie.appState = pie.model.extend(<span class="hljs-string">'appState'</span>, {

  infoIgnore: <span class="hljs-regexp">/^__/</span>,

  parseInfo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
    <span class="hljs-keyword">var</span> out = {}, r = <span class="hljs-keyword">this</span>.infoIgnore;
    pie.object.forEach(d, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
      <span class="hljs-keyword">if</span>(!r.test(k)) out[k] = v;
    });
    <span class="hljs-keyword">return</span> out;
  },

  thingsThatCareAboutStateChanges: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">this</span>.app.router];
  },

  transition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, skipHistory)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <p>no change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.test(<span class="hljs-string">'__fullId'</span>, id)) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> pq = <span class="hljs-keyword">this</span>.app.pathHelper.pathAndQuery(id);
    <span class="hljs-keyword">var</span> changes = [{}, pq.query];

    <span class="hljs-keyword">this</span>.thingsThatCareAboutStateChanges().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stateWillChangeIterator</span><span class="hljs-params">(thing)</span> </span>{
      changes.push(thing.stateWillChange(pq.path, pq.query));
    });


    changes = pie.object.merge.apply(<span class="hljs-literal">null</span>, changes);

    <span class="hljs-keyword">var</span> info = <span class="hljs-keyword">this</span>.parseInfo(changes);

    pie.object.merge(changes, {
      __id: pq.path,
      __query: pq.query || {},
      __fullId: id,
      __history: !skipHistory,
      __info: info
    });


    <span class="hljs-keyword">this</span>.setData(changes);
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <h1 id="pie-emitter">Pie Emitter</h1>
<p>An emitter is an event subscriber &amp; notifier. It’s similar to a pubsub implementation but
allows for blocking of an event via <code>around</code> callbacks. It’s similar to a promise implementation,
but doesn’t worry itself with the result of the underlying functions.</p>
<pre><code><span class="hljs-keyword">var</span> emitter = pie.emitter.create();

emitter.on(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{} );
emitter.prepend(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{} );

emitter.once(<span class="hljs-string">'bar:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{} );
emitter.prependOnce(<span class="hljs-string">'bar:before'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{} );
emitter.once(<span class="hljs-string">'bar:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{} );

emitter.fire(<span class="hljs-string">'foo'</span>);
emitter.fireSequence(<span class="hljs-string">'bar'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.emitter = pie.model.extend(<span class="hljs-string">'emitter'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      triggeredEvents: {},
      eventCallbacks: {}
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              <p><strong> pie.emitter.clear </strong></p>
<p>Remove any events registered under <code>eventName</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'eventCallbacks.'</span> + eventName, <span class="hljs-literal">undefined</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p><strong> pie.emitter.hasEvent </strong></p>
<p>Has the event <code>eventName</code> been triggered by this emitter yet?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">return</span> !!<span class="hljs-keyword">this</span>.firedCount(eventName);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <p><strong> pie.emitter.hasCallback </strong></p>
<p>Is there a callback for the event <code>eventName</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasCallback: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">var</span> cbs = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eventCallbacks.'</span> + eventName);
    <span class="hljs-keyword">return</span> !!(cbs &amp;&amp; cbs.length);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              <p><strong> pie.emitter.firedCount </strong></p>
<p>Count the number of times an event has been triggered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  firedCount: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'triggeredEvents.'</span> + eventName + <span class="hljs-string">'.count'</span>) || <span class="hljs-number">0</span>;
  },

  lastInvocation: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'triggeredEvents.'</span> + eventName + <span class="hljs-string">'.lastArgs'</span>) || [];
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p><strong> pie.emitter.waitUntil </strong></p>
<p>Wait until all <code>eventNames</code> have been fired before invoking <code>fn</code>.</p>
<pre><code>emitter.waitUntil(<span class="hljs-string">'setup:after'</span>, <span class="hljs-string">'render:after'</span>, <span class="hljs-keyword">this</span>.highlightNav.bind(<span class="hljs-keyword">this</span>));
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  waitUntil: (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

    <span class="hljs-keyword">var</span> invalidEventNameRegex = <span class="hljs-regexp">/:around$/</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* eventNames, fn */</span>)</span> </span>{
      <span class="hljs-keyword">var</span> eventNames = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>),
      fn = eventNames.pop(),
      observers;

      observers = eventNames.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span></span>{
        <span class="hljs-keyword">if</span>(invalidEventNameRegex.test(event)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(event + <span class="hljs-string">" is not supported by waitUntil."</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">this</span>.once(event, cb, {immediate: <span class="hljs-literal">true</span>});
        }.bind(<span class="hljs-keyword">this</span>);
      }.bind(<span class="hljs-keyword">this</span>));

      pie.fn.async(observers, fn);
    };
  })(),</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <h4 id="event-observation">Event Observation</h4>

            </div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p><strong> pie.emitter._on </strong></p>
<p>Append or prepend a function <code>fn</code> via <code>meth</code> to the callbacks registered under <code>event</code>.
Options are as follows:</p>
<ul>
<li><strong>immediate</strong> - trigger the <code>fn</code> immediately if the <code>event</code> has been fired in the past.</li>
<li><strong>onceOnly</strong> - trigger the <code>fn</code> a single time then remove the observer.</li>
</ul>
<p><em>Note that if <code>immediate</code> and <code>onceOnly</code> are provided as options and the event has been previously
triggered, the function will be invoked and nothing will be added to the callbacks.</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _on: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options, meth)</span> </span>{
    options = options || {};

    <span class="hljs-keyword">if</span>(options.waitUntil) {

      <span class="hljs-keyword">var</span> origFn = fn,
      waitUntil = pie.array.from(options.waitUntil),
      o = pie.object.except(options, <span class="hljs-string">'waitUntil'</span>);
      o.immediate = <span class="hljs-literal">true</span>;

      fn = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.waitUntil(waitUntil, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
          <span class="hljs-keyword">this</span>._on(event, origFn, o, meth);
        }.bind(<span class="hljs-keyword">this</span>));
      }.bind(<span class="hljs-keyword">this</span>);

      fn.wrapper = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">var</span> lastArgs = <span class="hljs-keyword">this</span>.lastInvocation(event);

    <span class="hljs-keyword">if</span>(options.now || (options.immediate &amp;&amp; <span class="hljs-keyword">this</span>.hasEvent(event))) {
      fn.apply(<span class="hljs-literal">null</span>, lastArgs);
      <span class="hljs-keyword">if</span>(options.onceOnly) <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> storage = pie.object.merge({fn: fn, event: event}, options);
    <span class="hljs-keyword">var</span> uid = pie.uid(storage);

    <span class="hljs-keyword">this</span>.getOrSet(<span class="hljs-string">'eventCallbacks.'</span> + event, [])[meth](storage);
    <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eventCallbacks'</span>)[uid] = storage;

    <span class="hljs-keyword">return</span> uid;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>Same method signature of <code>_on</code>, but handles the inclusion of the <code>onceOnly</code> option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _once: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options, meth)</span> </span>{
    options = pie.object.merge({onceOnly: <span class="hljs-literal">true</span>}, options);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._on(event, fn, options, meth);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p><strong> pie.emitter.on </strong></p>
<p>Public interface for invoking <code>_on</code> &amp; pushing an event to the end of the callback chain.</p>
<pre><code>emitter.on(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
emitter.on(<span class="hljs-string">'foo:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  on: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._on(event, fn, options, <span class="hljs-string">'push'</span>);
  },

  off: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(uid)</span> </span>{
    <span class="hljs-keyword">var</span> storage = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eventCallbacks.'</span> + uid);
    <span class="hljs-keyword">if</span>(!storage) <span class="hljs-keyword">return</span>;
    pie.array.remove(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eventCallbacks.'</span> + storage.event), storage);
    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'eventCallbacks.'</span> + uid, <span class="hljs-literal">undefined</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p><strong> pie.emitter.prepend </strong></p>
<p>Public interface for invoking <code>_on</code> &amp; prepending an event to the beginning of the callback chain.</p>
<pre><code>emitter.prepend(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  prepend: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._on(event, fn, options, <span class="hljs-string">'unshift'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p><strong> pie.emitter.once </strong></p>
<p>Public interface for invoking <code>_once</code> &amp; pushing an event to the end of the callback chain.</p>
<pre><code>emitter.once(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{}, {immediate: <span class="hljs-literal">true</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  once: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._once(event, fn, options, <span class="hljs-string">'push'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p><strong> pie.emitter.prependOnce </strong></p>
<p>Public interface for invoking <code>_once</code> &amp; prepending an event to the beginning of the callback chain.</p>
<pre><code>emitter.prependOnce(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  prependOnce: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._once(event, fn, options, <span class="hljs-string">'unshift'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <h4 id="event-triggering">Event Triggering</h4>

            </div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <p><strong> pie.emitter._reportTrigger </strong></p>
<p>Increment our <code>triggeredEvents</code> counter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _reportTrigger: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, args)</span> </span>{
    <span class="hljs-keyword">var</span> triggered = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'triggeredEvents'</span>);
    <span class="hljs-keyword">if</span>(!triggered[event]) triggered[event] = {count: <span class="hljs-number">0</span>};
    triggered[event].lastArgs = args;
    triggered[event].count = triggered[event].count + <span class="hljs-number">1</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              <p><strong> pie.emitter.fire </strong></p>
<p>Trigger an <code>event</code> causing any registered callbacks to be fired.
Any callbacks associated with that event will be invoked with the arguments supplied by positions 1-N.</p>
<pre><code>emitter.fire(<span class="hljs-string">'userSignedUp'</span>, <span class="hljs-string">'Doug Wilson'</span>);
<span class="hljs-comment">//=&gt; invokes all registered callbacks of the `userSignedUp` event with a single argument, "Doug Wilson".</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  fire: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* event, arg1, arg2, */</span>)</span> </span>{

    <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
    event = args.shift(),
    callbacks = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eventCallbacks.'</span> + event),
    compactNeeded = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">/* increment our trigger counters */</span>
    <span class="hljs-keyword">this</span>._reportTrigger(event, args);

    <span class="hljs-keyword">if</span>(callbacks) {
      callbacks.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emitterFireCallback</span><span class="hljs-params">(cb, i)</span> </span>{
        <span class="hljs-comment">/* invoke the function for the callback */</span>
        cb.fn.apply(<span class="hljs-literal">null</span>, args);
        <span class="hljs-comment">/* if the function is `onceOnly`, clear it out */</span>
        <span class="hljs-keyword">if</span>(cb.onceOnly) {
          compactNeeded = <span class="hljs-literal">true</span>;
          callbacks[i] = <span class="hljs-literal">undefined</span>;
        }
      });
    }

    <span class="hljs-comment">/* if we removed callbacks, clean up */</span>
    <span class="hljs-keyword">if</span>(compactNeeded) <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'eventCallbacks.'</span> + event, pie.array.compact(callbacks));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p><strong> pie.emitter.fireSequence </strong></p>
<p>Fire a sequence of events based on base event name of <code>event</code>.
Optionally, provide a function <code>fn</code> which will be invoked before the base event is fired.</p>
<pre><code>emitter.fireSequence(<span class="hljs-string">'foo'</span>, barFn);
<span class="hljs-comment">//=&gt; invokes the following sequence:</span>
<span class="hljs-comment">// fires "foo", fires "foo:around", invokes barFn, fires "foo", fires "foo:after"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  fireSequence: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn)</span> </span>{
    <span class="hljs-keyword">var</span> before = event + <span class="hljs-string">':before'</span>,
        after  = event + <span class="hljs-string">':after'</span>,
        around = event + <span class="hljs-string">':around'</span>;

    <span class="hljs-keyword">this</span>.fire(before);
    <span class="hljs-keyword">this</span>.fireAround(around, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emitterFireAroundCallback</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span>(fn) fn();
      <span class="hljs-keyword">this</span>.fire(event);
      <span class="hljs-keyword">this</span>.fire(after);
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p><strong> pie.emitter.fireAround </strong></p>
<p>Invokes <code>event</code> callbacks and expects each callback to invoke a provided callback when complete.
After all callbacks have reported that they’re finished, <code>onComplete</code> will be invoked.</p>
<pre><code>cb1 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'cb1!'</span>); cb(); };
cb2 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'cb2!'</span>); cb(); };
emitter.on(<span class="hljs-string">'foo:around'</span>, cb1);
emitter.on(<span class="hljs-string">'foo:around'</span>, cb2);
emitter.fireAround(<span class="hljs-string">'foo:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'done!'</span>); });
<span class="hljs-comment">//=&gt; console would log "cb1!", "cb2!", "done!"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  fireAround: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, onComplete)</span> </span>{
    <span class="hljs-keyword">var</span> callbacks = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eventCallbacks.'</span> + event),
    compactNeeded = <span class="hljs-literal">false</span>,
    fns;

    <span class="hljs-keyword">this</span>._reportTrigger(event);

    <span class="hljs-keyword">if</span>(callbacks) {
      fns = callbacks.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb, i)</span> </span>{
        <span class="hljs-keyword">if</span>(cb.onceOnly) {
          compactNeeded = <span class="hljs-literal">true</span>;
          callbacks[i] = <span class="hljs-literal">undefined</span>;
        }
        <span class="hljs-keyword">return</span> cb.fn;
      });

      <span class="hljs-keyword">if</span>(compactNeeded) <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'eventCallbacks.'</span> + event, pie.array.compact(callbacks));

      pie.fn.async(fns, onComplete);
    } <span class="hljs-keyword">else</span> {
      onComplete();
    }
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <h1 id="pie-error-handler">Pie Error Handler</h1>
<p>A class which knows how to handle errors in the app.
By default, it focuses mostly on xhr issues.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.errorHandler = pie.model.extend(<span class="hljs-string">'errorHandler'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      responseCodeHandlers: {}
    }, {
      app: app
    });
  },


  <span class="hljs-comment">/* extract the "data" object out of an xhr */</span>
  xhrData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
    <span class="hljs-keyword">return</span> xhr.data = xhr.data || (xhr.status ? <span class="hljs-built_in">JSON</span>.parse(xhr.response) : {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <p><strong> pie.errorHandler.errorMessagesFromRequest </strong></p>
<p>Extract error messages from a response. Try to extract the messages from
the xhr data diretly, or allow overriding by response code.
It will look for an “error”, “errors”, or “errors.message” response format.</p>
<pre><code>{
  errors: [
    {
      key: <span class="hljs-string">'invalid_email'</span>,
      message: <span class="hljs-string">"Email is invalid"</span>
    }
  ]
}
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  errorMessagesFromRequest: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
    <span class="hljs-keyword">var</span> d = <span class="hljs-keyword">this</span>.xhrData(xhr),
    errors = pie.array.from(d.error || d.message || d.errors || []),
    clean;

    errors = errors.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> pie.object.isString(e) ? e : e.message; });

    errors = pie.array.compact(errors, <span class="hljs-literal">true</span>);
    clean   = <span class="hljs-keyword">this</span>.app.i18n.t(<span class="hljs-string">'app.errors.'</span> + xhr.status, {<span class="hljs-keyword">default</span>: errors});

    <span class="hljs-keyword">this</span>.app.debug.apply(<span class="hljs-keyword">this</span>.app, pie._debugArgs(errors));

    <span class="hljs-keyword">return</span> pie.array.from(clean);
  },

  getResponseCodeHandler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'responseCodeHandlers.'</span> + status);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              <p><strong> pie.errorHandler.handleXhrError </strong></p>
<p>Find a handler for the xhr via response code or the app default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  handleXhrError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{

    <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">this</span>.getResponseCodeHandler(xhr.status.toString());

    <span class="hljs-keyword">if</span>(handler) {
      handler.call(xhr, xhr);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.notifyErrors(xhr);
    }

  },

  handleI18nError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error, info)</span> </span>{
    <span class="hljs-keyword">this</span>.reportError(error, info);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <p><strong> pie.errorHandler.notifyErrors </strong></p>
<p>Build errors and send them to the notifier.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  notifyErrors: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span></span>{
    <span class="hljs-keyword">var</span> n = <span class="hljs-keyword">this</span>.app.notifier, errors = <span class="hljs-keyword">this</span>.errorMessagesFromRequest(xhr);

    <span class="hljs-keyword">if</span>(errors.length) {
      <span class="hljs-comment">/* clear all previous errors when an error occurs. */</span>
      n.clear(<span class="hljs-string">'error'</span>);

      <span class="hljs-comment">/* delay so UI will visibly change when the same content is shown. */</span>
      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        n.notify(errors, <span class="hljs-string">'error'</span>, <span class="hljs-number">10000</span>);
      }, <span class="hljs-number">100</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              <p><strong> pie.errorHandler.registerHandler </strong></p>
<p>Register a response code handler</p>
<pre><code>handler.registerHandler(<span class="hljs-string">'401'</span>, myRedirectCallback);
handler.registerHandler(<span class="hljs-string">'404'</span>, myFourOhFourCallback);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  registerHandler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(responseCode, handler)</span> </span>{
    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'responseCodeHandlers.'</span> + responseCode.toString(), handler);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              <p><strong> pie.errorHandler.reportError </strong></p>
<p>Provide an interface for sending errors to a bug reporting service.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reportError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, options)</span> </span>{
    options = options || {};

    <span class="hljs-keyword">this</span>._reportError(err, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              <p><strong> pie.errorHandler._reportError </strong></p>
<p>Hook in your own error reporting service. bugsnag, airbrake, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _reportError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, options)</span> </span>{
    <span class="hljs-keyword">this</span>.app.debug.apply(<span class="hljs-keyword">this</span>.app, pie._debugArgs(<span class="hljs-built_in">String</span>(err) + <span class="hljs-string">" | "</span> + <span class="hljs-built_in">JSON</span>.stringify(options)));
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <h1 id="pie-formview">Pie FormView</h1>
<p>A view designed to ease form modeling &amp; interactions.
FormViews make use of bindings &amp; validations to simplify the input, validation, and submission of forms.
FormViews expect the activeView and bindings mixins to be included.</p>
<pre><code>myForm = pie.formView.create({
  fields: [
    {
      name: <span class="hljs-string">'full_name'</span>
      validation: {
        presence: <span class="hljs-literal">true</span>
      }
    },
    ...
    {
      name: <span class="hljs-string">'terms_of_service'</span>,
      binding: {
        type: <span class="hljs-string">'check'</span>,
        dataType: <span class="hljs-string">'boolean'</span>
      },
      validation: {
        chosen: <span class="hljs-literal">true</span>
      }
    }
  ]
})
</code></pre><p>Valid options are as follows:</p>
<ul>
<li><strong>fields</strong> - a list of fields to bind to, validate, and submit. Each field can have the following:<ul>
<li><strong>name</strong> - the name of the field to bind to. Should be the same as the name attribute of the field &amp; the attribute you’d like to submit as.</li>
<li><strong>binding</strong> - options for the binding. All options present in <code>pie.mixins.bindings#normalizeBindingOptions</code> are available.</li>
<li><strong>validation</strong> - options for the validation. All options present in <code>pie.mixins.validatable</code> are available.</li>
</ul>
</li>
<li><strong>ajax</strong> - (optional) an object of ajax options to use as part of the submission. By default it will infer the url &amp; verb from the <code>&lt;form&gt;</code> this view contains.</li>
<li><strong>formSel</strong> - (optional) defaulted to “form”, this is the selector which will be observed for submission.</li>
<li><strong>model</strong> - (optional) a model to be bound to. By default it will create a new model automatically. Keep in mind if you supply a model, the model will have validations applied to it.</li>
<li><strong>validationStrategy</strong> - (optional) a validation strategy to be applied to the model. See <code>pie.mixins.validatable</code> for more info on that.</li>
</ul>
<p>Upon submission a few things happen. If the ajax call is a success, the view’s <code>onSuccess</code> function is invoked. The emitter also fires an <code>onSuccess</code> event.
Similarly, upon failure, <code>onFailure</code> is invoked &amp; emitted. If you override <code>ajax.extraError</code> or <code>ajax.success</code> in the options, the associated function &amp; event will not be triggered.
If you’re overriding formView behavior, here’s the general process which is taken:</p>
<ol>
<li>Upon setup, fields are bound &amp; initialized</li>
<li>Upon submission, fields are read one final time</li>
<li>A <code>submit</code> event is triggered on our emitter.</li>
<li>The model is validated.</li>
<li>If invalid, an <code>onInvalid</code> event is fired and the <code>onInvalid</code> function is invoked.</li>
<li>If invalid, an <code>onValid</code> event is fired and the <code>onValid</code> function is invoked.</li>
<li>By default, the <code>onValid</code> function invokes <code>prepareSubmissionData</code> with a callback.</li>
<li><code>prepareSubmissionData</code> reads the fields out of the model. This is the point when ajax could take place if, say, a token needed to be generated by an external service (I’m talking to you, Stripe).</li>
<li>When the data is prepared, the callback is invoked.</li>
<li>The ajax request is made to the form target.</li>
<li>If unsuccessful, an <code>onFailure</code> event &amp; function are triggered.</li>
<li>If successful, an <code>onSuccess</code> event &amp; function are triggered.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.formView = pie.activeView.extend(<span class="hljs-string">'formView'</span>, pie.mixins.bindings, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">this</span>._ensureModel();
    <span class="hljs-keyword">this</span>._normalizeFormOptions();
  },

  setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._setupFormBindings();

    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'submit'</span>, <span class="hljs-keyword">this</span>.options.formSel, <span class="hljs-keyword">this</span>.validateAndSubmitForm.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  <span class="hljs-comment">/* we build a model if one isn't present already */</span>
  <span class="hljs-comment">/* if the model doesn't know how to perform validations, we extend it with the functionality */</span>
  _ensureModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.model = <span class="hljs-keyword">this</span>.model || <span class="hljs-keyword">this</span>.options.model || pie.model.create({});

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.model.validates) <span class="hljs-keyword">this</span>.model.reopen(pie.mixins.validatable);
  },


  _normalizeFormOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.options.formSel  = <span class="hljs-keyword">this</span>.options.formSel || <span class="hljs-string">'form'</span>;
    <span class="hljs-keyword">this</span>.options.fields   = <span class="hljs-keyword">this</span>.options.fields || [];
    <span class="hljs-keyword">this</span>.options.fields   = <span class="hljs-keyword">this</span>.options.fields.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(field)</span> </span>{

      <span class="hljs-keyword">if</span>(pie.object.isString(field)) field = {name: field};

      <span class="hljs-keyword">if</span>(!field || !field.name) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"A `name` property must be provided for all fields."</span>);

      field.binding = field.binding || {};
      field.binding.attr = field.binding.attr || field.name;

      <span class="hljs-keyword">return</span> field;
    });
  },

  <span class="hljs-comment">/* These `_on*` methods are provided to enable event observation. */</span>
  <span class="hljs-comment">/* Implementers of formView should override `on*` methods. */</span>
  _onInvalid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'onInvalid'</span>);
    <span class="hljs-keyword">this</span>.onInvalid.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  _onFailure: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'onFailure'</span>);
    <span class="hljs-keyword">this</span>.onFailure.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  _onSuccess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'onSuccess'</span>);
    <span class="hljs-keyword">this</span>.onSuccess.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  _onValid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'onValid'</span>);
    <span class="hljs-keyword">this</span>.onValid.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  _setupFormBindings: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> validation;

    <span class="hljs-keyword">this</span>.options.fields.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(field)</span> </span>{

      <span class="hljs-keyword">this</span>.bind(field.binding);

      validation = field.validation || field.validations;

      <span class="hljs-keyword">if</span>(validation) {
        validation = {};
        validation[field.name] = field.validation || field.validations;
        <span class="hljs-keyword">this</span>.model.validates(validation, <span class="hljs-keyword">this</span>.options.validationStrategy);
      }
    }.bind(<span class="hljs-keyword">this</span>));
  },

  <span class="hljs-comment">/* The ajax options to be applied before submission */</span>
  ajaxOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.options.ajax;
  },

  <span class="hljs-comment">/* the process of applying form data to the model. */</span>
  applyFieldsToModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* form */</span>)</span> </span>{
    <span class="hljs-keyword">this</span>.readBoundFields();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              <p><strong> pie.formView.onInvalid </strong></p>
<p>For the inheriting class to override.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onInvalid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{},</pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              <p><strong> pie.formView.onValid </strong></p>
<p>What happens when the model validations pass.
By default, the data is prepared for submission via <code>prepareSubmissionData</code>
and sent to <code>performSubmit</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onValid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.prepareSubmissionData().then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onValidDataCallback</span><span class="hljs-params">(data)</span> </span>{

      <span class="hljs-keyword">this</span>.performSubmit(data).then(
        <span class="hljs-keyword">this</span>._onSuccess.bind(<span class="hljs-keyword">this</span>),
        <span class="hljs-keyword">this</span>._onFailure.bind(<span class="hljs-keyword">this</span>)
      );

    }.bind(<span class="hljs-keyword">this</span>));

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              <p><strong> pie.formView.performSubmit </strong></p>
<p>By default it builds an ajax request based on <code>this.options.ajax</code>
and / or the <form> tag identified by <code>form</code>.
Upon success or failure of the request, the <code>cb</code> is invoked with
a signature of <code>cb(success?, responseData)</code></p>
<pre><code>formView.performSubmit(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">form</span>&gt;</span>, {foo: 'bar'}, function(isSuccess, data){ console.log(isSuccess, data); });</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  performSubmit: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
    <span class="hljs-keyword">var</span> request = app.ajax.ajax(pie.object.merge({
      verb: <span class="hljs-string">'post'</span>,
      data: data
    }, <span class="hljs-keyword">this</span>.ajaxOptions()));

    <span class="hljs-keyword">return</span> request.promise();
  },

  <span class="hljs-comment">/* for the inheriting class to override. */</span>
  onFailure: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* response, xhr */</span>)</span> </span>{},

  <span class="hljs-comment">/* for the inheriting class to override. */</span>
  onSuccess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* response, xhr */</span>)</span> </span>{},</pre></div></div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              <p><strong> pie.formView.prepareSubmissionData </strong></p>
<p>The data to be sent to the server.
By default these are the defined fields extracted out of the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  prepareSubmissionData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> fieldNames = pie.array.map(<span class="hljs-keyword">this</span>.options.fields, <span class="hljs-string">'name'</span>),
    data = <span class="hljs-keyword">this</span>.model.gets(fieldNames);

    <span class="hljs-keyword">return</span> pie.promise.resolve(data);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p><strong> pie.formView.validateModel </strong></p>
<p>Perform validations on the model &amp; invoke <code>cb</code> when complete.
By default, <code>model.validateAll</code> will be invoked but this can be overridden
to talk to external services, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validateModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.model.validateAll();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              <p><strong> pie.formView.validateAndSubmitForm </strong></p>
<p>Start the submission process. We apply our form fields to the model
via <code>applyFieldsToModel</code>, fire a submit event via our emitter, then
begin the validation process via <code>validateModel</code>. If the model validates,
we invoke our <code>onValid</code> function, otherwise the <code>onInvalid</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validateAndSubmitForm: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    <span class="hljs-keyword">this</span>.consumeEvent(e);

    <span class="hljs-keyword">this</span>.applyFieldsToModel();

    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'submit'</span>);

    <span class="hljs-keyword">this</span>.validateModel().then(<span class="hljs-keyword">this</span>._onValid.bind(<span class="hljs-keyword">this</span>), <span class="hljs-keyword">this</span>._onInvalid.bind(<span class="hljs-keyword">this</span>));
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-291">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-291">&#182;</a>
              </div>
              <h1 id="pie-helpers">Pie Helpers</h1>
<p>A registry for template helpers.
Any helper function register here will be available in the
templates rendered by the associated app’s <code>templates</code> object.</p>
<pre><code>helpers.register(<span class="hljs-string">'upcase'</span>, pie.string.upcase);
helpers.register(<span class="hljs-string">'reverse'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span></span>{
  <span class="hljs-keyword">return</span> str.split(<span class="hljs-string">''</span>).reverse().join(<span class="hljs-string">''</span>);
});
</code></pre><p>Now, in your templates you’ll be able to use these helpers:</p>
<pre><code>&lt;h1&gt;[%= h.upcase(data.fullName) %]&lt;/h1&gt;
&lt;p&gt;[%= h.reverse(data.jibberish) %]&lt;/p&gt;
</code></pre><p>Note: these do not become global functions but rather are local to each template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.helpers = pie.model.extend(<span class="hljs-string">'helpers'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      fns: {}
    }, pie.object.merge({
      app: app,
      variableName: <span class="hljs-string">'h'</span>
    }, options));

    <span class="hljs-keyword">var</span> i18n = <span class="hljs-keyword">this</span>.app.i18n;

    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'t'</span>, i18n.t.bind(i18n));
    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'l'</span>, i18n.l.bind(i18n));
    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'state'</span>, <span class="hljs-keyword">this</span>.app.state);
    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'timeago'</span>, i18n.timeago.bind(i18n));
    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'path'</span>, <span class="hljs-keyword">this</span>.app.path.bind(<span class="hljs-keyword">this</span>.app));
    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'get'</span>, pie.object.getPath);
    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'render'</span>, <span class="hljs-keyword">this</span>.renderPartials.bind(<span class="hljs-keyword">this</span>));
  },

  <span class="hljs-comment">/* Register a function to be available in templates. */</span>
  register: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, fn)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'fns.'</span> + name, fn);
  },

  <span class="hljs-comment">/* Fetch a helper function */</span>
  fetch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'fns.'</span> + name);
  },

  <span class="hljs-comment">/* Call a helper function */</span>
  call: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* name, ..args */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
    name = args.shift();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fetch(name).apply(<span class="hljs-literal">null</span>, args);
  },

  <span class="hljs-comment">/* enables render to be called from templates. data can be an object or an array */</span>
  renderPartials: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(templateName, data)</span> </span>{
    <span class="hljs-keyword">return</span> pie.array.map(data, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span></span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.app.templates.render(templateName, d);
    }.bind(<span class="hljs-keyword">this</span>)).join(<span class="hljs-string">"\n"</span>);
  },

  <span class="hljs-comment">/* Provide the functions which should be available in templates. */</span>
  functions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'fns'</span>);
  },

  provideVariables: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">"var app = pie.apps["</span> + pie.uid(<span class="hljs-keyword">this</span>.app) + <span class="hljs-string">"]; var "</span> + <span class="hljs-keyword">this</span>.options.variableName + <span class="hljs-string">" = app.helpers.functions();"</span>;

  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-292">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-292">&#182;</a>
              </div>
              <h1 id="pie-i18n">Pie i18n</h1>
<p>The i18n class is in charge of the defining and lookup of translations, the
defining and lookup of date formats, and the standardization of “word” things.
The standard i18n lookup usage is as follows:</p>
<pre><code>i18n.load({
  hi: "Hi %{firstName}",
  followers: {
    zero: "${hi}, you don't have any followers :(",
    one: "${hi}, you have a follower!",
    other: ${hi}, you have %{count} followers!"
});

i18n.t("hi");
//=&gt; "Hi undefined"
i18n.t("hi", {firstName: 'Doug'});
//=&gt; "Hi Doug"
i18n.t("hi", {firstName: 'Doug'}, 'upcase');
//=&gt; "HI DOUG"
i18n.t("followers", {firstName: 'Doug', count: 5});
//=&gt; "Hi Doug, you have 5 followers!"
i18n.t("followers", {firstName: 'Doug', count: 0});
//=&gt; "Hi Doug, you don't have any followers :("
</code></pre><p>Note that recursive interpolation is allowed via the <code>${}</code> identifier. Direct interpolation is
handled by <code>%{}</code>. There is no loop detection so use this wisely.</p>
<p>And date/time usage is as follows:</p>
<pre><code>i18n.l(date, <span class="hljs-string">'%Y-%m'</span>);
<span class="hljs-comment">//=&gt; "2015-01"</span>
i18n.l(date, <span class="hljs-string">'isoTime'</span>);
<span class="hljs-comment">//=&gt; "2015-01-14T09:42:26.069-05:00"</span>
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-293">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-293">&#182;</a>
              </div>
              <p><em><strong>Todo:</strong> allow a default scope (eg, en, en-GB, etc). Currently the assumption is that only the relevant translations are loaded.</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.i18n = pie.model.extend(<span class="hljs-string">'i18n'</span>, (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

  <span class="hljs-keyword">var</span> extension = {

    init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
      <span class="hljs-keyword">var</span> data = pie.object.merge({}, pie.i18n.defaultTranslations);
      options = pie.object.deepMerge({
        settings: {
          interpolationStart: <span class="hljs-string">'%{'</span>,
          interpolationEnd: <span class="hljs-string">'}'</span>,
          nestedStart: <span class="hljs-string">'${'</span>,
          nestedEnd: <span class="hljs-string">'}'</span>
        }
      }, options || {}, {app: app});


      <span class="hljs-keyword">var</span> escapedInterpEnd = pie.string.escapeRegex(options.settings.interpolationEnd),
      escapedNestedEnd = pie.string.escapeRegex(options.settings.nestedEnd);

      options.settings.interpolationRegex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(pie.string.escapeRegex(options.settings.interpolationStart) + <span class="hljs-string">'([^'</span> + escapedNestedEnd + <span class="hljs-string">']+)'</span> + escapedInterpEnd, <span class="hljs-string">'g'</span>);
      options.settings.nestedRegex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(pie.string.escapeRegex(options.settings.nestedStart) + <span class="hljs-string">'([^'</span> + escapedNestedEnd + <span class="hljs-string">']+)'</span> + escapedNestedEnd, <span class="hljs-string">'g'</span>);

      pie.object.forEach(<span class="hljs-keyword">this</span>.strftimeMods, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span></span>{
        <span class="hljs-keyword">this</span>.strftimeMods[k] = v.bind(<span class="hljs-keyword">this</span>);
      }.bind(<span class="hljs-keyword">this</span>));

      <span class="hljs-keyword">this</span>._super(data, options);
    },

    _ampm: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(num)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.meridiems.'</span> + (num &gt;= <span class="hljs-number">12</span> ? <span class="hljs-string">'pm'</span> : <span class="hljs-string">'am'</span>));
    },


    _countAlias: {
      <span class="hljs-string">'0'</span> : <span class="hljs-string">'zero'</span>,
      <span class="hljs-string">'1'</span> : <span class="hljs-string">'one'</span>,
      <span class="hljs-string">'-1'</span> : <span class="hljs-string">'negone'</span>
    },


    _dayName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.day_names.'</span> + d);
    },


    _hour: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(h)</span> </span>{
      <span class="hljs-keyword">if</span>(h &gt; <span class="hljs-number">12</span>) h -= <span class="hljs-number">12</span>;
      <span class="hljs-keyword">if</span>(!h) h += <span class="hljs-number">12</span>;
      <span class="hljs-keyword">return</span> h;
    },


    _monthName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.month_names.'</span> + m);
    },


    _nestedTranslate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t, data)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._expand(t, <span class="hljs-keyword">this</span>.options.settings.nestedRegex, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, path)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.translate(path, data);
      }.bind(<span class="hljs-keyword">this</span>));
    },

    _interpolateTranslation: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t, data)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._expand(t, <span class="hljs-keyword">this</span>.options.settings.interpolationRegex, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, key)</span> </span>{
        <span class="hljs-keyword">return</span> pie.object.getPath(data, key);
      });
    },

    _expand: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t, regex, fn)</span> </span>{
      <span class="hljs-keyword">try</span>{
        <span class="hljs-keyword">var</span> val;
        <span class="hljs-keyword">return</span> t.replace(regex, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, key)</span> </span>{
          val = fn(match, key);
          <span class="hljs-keyword">if</span>(val === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Missing interpolation argument `"</span> + key + <span class="hljs-string">"` for '"</span> + t + <span class="hljs-string">"'"</span>);
          <span class="hljs-keyword">return</span> val;
        });
      } <span class="hljs-keyword">catch</span>(e) {
        <span class="hljs-keyword">this</span>.app.errorHandler.handleI18nError(e, {
          handledBy: <span class="hljs-string">"pie.i18n#_expand"</span>,
          expandString: t,
          regex: regex
        });
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
      }
    },


    <span class="hljs-comment">/* assumes that dates either come in as dates, iso strings, or epoch timestamps */</span>
    _normalizedDate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">String</span>(d).match(<span class="hljs-regexp">/^\d+$/</span>)) {
        d = <span class="hljs-built_in">parseInt</span>(d, <span class="hljs-number">10</span>);
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">String</span>(d).length &lt; <span class="hljs-number">13</span>) d *= <span class="hljs-number">1000</span>;
        d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(d);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isString(d)) {
        d = pie.date.timeFromISO(d);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">/* let the system parse */</span>
        d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(d);
      }
      <span class="hljs-keyword">return</span> d;
    },


    _shortDayName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.short_day_names.'</span> + d, {<span class="hljs-string">'default'</span> : <span class="hljs-string">''</span>}) || <span class="hljs-keyword">this</span>._dayName(d).slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);
    },

    _formattedDayName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._isToday(d)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.today'</span>);
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._isTomorrow(d)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.tomorrow'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._dayName(d.getDay());
    },

    _formattedShortDayName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._isToday(d)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.today'</span>);
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._isTomorrow(d)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.tomorrow'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._shortDayName(d.getDay());
    },

    _isToday: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date)</span> </span>{
      <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      <span class="hljs-keyword">return</span> now.getFullYear() === date.getFullYear() &amp;&amp;
        now.getMonth() === date.getMonth() &amp;&amp;
        now.getDate() === date.getDate();
    },

    _isTomorrow: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date)</span> </span>{
      <span class="hljs-keyword">var</span> tom = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      tom.setDate(tom.getDate() + <span class="hljs-number">1</span>);
      <span class="hljs-keyword">return</span> tom.getFullYear() === date.getFullYear() &amp;&amp;
        tom.getMonth() === date.getMonth() &amp;&amp;
        tom.getDate() === date.getDate();
    },


    _shortMonthName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.short_month_names.'</span> + m, {<span class="hljs-string">'default'</span> : <span class="hljs-string">''</span>}) || <span class="hljs-keyword">this</span>._monthName(m).slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);
    },


    _pad: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(num, cnt, pad, prefix)</span> </span>{
      <span class="hljs-keyword">var</span> s = <span class="hljs-string">''</span>,
          p = cnt - num.toString().length;
      <span class="hljs-keyword">if</span>(pad === <span class="hljs-literal">undefined</span>) pad = <span class="hljs-string">' '</span>;
      <span class="hljs-keyword">while</span>(p&gt;<span class="hljs-number">0</span>){
        s += prefix ? pad + s : s + pad;
        p -= <span class="hljs-number">1</span>;
      }
      <span class="hljs-keyword">return</span> s + num.toString();
    },

    _ordinal: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(number)</span> </span>{
      <span class="hljs-keyword">var</span> unit = number % <span class="hljs-number">100</span>;

      <span class="hljs-keyword">if</span>(unit &gt;= <span class="hljs-number">11</span> &amp;&amp; unit &lt;= <span class="hljs-number">13</span>) unit = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">else</span> unit = number % <span class="hljs-number">10</span>;

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.ordinals.o'</span> + unit);
    },

    _timezoneAbbr: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date)</span> </span>{
      <span class="hljs-keyword">var</span> str = date &amp;&amp; date.toString();
      <span class="hljs-keyword">return</span> str &amp;&amp; str.split(<span class="hljs-regexp">/\((.*)\)/</span>)[<span class="hljs-number">1</span>];
    },


    _utc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span> </span>{
      <span class="hljs-keyword">var</span> t2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(t.getTime());
      t2.setMinutes(t2.getMinutes() + t2.getTimezoneOffset());
      <span class="hljs-keyword">return</span> t2;
    },

    keyCheck: <span class="hljs-regexp">/^\.(.+)$/</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-294">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-294">&#182;</a>
              </div>
              <p><strong> pie.i18n.attempt </strong></p>
<p>If the provided <code>key</code> looks like a translation key, prepended with a “.”,
try to look it up. If it does not or the provided key does not exist, return
the provided key.</p>
<pre><code>i18n.attempt(<span class="hljs-string">'.foo.bar.baz'</span>)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    attempt: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* args */</span>)</span> </span>{
      <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
      key = args[<span class="hljs-number">0</span>],
      m = key &amp;&amp; key.match(<span class="hljs-keyword">this</span>.keyCheck);

      <span class="hljs-keyword">if</span>(!m) <span class="hljs-keyword">return</span> key;

      args[<span class="hljs-number">0</span>] = m[<span class="hljs-number">1</span>]; <span class="hljs-comment">/* swap out the formatted key for the real one */</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.translate.apply(<span class="hljs-keyword">this</span>, args);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-295">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-295">&#182;</a>
              </div>
              <p><strong> pie.i18n.load </strong></p>
<p>Load translations into this instance.
By default, a deep merge will occur, provide <code>false</code> for <code>shallow</code>
if you would like a shallow merge to occur.</p>
<pre><code>i18n.load({foo: <span class="hljs-string">'Bar %{baz}'</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, shallow)</span> </span>{
      <span class="hljs-keyword">var</span> f = shallow ? pie.object.merge : pie.object.deepMerge;
      f.call(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>.data, data);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-296">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-296">&#182;</a>
              </div>
              <p><strong> pie.i18n.translate (pie.i18n.t) </strong></p>
<p>Given a <code>path</code>, look up a translation.
If the second argument <code>data</code> is provided, the <code>data</code> will be
interpolated into the translation before returning.
Arguments 3+ are string modification methods as defined by <code>pie.string</code>.
<code>translate</code> is aliased as <code>t</code>.</p>
<pre><code><span class="hljs-comment">//=&gt; Assuming 'foo.path' is defined as "This is %{name}"</span>
i18n.t(<span class="hljs-string">'foo.path'</span>, {name: <span class="hljs-string">'Bar'</span>}, <span class="hljs-string">'pluralize'</span>, <span class="hljs-string">'upcase'</span>)
<span class="hljs-comment">//=&gt; "THIS IS BAR'S"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    translate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* path, data, stringChange1, stringChange2 */</span>)</span> </span>{
      <span class="hljs-keyword">var</span> changes = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'compact'</span>),
      path = changes.shift(),
      data = pie.object.isObject(changes[<span class="hljs-number">0</span>]) ? changes.shift() : <span class="hljs-literal">undefined</span>,
      translation = <span class="hljs-keyword">this</span>.get(path),
      count;

      <span class="hljs-keyword">if</span> (pie.object.has(data, <span class="hljs-string">'count'</span>) &amp;&amp; pie.object.isObject(translation)) {
        count = (data.count || <span class="hljs-number">0</span>).toString();
        count = <span class="hljs-keyword">this</span>._countAlias[count] || (count &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'other'</span> : <span class="hljs-string">'negother'</span>);
        translation = translation[count] === <span class="hljs-literal">undefined</span> ? translation.other : translation[count];
      }

      <span class="hljs-keyword">if</span>(!translation) {

        <span class="hljs-keyword">if</span>(pie.object.has(data, <span class="hljs-string">'default'</span>)) {
          <span class="hljs-keyword">var</span> def = pie.fn.valueFrom(data.default);
          <span class="hljs-keyword">if</span>(pie.object.isString(def)) {
            translation = <span class="hljs-keyword">this</span>.attempt(def);
          } <span class="hljs-keyword">else</span> {
            translation = def;
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(translation == <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">this</span>.app.errorHandler.handleI18nError(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Translation not found: "</span> + path), {
            handledBy: <span class="hljs-string">"pie.i18n#translate"</span>,
            translationPath: path
          });
          <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }
      }


      <span class="hljs-keyword">if</span>(pie.object.isString(translation)) {
        translation = translation.indexOf(<span class="hljs-keyword">this</span>.options.settings.nestedStart) === -<span class="hljs-number">1</span> ? translation : <span class="hljs-keyword">this</span>._nestedTranslate(translation, data);
        translation = translation.indexOf(<span class="hljs-keyword">this</span>.options.settings.interpolationStart) === -<span class="hljs-number">1</span> ? translation : <span class="hljs-keyword">this</span>._interpolateTranslation(translation, data);
      }

      <span class="hljs-keyword">if</span>(changes.length) {
        changes.unshift(translation);
        translation = pie.string.change.apply(<span class="hljs-literal">null</span>, changes);
      }

      <span class="hljs-keyword">return</span> translation;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-297">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-297">&#182;</a>
              </div>
              <p><strong> pie.i18n.timeago </strong></p>
<p>Return a human representation of the time since the provided time <code>t</code>.
You can also pass an alternate “relative to” time as the second argument.</p>
<pre><code>d.setDate(d.getDate() - <span class="hljs-number">4</span>);
i18n.timeago(d)
<span class="hljs-comment">//=&gt; "4 days ago"</span>

d.setDate(d.getDate() - <span class="hljs-number">7</span>);
i18n.timeago(d)
<span class="hljs-comment">//=&gt; "1 week ago"</span>

d.setDate(d.getDate() - <span class="hljs-number">90</span>);
d2.setDate(d.getDate() + <span class="hljs-number">2</span>);
i18n.timeago(d, d2)
<span class="hljs-comment">//=&gt; "2 days ago"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    timeago: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t, now, scope)</span> </span>{
      <span class="hljs-keyword">var</span> tD = t,
      nowD = now,
      diff, c;

      t = <span class="hljs-keyword">this</span>._normalizedDate(t).getTime()  / <span class="hljs-number">1000</span>;
      now = <span class="hljs-keyword">this</span>._normalizedDate(now || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime() / <span class="hljs-number">1000</span>;

      diff = now - t;

      scope = scope || <span class="hljs-string">'app'</span>;

      <span class="hljs-keyword">if</span>(diff &lt; <span class="hljs-number">60</span>) { <span class="hljs-comment">// less than a minute</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.now'</span>, {count: diff});
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">3600</span>) { <span class="hljs-comment">// less than an hour</span>
        c = <span class="hljs-built_in">Math</span>.floor(diff / <span class="hljs-number">60</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.minutes'</span>, {count: c});
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86400</span>) { <span class="hljs-comment">// less than a day</span>
        c = <span class="hljs-built_in">Math</span>.floor(diff / <span class="hljs-number">3600</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.hours'</span>, {count: c});
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86400</span> * <span class="hljs-number">7</span>) { <span class="hljs-comment">// less than a week</span>
        c = <span class="hljs-built_in">Math</span>.floor(diff / <span class="hljs-number">86400</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.days'</span>, {count: c});
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86400</span> * <span class="hljs-number">30</span>) { <span class="hljs-comment">// less than 30 days</span>
        c = <span class="hljs-built_in">Math</span>.floor(diff / (<span class="hljs-number">86400</span> * <span class="hljs-number">7</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.weeks'</span>, {count: c});
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86500</span> * <span class="hljs-number">365</span>) { <span class="hljs-comment">// less than 365 days</span>
        c = (nowD.getFullYear() - tD.getFullYear()) * <span class="hljs-number">12</span>;
        c -= tD.getMonth();
        c += nowD.getMonth();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.months'</span>, {count: c});
      } <span class="hljs-keyword">else</span> {
        c = <span class="hljs-built_in">Math</span>.floor(diff / (<span class="hljs-number">86400</span> * <span class="hljs-number">365</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.years'</span>, {count: c});
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-298">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-298">&#182;</a>
              </div>
              <p><strong> pie.i18n.strftime (pie.i18n.l) </strong></p>
<p>Given a <code>date</code>, format it based on the format <code>f</code>.
The format can be:</p>
<ul>
<li>A named format, existing at app.time.formats.X</li>
<li>A custom format following the guidelines of ruby’s strftime</li>
</ul>
<p><em>Ruby’s strftime: <a href="http://ruby-doc.org/core-2.2.0/Time.html#method-i-strftime">http://ruby-doc.org/core-2.2.0/Time.html#method-i-strftime</a></em></p>
<pre><code>i18n.l(date, <span class="hljs-string">'shortDate'</span>);
i18n.l(date, <span class="hljs-string">'%Y-%m'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    strftime: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date, f)</span> </span>{
      <span class="hljs-keyword">this</span>._date = <span class="hljs-keyword">this</span>._normalizedDate(date);

      <span class="hljs-comment">/* named format from translations.time. */</span>
      <span class="hljs-keyword">if</span>(!~f.indexOf(<span class="hljs-string">'%'</span>)) f = <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.formats.'</span> + f, {<span class="hljs-string">"default"</span> : f});

      pie.object.forEach(<span class="hljs-keyword">this</span>.strftimeMods, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pattern, fn)</span> </span>{
        f = f.replace(pattern, fn);
      });

      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._date;
      <span class="hljs-keyword">return</span> f;
    },

    strftimeMods: {
      <span class="hljs-string">'%a'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._shortDayName(<span class="hljs-keyword">this</span>._date.getDay()); },
      <span class="hljs-string">'%-a'</span>  : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._formattedShortDayName(<span class="hljs-keyword">this</span>._date, <span class="hljs-keyword">this</span>._date.getDay()); },
      <span class="hljs-string">'%A'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._dayName(<span class="hljs-keyword">this</span>._date.getDay()); },
      <span class="hljs-string">'%-A'</span>  : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._formattedDayName(<span class="hljs-keyword">this</span>._date, <span class="hljs-keyword">this</span>._date.getDay()); },
      <span class="hljs-string">'%B'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._monthName(<span class="hljs-keyword">this</span>._date.getMonth()); },
      <span class="hljs-string">'%b'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._shortMonthName(<span class="hljs-keyword">this</span>._date.getMonth()); },
      <span class="hljs-string">'%d'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pad(<span class="hljs-keyword">this</span>._date.getDate(), <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>); },
      <span class="hljs-string">'%-d'</span>  : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._date.getDate(); },
      <span class="hljs-string">'%+d'</span>  : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._date.getDate() + <span class="hljs-keyword">this</span>._ordinal(<span class="hljs-keyword">this</span>._date.getDate()); },
      <span class="hljs-string">'%e'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pad(<span class="hljs-keyword">this</span>._date.getDate(), <span class="hljs-number">2</span>, <span class="hljs-string">' '</span>); },
      <span class="hljs-string">'%H'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pad(<span class="hljs-keyword">this</span>._date.getHours(), <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>); },
      <span class="hljs-string">'%-H'</span>  : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._date.getHours(); },
      <span class="hljs-string">'%k'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pad(<span class="hljs-keyword">this</span>._date.getHours(), <span class="hljs-number">2</span>, <span class="hljs-string">' '</span>); },
      <span class="hljs-string">'%-k'</span>  : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._date.getHours(); },
      <span class="hljs-string">'%I'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pad(<span class="hljs-keyword">this</span>._hour(<span class="hljs-keyword">this</span>._date.getHours()), <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>); },
      <span class="hljs-string">'%l'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._hour(<span class="hljs-keyword">this</span>._date.getHours()); },
      <span class="hljs-string">'%m'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pad(<span class="hljs-keyword">this</span>._date.getMonth() + <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>); },
      <span class="hljs-string">'%-m'</span>  : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._date.getMonth() + <span class="hljs-number">1</span>; },
      <span class="hljs-string">'%M'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pad(<span class="hljs-keyword">this</span>._date.getMinutes(), <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>); },
      <span class="hljs-string">'%p'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._ampm(<span class="hljs-keyword">this</span>._date.getHours()).toUpperCase(); },
      <span class="hljs-string">'%P'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._ampm(<span class="hljs-keyword">this</span>._date.getHours()); },
      <span class="hljs-string">'%S'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pad(<span class="hljs-keyword">this</span>._date.getSeconds(), <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>); },
      <span class="hljs-string">'%-S'</span>  : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._date.getSeconds(); },
      <span class="hljs-string">'%L'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pad(<span class="hljs-keyword">this</span>._date.getMilliseconds(), <span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>); },
      <span class="hljs-string">'%-L'</span>  : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._date.getMilliseconds(); },
      <span class="hljs-string">'%w'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._date.getDay(); },
      <span class="hljs-string">'%y'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pad(<span class="hljs-keyword">this</span>._date.getFullYear() % <span class="hljs-number">100</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>); },
      <span class="hljs-string">'%Y'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._date.getFullYear(); },
      <span class="hljs-string">'%Z'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._timezoneAbbr(<span class="hljs-keyword">this</span>._date); },
      <span class="hljs-string">'%z'</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> offset = <span class="hljs-keyword">this</span>._date.getTimezoneOffset();
        <span class="hljs-keyword">var</span> absOffsetHours    = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.abs(offset / <span class="hljs-number">60</span>));
        <span class="hljs-keyword">var</span> absOffsetMinutes  = <span class="hljs-built_in">Math</span>.abs(offset) - (absOffsetHours * <span class="hljs-number">60</span>);
        <span class="hljs-keyword">return</span> (offset &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"-"</span> : <span class="hljs-string">"+"</span>) + <span class="hljs-keyword">this</span>._pad(absOffsetHours, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>) + <span class="hljs-keyword">this</span>._pad(absOffsetMinutes, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);
      },
      <span class="hljs-string">'%:z'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> tzOffset = <span class="hljs-keyword">this</span>.strftimeMods[<span class="hljs-string">'%z'</span>]();
        <span class="hljs-keyword">return</span> tzOffset.slice(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>) + <span class="hljs-string">':'</span> + tzOffset.slice(<span class="hljs-number">3</span>);
      }
    }
  };

  extension.t = extension.translate;
  extension.l = extension.strftime;

  <span class="hljs-keyword">return</span> extension;
})());

pie.i18n.defaultTranslations = {
  app: {
    sentence: {
      conjunction: <span class="hljs-string">' and '</span>,
      delimeter: <span class="hljs-string">', '</span>
    },

    timeago: {
      now: <span class="hljs-string">"just now"</span>,
      minutes: {
        one:    <span class="hljs-string">"%{count} minute ago"</span>,
        other:  <span class="hljs-string">"%{count} minutes ago"</span>
      },
      hours: {
        one:    <span class="hljs-string">"%{count} hour ago"</span>,
        other:  <span class="hljs-string">"%{count} hours ago"</span>
      },
      days: {
        one:    <span class="hljs-string">"%{count} day ago"</span>,
        other:  <span class="hljs-string">"%{count} days ago"</span>
      },
      weeks: {
        one:    <span class="hljs-string">"%{count} week ago"</span>,
        other:  <span class="hljs-string">"%{count} weeks ago"</span>
      },
      months: {
        one:    <span class="hljs-string">"%{count} month ago"</span>,
        other:  <span class="hljs-string">"%{count} months ago"</span>
      },
      years: {
        one:    <span class="hljs-string">"%{count} year ago"</span>,
        other:  <span class="hljs-string">"%{count} years ago"</span>
      }
    },
    time: {
      today: <span class="hljs-string">"Today"</span>,
      tomorrow: <span class="hljs-string">"Tomorrow"</span>,
      formats: {
        isoDate:    <span class="hljs-string">'%Y-%m-%d'</span>,
        isoTime:    <span class="hljs-string">'%Y-%m-%dT%H:%M:%S.%L%:z'</span>,
        shortDate:  <span class="hljs-string">'%m/%d/%Y'</span>,
        longDate:   <span class="hljs-string">'%B %+d, %Y'</span>
      },
      meridiems: {
        am: <span class="hljs-string">'am'</span>,
        pm: <span class="hljs-string">'pm'</span>
      },
      ordinals: {
        o0: <span class="hljs-string">"th"</span>,
        o1: <span class="hljs-string">"st"</span>,
        o2: <span class="hljs-string">"nd"</span>,
        o3: <span class="hljs-string">"rd"</span>,
        o4: <span class="hljs-string">"th"</span>,
        o5: <span class="hljs-string">"th"</span>,
        o6: <span class="hljs-string">"th"</span>,
        o7: <span class="hljs-string">"th"</span>,
        o8: <span class="hljs-string">"th"</span>,
        o9: <span class="hljs-string">"th"</span>
      },
      day_names: [
        <span class="hljs-string">'Sunday'</span>,
        <span class="hljs-string">'Monday'</span>,
        <span class="hljs-string">'Tuesday'</span>,
        <span class="hljs-string">'Wednesday'</span>,
        <span class="hljs-string">'Thursday'</span>,
        <span class="hljs-string">'Friday'</span>,
        <span class="hljs-string">'Saturday'</span>
      ],
      short_day_names: [
        <span class="hljs-string">'Sun'</span>,
        <span class="hljs-string">'Mon'</span>,
        <span class="hljs-string">'Tue'</span>,
        <span class="hljs-string">'Wed'</span>,
        <span class="hljs-string">'Thu'</span>,
        <span class="hljs-string">'Fri'</span>,
        <span class="hljs-string">'Sat'</span>
      ],
      month_names: [
        <span class="hljs-string">'January'</span>,
        <span class="hljs-string">'February'</span>,
        <span class="hljs-string">'March'</span>,
        <span class="hljs-string">'April'</span>,
        <span class="hljs-string">'May'</span>,
        <span class="hljs-string">'June'</span>,
        <span class="hljs-string">'July'</span>,
        <span class="hljs-string">'August'</span>,
        <span class="hljs-string">'September'</span>,
        <span class="hljs-string">'October'</span>,
        <span class="hljs-string">'November'</span>,
        <span class="hljs-string">'December'</span>
      ],
      short_month_names: [
        <span class="hljs-string">'Jan'</span>,
        <span class="hljs-string">'Feb'</span>,
        <span class="hljs-string">'Mar'</span>,
        <span class="hljs-string">'Apr'</span>,
        <span class="hljs-string">'May'</span>,
        <span class="hljs-string">'Jun'</span>,
        <span class="hljs-string">'Jul'</span>,
        <span class="hljs-string">'Aug'</span>,
        <span class="hljs-string">'Sep'</span>,
        <span class="hljs-string">'Oct'</span>,
        <span class="hljs-string">'Nov'</span>,
        <span class="hljs-string">'Dec'</span>
      ]
    },

    validations: {

      ccNumber:           <span class="hljs-string">"does not look like a credit card number"</span>,
      ccSecurity:         <span class="hljs-string">"is not a valid security code"</span>,
      ccExpirationMonth:  <span class="hljs-string">"is not a valid expiration month"</span>,
      ccExpirationYear:   <span class="hljs-string">"is not a valid expiration year"</span>,
      ccExpirationDate:   <span class="hljs-string">"is not a valid expiration date"</span>,
      chosen:             <span class="hljs-string">"must be chosen"</span>,
      date:               <span class="hljs-string">"is not a valid date"</span>,
      email:              <span class="hljs-string">"must be a valid email"</span>,
      format:             <span class="hljs-string">"is invalid"</span>,
      inclusion:          <span class="hljs-string">"is not a valid value"</span>,
      integer:            <span class="hljs-string">"must be an integer"</span>,
      length:             <span class="hljs-string">"length must be"</span>,
      number:             <span class="hljs-string">"must be a number"</span>,
      phone:              <span class="hljs-string">"is not a valid phone number"</span>,
      presence:           <span class="hljs-string">"can't be blank"</span>,
      uniqueness:         <span class="hljs-string">"is not unique"</span>,
      url:                <span class="hljs-string">"must be a valid url"</span>,

      range_messages: {
        eq:  <span class="hljs-string">"equal to %{count}"</span>,
        lt:  <span class="hljs-string">"less than %{count}"</span>,
        gt:  <span class="hljs-string">"greater than %{count}"</span>,
        lte: <span class="hljs-string">"less than or equal to %{count}"</span>,
        gte: <span class="hljs-string">"greater than or equal to %{count}"</span>
      }
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-299">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-299">&#182;</a>
              </div>
              <h1 id="pie-list">Pie List</h1>
<p>A model representing a list. Essentially an array wrapper.
List models provide observation for:</p>
<ul>
<li>The entire list</li>
<li>Specific indexes</li>
<li>Length of the list</li>
<li>Any other key not related to the list.
Optionally, a list can provide a <code>cast</code> option which it will use
to cast plain object index values into. <code>castOptions</code> can also be supplied
which will be provided as the second argument to the cast’ constructor.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.list = pie.model.extend(<span class="hljs-string">'list'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arrayOrData, options)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(arrayOrData)) arrayOrData = {items: arrayOrData};
    <span class="hljs-keyword">this</span>._super(arrayOrData, options);
    <span class="hljs-keyword">this</span>.boundChangeObserver = <span class="hljs-keyword">this</span>.onItemChange.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.data.items = pie.array.from(<span class="hljs-keyword">this</span>.data.items).map(<span class="hljs-keyword">this</span>._cast.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-300">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-300">&#182;</a>
              </div>
              <p><strong> pie.list._cast </strong></p>
<p>Casts a <code>value</code> to the option-provided <code>cast</code>.
The first argument provided to the cast is the object itself, the
second is the options-provided castOptions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _cast: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">var</span> klass = <span class="hljs-keyword">this</span>.options.cast;
    <span class="hljs-keyword">if</span>(klass === <span class="hljs-literal">true</span>) klass = pie.model;

    <span class="hljs-keyword">if</span>(klass &amp;&amp; pie.object.isPlainObject(value)) {
      value = klass.create(value, <span class="hljs-keyword">this</span>.options.castOptions);
    }

    <span class="hljs-keyword">this</span>._observeItem(value);

    <span class="hljs-keyword">return</span> value;
  },

  _observeItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.observeItems === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(!child.observe) <span class="hljs-keyword">return</span>;

    child.observe(<span class="hljs-keyword">this</span>.boundChangeObserver, <span class="hljs-string">'__version'</span>);
  },

  _unobserveItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.observeItems === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(!child || !child.unobserve) <span class="hljs-keyword">return</span>;
    child.unobserve(<span class="hljs-keyword">this</span>.boundChangeObserver, <span class="hljs-string">'__version'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-301">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-301">&#182;</a>
              </div>
              <p><strong> pie.list._normalizeIndex </strong></p>
<p>Converts a potential index into the numeric form.
If the index is negative, it should represent the index from the end of the current list.</p>
<pre><code><span class="hljs-comment">// assuming a list length of 3</span>
list._normalizeIndex(<span class="hljs-string">'foo'</span>) <span class="hljs-comment">//=&gt; 'foo'</span>
list._normalizeIndex(<span class="hljs-string">'4'</span>) <span class="hljs-comment">//=&gt; 4</span>
list._normalizeIndex(-<span class="hljs-number">1</span>) <span class="hljs-comment">//=&gt; 2</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  _normalizedIndex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(wanted)</span> </span>{
    wanted = <span class="hljs-built_in">parseInt</span>(wanted, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isNaN</span>(wanted) &amp;&amp; wanted &lt; <span class="hljs-number">0</span>) wanted += <span class="hljs-keyword">this</span>.data.items.length;
    <span class="hljs-keyword">return</span> wanted;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-302">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-302">&#182;</a>
              </div>
              <p><strong> pie.list._trackMutations </strong></p>
<p>Track changes to the array which occur during <code>fn</code>‘s execution.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _trackMutations: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, fn)</span> </span>{

    <span class="hljs-keyword">var</span> oldLength = <span class="hljs-keyword">this</span>.data.items.length,
    newLength;

    fn.call();

    newLength = <span class="hljs-keyword">this</span>.data.items.length;

    <span class="hljs-keyword">if</span>(!options || !options.skipTrackMutations) {
      <span class="hljs-keyword">if</span>(oldLength !== newLength) {
        <span class="hljs-keyword">this</span>.addChangeRecord(<span class="hljs-string">'length'</span>, <span class="hljs-string">'update'</span>, oldLength, newLength)
      }

      <span class="hljs-keyword">this</span>.addChangeRecord(<span class="hljs-string">'items'</span>, <span class="hljs-string">'update'</span>, <span class="hljs-keyword">this</span>.data.items, <span class="hljs-keyword">this</span>.data.items);
    }

    <span class="hljs-keyword">if</span>(options &amp;&amp; options.skipObservers) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deliverChangeRecords();
  },

  onItemChange: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changeSet)</span> </span>{
    <span class="hljs-keyword">var</span> item = changeSet[<span class="hljs-number">0</span>].object;
    <span class="hljs-keyword">if</span>(!item) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-303">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-303">&#182;</a>
              </div>
              <p>todo, create a uid based index hash which would make this much faster.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>.indexOf(item);
    <span class="hljs-keyword">this</span>.addChangeRecord(<span class="hljs-string">'items*'</span>, <span class="hljs-string">'item:change'</span>, item, item, {changes: changeSet, index: idx});

    <span class="hljs-keyword">this</span>.deliverChangeRecords();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-304">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-304">&#182;</a>
              </div>
              <p><strong> pie.list.forEach </strong></p>
<p>Iterate the list, calling <code>f</code> with each item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  forEach: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>).forEach(f);
  },

  map: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>).map(f);
  },

  filter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>).filter(f);
  },

  sort: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listSort</span><span class="hljs-params">()</span></span>{

      <span class="hljs-keyword">var</span> items = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>);
      items.sort(f);

      <span class="hljs-keyword">this</span>.addChangeRecord(<span class="hljs-string">'items'</span>, <span class="hljs-string">'reorder'</span>, items, items);

    }.bind(<span class="hljs-keyword">this</span>));
  },

  detect: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span> </span>{
    <span class="hljs-keyword">return</span> pie.array.detect(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>), fn);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-305">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-305">&#182;</a>
              </div>
              <p><strong> pie.list.get </strong></p>
<p>Get an item at a specific index.
<code>key</code> can be any valid input to <code>_normalizeIndex</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key), path;

    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(idx)) path = key;
    <span class="hljs-keyword">else</span> path = <span class="hljs-string">'items.'</span> + idx;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._super(path);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-306">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-306">&#182;</a>
              </div>
              <p><strong> pie.list.indexOf </strong></p>
<p>Find the index of a specific value.
Uses the standard array equality check for indexOf.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  indexOf: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>).indexOf(value);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-307">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-307">&#182;</a>
              </div>
              <p><strong> pie.list.insert </strong></p>
<p>Insert <code>value</code> at the index specified by <code>key</code>.
Returns the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  insert: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listInsert</span><span class="hljs-params">()</span></span>{

      value = <span class="hljs-keyword">this</span>._cast(value);

      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key);

      <span class="hljs-keyword">this</span>.addChangeRecord(<span class="hljs-string">'items*'</span>, <span class="hljs-string">'item:add'</span>, <span class="hljs-keyword">this</span>.data.items[idx], value, {index: idx});

      <span class="hljs-keyword">this</span>.data.items.splice(idx, <span class="hljs-number">0</span>, value);

    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-308">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-308">&#182;</a>
              </div>
              <p><strong> pie.list.length </strong></p>
<p>The length of the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  length: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items.length'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-309">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-309">&#182;</a>
              </div>
              <p><strong> pie.list.pop </strong></p>
<p>Pop an item off the end of the list.
Returns the item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pop: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">var</span> l = <span class="hljs-keyword">this</span>.length(), value;

    <span class="hljs-keyword">if</span>(!l) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listPop</span><span class="hljs-params">()</span> </span>{

      value = <span class="hljs-keyword">this</span>.data.items.pop();
      <span class="hljs-keyword">this</span>.addChangeRecord(<span class="hljs-string">'items*'</span>, <span class="hljs-string">'item:delete'</span>, value, <span class="hljs-literal">undefined</span>, {index: <span class="hljs-keyword">this</span>.data.items.length});

      <span class="hljs-keyword">this</span>._unobserveItem(value);

    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> value;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-310">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-310">&#182;</a>
              </div>
              <p><strong> pie.list.push </strong></p>
<p>Add an item to the end of the list.
Returns the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  push: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listPush</span><span class="hljs-params">()</span></span>{

      value = <span class="hljs-keyword">this</span>._cast(value);

      <span class="hljs-keyword">this</span>.addChangeRecord(<span class="hljs-string">'items*'</span>, <span class="hljs-string">'item:add'</span>, <span class="hljs-literal">undefined</span>, value, {index: <span class="hljs-keyword">this</span>.data.items.length});

      <span class="hljs-keyword">this</span>.data.items.push(value);
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-311">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-311">&#182;</a>
              </div>
              <p><strong> pie.list.remove </strong></p>
<p>Remove a specific index from the list.
Returns the removed item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span> </span>{

    <span class="hljs-keyword">var</span> value;

    <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listRemove</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key);

      value = <span class="hljs-keyword">this</span>.data.items[idx];
      <span class="hljs-keyword">this</span>.data.items.splice(idx, <span class="hljs-number">1</span>);

      <span class="hljs-keyword">this</span>._unobserveItem(value);

      <span class="hljs-keyword">this</span>.addChangeRecord(<span class="hljs-string">'items*'</span>, <span class="hljs-string">'item:delete'</span>, value, <span class="hljs-keyword">this</span>.data.items[idx], {index: idx});
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> value;
  },

  removeAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span> </span>{
    <span class="hljs-keyword">if</span>(!fn) {
      <span class="hljs-keyword">this</span>.setItems([]);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

    <span class="hljs-keyword">var</span> items = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; items.length; i++) {
      <span class="hljs-keyword">if</span>(fn(items[i])) {
        <span class="hljs-keyword">this</span>.remove(i)
        i--;
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-312">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-312">&#182;</a>
              </div>
              <p><strong> pie.list.set </strong></p>
<p>Set an attribute or an index based on <code>key</code> to <code>value</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, options)</span> </span>{
    <span class="hljs-keyword">if</span>(key === <span class="hljs-string">'items'</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.setItems(value, options);

    <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key);

    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(idx)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._super(key, value, options);
    }

    <span class="hljs-keyword">var</span> innerOptions = pie.object.merge({}, options, {skipTrackMutations: <span class="hljs-literal">true</span>, skipObservers: <span class="hljs-literal">true</span>});

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listSet</span><span class="hljs-params">()</span></span>{

      <span class="hljs-keyword">this</span>.remove(key, innerOptions);

      <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">this</span>.insert(key, value, innerOptions);

    }.bind(<span class="hljs-keyword">this</span>));
  },

  setItems: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, options)</span> </span>{
    arr = arr || [];

    <span class="hljs-keyword">var</span> innerOptions = pie.object.merge({}, options, {
      skipTrackMutations: <span class="hljs-literal">true</span>,
      skipObservers: <span class="hljs-literal">true</span>
    });

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listSetItems</span><span class="hljs-params">()</span></span>{

      <span class="hljs-keyword">while</span>(<span class="hljs-keyword">this</span>.length()) {
        <span class="hljs-keyword">this</span>.pop(innerOptions);
      }

      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arr.length; i++) {
        <span class="hljs-keyword">this</span>.push(arr[i], innerOptions);
      }

    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-313">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-313">&#182;</a>
              </div>
              <p><strong> pie.list.shift </strong></p>
<p>Shift an item off the front of the list.
Returns the removed item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  shift: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.remove(<span class="hljs-number">0</span>, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-314">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-314">&#182;</a>
              </div>
              <p><strong> pie.list.unshift </strong></p>
<p>Insert an item at the beginning of the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unshift: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.insert(<span class="hljs-number">0</span>, value, options);
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-315">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-315">&#182;</a>
              </div>
              <h1 id="pie-listview">Pie ListView</h1>
<p>A view mixin for easily managing a series of items. It assumes the activeView mixin has already been applied to your view.</p>
<pre><code>list = <span class="hljs-keyword">new</span> pie.listView({
  template: <span class="hljs-string">'userList'</span>,
  itemOptions: {
    template: <span class="hljs-string">'userItem'</span>
  }
});
</code></pre><p>Available options:</p>
<ul>
<li>listOptions<ul>
<li><strong>containerSel -</strong> the selector within this view’s template to append items to. Defaults to “ul, ol, .js-items-container”. If no match is found the view’s <code>el</code> is used.</li>
<li><strong>loadingClass -</strong> the loading class to be added to the list container while items are being removed, setup, and added. Defaults to “is-loading”.</li>
<li><strong>modelAttribute -</strong> the attribute to extract list data from. Defaults to <code>items</code> to work with pie.list.</li>
<li><strong>minLoadingTime -</strong> if a loading class is added, the minimum time it should be shown. Defaults to 0.</li>
</ul>
</li>
<li>itemOptions<ul>
<li><strong>factory -</strong> a function used to generate the item view(s). If none is supplied, an activeView will be constructed with the item data &amp; the parent’s renderData as the renderData.</li>
<li><strong>template -</strong> assuming a substitute factory is not provided, this is the template (name) to apply to the default activeView.</li>
<li><strong>any option -</strong> any set of option you’d like to pass to your view.</li>
</ul>
</li>
<li>emptyOptions<ul>
<li><strong>any option -</strong> these options are identical to the itemOptions.</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.listView = pie.activeView.extend(<span class="hljs-string">'listView'</span>, (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

  <span class="hljs-keyword">var</span> viewFactory = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, itemData)</span></span>{
    options = pie.object.merge({ model: itemData }, options);
    <span class="hljs-keyword">return</span> pie.activeView.create(options);
  };

  <span class="hljs-keyword">var</span> listChildContainer = pie.base.extend(<span class="hljs-string">'listChildContainer'</span>, pie.mixins.container);

  <span class="hljs-keyword">return</span> {

    init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

      <span class="hljs-keyword">this</span>.options = pie.object.deepMerge({
        listOptions: {
          loadingClass: <span class="hljs-string">'is-loading'</span>,
          modelAttribute: <span class="hljs-string">'items'</span>,
          minLoadingTime: <span class="hljs-literal">null</span>
        },
        itemOptions: {
          factory: viewFactory
        },
        emptyOptions: {
          factory: viewFactory
        }
      }, <span class="hljs-keyword">this</span>.options);

      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.options.itemOptions.factory) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"No view factory provided"</span>);
      }

      <span class="hljs-keyword">this</span>.list = <span class="hljs-keyword">this</span>.list || pie.list.create([]);
      <span class="hljs-keyword">this</span>.model = <span class="hljs-keyword">this</span>.model || <span class="hljs-keyword">this</span>.list;

      <span class="hljs-keyword">this</span>.listItems = listChildContainer.create();</pre></div></div>
            
        </li>
        
        
        <li id="section-316">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-316">&#182;</a>
              </div>
              <p>to ensure bubbling gets to us.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.addChild(<span class="hljs-string">'listItems'</span>, <span class="hljs-keyword">this</span>.listItems);
    },

    setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>.observe(<span class="hljs-keyword">this</span>.list, <span class="hljs-string">'manageListUpdates'</span>, <span class="hljs-string">'items*'</span>, <span class="hljs-string">'items'</span>);
      <span class="hljs-keyword">this</span>.observe(<span class="hljs-keyword">this</span>.list, <span class="hljs-string">'manageEmptyItem'</span>, <span class="hljs-string">'length'</span>);

      <span class="hljs-keyword">this</span>.eon(<span class="hljs-string">'render:after'</span>, <span class="hljs-string">'bootstrapItems'</span>);

      <span class="hljs-keyword">this</span>.eon(<span class="hljs-string">'renderItems:before'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">beforeRenderItems</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">this</span>.setListLoadingStyle(<span class="hljs-literal">true</span>); }.bind(<span class="hljs-keyword">this</span>));
      <span class="hljs-keyword">this</span>.eon(<span class="hljs-string">'renderItems:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">afterRenderItems</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">this</span>.setListLoadingStyle(<span class="hljs-literal">false</span>); }.bind(<span class="hljs-keyword">this</span>));

      <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    },

    findChildByItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.listItems.getChild(<span class="hljs-keyword">this</span>.childName(item));
    },

    childName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-string">'item-'</span> + pie.uid(item);
    },

    bootstrapItems: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(containerEl)</span> </span>{
      <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'renderItems'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listViewBootstrapItems</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> uid, child, containerEl;

        containerEl = containerEl || <span class="hljs-keyword">this</span>.listContainer();

        <span class="hljs-keyword">this</span>.list.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listViewBootstrapItem</span><span class="hljs-params">(item, i)</span> </span>{
          child = <span class="hljs-keyword">this</span>.findChildByItem(item) || <span class="hljs-keyword">this</span>.buildItemChild(item, i, containerEl);
          child.removeFromDom();
          child.addToDom(containerEl);
        }.bind(<span class="hljs-keyword">this</span>));

        <span class="hljs-keyword">this</span>.manageEmptyItem();
      }.bind(<span class="hljs-keyword">this</span>));
    },

    addItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item, idx, containerEl)</span> </span>{
      containerEl = containerEl || <span class="hljs-keyword">this</span>.listContainer();

      <span class="hljs-keyword">var</span> child = <span class="hljs-keyword">this</span>.buildItemChild(item, idx, containerEl);
      <span class="hljs-keyword">var</span> idx = child._indexWithinParent;
      <span class="hljs-keyword">var</span> nextChild = <span class="hljs-keyword">this</span>.listItems.getChild(idx + <span class="hljs-number">1</span>);

      child.addToDom(containerEl, nextChild &amp;&amp; nextChild.el);
    },

    buildItemChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item, idx, containerEl)</span> </span>{
      containerEl = containerEl || <span class="hljs-keyword">this</span>.listContainer();

      <span class="hljs-keyword">var</span> opts = pie.object.dup(<span class="hljs-keyword">this</span>.options.itemOptions),
      factory = opts.factory,
      child;

      <span class="hljs-keyword">delete</span> opts.factory;

      child = factory(opts, item);

      <span class="hljs-keyword">this</span>.listItems.addChild(<span class="hljs-keyword">this</span>.childName(item), child, idx);
      child.setup();

      <span class="hljs-keyword">return</span> child;
    },

    removeItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> </span>{
      <span class="hljs-keyword">var</span> child = <span class="hljs-keyword">this</span>.findChildByItem(item);
      <span class="hljs-keyword">if</span>(child) {
        <span class="hljs-keyword">this</span>.listItems.removeChild(child);
        child.teardown();
      }
    },

    manageListUpdates: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changeSet)</span> </span>{
      <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'renderItems'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listViewManageListUpdates</span><span class="hljs-params">()</span> </span>{

        <span class="hljs-keyword">var</span> containerEl = <span class="hljs-keyword">this</span>.listContainer();

        changeSet.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(change)</span></span>{
          <span class="hljs-keyword">this</span>.manageListUpdate(change, containerEl);
        }.bind(<span class="hljs-keyword">this</span>));

      }.bind(<span class="hljs-keyword">this</span>));
    },

    manageListUpdate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(change, containerEl)</span> </span>{
      <span class="hljs-keyword">if</span>(change.type === <span class="hljs-string">'item:add'</span>) {
        <span class="hljs-keyword">this</span>.addItem(change.value, change.index, containerEl);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (change.type === <span class="hljs-string">'item:delete'</span>) {
        <span class="hljs-keyword">this</span>.removeItem(change.oldValue);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (change.type === <span class="hljs-string">'reorder'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-317">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-317">&#182;</a>
              </div>
              <p>blow away our indexes, but don’t rebuild our children.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.listItems.sendToChildren(<span class="hljs-string">'removeFromDom'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-318">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-318">&#182;</a>
              </div>
              <p>this will find our existing children and add them back into our dom</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.bootstrapItems(containerEl);
      }
    },

    manageEmptyItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.list.length()) {
        <span class="hljs-keyword">this</span>.removeEmptyItem();
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.addEmptyItem();
      }
    },

    removeEmptyItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> empty = <span class="hljs-keyword">this</span>.getChild(<span class="hljs-string">"empty"</span>);
      <span class="hljs-keyword">if</span>(empty) {
        <span class="hljs-keyword">this</span>.removeChild(empty);
        empty.teardown();
      }
    },

    addEmptyItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> opts = pie.object.dup(<span class="hljs-keyword">this</span>.options.emptyOptions),
      factory = opts.factory;

      <span class="hljs-keyword">delete</span> opts.factory;

      <span class="hljs-keyword">if</span>(!factory) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">var</span> child = factory(opts, {});

      <span class="hljs-keyword">this</span>.addChild(<span class="hljs-string">'empty'</span>, child);
      child.addToDom(<span class="hljs-keyword">this</span>.listContainer());
      child.setup();
    },

    setListLoadingStyle: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool)</span> </span>{
      <span class="hljs-keyword">var</span> className = <span class="hljs-keyword">this</span>.options.listOptions.loadingClass;
      <span class="hljs-keyword">if</span>(!className) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">this</span>.listContainer().classList[bool ? <span class="hljs-string">'add'</span> : <span class="hljs-string">'remove'</span>](className);
    },

    listContainer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> option = <span class="hljs-keyword">this</span>.options.listOptions.sel;
      <span class="hljs-keyword">if</span>(pie.object.isString(option)) option = <span class="hljs-keyword">this</span>.qs(option);
      <span class="hljs-keyword">if</span>(!option) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.el;
      <span class="hljs-keyword">return</span> option;
    },

    teardownChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>._super();
      <span class="hljs-keyword">this</span>._super.call(<span class="hljs-keyword">this</span>.listItems);
    }

  };
})());</pre></div></div>
            
        </li>
        
        
        <li id="section-319">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-319">&#182;</a>
              </div>
              <h1 id="pie-navigator">Pie Navigator</h1>
<p>The navigator is in charge of observing browser navigation and updating it’s data.
It’s also the place to conduct push/replaceState history changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.navigator = pie.base.extend(<span class="hljs-string">'navigator'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super();

    <span class="hljs-keyword">this</span>.app = app;
    <span class="hljs-keyword">this</span>.options = options;

    <span class="hljs-keyword">this</span>.state = <span class="hljs-keyword">this</span>.app.state;

    <span class="hljs-keyword">this</span>.app.emitter.once(<span class="hljs-string">'start'</span>, <span class="hljs-keyword">this</span>.start.bind(<span class="hljs-keyword">this</span>));
  },

  evaluateState: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.state.test(<span class="hljs-string">'__fullId'</span>, <span class="hljs-keyword">this</span>.browserPath())) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> route = <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'__route'</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.app.routeHandler.canRouteBeHandled(route)) <span class="hljs-keyword">this</span>.softGo();
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.hardGo();
  },

  softGo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> replace = !<span class="hljs-keyword">this</span>.state.is(<span class="hljs-string">'__history'</span>);
    <span class="hljs-built_in">window</span>.history[replace ? <span class="hljs-string">'replaceState'</span> : <span class="hljs-string">'pushState'</span>]({}, <span class="hljs-built_in">document</span>.title, <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'__fullId'</span>));
  },

  hardGo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">window</span>.location.href = <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'__fullId'</span>);
  },

  browserPath: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.location.pathname + <span class="hljs-built_in">window</span>.location.search;
  },

  navigateApp: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.app.go(<span class="hljs-keyword">this</span>.browserPath(), <span class="hljs-literal">true</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-320">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-320">&#182;</a>
              </div>
              <p><strong> pie.navigator.start </strong></p>
<p>Setup the pushstate observations and get our app’s state bootstrapped.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  start: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-321">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-321">&#182;</a>
              </div>
              <p>on popstate we trigger a pieHistoryChange event so any other navigator-enabled apps</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pie.dom.on(<span class="hljs-built_in">window</span>, <span class="hljs-string">'popstate'</span>, <span class="hljs-keyword">this</span>.navigateApp.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">this</span>.state.observe(<span class="hljs-keyword">this</span>.evaluateState.bind(<span class="hljs-keyword">this</span>), <span class="hljs-string">'__fullId'</span>, <span class="hljs-string">'__route'</span>);
    <span class="hljs-keyword">this</span>.navigateApp();
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-322">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-322">&#182;</a>
              </div>
              <h1 id="pie-notifier">Pie Notifier</h1>
<p>A class which provides an interface for rendering page-level notifications.
This does only structures and manages the data to be used by a view. This does not impelement
UI notifications.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.notifier = pie.base.extend(<span class="hljs-string">'notifier'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>.options = options || {};
    <span class="hljs-keyword">this</span>.app = app || <span class="hljs-keyword">this</span>.options.app || pie.appInstance;
    <span class="hljs-keyword">this</span>.notifications = pie.list.create([], {cast: <span class="hljs-literal">true</span>});

    <span class="hljs-keyword">this</span>._super();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-323">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-323">&#182;</a>
              </div>
              <p>remove all alerts, potentially filtering by the type of alert.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type)</span> </span>{
    <span class="hljs-keyword">var</span> filter = type ? <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span></span>{ <span class="hljs-keyword">return</span> m.test(<span class="hljs-string">'type'</span>, type); } : <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">this</span>.notifications.removeAll(filter);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-324">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-324">&#182;</a>
              </div>
              <p><strong> pie.notifier.notify </strong></p>
<p>Show a notification or notifications.
Messages can be a string or an array of messages.
You can choose to close a notification automatically by providing <code>true</code> as the third arg.
You can provide a number in milliseconds as the autoClose value as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  notify: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(messages, type, autoRemove)</span> </span>{
    type = type || <span class="hljs-string">'message'</span>;
    autoRemove = <span class="hljs-keyword">this</span>.getAutoRemoveTimeout(autoRemove);

    messages = pie.array.from(messages);
    messages = messages.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notifyI18nAttempter</span><span class="hljs-params">(m)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.app.i18n.attempt(m); }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">var</span> msg = {
      messages: messages,
      type: type
    };

    msg.id = pie.uid(msg);
    <span class="hljs-keyword">this</span>.notifications.push(msg);

    <span class="hljs-keyword">if</span>(autoRemove) {
      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">autoRemoveCallback</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">this</span>.remove(msg.id); }.bind(<span class="hljs-keyword">this</span>), autoRemove);
    }

  },

  getAutoRemoveTimeout: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(timeout)</span> </span>{
    <span class="hljs-keyword">if</span>(timeout === <span class="hljs-literal">undefined</span>) timeout = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(timeout &amp;&amp; !pie.object.isNumber(timeout)) timeout = <span class="hljs-number">7000</span>;
    <span class="hljs-keyword">return</span> timeout;
  },

  remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msgId)</span> </span>{
    <span class="hljs-keyword">var</span> idx = pie.array.indexOf(<span class="hljs-keyword">this</span>.notifications.get(<span class="hljs-string">'items'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span></span>{ <span class="hljs-keyword">return</span> n.get(<span class="hljs-string">'id'</span>) == msgId; });
    <span class="hljs-keyword">if</span>(~idx) <span class="hljs-keyword">this</span>.notifications.remove(idx);
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-325">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-325">&#182;</a>
              </div>
              <h1 id="pie-resources">Pie Resources</h1>
<p>An external resource loader. It specializes in retrieving scripts, stylesheets, and generic ajax content.
Upon load of the external resource a callback can be fired. Resources can be registered beforehand to make
development a bit easier and more standardized.</p>
<pre><code>resources.define(<span class="hljs-string">'googleMaps'</span>, <span class="hljs-string">'//maps.google.com/.../js'</span>);
resources.define(<span class="hljs-string">'templates'</span>, {src: <span class="hljs-string">'/my-templates.html'</span>, dataSuccess: parseTemplates});

resources.load(<span class="hljs-string">'googleMaps'</span>, <span class="hljs-string">'templates'</span>, <span class="hljs-string">'customI18n'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  google.Maps.doStuff();
});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.resources = pie.model.extend(<span class="hljs-string">'resources'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-326">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-326">&#182;</a>
              </div>
              <p><strong> pie.resources.init </strong></p>
<p>Provide an app and a source map (shortcut all the <code>resources.define()</code> calls).</p>
<pre><code>pie.resources.create(app, {googleMaps: <span class="hljs-string">'//maps.google.com/.../js'</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, srcMap)</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      srcMap: srcMap || {},
      loaded: {}
    }, {
      app: app
    });

    pie.object.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
      <span class="hljs-keyword">this</span>.define(k, v);
    }.bind(<span class="hljs-keyword">this</span>));
  },

  _appendNode: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(node)</span> </span>{
    <span class="hljs-keyword">var</span> target = pie.qs(<span class="hljs-string">'head'</span>);
    target = target || <span class="hljs-built_in">document</span>.body;
    target.appendChild(node);
  },

  _inferredResourceType: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(src)</span> </span>{
    <span class="hljs-keyword">if</span>((<span class="hljs-regexp">/(\.|\/)js(\?|$)/</span>).test(src)) <span class="hljs-keyword">return</span> <span class="hljs-string">'script'</span>;
    <span class="hljs-keyword">if</span>((<span class="hljs-regexp">/(\.|\/)css(\?|$)/</span>).test(src)) <span class="hljs-keyword">return</span> <span class="hljs-string">'link'</span>;
    <span class="hljs-keyword">if</span>((<span class="hljs-regexp">/\.(png|jpeg|jpg|gif|svg|tiff|tif)(\?|$)/</span>).test(src)) <span class="hljs-keyword">return</span> <span class="hljs-string">'image'</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'ajax'</span>;
  },

  _normalizeSrc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(srcOrOptions)</span> </span>{
    <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">typeof</span> srcOrOptions === <span class="hljs-string">'string'</span> ? {src: srcOrOptions} : pie.object.merge({}, srcOrOptions);
    <span class="hljs-keyword">return</span> options;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-327">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-327">&#182;</a>
              </div>
              <p><strong>pie.resources._loadajax</strong></p>
<p>Conduct an ajax request and invoke the <code>resourceOnload</code> function when complete</p>
<p>Options:</p>
<ul>
<li><strong>src</strong> - the url of the request</li>
<li><strong> * </strong> - any valid ajax options</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _loadajax: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">var</span> ajaxOptions = pie.object.merge({
      verb: <span class="hljs-string">'GET'</span>,
      url: options.src
    }, options);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.app.ajax.ajax(ajaxOptions).promise();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-328">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-328">&#182;</a>
              </div>
              <p><strong>pie.resources._loadimage</strong></p>
<p>Load an image and invoke <code>resourceOnload</code> when complete.
Options:</p>
<ul>
<li><strong>src</strong> - the url of the image.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _loadimage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, resourceOnload)</span> </span>{
    <span class="hljs-keyword">return</span> pie.promise.create(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve, reject)</span></span>{
      <span class="hljs-keyword">var</span> img = <span class="hljs-keyword">new</span> Image();
      img.onload = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ resolve(pie.object.merge({ img: img }, options)); };
      img.onerror = reject;
      img.src = options.src;
    });

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-329">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-329">&#182;</a>
              </div>
              <p><strong>pie.resources._loadlink</strong></p>
<p>Adds a <code>&lt;link&gt;</code> tag to the dom if the “type” of the resource is “link”.</p>
<p>Options:</p>
<ul>
<li><strong>src</strong> - the url of the resource</li>
<li><strong>media</strong> - <em>(optional)</em> defaulting to <code>screen</code>, it’s the media attribute of the <code>&lt;link&gt;</code></li>
<li><strong>rel</strong> - <em>(optional)</em> defaulting to <code>stylesheet</code>, it’s the rel attribute of the <code>&lt;link&gt;</code></li>
<li><strong>contentType</strong> - <em>(optional)</em> defaulting to <code>text/css</code>, it’s the type attribute of the <code>&lt;link&gt;</code></li>
</ul>
<p><em>Note that since <code>&lt;link&gt;</code> tags don’t provide a callback, the onload happens immediately.</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _loadlink: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">var</span> link = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'link'</span>);

    link.href = options.src;
    link.media = options.media || <span class="hljs-string">'screen'</span>;
    link.rel = options.rel || <span class="hljs-string">'stylesheet'</span>;
    link.type = options.contentType || <span class="hljs-string">'text/css'</span>;

    <span class="hljs-keyword">this</span>._appendNode(link);

    <span class="hljs-comment">/* Need to record that we added this thing. */</span>
    <span class="hljs-comment">/* The resource may not actually be present yet. */</span>
    <span class="hljs-keyword">return</span> pie.promise.resolve();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-330">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-330">&#182;</a>
              </div>
              <p><strong>pie.resources._loadscript</strong></p>
<p>Adds a <code>&lt;script&gt;</code> tag to the dom if the “type” is “script”</p>
<p>Options:</p>
<ul>
<li><strong>src</strong> - the url of the script.</li>
<li><strong>callbackName</strong> - <em>(optional)</em> the global callback name the loading library will invoke</li>
<li><strong>noAsync</strong> - <em>(optional)</em> if true, the script will be loaded synchronously.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _loadscript: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{

    <span class="hljs-keyword">return</span> pie.promise.create(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve, reject)</span> </span>{
      <span class="hljs-keyword">var</span> script = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);

      <span class="hljs-keyword">if</span>(options.noAsync) script.async = <span class="hljs-literal">false</span>;

      <span class="hljs-comment">/* If options.callbackName is present, the invoking method self-references itself so it can clean itself up. */</span>
      <span class="hljs-comment">/* Because of this, we don't need to invoke the onload */</span>
      <span class="hljs-keyword">if</span>(!options.callbackName) {
        <span class="hljs-keyword">var</span> done = <span class="hljs-literal">false</span>;
        script.onload = script.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadScriptCallback</span><span class="hljs-params">()</span></span>{
          <span class="hljs-keyword">if</span>(!done &amp;&amp; (!<span class="hljs-keyword">this</span>.readyState || <span class="hljs-keyword">this</span>.readyState===<span class="hljs-string">'loaded'</span> || <span class="hljs-keyword">this</span>.readyState===<span class="hljs-string">'complete'</span>)) {
            done = <span class="hljs-literal">true</span>;
            resolve();
          }
        };

        script.onerror = reject;
      }

      <span class="hljs-keyword">this</span>._appendNode(script);
      script.src = options.src;

    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-331">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-331">&#182;</a>
              </div>
              <p><strong> pie.resources.define </strong></p>
<p>Define a resource by human readable <code>name</code>. <code>srcOrOptions</code> is a url or
an options hash as described by the relevant <code>_load</code> function.</p>
<pre><code>resources.define(<span class="hljs-string">'googleMaps'</span>, <span class="hljs-string">'//maps.google.com/.../js'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  define: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, srcOrOptions)</span> </span>{
    <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">this</span>._normalizeSrc(srcOrOptions);
    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'srcMap.'</span> + name, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-332">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-332">&#182;</a>
              </div>
              <p><strong> pie.resources.load </strong></p>
<p>Load resources defined by each argument.
If the last argument is a function it will be invoked after all resources have loaded.</p>
<pre><code>resources.load(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callback</span><span class="hljs-params">()</span></span>{});
resources.load([<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
resources.load(<span class="hljs-string">'//maps.google.com/.../js'</span>);
resources.load({src: <span class="hljs-string">'/templates.html'</span>, dataSuccess: parseTemplates}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callback</span><span class="hljs-params">()</span></span>{});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* src1, src2, src3, onload */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> sources = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>),
    promises;

    sources = sources.map(<span class="hljs-keyword">this</span>._normalizeSrc.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-comment">/* we generate a series of functions to be invoked by pie.fn.async */</span>
    <span class="hljs-comment">/* each function's responsibility is to invoke the provided callback when the resource is loaded */</span>
    promises = sources.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resourceLoadPromiseGenerator</span><span class="hljs-params">(options)</span></span>{

      <span class="hljs-comment">/* we could be dealing with an alias, so make sure to grab the real source */</span>
      options = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'srcMap.'</span> + options.src) || options;

      <span class="hljs-comment">/* we cache the loading promise on our promises object */</span>
      <span class="hljs-keyword">var</span> promise = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'promises.'</span> + options.src);
      <span class="hljs-keyword">var</span> type = options.type || <span class="hljs-keyword">this</span>._inferredResourceType(options.src)

      <span class="hljs-keyword">if</span>(!promise) {
        promise = <span class="hljs-keyword">this</span>[<span class="hljs-string">'_load'</span> + type](options);

        <span class="hljs-comment">/* if a global callback name is desired, set it up then tear it down when the promise resolves */</span>
        <span class="hljs-keyword">if</span>(options.callbackName) {
          <span class="hljs-built_in">window</span>[options.callbackName] = promise.resolve.bind(promise);
          promise = promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">delete</span> <span class="hljs-built_in">window</span>[options.callbackName]; });
        }

        <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'promises.'</span> + options.src, promise);
      }

      <span class="hljs-keyword">return</span> promise;
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> pie.promise.all(promises);
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-333">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-333">&#182;</a>
              </div>
              <h1 id="pie-route">Pie Route</h1>
<p>Represents a route used by the router.
Routes understand if they match string paths, they know how to extract interpolations from a path,
and know how to generate a path given some data.</p>
<pre><code>r = pie.route.create(<span class="hljs-string">'/foo/:id'</span>);

r.isDirectMatch(<span class="hljs-string">'/foo/bar'</span>)
<span class="hljs-comment">//=&gt; false</span>
r.isMatch(<span class="hljs-string">'/foo/bar'</span>)
<span class="hljs-comment">//=&gt; true</span>

r.interpolations(<span class="hljs-string">'/foo/bar'</span>)
<span class="hljs-comment">//=&gt; {id: 'bar'}</span>

r.path({id: <span class="hljs-string">'baz'</span>, page: <span class="hljs-number">2</span>})
<span class="hljs-comment">//=&gt; '/foo/baz?page=2'</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.route = pie.model.extend(<span class="hljs-string">'route'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, config)</span> </span>{
    <span class="hljs-keyword">var</span> uid = pie.uid(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>._super({
      pathTemplate: pie.string.normalizeUrl(path),
      config: config,
      name: config &amp;&amp; config.name || (<span class="hljs-string">"route-"</span> + uid)
    });

    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'config.name'</span>, <span class="hljs-literal">undefined</span>);

    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'segments'</span>,            <span class="hljs-string">'pathTemplate'</span>);
    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'pathRegex'</span>,           <span class="hljs-string">'pathTemplate'</span>);
    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'hasInterpolations'</span>,   <span class="hljs-string">'pathTemplate'</span>);
    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'weight'</span>,              <span class="hljs-string">'segments'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-334">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-334">&#182;</a>
              </div>
              <p><strong>pie.route.segments</strong></p>
<p>The pathTemplate split into segments.
Since this is a computed property, we only ever have to do this once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  segments: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathTemplate'</span>).split(<span class="hljs-string">'/'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-335">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-335">&#182;</a>
              </div>
              <p><strong>pie.route.pathRegex</strong></p>
<p>A RegExp representing the path.
Since this is a computed property, we only ever have to do this once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pathRegex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathTemplate'</span>);
    t = pie.string.escapeRegex(t);
    t = t.replace(<span class="hljs-regexp">/(:[^\/\?]+)/g</span>,<span class="hljs-string">'([^\\/\\?]+)'</span>);
    t = t.replace(<span class="hljs-regexp">/(\\\*[^\/]+)/g</span>, <span class="hljs-string">'(.*)'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + t + <span class="hljs-string">'$'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-336">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-336">&#182;</a>
              </div>
              <p><strong>pie.route.weight</strong></p>
<p>A weight representing the specificity of the route. It compiles a number as a string
based on the type of segment then casts the number as an integer as part of the return statement.
Specificity is determined by:
  -
Since this is a computed property, we only ever have to do this once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  weight: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> tmpls = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'segments'</span>),
    w = <span class="hljs-string">''</span>;

    tmpls.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(segment)</span></span>{
      <span class="hljs-keyword">if</span>(segment.match(<span class="hljs-regexp">/^:([^\/]+)$/</span>))
        w += <span class="hljs-string">'3'</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(segment.match(<span class="hljs-regexp">/^\*([^\/]+)$/</span>))
        w += <span class="hljs-string">'2'</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(segment === <span class="hljs-string">''</span>)
        w += <span class="hljs-string">'1'</span>;
      <span class="hljs-keyword">else</span>
        w += <span class="hljs-string">'4'</span>;
    });

    <span class="hljs-keyword">return</span> +w;
  },

  hasInterpolations: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-regexp">/[:\*]/</span>.test(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathTemplate'</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-337">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-337">&#182;</a>
              </div>
              <p><strong>pie.route.interpolations</strong></p>
<p>Under the assumption that the path is already normalized and we’ve “matched” it,
extract the interpolations from <code>path</code>. If <code>parseValues</code> is true, the values will
be parsed based on <code>pie.string.deserialize</code>‘s implementation.</p>
<pre><code>r = pie.route.create(<span class="hljs-string">'/foo/:id'</span>);
r.interolations(<span class="hljs-string">'/foo/bar'</span>);
<span class="hljs-comment">//=&gt; {id: 'bar'}</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  interpolations: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">var</span> interpolations = {};

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.is(<span class="hljs-string">'hasInterpolations'</span>)) <span class="hljs-keyword">return</span> interpolations;

    <span class="hljs-keyword">var</span> splitPaths = path.split(<span class="hljs-string">'/'</span>),
    tmpls = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'segments'</span>),
    splitPath, tmpl;

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; splitPaths.length; i++){
      tmpl = tmpls[i];
      splitPath = splitPaths[i];
      <span class="hljs-keyword">if</span>(splitPath !== tmpl) {
        <span class="hljs-keyword">if</span>(tmpl.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">':'</span>) {
          interpolations[tmpl.substr(<span class="hljs-number">1</span>)] = splitPath;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(tmpl.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'*'</span>) {
          interpolations[tmpl.substr(<span class="hljs-number">1</span>)] = pie.array.get(splitPaths, i, -<span class="hljs-number">1</span>).join(<span class="hljs-string">'/'</span>);
          <span class="hljs-keyword">break</span>;
        }
      }
    }

    <span class="hljs-keyword">return</span> interpolations;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-338">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-338">&#182;</a>
              </div>
              <p><strong>pie.route.isDirectMatch</strong></p>
<p>Is the provided <code>path</code> a direct match to our definition?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isDirectMatch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">return</span> path === <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathTemplate'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-339">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-339">&#182;</a>
              </div>
              <p><strong>pie.route.isMatch</strong></p>
<p>is the provided <code>path</code> a match based on our <code>pathRegex</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isMatch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathRegex'</span>).test(path);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-340">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-340">&#182;</a>
              </div>
              <p><strong>pie.route.path</strong></p>
<p>Generate a path based on our template &amp; the provided <code>data</code>. If <code>interpolateOnly</code> is true,
a query string will not be appended, even if there are extra items provided by <code>data</code>.</p>
<pre><code>r = pie.route.create(<span class="hljs-string">'/foo/:id'</span>);
r.path({id: <span class="hljs-string">'bar'</span>})
<span class="hljs-comment">//=&gt; '/foo/bar'</span>
r.path({id: <span class="hljs-string">'baz'</span>, page: <span class="hljs-number">2</span>});
<span class="hljs-comment">//=&gt; '/foo/baz?page=2'</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  path: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(query)</span> </span>{
    <span class="hljs-keyword">var</span> usedKeys = [], path = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathTemplate'</span>);

    path = path.replace(<span class="hljs-regexp">/([:\*])([a-zA-Z0-9_]+)/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">routePathGenerator</span><span class="hljs-params">(match, indicator, key)</span></span>{
      usedKeys.push(key);

      <span class="hljs-keyword">if</span>(indicator === <span class="hljs-string">'*'</span>) <span class="hljs-keyword">return</span> query &amp;&amp; pie.object.has(query, key) ? query[key] : <span class="hljs-string">''</span>;

      <span class="hljs-keyword">if</span>(!query || query[key] == <span class="hljs-literal">null</span> ||  !<span class="hljs-built_in">String</span>(query[key]).length) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"[PIE] missing route interpolation: "</span> + match);
      }
      <span class="hljs-keyword">return</span> query[key];
    });

    <span class="hljs-keyword">var</span> unusedData = usedKeys.length ? pie.object.except(query, usedKeys) : query;

    <span class="hljs-keyword">if</span>(!pie.object.isEmpty(unusedData)) {
      <span class="hljs-keyword">var</span> params = pie.object.serialize(pie.object.compact(unusedData, <span class="hljs-literal">true</span>));
      <span class="hljs-keyword">if</span>(params.length) path = pie.string.urlConcat(path, params);
    }

    <span class="hljs-keyword">return</span> path;
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-341">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-341">&#182;</a>
              </div>
              <h1 id="pie-router">Pie Router</h1>
<p>An interface for declaring, processing, and determing a collection of routes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.router = pie.model.extend(<span class="hljs-string">'router'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-342">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-342">&#182;</a>
              </div>
              <p><strong>pie.router.init</strong></p>
<p>Initialize a new router given an <code>app</code> and a set of options.
Options:</p>
<ul>
<li><strong>root</strong> - the root to be prepended to all constructed routes. Defaults to <code>&#39;/&#39;</code>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      root: options &amp;&amp; options.root || <span class="hljs-string">'/'</span>
    }, pie.object.merge({app: app}, options));

    <span class="hljs-keyword">this</span>.cache = pie.cache.create();
    <span class="hljs-keyword">this</span>.state = <span class="hljs-keyword">this</span>.app.state;

    <span class="hljs-keyword">if</span>(!pie.string.endsWith(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'root'</span>), <span class="hljs-string">'/'</span>)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"The root option must end in a /"</span>);

    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'rootRegex'</span>, <span class="hljs-string">'root'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-343">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-343">&#182;</a>
              </div>
              <p><strong>pie.router.rootRegex</strong></p>
<p>A regex for testing whether a path starts with the declared root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rootRegex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'root'</span>) + <span class="hljs-string">'(.+)?'</span>);
  },


  stateWillChange: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, query)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache.fetch(<span class="hljs-string">'states::'</span> + path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      path = <span class="hljs-keyword">this</span>.stripRoot(path);

      <span class="hljs-keyword">var</span> route = <span class="hljs-keyword">this</span>.findRoute(path);
      <span class="hljs-keyword">var</span> changes = { __route: route };

      <span class="hljs-keyword">if</span>(route) {
        <span class="hljs-keyword">var</span> interpolations = route.interpolations(path);
        pie.object.merge(changes, {__interpolations: interpolations}, route.get(<span class="hljs-string">'config.state'</span>), interpolations);
      }

      <span class="hljs-keyword">return</span> changes;
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-344">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-344">&#182;</a>
              </div>
              <p><strong>pie.router.findRoute</strong></p>
<p>Find the most relevant route based on <code>nameOrPath</code>.
Direct matches match first, then the most relevant pattern match comes next.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  findRoute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache.fetch(<span class="hljs-string">'routes::'</span> + path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-comment">/* if a direct match is present, we return that */</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.findDirectMatch(path) || <span class="hljs-keyword">this</span>.findPatternMatch(path);
    }.bind(<span class="hljs-keyword">this</span>));
  },

  findDirectMatch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">return</span> pie.array.detect(<span class="hljs-keyword">this</span>.children, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span></span>{ <span class="hljs-keyword">return</span> r.isDirectMatch(path); });
  },

  findPatternMatch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">return</span> pie.array.detect(<span class="hljs-keyword">this</span>.children, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span></span>{ <span class="hljs-keyword">return</span> r.isMatch(path); });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-345">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-345">&#182;</a>
              </div>
              <p><strong>pie.router.map</strong></p>
<p>Add routes to this router.
Routes objects which contain a “name” key will be added as a name lookup.
You can pass a set of defaults which will be extended into each route object.</p>
<pre><code>router.map({

  <span class="hljs-string">'/foo/:id'</span> : {subView: <span class="hljs-string">'foo'</span>,  name: <span class="hljs-string">'foo'</span>},
  <span class="hljs-string">'/bars'</span>    : {subView: <span class="hljs-string">'bars'</span>, name: <span class="hljs-string">'bars'</span>},

  <span class="hljs-string">'api.whatever'</span> : <span class="hljs-string">'/api/whatever.json'</span>
}, {
  view: <span class="hljs-string">'sublayout'</span>
});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  map: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(routes, defaults)</span></span>{
    defaults = defaults || {};

    <span class="hljs-keyword">var</span> path, config, route, existing;

    pie.object.forEach(routes, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">routerMapper</span><span class="hljs-params">(k,r)</span> </span>{

      <span class="hljs-keyword">if</span>(pie.object.isObject(r)) {
        path = k;
        config = r;
        <span class="hljs-keyword">if</span>(defaults) config = pie.object.merge({}, defaults, config);
      } <span class="hljs-keyword">else</span> {
        path = r;
        config = {name: k};
      }

      existing = <span class="hljs-keyword">this</span>.findDirectMatch(path) || config.name;
      <span class="hljs-keyword">this</span>.removeChild(existing);

      route = pie.route.create(path, config);
      <span class="hljs-keyword">this</span>.registerRoute(route);
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">this</span>.sortRoutes();
    <span class="hljs-keyword">this</span>.cache.reset();
  },

  registerRoute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route)</span> </span>{
    <span class="hljs-keyword">this</span>.addChild(route.get(<span class="hljs-string">'name'</span>), route);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-346">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-346">&#182;</a>
              </div>
              <p><strong>pie.router.path</strong></p>
<p>Will return the named path. If there is no path with that name it will return itself.
You can optionally pass a data hash and it will build the path with query params or
with path interpolation.</p>
<pre><code>router.path(<span class="hljs-string">"/foo/bar/:id"</span>, {id: <span class="hljs-string">'44'</span>, q: <span class="hljs-string">'search'</span>})
<span class="hljs-comment">//=&gt; "/foo/bar/44?q=search"</span>
</code></pre><p>nameOrPath = ‘viewB’
nameOrPath = ‘/examples/navigation/view-b’
nameOrPath = ‘/view-b’
nameOrPath = ‘view-b’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  path: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nameOrPath, query)</span> </span>{
    <span class="hljs-keyword">var</span> route, path;

    <span class="hljs-keyword">if</span>(nameOrPath.indexOf(<span class="hljs-string">'/'</span>) === <span class="hljs-number">0</span>) {
      nameOrPath = <span class="hljs-keyword">this</span>.stripRoot(nameOrPath);
      route = <span class="hljs-keyword">this</span>.findRoute(nameOrPath);
    } <span class="hljs-keyword">else</span> {
      route = <span class="hljs-keyword">this</span>.getChild(nameOrPath, <span class="hljs-literal">false</span>)
    }

    <span class="hljs-keyword">if</span>(!route) {
      route = pie.route.create(nameOrPath);
      <span class="hljs-keyword">this</span>.registerRoute(route);</pre></div></div>
            
        </li>
        
        
        <li id="section-347">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-347">&#182;</a>
              </div>
              <p>if we had a route, we might have interpolations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> interps = route.interpolations(nameOrPath);
      <span class="hljs-keyword">if</span>(!pie.object.isEmpty(interps)) {
        query = pie.object.merge({}, query, interps);
      }
    }

    path = route.path(query);
    path = <span class="hljs-keyword">this</span>.ensureRoot(path);

    <span class="hljs-keyword">return</span> path;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-348">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-348">&#182;</a>
              </div>
              <p><strong>pie.router.sortRoutes</strong></p>
<p>Sorts the routes to be the most exact to the most generic.</p>
<ul>
<li>prefers fewer interpolations to more</li>
<li>prefers more segments to less</li>
<li>prefers more characters to less</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sortRoutes: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> c;

    <span class="hljs-keyword">this</span>.sortChildren(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">routerChildSorter</span><span class="hljs-params">(a,b)</span> </span>{
      c = b.get(<span class="hljs-string">'weight'</span>) - a.get(<span class="hljs-string">'weight'</span>);
      c = c || b.get(<span class="hljs-string">'pathTemplate'</span>).length - a.get(<span class="hljs-string">'pathTemplate'</span>).length;
      c = c || a.get(<span class="hljs-string">'pathTemplate'</span>).localeCompare(b.get(<span class="hljs-string">'pathTemplate'</span>));
      <span class="hljs-keyword">return</span> c;
    });
  },

  stripRoot: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">var</span> match = path.match(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'rootRegex'</span>));
    <span class="hljs-keyword">if</span>(match) path = <span class="hljs-string">'/'</span> + (match[<span class="hljs-number">1</span>] || <span class="hljs-string">''</span>);
    <span class="hljs-keyword">return</span> path;
  },

  ensureRoot: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">if</span>(path.match(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'rootRegex'</span>))) <span class="hljs-keyword">return</span> path;

    <span class="hljs-keyword">var</span> root = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'root'</span>);
    <span class="hljs-comment">/* if path is representative of root, use our root. */</span>
    <span class="hljs-keyword">if</span>(path === <span class="hljs-string">'/'</span> || path === <span class="hljs-string">''</span>) <span class="hljs-keyword">return</span> root;
    <span class="hljs-comment">/* if the path is our root, but missing the trailing slash, use our root. */</span>
    <span class="hljs-keyword">if</span>(path === root.substr(<span class="hljs-number">0</span>, root.length-<span class="hljs-number">1</span>)) <span class="hljs-keyword">return</span> root;
    <span class="hljs-keyword">return</span> pie.string.normalizeUrl(root + path);
  }

}, pie.mixins.container);
pie.routeHandler = pie.base.extend(<span class="hljs-string">'routeHandler'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>.app = app;
    <span class="hljs-keyword">this</span>.options = pie.object.merge({
      viewNamespace: <span class="hljs-string">'lib.views'</span>,
      uiTarget: <span class="hljs-string">'body'</span>,
      viewKey: <span class="hljs-string">'view'</span>,
      viewTransitionClass: pie.simpleViewTransition,
      viewTransitionOptions: {}
    }, options);

    <span class="hljs-keyword">this</span>.state = <span class="hljs-keyword">this</span>.app.state;
    <span class="hljs-keyword">this</span>.emitter  = <span class="hljs-keyword">this</span>.app.emitter;

    <span class="hljs-keyword">this</span>.state.observe(<span class="hljs-keyword">this</span>.onRouteChange.bind(<span class="hljs-keyword">this</span>), <span class="hljs-string">'__route'</span>);
    <span class="hljs-keyword">this</span>._super();
  },

  currentView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.app.getChild(<span class="hljs-string">"currentView"</span>);
  },

  canRouteBeHandled: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.canHandleRedirect(route) || <span class="hljs-keyword">this</span>.canHandleView(route);
  },

  canHandleRedirect: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route)</span> </span>{
    <span class="hljs-keyword">return</span> route &amp;&amp; route.is(<span class="hljs-string">'config.redirect'</span>);
  },

  canHandleView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route)</span> </span>{
    <span class="hljs-keyword">return</span> route &amp;&amp; route.is(<span class="hljs-string">'config.view'</span>);
  },

  onRouteChange: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> route = <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'__route'</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.canHandleRedirect(route)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.handleRedirect(route);
    <span class="hljs-keyword">this</span>.handleView(route);
  },

  handleRedirect: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route)</span> </span>{
    <span class="hljs-keyword">var</span> redirectTo = route.get(<span class="hljs-string">'config.redirect'</span>);
    <span class="hljs-keyword">this</span>.app.go(redirectTo);
  },

  handleView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route)</span> </span>{

    <span class="hljs-keyword">if</span>(route) {
      <span class="hljs-keyword">var</span> current = <span class="hljs-keyword">this</span>.currentView();</pre></div></div>
            
        </li>
        
        
        <li id="section-349">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-349">&#182;</a>
              </div>
              <p>if the view that’s in there is already loaded, don’t remove / add again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(current &amp;&amp; current._pieName === route.get(<span class="hljs-string">'config.'</span> + <span class="hljs-keyword">this</span>.options.viewKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">if</span>(!route.get(<span class="hljs-string">'config.'</span> + <span class="hljs-keyword">this</span>.options.viewKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">this</span>.transitionToNewView(route);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-350">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-350">&#182;</a>
              </div>
              <p>The process for transitioning to a new view.
Both the current view and the next view are optional.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transitionToNewView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route)</span> </span>{
    <span class="hljs-keyword">var</span> current = <span class="hljs-keyword">this</span>.currentView(),
        target, viewClass, child, transition;

    target = pie.object.isString(<span class="hljs-keyword">this</span>.options.uiTarget) ? pie.qs(<span class="hljs-keyword">this</span>.options.uiTarget) : <span class="hljs-keyword">this</span>.options.uiTarget;</pre></div></div>
            
        </li>
        
        
        <li id="section-351">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-351">&#182;</a>
              </div>
              <p>Provide some events that can be observed around the transition process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'viewChanged:before'</span>);
    <span class="hljs-keyword">this</span>.emitter.fireAround(<span class="hljs-string">'viewChanged:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">routeHandlerTransition</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'viewChanged'</span>);

      <span class="hljs-keyword">if</span>(route) {</pre></div></div>
            
        </li>
        
        
        <li id="section-352">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-352">&#182;</a>
              </div>
              <p>Use the view key of the route to find the viewClass.
At this point we’ve already verified the view option exists, so we don’t have to check it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        viewClass = pie.object.getPath(<span class="hljs-built_in">window</span>, <span class="hljs-keyword">this</span>.options.viewNamespace + <span class="hljs-string">'.'</span> + route.get(<span class="hljs-string">'config.'</span> + <span class="hljs-keyword">this</span>.options.viewKey));</pre></div></div>
            
        </li>
        
        
        <li id="section-353">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-353">&#182;</a>
              </div>
              <p>The instance to be added. If the class is not defined, this could and should blow up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        child = viewClass.create({ app: <span class="hljs-keyword">this</span>.app });</pre></div></div>
            
        </li>
        
        
        <li id="section-354">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-354">&#182;</a>
              </div>
              <p>Cache an identifier on the view so we can use the current view if there’s sub-navigiation.
if the url changes but the view does not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        child._pieName = route.get(<span class="hljs-string">'config.'</span> + <span class="hljs-keyword">this</span>.options.viewKey);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-355">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-355">&#182;</a>
              </div>
              <p>Instantiate a transition object based on the app configuration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transition = <span class="hljs-keyword">this</span>.options.viewTransitionClass.create(<span class="hljs-keyword">this</span>.app, pie.object.merge({
        oldChild: current,
        newChild: child,
        childName: <span class="hljs-string">"currentView"</span>,
        targetEl: target
      }, <span class="hljs-keyword">this</span>.options.viewTransitionOptions));</pre></div></div>
            
        </li>
        
        
        <li id="section-356">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-356">&#182;</a>
              </div>
              <p>Provide a couple common events out of the app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transition.emitter.on(<span class="hljs-string">'removeOldChild:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">routeHandlerAfterRemoveOldChildCallback</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'oldViewRemoved'</span>, current);
      }.bind(<span class="hljs-keyword">this</span>));

      transition.emitter.on(<span class="hljs-string">'transition:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">routeHandlerAfterTransitionCallback</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'newViewLoaded'</span>, child);
      }.bind(<span class="hljs-keyword">this</span>));

      transition.transition(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">routeHandlerAfterTransition</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-357">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-357">&#182;</a>
              </div>
              <p>The instance is now our ‘currentView’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'viewChanged:after'</span>);
      }.bind(<span class="hljs-keyword">this</span>));

    }.bind(<span class="hljs-keyword">this</span>));
  },
});</pre></div></div>
            
        </li>
        
        
        <li id="section-358">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-358">&#182;</a>
              </div>
              <h1 id="pie-templates">Pie Templates</h1>
<p>A container for a collection of templates. It knows how to read, compile, and invoke template functions.</p>
<pre><code>templates.registerTemplate(<span class="hljs-string">'plainOld'</span>, <span class="hljs-string">"Just plain old string content: [%= data.id %]"</span>);
templates.render(<span class="hljs-string">'plainOld'</span>, {id: <span class="hljs-string">'fooBar'</span>});
<span class="hljs-comment">//=&gt; "Just plain old string content: fooBar"</span>
</code></pre><p>Templates can be declared in two ways:</p>
<ol>
<li><strong>script tag content</strong> - tags matching the <code>templateSelector</code> class option can be given an id attribute which maps to the templates name.
If a template by that name is requested and has not yet been compiled, the tag’s content will be parsed and a template function will be generated.</li>
<li><strong>script tag data-src</strong> - The same process as <code>1.</code> is followed but if a <code>data-src</code> attribute is present a <code>text/html</code> ajax request will take place to fetch the template content.
After fetch, the content will be parsed and a template will be generated. This method is inherently async and is only checked if <code>templates#renderAsync</code> is used.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.templates = pie.model.extend(<span class="hljs-string">'templates'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super({}, pie.object.merge({
      app: app,
      templateSelector: <span class="hljs-string">'script[type="text/pie-template"]'</span>
    }, options));
  },

  _node: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">return</span> pie.qs(<span class="hljs-keyword">this</span>.options.templateSelector + <span class="hljs-string">'[id="'</span> + name + <span class="hljs-string">'"]'</span>);
  },

  ensureTemplate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, cb)</span> </span>{
    <span class="hljs-keyword">var</span> node, content, src;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.get(name)) {
      cb(name);
      <span class="hljs-keyword">return</span>;
    }

    node = <span class="hljs-keyword">this</span>._node(name);
    content = node &amp;&amp; (node.content || node.textContent);
    src = node &amp;&amp; node.getAttribute(<span class="hljs-string">'data-src'</span>);

    <span class="hljs-keyword">if</span> (content) {
      <span class="hljs-keyword">this</span>.registerTemplate(name, content);
      cb(name);
      <span class="hljs-keyword">return</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(src) {
      <span class="hljs-keyword">this</span>.load(name, {url: src}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ensureTemplateCallback</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">this</span>.ensureTemplate(name, cb);
      }.bind(<span class="hljs-keyword">this</span>));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"[PIE] Template fetch error: "</span> + name);
    }

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-359">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-359">&#182;</a>
              </div>
              <p><strong>pie.templates.registerTemplate</strong></p>
<p>Register a template containing the <code>content</code> by the <code>name</code>.
The resulting function will be one produced by <code>pie.string.template</code> but will
have any registered helpers available via the <code>pie.helpers</code> <code>variableName</code> option.</p>
<p>So the following template would function fine, given the default helper methods as defined by <code>pie.helpers</code></p>
<pre><code>&lt;h1&gt;[%= h.t(<span class="hljs-string">"account.hello"</span>) %], [%= h.get(data, <span class="hljs-string">"firstName"</span>) %]&lt;<span class="hljs-regexp">/h1&gt;</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  registerTemplate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, content)</span> </span>{
    <span class="hljs-keyword">var</span> args = pie._debugArgs(<span class="hljs-string">'Compiling template: %c'</span> + name);
    args.push(<span class="hljs-string">"color: #aaa;"</span>);

    <span class="hljs-keyword">this</span>.app.debug.apply(<span class="hljs-keyword">this</span>.app, args);

    <span class="hljs-keyword">this</span>.set(name, pie.string.template(content, <span class="hljs-keyword">this</span>.app.helpers.provideVariables()));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-360">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-360">&#182;</a>
              </div>
              <p><strong>pie.templates.load</strong></p>
<p>Load a template from an external source, register it, then invoke the callback.</p>
<pre><code>templates.load(<span class="hljs-string">'fooBar'</span>, {url: <span class="hljs-string">'/foo-bar.html'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  template.render(<span class="hljs-string">'fooBar'</span>, {});
});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, ajaxOptions, cb)</span> </span>{
    ajaxOptions = pie.object.merge({
      verb: <span class="hljs-string">'get'</span>,
      accept: <span class="hljs-string">'text/html'</span>
    }, ajaxOptions);

    <span class="hljs-keyword">var</span> req = <span class="hljs-keyword">this</span>.app.ajax.ajax(ajaxOptions);

    req.dataSuccess(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">templateLoadCallback</span><span class="hljs-params">(content)</span> </span>{
      <span class="hljs-keyword">this</span>.registerTemplate(name, content);
    }.bind(<span class="hljs-keyword">this</span>)).error(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tmeplateLoadError</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"[PIE] Template fetch error: "</span> + name);
    }).complete(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">templateLoadComplete</span><span class="hljs-params">()</span> </span>{
      cb();
    });

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-361">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-361">&#182;</a>
              </div>
              <p><strong>pie.templates.render</strong></p>
<p>Synchronously render a template named <code>name</code> with <code>data</code>.
This will compile and register a template if it’s never been seen before.</p>
<pre><code>&lt;script id="fooBar" type="text/pie-template"&gt;
  Hi, [%= data.name %]
&lt;/script&gt;
&lt;script&gt;
  templates.render('fooBar', {name: 'Doug'});
  //=&gt; "Hi, Doug"
&lt;/script&gt;
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, data)</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.get(name)) {

      <span class="hljs-keyword">var</span> node = <span class="hljs-keyword">this</span>._node(name);

      <span class="hljs-keyword">if</span>(node) {
        <span class="hljs-keyword">this</span>.registerTemplate(name, node.content || node.textContent);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"[PIE] Unknown template error: "</span> + name);
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(name)(data || {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-362">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-362">&#182;</a>
              </div>
              <p><strong>pie.templates.renderAsync</strong></p>
<p>Render a template asynchronously. That is, attempt to extract the content from the associated <code>&lt;script&gt;</code> but
if it declares a <code>data-src</code> attribute, fetch the content from there instead. When the template is available
and rendered, invoke the callback <code>cb</code> with the content.</p>
<pre><code>&lt;script id=<span class="hljs-string">"fooBar"</span> type=<span class="hljs-string">"text/pie-template"</span> data-src=<span class="hljs-string">"/foo-bar.html"</span>&gt;<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
  templates.renderAsync(<span class="hljs-string">'fooBar'</span>, {name: <span class="hljs-string">'Doug'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(content)</span></span>{
    <span class="hljs-comment">//=&gt; "Hi, Doug"</span>
  });
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span></span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  renderAsync: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, data, cb)</span> </span>{
    <span class="hljs-keyword">this</span>.ensureTemplate(name, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderAsyncCallback</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> content = <span class="hljs-keyword">this</span>.render(name, data);
      cb(content);
    }.bind(<span class="hljs-keyword">this</span>));
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-363">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-363">&#182;</a>
              </div>
              <h1 id="pie-validator">Pie Validator</h1>
<p>A collection of validators commonly used in web forms.</p>
<pre><code>validator = pie.validator.create();
validator.email(<span class="hljs-string">"foo@djalfdsaf"</span>);
<span class="hljs-comment">//=&gt; false</span>
validator.email(<span class="hljs-string">"foo@bar.com"</span>);
<span class="hljs-comment">//=&gt; true</span>
validator.email(<span class="hljs-string">""</span>, {allowBlank: <span class="hljs-literal">true</span>});
<span class="hljs-comment">//=&gt; true</span>
</code></pre><p>Messages can be generated based on a validation type and the set of provided options. The messages are formed
via the associated app’s <code>i18n</code> object.</p>
<pre><code>validator.errorMessage(<span class="hljs-string">'length'</span>, {gte: <span class="hljs-number">4</span>})
<span class="hljs-comment">//=&gt; "must be greater than or equal to 4"</span>
</code></pre><p>Default validation messages are configured in i18n.js.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.validator = pie.base.extend(<span class="hljs-string">'validator'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>.app = app || pie.appInstance;
    <span class="hljs-keyword">this</span>.i18n = app.i18n;
    <span class="hljs-keyword">this</span>.options = pie.object.deepMerge({
      formats: {
        isoDate: <span class="hljs-regexp">/^\d{4}\-\d{2}\-\d{2}$/</span>,
        isoTime: <span class="hljs-regexp">/^\d{4}\-\d{2}\-\d{2}T\d{2}-\d{2}-\d{3}/</span>,
        epochs: <span class="hljs-regexp">/^\d{10}$/</span>,
        epochms: <span class="hljs-regexp">/^\d{13}$/</span>
      }
    }, options);

    <span class="hljs-keyword">this</span>._super();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-364">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-364">&#182;</a>
              </div>
              <p><strong>pie.validator.errorMessage</strong></p>
<p>Generate a validation message based on the given <code>validationType</code> and <code>validationOptions</code>.
Note there is no value given so the message will always be the full set of expectations, not
necessarily the parts that failed.</p>
<pre><code>validator.errorMessage(<span class="hljs-string">"length"</span>, {gte: <span class="hljs-number">4</span>})
<span class="hljs-comment">//=&gt; "must be greater than or equal to 4"</span>
</code></pre><p>If validationOptions contains a <code>message</code> key, that will be used to produce the message.
The <code>message</code> key can be a string, i18n attempt path, or a function.
If the validationOPtions contains a <code>messageKey</code> key, that will be used as an i18n lookup
at <code>app.validations.${messageKey}</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  errorMessage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(validationType, validationOptions)</span> </span>{

    <span class="hljs-keyword">if</span>(validationOptions.message) {
      <span class="hljs-keyword">var</span> msg = validationOptions.message;
      <span class="hljs-keyword">if</span>(pie.object.isFunction(msg)) msg = msg(validationType, validationOptions);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.app.i18n.attempt(msg);
    }

    <span class="hljs-keyword">var</span> key = validationOptions.messageKey || validationType,
        base = <span class="hljs-keyword">this</span>.i18n.t(<span class="hljs-string">'app.validations.'</span> + key),
        rangeOptions = pie.validator.rangeOptions.create(<span class="hljs-keyword">this</span>.app, validationOptions),
        range = rangeOptions.message();

    <span class="hljs-keyword">if</span>(!range &amp;&amp; key === <span class="hljs-string">'length'</span>) {
      rangeOptions = pie.validator.rangeOptions.create(<span class="hljs-keyword">this</span>.app, {gt: <span class="hljs-number">0</span>});
      range = rangeOptions.message();
    }

    <span class="hljs-keyword">return</span> (base + <span class="hljs-string">' '</span> + range).trim();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-365">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-365">&#182;</a>
              </div>
              <p><strong>pie.validator.withStandardChecks</strong></p>
<p>A series of common checks to make based on options passed to validators.
It handles <code>allowBlank</code>, <code>if</code>, and <code>unless</code> checks. Assuming all of these conditions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  withStandardChecks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options, f)</span></span>{
    options = options || {};

    <span class="hljs-keyword">if</span>(options.allowBlank &amp;&amp; !<span class="hljs-keyword">this</span>.presence(value)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(options.unless &amp;&amp; options.unless.call()) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(options[<span class="hljs-string">'if'</span>] &amp;&amp; !options[<span class="hljs-string">'if'</span>].call()) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">return</span> f.call();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-366">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-366">&#182;</a>
              </div>
              <p><strong>pie.validator.ccNumber</strong></p>
<p>Determine whether the provided value looks like a credit card number.
It ensures a number, that it has an appropriate length,
and that it passes the luhn check.</p>
<pre><code>validator.ccNumber(<span class="hljs-string">"4242 4242 4242 4242"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.ccNumber(<span class="hljs-string">"4242 4242"</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.ccNumber(<span class="hljs-string">"4242 4244 4442 4242"</span>)
<span class="hljs-comment">//=&gt; false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  ccNumber: (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">/* http://rosettacode.org/wiki/Luhn_test_of_credit_card_numbers#JavaScript */</span>
    <span class="hljs-comment">/* for checking credit card validity */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">luhnCheck</span><span class="hljs-params">(a)</span> </span>{
      <span class="hljs-keyword">var</span> b,c,d,e;
      <span class="hljs-keyword">for</span>(d = +a[b = a.length-<span class="hljs-number">1</span>], e=<span class="hljs-number">0</span>; b--;)
        c = +a[b], d += ++e % <span class="hljs-number">2</span> ? <span class="hljs-number">2</span> * c % <span class="hljs-number">10</span> + (c &gt; <span class="hljs-number">4</span>) : c;
      <span class="hljs-keyword">return</span> !(d%<span class="hljs-number">10</span>);
    };

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ccNumberValidationCallback</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-367">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-367">&#182;</a>
              </div>
              <p>don’t get rid of letters because we don’t want a mix of letters and numbers passing through</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> sanitized = <span class="hljs-built_in">String</span>(value).replace(<span class="hljs-regexp">/[^a-zA-Z0-9]/g</span>, <span class="hljs-string">''</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.number(sanitized) &amp;&amp;
               <span class="hljs-keyword">this</span>.length(sanitized, {gte: <span class="hljs-number">10</span>, lte: <span class="hljs-number">16</span>}) &amp;&amp;
               luhnCheck(sanitized);
      }.bind(<span class="hljs-keyword">this</span>));
    };
  })(),</pre></div></div>
            
        </li>
        
        
        <li id="section-368">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-368">&#182;</a>
              </div>
              <p><strong>pie.validator.ccExpirationMonth</strong></p>
<p>Ensures the provided value is a valid month (1-12).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ccExpirationMonth: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ccExpirationMonthValidationCallback</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.integer(value, {gte: <span class="hljs-number">1</span>, lte: <span class="hljs-number">12</span>});
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-369">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-369">&#182;</a>
              </div>
              <p><strong>pie.validator.ccExpirationYear</strong></p>
<p>Ensures the provided value is a valid credit card year.
It assumes the minimum is this year, and the maximum is 20 years from now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ccExpirationYear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ccExpirationYearValidationCallback</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.integer(value, {gte: now.getFullYear(), lte: now.getFullYear() + <span class="hljs-number">20</span>});
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-370">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-370">&#182;</a>
              </div>
              <p><strong>pie.validator.ccSecurity</strong></p>
<p>Ensures a well-formed cvv value.
It must be a number between 3 and 4 characters long.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ccSecurity: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ccSecurityValidationCallback</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.number(value) &amp;&amp;
              <span class="hljs-keyword">this</span>.length(value, {gte: <span class="hljs-number">3</span>, lte: <span class="hljs-number">4</span>});
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-371">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-371">&#182;</a>
              </div>
              <p><strong>pie.validator.chosen</strong></p>
<p>Ensures the provided value is present. To be used for select boxes,
radios, and checkboxes.
If the value is an array, it will check to see if there is at least one
value in the array.</p>
<pre><code>validator.chosen(<span class="hljs-string">""</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.chosen(<span class="hljs-string">"foo"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.chosen([])
<span class="hljs-comment">//=&gt; false</span>
validator.chosen([<span class="hljs-string">"foo"</span>])
<span class="hljs-comment">//=&gt; true</span>
validator.chosen([<span class="hljs-string">""</span>])
<span class="hljs-comment">//=&gt; false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  chosen: (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">valueCheck</span><span class="hljs-params">(value)</span></span>{
      <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span> &amp;&amp; value !== <span class="hljs-string">''</span>;
    };

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">chosen</span><span class="hljs-params">(value, options)</span></span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">chosenValidationCallback</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(value)) {
          <span class="hljs-keyword">return</span> !!value.filter(valueCheck).length;
        }
        <span class="hljs-keyword">return</span> valueCheck(value);
      });
    };
  })(),</pre></div></div>
            
        </li>
        
        
        <li id="section-372">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-372">&#182;</a>
              </div>
              <p><strong>pie.validator.date</strong></p>
<p>Determines if the provided value is a date (in the form of an iso8601 timestamp or iso8601 date - “yyyy-mm-dd”).
Optionally, you may pass any range options for comparison.</p>
<pre><code>validator.date(<span class="hljs-string">"2015-04-01"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.date(<span class="hljs-string">"2012-00-00"</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.date(<span class="hljs-string">"2015-13-01"</span>)
<span class="hljs-comment">//=&gt; false</span>
d.setDate(<span class="hljs-string">"2022-10-10"</span>, {gte: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()});
<span class="hljs-comment">//=&gt; true</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  date: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    options = options || {};
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dateValidationCallback</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> split = value.split(<span class="hljs-string">'-'</span>), y = split[<span class="hljs-number">0</span>], m = split[<span class="hljs-number">1</span>], d = split[<span class="hljs-number">2</span>], iso, date;

      <span class="hljs-keyword">if</span>(!y || !m || !d) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.length(y, {eq: <span class="hljs-number">4</span>}) || !<span class="hljs-keyword">this</span>.length(m, {eq: <span class="hljs-number">2</span>}) || !<span class="hljs-keyword">this</span>.length(d, {eq: <span class="hljs-number">2</span>})) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.number(y) || !<span class="hljs-keyword">this</span>.number(m, {gte: <span class="hljs-number">1</span>, lte: <span class="hljs-number">12</span>}) || !<span class="hljs-keyword">this</span>.number(d, {gte: <span class="hljs-number">1</span>, lte: <span class="hljs-number">31</span>})) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

      date = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(y, m-<span class="hljs-number">1</span>, d);

      <span class="hljs-comment">/* ensure the date is actually in the defined month */</span>
      <span class="hljs-keyword">if</span>(date.getDate() !== <span class="hljs-built_in">parseInt</span>(d, <span class="hljs-number">10</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

      <span class="hljs-keyword">if</span>(!options.sanitized) {
        <span class="hljs-built_in">Object</span>.keys(options).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dateValidatorSanitizer</span><span class="hljs-params">(k)</span></span>{
          iso = options[k];
          iso = <span class="hljs-keyword">this</span>.app.i18n.l(iso, <span class="hljs-string">'isoDate'</span>);
          options[k] = iso;
        });
        options.sanitized = <span class="hljs-literal">true</span>;
      }

      <span class="hljs-keyword">var</span> ro = pie.validator.rangeOptions.create(<span class="hljs-keyword">this</span>.app, options);
      <span class="hljs-keyword">return</span> ro.matches(value);

    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-373">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-373">&#182;</a>
              </div>
              <p><strong>pie.validator.email</strong></p>
<p>Loosely checks the validity of an email address.
It simply looks for something in the form of [a]@[b].[c]</p>
<pre><code>validator.email(<span class="hljs-string">"foo@bar.com"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.email(<span class="hljs-string">"foo@bar"</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.email(<span class="hljs-string">"foo@bar.baz.com"</span>)
<span class="hljs-comment">//=&gt; true</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  email: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    options = pie.object.merge({allowBlank: <span class="hljs-literal">false</span>}, options || {});
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emailValidationCallback</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^.+@.+\..+$/</span>).test(value);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-374">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-374">&#182;</a>
              </div>
              <p><strong>pie.validator.fn</strong></p>
<p>A generic function interface. This enables a function to be passed,
along with all the normal options. The function must respond in true, false,
or a promise.</p>
<pre><code><span class="hljs-keyword">var</span> opts = {fn: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span></span>{ <span class="hljs-keyword">return</span> v.length === <span class="hljs-number">3</span>; }};
validator.fn(<span class="hljs-string">"foo"</span>, opts);
<span class="hljs-comment">//=&gt; true</span>
validator.fn(<span class="hljs-string">"foos"</span>, opts);
<span class="hljs-comment">//=&gt; false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  fn: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fnValidationCallback</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">return</span> options.fn.call(<span class="hljs-literal">null</span>, value, options);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-375">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-375">&#182;</a>
              </div>
              <p><strong>pie.validator.format</strong></p>
<p>Determine if a value matches a given format. The format, provided via the <code>format</code> option, can be a regular expression
or a named format as defined by the validator instance’s <code>formats</code> option.
By default, named formats include <code>isoDate</code>, <code>isoTime</code>, <code>epochs</code> (epoch seconds), and <code>epochms</code> (epoch milliseconds).</p>
<pre><code>validator.format(<span class="hljs-string">"foo"</span>, {format: <span class="hljs-regexp">/oo/</span>});
<span class="hljs-comment">//=&gt; true</span>
validator.format(<span class="hljs-string">"bar"</span>, {format: <span class="hljs-regexp">/oo/</span>});
<span class="hljs-comment">//=&gt; false</span>
validator.format(<span class="hljs-string">"2015-04-20"</span>, {format: <span class="hljs-string">'isoDate'</span>});
<span class="hljs-comment">//=&gt; true</span>
validator.format(<span class="hljs-string">"2015-04-20"</span>, {format: <span class="hljs-string">'isoTime'</span>});
<span class="hljs-comment">//=&gt; false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  format: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    options = options || {};
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">formatValidationCallback</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> fmt = options.format || options[<span class="hljs-string">'with'</span>];
      fmt = <span class="hljs-keyword">this</span>.options.formats[fmt] || fmt;
      <span class="hljs-keyword">return</span> !!fmt.test(<span class="hljs-built_in">String</span>(value));
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-376">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-376">&#182;</a>
              </div>
              <p><strong>pie.validator.inclusion</strong></p>
<p>Is the value part of the expected list?
The list is defined via the <code>in</code> option and can either be an array, object, or function.
In the case of a function, it is evaluated and the result is used as the list.
In the case of an array, the array is checked for <code>value</code>‘s inclusion.
In the case of an object, the <code>value</code> is checked for equality.</p>
<pre><code>validator.inclusion(<span class="hljs-string">"foo"</span>, {<span class="hljs-keyword">in</span>: <span class="hljs-string">"foo"</span>});
<span class="hljs-comment">//=&gt; true</span>
validator.inclusion(<span class="hljs-string">"foo"</span>, {<span class="hljs-keyword">in</span>: <span class="hljs-string">"food"</span>});
<span class="hljs-comment">//=&gt; false</span>
validator.inclusion(<span class="hljs-string">"foo"</span>, {<span class="hljs-keyword">in</span>: [<span class="hljs-string">"foo"</span>]});
<span class="hljs-comment">//=&gt; true</span>
validator.inclusion(<span class="hljs-string">"foo"</span>, {<span class="hljs-keyword">in</span>: []});
<span class="hljs-comment">//=&gt; true, because the "in" option is considered blank.</span>
validator.inclusion(<span class="hljs-string">"foo"</span>, {<span class="hljs-keyword">in</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> [<span class="hljs-string">"bar"</span>] }});
<span class="hljs-comment">//=&gt; false</span>
validator.inclusion(<span class="hljs-string">"foo"</span>, {<span class="hljs-keyword">in</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> [<span class="hljs-string">"bar"</span>, <span class="hljs-string">"foo"</span>] }});
<span class="hljs-comment">//=&gt; true</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  inclusion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    options = options || {};
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inclusionValidationCallback</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> inVal = pie.fn.valueFrom(options[<span class="hljs-string">'in'</span>]);
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(inVal)) <span class="hljs-keyword">return</span> !inVal.length || !!~inVal.indexOf(value);
      <span class="hljs-keyword">return</span> inVal == <span class="hljs-literal">null</span> || inVal === value;
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-377">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-377">&#182;</a>
              </div>
              <p><strong>pie.validator.integer</strong></p>
<p>Check if a value is an integer, not based on precision but based on value.</p>
<pre><code>validator.integer(<span class="hljs-number">4</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.integer(<span class="hljs-number">4.4</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.integer(<span class="hljs-number">4.0</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.integer(<span class="hljs-string">"4.0"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.integer(<span class="hljs-number">3</span>, {gt: <span class="hljs-number">1</span>, lte: <span class="hljs-number">10</span>})
<span class="hljs-comment">//=&gt; true</span>
validator.integer(<span class="hljs-number">3.5</span>, {gt: <span class="hljs-number">1</span>, lte: <span class="hljs-number">10</span>})
<span class="hljs-comment">//=&gt; false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  integer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
    <span class="hljs-keyword">return</span>  <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">integerValidationCallback</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">return</span>  <span class="hljs-keyword">this</span>.number(value, options) &amp;&amp;
              <span class="hljs-built_in">parseInt</span>(value, <span class="hljs-number">10</span>) === <span class="hljs-built_in">parseFloat</span>(value, <span class="hljs-number">10</span>);
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-378">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-378">&#182;</a>
              </div>
              <p><strong>pie.validator.length</strong></p>
<p>Is the length of <code>value</code> within the desired range?
If the value is an array it will use the array’s length, otherwise, it will use the length of the String cast version of the value.
If no ranges are given, it checks for a length of greater than 0</p>
<pre><code>validator.length(<span class="hljs-string">"foo"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.length(<span class="hljs-string">""</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.length(<span class="hljs-string">"foo"</span>, {gte: <span class="hljs-number">2</span>, lte: <span class="hljs-number">3</span>})
<span class="hljs-comment">//=&gt; true</span>
validator.length([<span class="hljs-string">"foo"</span>], {gte: <span class="hljs-number">2</span>, lte: <span class="hljs-number">3</span>})
<span class="hljs-comment">//=&gt; false</span>
validator.length([<span class="hljs-string">""</span>])
<span class="hljs-comment">//=&gt; true</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  length: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
    options = pie.object.merge({allowBlank: <span class="hljs-literal">false</span>}, options);

    <span class="hljs-comment">/* preparation to use the number validator */</span>
    <span class="hljs-keyword">if</span>(!pie.object.hasAny(options, <span class="hljs-string">'gt'</span>, <span class="hljs-string">'gte'</span>, <span class="hljs-string">'lt'</span>, <span class="hljs-string">'lte'</span>, <span class="hljs-string">'eq'</span>)){
      options.gt = <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lengthValidationCallback</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">var</span> length = <span class="hljs-built_in">Array</span>.isArray(value) ? value.length : <span class="hljs-built_in">String</span>(value).trim().length;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.number(length, options);
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-379">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-379">&#182;</a>
              </div>
              <p><strong>pie.validator.number</strong></p>
<p>Must be a number and in the given range.</p>
<pre><code>validator.number(<span class="hljs-number">4</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.number(<span class="hljs-number">4.4</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.number(<span class="hljs-string">"alpha"</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.number(<span class="hljs-string">"4.0"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.number(<span class="hljs-number">3</span>, {gt: <span class="hljs-number">1</span>, lte: <span class="hljs-number">10</span>})
<span class="hljs-comment">//=&gt; true</span>
validator.number(<span class="hljs-number">20</span>, {gt: <span class="hljs-number">1</span>, lte: <span class="hljs-number">10</span>})
<span class="hljs-comment">//=&gt; false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  number: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
    options = options || {};

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">numberValidationCallback</span><span class="hljs-params">()</span></span>{

      value = <span class="hljs-built_in">String</span>(value).trim();
      <span class="hljs-comment">/* not using parseFloat because it accepts multiple decimals */</span>
      <span class="hljs-comment">/* ip addresses would be considered numbers if parseFloat was used */</span>
      <span class="hljs-keyword">if</span>(!<span class="hljs-regexp">/^([\-])?([\d]+)?\.?[\d]+$/</span>.test(value)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

      <span class="hljs-keyword">var</span> number = <span class="hljs-built_in">parseFloat</span>(value),
      ro = pie.validator.rangeOptions.create(<span class="hljs-keyword">this</span>.app, options);

      <span class="hljs-keyword">return</span> ro.matches(number);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-380">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-380">&#182;</a>
              </div>
              <p><strong>pie.validator.phone</strong></p>
<p>Remove whitespace and unecessary characters and ensure we have a 10 digit number.
clean out all things that are not numbers and + and get a minimum of 10 digits.
If you want a locale based phone validation, use the format validator.</p>
<pre><code>validator.phone(<span class="hljs-string">"555-555-5555"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.phone(<span class="hljs-string">"555-5555"</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.phone(<span class="hljs-string">"(555) 555-5555"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.phone(<span class="hljs-string">"+15555555555"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.phone(<span class="hljs-string">"555-555-5555 on weekdays"</span>)
<span class="hljs-comment">//=&gt; true</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  phone: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    options = pie.object.merge({allowBlank: <span class="hljs-literal">false</span>}, options || {});

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">phoneValidationCallback</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">var</span> clean = <span class="hljs-built_in">String</span>(value).replace(<span class="hljs-regexp">/[^\+\d]+/g</span>, <span class="hljs-string">''</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.length(clean, {gte: <span class="hljs-number">10</span>});
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-381">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-381">&#182;</a>
              </div>
              <p><strong>pie.validator.presence</strong></p>
<p>Check if a value is truthy and has any non-whitespace characters.</p>
<pre><code>validator.presence(<span class="hljs-literal">null</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.presence(<span class="hljs-string">""</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.presence(<span class="hljs-string">"   "</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.presence(<span class="hljs-literal">false</span>)
<span class="hljs-comment">//=&gt; false</span>
validator.presence(<span class="hljs-literal">true</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.presence(<span class="hljs-string">"foo"</span>)
<span class="hljs-comment">//=&gt; true</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  presence: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, pie.object.merge({}, options, {allowBlank: <span class="hljs-literal">false</span>}), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">return</span> !!(value &amp;&amp; (<span class="hljs-regexp">/[^ ]/</span>).test(<span class="hljs-built_in">String</span>(value)));
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-382">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-382">&#182;</a>
              </div>
              <p><strong>pie.validator.uniqueness</strong></p>
<p>Determine whether the given value is unique within the array defined by the <code>within</code> option.
The <code>within</code> option can be an array or a function which returns an array.</p>
<pre><code>validator.uniqueness(<span class="hljs-string">"foo"</span>, {within: [<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>]})
<span class="hljs-comment">//=&gt; true</span>
validator.uniqueness(<span class="hljs-string">"foo"</span>, {within: [<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"foo"</span>]})
<span class="hljs-comment">//=&gt; false</span>
validator.uniqueness(<span class="hljs-string">"foo"</span>, {within: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> [<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>]; }});
<span class="hljs-comment">//=&gt; true</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  uniqueness: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uniquenessValidationCallback</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">if</span>(!options.within) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">var</span> within = pie.fn.valueFrom(options.within), i = <span class="hljs-number">0</span>, cnt = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">for</span>(; i &lt; within.length; i++) {
        <span class="hljs-keyword">if</span>(within[i] === value) cnt++;
        <span class="hljs-keyword">if</span>(cnt &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }

      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-383">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-383">&#182;</a>
              </div>
              <p><strong>pie.validator.url</strong></p>
<p>Determine whether <code>value</code> loosely looks like a url.
For a more complicated url check, use the format validator.</p>
<pre><code>validator.url(<span class="hljs-string">"http://www.google.com"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.url(<span class="hljs-string">"https://www.google.com"</span>)
<span class="hljs-comment">//=&gt; true</span>
validator.url(<span class="hljs-string">"www.google.com"</span>)
<span class="hljs-comment">//=&gt; false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  url: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    options = pie.object.merge({}, options, {format: <span class="hljs-regexp">/^https?\:\/\/.+\..+$/</span>});
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.format(value, options);
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-384">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-384">&#182;</a>
              </div>
              <h2 id="pie-range-options">Pie Range Options</h2>
<p>A small utilitly class which matches range options to comparators.</p>
<pre><code>range = pie.validator.rangeOptions.create(app, {gte: <span class="hljs-number">3</span>, lt: <span class="hljs-number">8</span>});
range.matches(<span class="hljs-number">3</span>)
<span class="hljs-comment">//=&gt; true</span>
range.matches(<span class="hljs-number">10</span>)
<span class="hljs-comment">//=&gt; false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.validator.rangeOptions = pie.base.extend(<span class="hljs-string">'rangeOptions'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, hash)</span> </span>{
    <span class="hljs-keyword">this</span>.i18n = app.i18n;
    <span class="hljs-keyword">this</span>.rangedata = hash || {};
    <span class="hljs-comment">/* for double casting situations */</span>
    <span class="hljs-keyword">if</span>(pie.object.has(<span class="hljs-keyword">this</span>.rangedata, <span class="hljs-string">'rangedata'</span>)) <span class="hljs-keyword">this</span>.rangedata = <span class="hljs-keyword">this</span>.rangedata.rangedata;

    <span class="hljs-keyword">this</span>._super();
  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">return</span> pie.fn.valueFrom(<span class="hljs-keyword">this</span>.rangedata[key]);
  },

  has: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">return</span> pie.object.has(<span class="hljs-keyword">this</span>.rangedata, key);
  },

  t: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.i18n.t(<span class="hljs-string">'app.validations.range_messages.'</span> + key, options);
  },

  matches: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">var</span> valid = <span class="hljs-literal">true</span>;
    valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gt'</span>) || value &gt; <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gt'</span>));
    valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lt'</span>) || value &lt; <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lt'</span>));
    valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gte'</span>) || value &gt;= <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gte'</span>));
    valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lte'</span>) || value &lt;= <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lte'</span>));
    valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'eq'</span>) || value === <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eq'</span>));
    <span class="hljs-keyword">return</span> valid;
  },

  message: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'eq'</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'eq'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eq'</span>)});
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> s = [<span class="hljs-string">''</span>,<span class="hljs-string">''</span>];

      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gt'</span>)) s[<span class="hljs-number">0</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'gt'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gt'</span>)});
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gte'</span>)) s[<span class="hljs-number">0</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'gte'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gte'</span>)});

      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lt'</span>)) s[<span class="hljs-number">1</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'lt'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lt'</span>)});
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lte'</span>)) s[<span class="hljs-number">1</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'lte'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lte'</span>)});

      <span class="hljs-keyword">return</span> pie.array.toSentence(pie.array.compact(s, <span class="hljs-literal">true</span>), <span class="hljs-keyword">this</span>.i18n).trim();
    }
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-385">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-385">&#182;</a>
              </div>
              <p>general framework for transitioning between views.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.abstractViewTransition = pie.base.extend(<span class="hljs-string">'abstractViewTransition'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parent, options)</span> </span>{
    options = options || {};

    <span class="hljs-keyword">this</span>.emitter    = pie.emitter.create();
    <span class="hljs-keyword">this</span>.parent     = parent;
    <span class="hljs-keyword">this</span>.oldChild   = options.oldChild;
    <span class="hljs-keyword">this</span>.newChild   = options.newChild;
    <span class="hljs-keyword">this</span>.childName  = options.childName || <span class="hljs-keyword">this</span>.oldChild &amp;&amp; <span class="hljs-keyword">this</span>.oldChild._nameWithinParent;
    <span class="hljs-keyword">this</span>.targetEl   = options.targetEl  || <span class="hljs-keyword">this</span>.oldChild &amp;&amp; <span class="hljs-keyword">this</span>.oldChild.el.parentNode;

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.childName) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"No child name provided for view transition"</span>);
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.targetEl)  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"No target element provided for view transition"</span>);

    <span class="hljs-keyword">this</span>.options = options;

    <span class="hljs-keyword">this</span>.emitter.on(<span class="hljs-string">'transition:before'</span>, <span class="hljs-keyword">this</span>.manageChildren.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.propagateTransitionEvents();

    <span class="hljs-keyword">this</span>._super();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-386">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-386">&#182;</a>
              </div>
              <p>fire a sequence which looks like</p>
<pre><code>| transition:before
| transition
|--| removeOldChild:before
|  | removeOldChild
|  | removeOldChild:after
|  |--| addNewChild:before
|     | addNewChild
|     | addNewChild:after
| transition:after
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  transition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">var</span> em = <span class="hljs-keyword">this</span>.emitter;

    em.on(<span class="hljs-string">'addNewChild:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'transition:after'</span>);
      <span class="hljs-keyword">if</span>(cb) cb();
    });

    em.on(<span class="hljs-string">'removeOldChild:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'addNewChild:before'</span>);
      em.fireAround(<span class="hljs-string">'addNewChild:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'addNewChild'</span>);
      });
    });

    em.on(<span class="hljs-string">'transition'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'removeOldChild:before'</span>);
      em.fireAround(<span class="hljs-string">'removeOldChild:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'removeOldChild'</span>);
      });
    });

    em.fire(<span class="hljs-string">'transition:before'</span>);
    em.fireAround(<span class="hljs-string">'transition:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'transition'</span>);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-387">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-387">&#182;</a>
              </div>
              <p>to be called at the beginning of each transition.
this removes the old child from it’s parent and adds the new one
it also begins the setup process for the new child.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  manageChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.oldChild) <span class="hljs-keyword">this</span>.parent.removeChild(<span class="hljs-keyword">this</span>.oldChild);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.newChild) {
      <span class="hljs-keyword">this</span>.parent.addChild(<span class="hljs-keyword">this</span>.childName, <span class="hljs-keyword">this</span>.newChild);
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.newChild.emitter.hasEvent(<span class="hljs-string">'setup:before'</span>)) <span class="hljs-keyword">this</span>.newChild.setup();
    }
  },

  propagateTransitionEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> em = <span class="hljs-keyword">this</span>.emitter,
    oldEm = <span class="hljs-keyword">this</span>.oldChild &amp;&amp; <span class="hljs-keyword">this</span>.oldChild.emitter,
    newEm = <span class="hljs-keyword">this</span>.newChild &amp;&amp; <span class="hljs-keyword">this</span>.newChild.emitter;

    <span class="hljs-keyword">if</span>(oldEm) {
      em.on(<span class="hljs-string">'removeOldChild:before'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        oldEm.fire(<span class="hljs-string">'transitionOut:before'</span>);
      });

      em.on(<span class="hljs-string">'removeOldChild:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        oldEm.fire(<span class="hljs-string">'transitionOut:after'</span>);
      });
    }

    <span class="hljs-keyword">if</span>(newEm) {
      em.on(<span class="hljs-string">'addNewChild:before'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        newEm.fire(<span class="hljs-string">'transitionIn:before'</span>);
      });

      em.on(<span class="hljs-string">'transition:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        newEm.fire(<span class="hljs-string">'transitionIn:after'</span>);
      });
    }
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-388">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-388">&#182;</a>
              </div>
              <p>Simple view transition: remove the old child from the view and dom, add the new child immediately after.
Uses the default sequence of events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.simpleViewTransition = pie.abstractViewTransition.extend(<span class="hljs-string">'simpleViewTransition'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">this</span>.emitter.on(<span class="hljs-string">'removeOldChild'</span>, <span class="hljs-keyword">this</span>.removeOldChild.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.emitter.on(<span class="hljs-string">'addNewChild'</span>,    <span class="hljs-keyword">this</span>.addNewChild.bind(<span class="hljs-keyword">this</span>));
  },

  setLoading: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool)</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.options.loadingClass) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">this</span>.targetEl.classList[bool ? <span class="hljs-string">'add'</span> : <span class="hljs-string">'remove'</span>](<span class="hljs-keyword">this</span>.options.loadingClass);
  },

  addNewChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.newChild) {
      <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'addNewChild:after'</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.begin = pie.date.now();

    <span class="hljs-keyword">this</span>.setLoading(<span class="hljs-literal">true</span>);

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.minDelay) {
      setTimeout(<span class="hljs-keyword">this</span>.attemptToAddChild.bind(<span class="hljs-keyword">this</span>), <span class="hljs-keyword">this</span>.options.minDelay);
    }

    <span class="hljs-keyword">this</span>.newChild.emitter.once(<span class="hljs-string">'setup:after'</span>, <span class="hljs-keyword">this</span>.attemptToAddChild.bind(<span class="hljs-keyword">this</span>), {immediate: <span class="hljs-literal">true</span>});
  },

  attemptToAddChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> now = pie.date.now();

    <span class="hljs-comment">/* ensure our child has been setup */</span>
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.newChild.emitter.hasEvent(<span class="hljs-string">'setup:after'</span>)) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">/* ensure the minimum delay has been reached */</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.minDelay &amp;&amp; now &lt; (<span class="hljs-keyword">this</span>.begin + <span class="hljs-keyword">this</span>.options.minDelay)) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>.setLoading(<span class="hljs-literal">false</span>);

    <span class="hljs-comment">/* ensure our view was not removed from our parent */</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.newChild.parent !== <span class="hljs-keyword">this</span>.parent) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>.newChild.addToDom(<span class="hljs-keyword">this</span>.targetEl);
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'addNewChild:after'</span>);
  },

  removeOldChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.oldChild) <span class="hljs-keyword">this</span>.oldChild.teardown();
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'removeOldChild:after'</span>);
  }

});

pie.loadingViewTransition = pie.simpleViewTransition.extend(<span class="hljs-string">'loadingViewTransition'</span>, {
  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">this</span>.options.loadingClass = <span class="hljs-keyword">this</span>.options.loadingClass || <span class="hljs-string">'is-loading'</span>;
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-389">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-389">&#182;</a>
              </div>
              <p>A transition which applies an “out” class to the old view, removes it after it transitions out, then adds
the new view to the dom and applies an “in” class.
Preparation of the new view is done as soon as the transition is started, enabling the shortest possible
amount of delay before the next view is added to the dom.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.inOutViewTransition = pie.abstractViewTransition.extend(<span class="hljs-string">'inOutViewTransition'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">this</span>.options = pie.object.merge({</pre></div></div>
            
        </li>
        
        
        <li id="section-390">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-390">&#182;</a>
              </div>
              <p>the new view will gain this class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      inClass: <span class="hljs-string">'view-in'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-391">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-391">&#182;</a>
              </div>
              <p>the old view will gain this class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      outClass: <span class="hljs-string">'view-out'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-392">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-392">&#182;</a>
              </div>
              <p>if the browser doesn’t support onTransitionEnd, here’s the backup transition duration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      backupDuration: <span class="hljs-number">250</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-393">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-393">&#182;</a>
              </div>
              <p>async=true means the new view doesn’t wait for the old one to leave.
async=false means the new view won’t be added to the dom until the previous is removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      async: <span class="hljs-literal">false</span>
    }, <span class="hljs-keyword">this</span>.options);

    <span class="hljs-keyword">this</span>.setupObservations();
  },

  setupObservations: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> em = <span class="hljs-keyword">this</span>.emitter;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.oldChild) {
      em.on(<span class="hljs-string">'transitionOldChild'</span>,       <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'transitionOldChild'</span>));
      em.on(<span class="hljs-string">'transitionOldChild:after'</span>,  <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'teardownOldChild'</span>));
    } <span class="hljs-keyword">else</span> {
      em.on(<span class="hljs-string">'transitionOldChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'transitionOldChild:after'</span>);
      });
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.newChild) {
      em.on(<span class="hljs-string">'addNewChild'</span>,              <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'addNewChild'</span>));
      em.on(<span class="hljs-string">'transitionNewChild:around'</span>, <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'ensureNewChildPrepared'</span>));
      em.on(<span class="hljs-string">'transitionNewChild'</span>,       <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'refresh'</span>));
      em.on(<span class="hljs-string">'transitionNewChild'</span>,       <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'transitionNewChild'</span>));

      <span class="hljs-keyword">this</span>.newChild.emitter.once(<span class="hljs-string">'removedFromParent'</span>, <span class="hljs-keyword">this</span>.cancel.bind(<span class="hljs-keyword">this</span>));
    } <span class="hljs-keyword">else</span> {
      em.on(<span class="hljs-string">'transitionNewChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'transitionNewChild:after'</span>);
      });
    }
  },

  cancelWrap: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fnName)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.emitter.hasEvent(<span class="hljs-string">'cancel'</span>)) {
        <span class="hljs-keyword">this</span>[fnName].apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
      }
    }.bind(<span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-394">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-394">&#182;</a>
              </div>
              <p>apply the relevant class(es) to the element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  applyClass: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, isIn)</span> </span>{
    <span class="hljs-keyword">var</span> add = isIn ? <span class="hljs-keyword">this</span>.options.inClass : <span class="hljs-keyword">this</span>.options.outClass,
        remove = isIn ? <span class="hljs-keyword">this</span>.options.outClass : <span class="hljs-keyword">this</span>.options.inClass;

    <span class="hljs-keyword">if</span>(add) pie.dom.addClass(el, add);
    <span class="hljs-keyword">if</span>(remove) pie.dom.removeClass(el, remove);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-395">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-395">&#182;</a>
              </div>
              <p>WHEN options.async !== true
fire a sequence which looks like</p>
<pre><code>| transition:before
| transition
|  |--| removeOldChild:before
|     |--| transitionOldChild:before
|        | transitionOldChild
|        |--| transitionOldChild:after
|           |--| removeOldChild
|           |  |--| removeOldChild:after
|           |
|           |--| addNewChild:before
|              | addNewChild
|              |--| addNewChild:after
|                 |--| transitionNewChild:before
|                    | transitionNewChild
|                    |--| transitionNewChild:after
|                       |--| transition:after
</code></pre><p>WHEN options.async === true
fire a sequence which looks like</p>
<pre><code>| transition:before
| transition
|  |--| removeOldChild:before
|  |  |--| transitionOldChild:before
|  |     | transitionOldChild
|  |     |--| transitionOldChild:after
|  |        |--| removeOldChild
|  |           |--| removeOldChild:after
|  |
|  |--| addNewChild:before
|     | addNewChild
|     |--| addNewChild:after
|        |--| transitionNewChild:before
|           | transitionNewChild
|           |--| transitionNewChild:after
|              |--| transition:after
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  transition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">var</span> em = <span class="hljs-keyword">this</span>.emitter;

    em.on(<span class="hljs-string">'transitionNewChild:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'transition:after'</span>);
      <span class="hljs-keyword">if</span>(cb) cb();
    });

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.async) {
      em.on(<span class="hljs-string">'transition'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fireSequence(<span class="hljs-string">'addNewChild'</span>);
      });
    } <span class="hljs-keyword">else</span> {
      em.on(<span class="hljs-string">'removeOldChild:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fireSequence(<span class="hljs-string">'addNewChild'</span>);
      });
    }

    em.on(<span class="hljs-string">'addNewChild:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'transitionNewChild:before'</span>);
      em.fireAround(<span class="hljs-string">'transitionNewChild:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'transitionNewChild'</span>);
      });
    });

    em.on(<span class="hljs-string">'transitionOldChild:after'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fireSequence(<span class="hljs-string">'removeOldChild'</span>);
    });

    em.on(<span class="hljs-string">'transition'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'transitionOldChild:before'</span>);
      em.fireAround(<span class="hljs-string">'transitionOldChild:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'transitionOldChild'</span>);
      });
    });

    em.fire(<span class="hljs-string">'transition:before'</span>);
    em.fireAround(<span class="hljs-string">'transition:around'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'transition'</span>);
    });

  },

  cancel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.emitter.hasEvent(<span class="hljs-string">'transitionNewChild:after'</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-396">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-396">&#182;</a>
              </div>
              <p>the goal of a transition is to get the old child out and the new child in,
we make sure we’ve done that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.oldChild) {
        <span class="hljs-keyword">this</span>.teardownOldChild();
      }

      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.newChild) {
        <span class="hljs-keyword">this</span>.applyClass(<span class="hljs-keyword">this</span>.newChild.el, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">this</span>.newChild.addToDom(<span class="hljs-keyword">this</span>.targetEl);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-397">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-397">&#182;</a>
              </div>
              <p>then we let everyone else know.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'cancel'</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-398">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-398">&#182;</a>
              </div>
              <p>teardown() the child if it hasn’t already.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  teardownOldChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.oldChild.emitter.hasEvent(<span class="hljs-string">'teardown:before'</span>)) {
      <span class="hljs-keyword">this</span>.oldChild.teardown();
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-399">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-399">&#182;</a>
              </div>
              <p>Add the new child to the dom.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addNewChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.newChild.addToDom(<span class="hljs-keyword">this</span>.targetEl);
  },

  ensureNewChildPrepared: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">this</span>.newChild.emitter.once(<span class="hljs-string">'render:after'</span>, cb, {immediate: <span class="hljs-literal">true</span>});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-400">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-400">&#182;</a>
              </div>
              <p>make sure we’re rendered, then begin the ui transition in.
when complete, invoke the callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transitionNewChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.observeTransitionEnd(<span class="hljs-keyword">this</span>.newChild.el, <span class="hljs-literal">true</span>, <span class="hljs-string">'transitionNewChild:after'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-401">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-401">&#182;</a>
              </div>
              <p>start the transition out. when complete, invoke the callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transitionOldChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.oldChild.el.parentNode) <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'transitionOldChild:after'</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.observeTransitionEnd(<span class="hljs-keyword">this</span>.oldChild.el, <span class="hljs-literal">false</span>, <span class="hljs-string">'transitionOldChild:after'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-402">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-402">&#182;</a>
              </div>
              <p>ensure the browser has redrawn and locations are up to date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  refresh: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.oldChild) <span class="hljs-keyword">this</span>.oldChild.el.getBoundingClientRect();
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.newChild) <span class="hljs-keyword">this</span>.newChild.el.getBoundingClientRect();
    <span class="hljs-keyword">if</span>(cb) cb();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-403">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-403">&#182;</a>
              </div>
              <p>build a transition callback, and apply the appropriate class.
when the transition is complete, invoke the callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  observeTransitionEnd: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, isIn, fire)</span> </span>{
    <span class="hljs-keyword">var</span> transitionEvent = <span class="hljs-keyword">this</span>.transitionEvent(el),
    trans = transitionEvent.event,
    dur = transitionEvent.duration,
    called = <span class="hljs-literal">false</span>,
    onTransitionEnd = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span>(called) <span class="hljs-keyword">return</span>;
      called = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">if</span>(trans) pie.dom.off(el, trans, onTransitionEnd);
      <span class="hljs-keyword">this</span>.emitter.fire(fire);
    }.bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.emitter.once(<span class="hljs-string">'cancel'</span>, onTransitionEnd);

    <span class="hljs-keyword">if</span>(trans) {
      pie.dom.on(el, trans, onTransitionEnd);
    }

    <span class="hljs-keyword">this</span>.applyClass(el, isIn);

    <span class="hljs-keyword">if</span>(trans) {
      <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isNaN</span>(dur)) {
        setTimeout(onTransitionEnd, dur * <span class="hljs-number">1.1</span>);
      }
    } <span class="hljs-keyword">else</span> {
      setTimeout(onTransitionEnd, <span class="hljs-keyword">this</span>.options.backupDuration);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-404">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-404">&#182;</a>
              </div>
              <p>which transition event should we use?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transitionEndEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(base)</span></span>{
    <span class="hljs-keyword">var</span> cap = pie.string.capitalize(base);

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._transitionEndEvent === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span>(pie.object.has(<span class="hljs-built_in">window</span>, <span class="hljs-string">'on'</span> + base + <span class="hljs-string">'end'</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">this</span>._transitionEndEvent = base + <span class="hljs-string">'end'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.has(<span class="hljs-built_in">window</span>, <span class="hljs-string">'onwebkit'</span> + base + <span class="hljs-string">'end'</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">this</span>._transitionEndEvent = <span class="hljs-string">'webkit'</span> + cap + <span class="hljs-string">'End'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.has(<span class="hljs-built_in">window</span>, <span class="hljs-string">'ms'</span> + cap + <span class="hljs-string">'End'</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">this</span>._transitionEndEvent = <span class="hljs-string">'ms'</span> + cap + <span class="hljs-string">'End'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.has(<span class="hljs-built_in">document</span>.body, <span class="hljs-string">'ono'</span> + base + <span class="hljs-string">'end'</span>, <span class="hljs-literal">true</span>) || navigator.appName === <span class="hljs-string">'Opera'</span>) {
        <span class="hljs-keyword">this</span>._transitionEndEvent = <span class="hljs-string">'o'</span> + cap + <span class="hljs-string">'End'</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._transitionEndEvent = <span class="hljs-literal">false</span>;
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._transitionEndEvent;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-405">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-405">&#182;</a>
              </div>
              <p>get a transition or animation property based on the browser’s compatability.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  subProperty: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(endEvent, prop)</span> </span>{
    <span class="hljs-keyword">return</span> endEvent.replace(<span class="hljs-regexp">/end/i</span>, pie.string.capitalize(prop));
  },

  transitionEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
    <span class="hljs-keyword">var</span> endA = <span class="hljs-keyword">this</span>.transitionEndEvent(<span class="hljs-string">'transition'</span>),
        endB = <span class="hljs-keyword">this</span>.transitionEndEvent(<span class="hljs-string">'animation'</span>),
        objA = <span class="hljs-keyword">this</span>._transitionEvent(endA, el),
        objB = <span class="hljs-keyword">this</span>._transitionEvent(endB, el);


    <span class="hljs-keyword">return</span> objA.duration &gt; objB.duration ? objA : objB;
  },

  _transitionEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(endEvent, el)</span> </span>{
    <span class="hljs-keyword">if</span>(!endEvent) {
      <span class="hljs-keyword">return</span> {
        duration: <span class="hljs-number">0</span>
      };
    }

    <span class="hljs-keyword">var</span> durProp = <span class="hljs-keyword">this</span>.subProperty(endEvent, <span class="hljs-string">'duration'</span>),
        delayProp = <span class="hljs-keyword">this</span>.subProperty(endEvent, <span class="hljs-string">'delay'</span>),
        style = <span class="hljs-built_in">window</span>.getComputedStyle(el),
        durs = durProp &amp;&amp; style[durProp] &amp;&amp; style[durProp].split(<span class="hljs-string">','</span>) || [<span class="hljs-string">'0'</span>],
        delays = delayProp &amp;&amp; style[delayProp] &amp;&amp; style[delayProp].split(<span class="hljs-string">','</span>) || [<span class="hljs-string">'0'</span>],
        dur, delay;

    durs = durs.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>(d.toLowerCase(), <span class="hljs-number">10</span>); });
    delays = delays.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>(d.toLowerCase(), <span class="hljs-number">10</span>); });

    dur = <span class="hljs-built_in">Math</span>.max.apply(<span class="hljs-literal">null</span>, durs);
    delay = <span class="hljs-built_in">Math</span>.max.apply(<span class="hljs-literal">null</span>, delays);

    <span class="hljs-keyword">if</span>(durProp &amp;&amp; durProp.indexOf(<span class="hljs-string">'ms'</span>) &lt; <span class="hljs-number">0</span>) {
      dur *= <span class="hljs-number">1000</span>;
    }

    <span class="hljs-keyword">if</span>(delayProp &amp;&amp; delayProp.indexOf(<span class="hljs-string">'ms'</span>) &lt; <span class="hljs-number">0</span>) {
      delay *= <span class="hljs-number">1000</span>;
    }

    <span class="hljs-keyword">return</span> {
      event: endEvent,
      duration: <span class="hljs-built_in">parseInt</span>(dur + delay, <span class="hljs-number">10</span>)
    };
  }

});
pie.binding = pie.base.extend(<span class="hljs-string">'binding'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view, model, options)</span> </span>{
    <span class="hljs-keyword">this</span>.view = view;
    <span class="hljs-keyword">this</span>.model = model;
    <span class="hljs-keyword">this</span>.options = options;
    <span class="hljs-keyword">this</span>.emitterUids = [];

    <span class="hljs-keyword">this</span>.normalizeOptions();
    <span class="hljs-keyword">this</span>.setupViewCallbacks();
    <span class="hljs-keyword">this</span>.setupModelCallbacks();
  },

  teardown: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> v = <span class="hljs-keyword">this</span>.view;
    <span class="hljs-keyword">this</span>.emitterUids.forEach(v.eoff.bind(v));

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.modelObserverUid) {
      v.unobserve(<span class="hljs-keyword">this</span>.modelObserverUid);
    }
  },

  normalizeOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.options.attr) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"An attr must be provided for data binding. "</span> + <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-keyword">this</span>.options));

    <span class="hljs-keyword">var</span> given       = <span class="hljs-keyword">this</span>.options || {};
    <span class="hljs-keyword">var</span> out         = {};
    <span class="hljs-comment">/* the model attribute to be observed / updated. */</span>
    out.attr        = given.attr;
    <span class="hljs-comment">/* the selector to observe */</span>
    out.sel         = given.sel         || <span class="hljs-string">'[name="'</span> + given.attr + <span class="hljs-string">'"]'</span>;
    <span class="hljs-comment">/* the way in which the binding should extract the value from the dom. */</span>
    out.type        = given.type        || <span class="hljs-string">'auto'</span>;
    <span class="hljs-comment">/* the desired type the dom value's should be cast to. */</span>
    out.dataType    = given.dataType    || <span class="hljs-string">'default'</span>;
    <span class="hljs-comment">/* if `dataType` is "array", they type which should be applied to each. */</span>
    out.eachType    = given.eachType    || <span class="hljs-literal">undefined</span>;
    <span class="hljs-comment">/* when an input changes or has a keyup event, the model will update. */</span>
    out.trigger     = given.trigger     || <span class="hljs-string">'change keyup'</span>;
    <span class="hljs-comment">/* just in case the dom events should be based on a different field than that provided by `sel` */</span>
    out.triggerSel  = given.triggerSel  || out.sel;
    <span class="hljs-comment">/* if toModel is not provided, it's presumed to be desired. */</span>
    out.toModel     = given.toModel     || (given.toModel === <span class="hljs-literal">undefined</span> &amp;&amp; out.type !== <span class="hljs-string">'class'</span>);
    <span class="hljs-comment">/* if toView is not provided, it's presumed to be desired. */</span>
    out.toView      = given.toView      || given.toView === <span class="hljs-literal">undefined</span>;
    <span class="hljs-comment">/* no debounce by default. */</span>
    out.debounce    = given.debounce    || <span class="hljs-literal">false</span>;
    <span class="hljs-comment">/* secondary options. */</span>
    out.options     = given.options     || {};

    <span class="hljs-comment">/* A `true` value will results in a default debounce duration of 250ms. */</span>
    <span class="hljs-keyword">if</span>(out.debounce === <span class="hljs-literal">true</span>) out.debounce = <span class="hljs-number">250</span>;

    <span class="hljs-keyword">this</span>.options = out;
  },

  getModelValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.model.get(<span class="hljs-keyword">this</span>.options.attr);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.decorator) val = <span class="hljs-keyword">this</span>.options.decorator(val);
    <span class="hljs-keyword">return</span> val;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-406">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-406">&#182;</a>
              </div>
              <p>The type caster based on the <code>dataType</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getTypeCaster: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dataType)</span> </span>{
    dataType = dataType || <span class="hljs-keyword">this</span>.options.dataType;
    <span class="hljs-keyword">return</span> pie.binding.typeCasters[dataType] || pie.binding.typeCasters[<span class="hljs-string">'default'</span>];
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-407">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-407">&#182;</a>
              </div>
              <p>Provide a way to retrieve values out of the dom &amp; apply values to the dom.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getIntegration: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.type === <span class="hljs-string">'auto'</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.determineIntegrationForElement(el);
    <span class="hljs-keyword">return</span> pie.binding.integrations[<span class="hljs-keyword">this</span>.options.type] || pie.binding.integrations.value;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-408">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-408">&#182;</a>
              </div>
              <p>If type=auto, this does it’s best to determine the appropriate integration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  determineIntegrationForElement: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
    <span class="hljs-keyword">var</span> mod;
    <span class="hljs-keyword">if</span>(el.hasAttribute &amp;&amp; el.hasAttribute(<span class="hljs-string">'data-'</span> + <span class="hljs-keyword">this</span>.options.attr)) mod = <span class="hljs-string">'attribute'</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(el.nodeName === <span class="hljs-string">'INPUT'</span> &amp;&amp; <span class="hljs-built_in">String</span>(el.getAttribute(<span class="hljs-string">'type'</span>)).toUpperCase() === <span class="hljs-string">'CHECKBOX'</span>) mod = <span class="hljs-string">'check'</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(el.nodeName === <span class="hljs-string">'INPUT'</span> &amp;&amp; <span class="hljs-built_in">String</span>(el.getAttribute(<span class="hljs-string">'type'</span>)).toUpperCase() === <span class="hljs-string">'RADIO'</span>) mod = <span class="hljs-string">'radio'</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(el.nodeName === <span class="hljs-string">'INPUT'</span> || el.nodeName === <span class="hljs-string">'SELECT'</span> || el.nodeName === <span class="hljs-string">'TEXTAREA'</span>) mod = <span class="hljs-string">'value'</span>;
    <span class="hljs-keyword">else</span> mod = <span class="hljs-string">'text'</span>;

    <span class="hljs-keyword">return</span> pie.binding.integrations[mod];
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-409">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-409">&#182;</a>
              </div>
              <p>Wiring of the view-to-model callbacks. These will observe dom events
and translate them to model values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setupViewCallbacks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> _toModel = <span class="hljs-keyword">this</span>.options.toModel;
    <span class="hljs-keyword">var</span> opts = <span class="hljs-keyword">this</span>.options;

    <span class="hljs-keyword">if</span>(!_toModel) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-410">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-410">&#182;</a>
              </div>
              <p>If a function is provided, use that as the base implementation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!pie.object.isFunction(_toModel)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-411">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-411">&#182;</a>
              </div>
              <p>Otherwise, we provide a default implementation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _toModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, opts)</span> </span>{
        <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.getValueFromElement(el);
        <span class="hljs-keyword">this</span>.applyValueToModel(value, opts);
      }.bind(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">var</span> toModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">var</span> el = e.delegateTarget;
      _toModel(el);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-412">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-412">&#182;</a>
              </div>
              <p>If a debounce is requested, we apply the debounce to the wrapped function,
Leaving the base function untouched.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(opts.debounce) toModel = pie.fn.debounce(toModel, opts.debounce);

    <span class="hljs-keyword">this</span>.toModel = _toModel;</pre></div></div>
            
        </li>
        
        
        <li id="section-413">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-413">&#182;</a>
              </div>
              <p>Multiple events could be supplied, separated by a space.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    opts.trigger.split(<span class="hljs-string">' '</span>).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-414">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-414">&#182;</a>
              </div>
              <p>Use the view’s event management to register the callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.emitterUids.push(<span class="hljs-keyword">this</span>.view.on(event, opts.triggerSel, toModel));
    }.bind(<span class="hljs-keyword">this</span>));
  },

  setupModelCallbacks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> toView = <span class="hljs-keyword">this</span>.options.toView;
    <span class="hljs-keyword">var</span> opts = <span class="hljs-keyword">this</span>.options;

    <span class="hljs-keyword">if</span>(!toView) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span>(!pie.object.isFunction(toView)) {
      toView = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changeSet)</span> </span>{
        <span class="hljs-keyword">this</span>.lastChange = changeSet &amp;&amp; changeSet.get(opts.attr);
        <span class="hljs-keyword">this</span>.applyValueToElements();
      }.bind(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">this</span>.toView = toView;
    <span class="hljs-keyword">this</span>.modelObserverUid = <span class="hljs-keyword">this</span>.view.observe(<span class="hljs-keyword">this</span>.model, toView, opts.attr);
  },

  applyValueToElements: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.ignore) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> els = <span class="hljs-keyword">this</span>.els();
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; els.length; i++) {
      <span class="hljs-keyword">this</span>.getIntegration(els[i]).setValue(els[i], <span class="hljs-keyword">this</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-415">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-415">&#182;</a>
              </div>
              <p>Extract a value out of an element based on a binding configuration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getValueFromElement: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-416">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-416">&#182;</a>
              </div>
              <p>Get the basic value out of the element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.getIntegration(el).getValue(el, <span class="hljs-keyword">this</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-417">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-417">&#182;</a>
              </div>
              <p>Get the type casting function it based on the configuration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fn = <span class="hljs-keyword">this</span>.getTypeCaster();</pre></div></div>
            
        </li>
        
        
        <li id="section-418">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-418">&#182;</a>
              </div>
              <p>Type cast the value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    val = fn(val);</pre></div></div>
            
        </li>
        
        
        <li id="section-419">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-419">&#182;</a>
              </div>
              <p>If we’re configured to have an array and have defined an <code>eachType</code>
use it to typecast each value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.dataType === <span class="hljs-string">'array'</span> &amp;&amp; <span class="hljs-keyword">this</span>.options.eachType) {
      <span class="hljs-keyword">var</span> eachFn = <span class="hljs-keyword">this</span>.getTypeCaster(<span class="hljs-keyword">this</span>.options.eachType);
      val = val.map(eachFn);
    }

    <span class="hljs-keyword">return</span> val;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-420">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-420">&#182;</a>
              </div>
              <p>Apply a value to the model, ensuring the model-to-view triggers do not take place.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  applyValueToModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, opts)</span> </span>{
    <span class="hljs-keyword">try</span>{
      <span class="hljs-keyword">this</span>.ignore = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.model.set(<span class="hljs-keyword">this</span>.options.attr, value, opts);</pre></div></div>
            
        </li>
        
        
        <li id="section-421">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-421">&#182;</a>
              </div>
              <p>Even if we error, we should reset the ignore.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">this</span>.ignore = <span class="hljs-literal">false</span>;
    }
  },

  readFields: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(opts)</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.toModel) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> els = <span class="hljs-keyword">this</span>.els();

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; els.length; i++) {
      <span class="hljs-keyword">this</span>.toModel(els[i], opts);
    }
  },

  els: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> pie.object.isString(<span class="hljs-keyword">this</span>.options.sel) ? <span class="hljs-keyword">this</span>.view.qsa(<span class="hljs-keyword">this</span>.options.sel) : pie.array.from(<span class="hljs-keyword">this</span>.options.sel);
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-422">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-422">&#182;</a>
              </div>
              <p>A set of methods to cast raw values into a specific type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.binding.typeCasters = {
  array: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
    <span class="hljs-keyword">return</span> pie.array.from(raw);
  },

  boolean: (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-423">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-423">&#182;</a>
              </div>
              <p>Match different strings representing truthy values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> reg = <span class="hljs-regexp">/^(1|true|yes|ok|on)$/</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
      <span class="hljs-keyword">if</span>(raw == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> raw;
      <span class="hljs-keyword">return</span> !!(raw &amp;&amp; reg.test(<span class="hljs-built_in">String</span>(raw)));
    };

  })(),</pre></div></div>
            
        </li>
        
        
        <li id="section-424">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-424">&#182;</a>
              </div>
              <p>Attempt to parse as a float, if <code>NaN</code> return <code>null</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  number: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
    <span class="hljs-keyword">var</span> val = <span class="hljs-built_in">parseFloat</span>(raw, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(val)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> val;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-425">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-425">&#182;</a>
              </div>
              <p>Attempt to parse as an integer, if <code>NaN</code> return <code>null</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  integer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
    <span class="hljs-keyword">var</span> val = <span class="hljs-built_in">parseInt</span>(raw, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(val)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> val;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-426">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-426">&#182;</a>
              </div>
              <p><code>null</code> or <code>undefined</code> are passed through, otherwise cast as a String.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  string: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
    <span class="hljs-keyword">return</span> raw == <span class="hljs-literal">null</span> ? raw : <span class="hljs-built_in">String</span>(raw);
  },

  <span class="hljs-string">"default"</span> : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
    <span class="hljs-keyword">return</span> raw;
  }

};</pre></div></div>
            
        </li>
        
        
        <li id="section-427">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-427">&#182;</a>
              </div>
              <p>Bind to an element’s attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.ns(<span class="hljs-string">'pie.binding.integrations'</span>).attribute = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-428">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-428">&#182;</a>
              </div>
              <p>extract the attribute name from the binding configuration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> attributeName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(binding)</span></span>{
    <span class="hljs-keyword">return</span> binding.options.options.attribute || (<span class="hljs-string">'data-'</span> + binding.options.attr);
  };

  <span class="hljs-keyword">return</span> {

    getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
      <span class="hljs-keyword">return</span> el.getAttribute(attributeName(binding));
    },

    setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
      <span class="hljs-keyword">var</span> value = binding.getModelValue();
      <span class="hljs-keyword">return</span> el.setAttribute(attributeName(binding), value);
    }

  };
})();

pie.binding.integrations[<span class="hljs-string">'class'</span>] = {
  getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* el, binding */</span>)</span> </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"class bindings can only be from the model to the view. Please declare toModel: false"</span>);
  },

  setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
    <span class="hljs-keyword">var</span> className = binding.options.options.className;

    <span class="hljs-keyword">if</span>(className === <span class="hljs-string">'_value_'</span>) {
      <span class="hljs-keyword">var</span> change = binding.lastChange;
      <span class="hljs-keyword">if</span>(change) {
        <span class="hljs-keyword">if</span>(change.oldValue) {
          pie.dom.removeClass(el, change.oldValue);
        }

        <span class="hljs-keyword">if</span>(change.value) {
          pie.dom.addClass(el, change.value);
          <span class="hljs-keyword">return</span> change.value;
        }
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> value = binding.getModelValue();
      className = className || binding.options.attr;

      pie.dom[!!value ? <span class="hljs-string">'addClass'</span> : <span class="hljs-string">'removeClass'</span>](el, className);

      <span class="hljs-keyword">return</span> className;
    }
  }
};

pie.binding.integrations.value = {</pre></div></div>
            
        </li>
        
        
        <li id="section-429">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-429">&#182;</a>
              </div>
              <p>Simple value extraction</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el <span class="hljs-comment">/*, binding */</span>)</span> </span>{
    <span class="hljs-keyword">return</span> el.value;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-430">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-430">&#182;</a>
              </div>
              <p>Apply the model’s value to the element’s value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
    <span class="hljs-keyword">var</span> value = binding.getModelValue();
    <span class="hljs-comment">/* jslint eqnull:true */</span>
    <span class="hljs-keyword">if</span>(value == <span class="hljs-literal">null</span>) value = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span> el.value = value;
  }

};

pie.binding.integrations.check = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-431">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-431">&#182;</a>
              </div>
              <p>String based index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> index = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, value)</span> </span>{
    <span class="hljs-keyword">if</span>(!arr) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    value = <span class="hljs-built_in">String</span>(value);
    <span class="hljs-keyword">return</span> pie.array.indexOf(arr, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>(e) === value; });
  };

  <span class="hljs-keyword">return</span> {

    getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-432">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-432">&#182;</a>
              </div>
              <p>If we have an array, manage the values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(binding.options.dataType === <span class="hljs-string">'array'</span>) {

        <span class="hljs-keyword">var</span> existing = pie.array.from(binding.getModelValue()), i;

        i = index(existing, el.value);</pre></div></div>
            
        </li>
        
        
        <li id="section-433">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-433">&#182;</a>
              </div>
              <p>If we are checked and we don’t already have it, add it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(el.checked &amp;&amp; i &lt; <span class="hljs-number">0</span>) {
          existing = pie.array.dup(existing);
          existing.push(el.value);</pre></div></div>
            
        </li>
        
        
        <li id="section-434">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-434">&#182;</a>
              </div>
              <p>If we are not checked but we do have it, then we add it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!el.checked &amp;&amp; i &gt;= <span class="hljs-number">0</span>) {
          existing = pie.array.dup(existing);
          existing.splice(i, <span class="hljs-number">1</span>);
        }

        <span class="hljs-keyword">return</span> existing;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(binding.options.dataType === <span class="hljs-string">'boolean'</span>){
        <span class="hljs-keyword">return</span> !!el.checked;
      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-435">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-435">&#182;</a>
              </div>
              <p>Otherwise, we return the el’s value if it’s checked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> el.checked ? el.value : <span class="hljs-literal">null</span>;
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-436">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-436">&#182;</a>
              </div>
              <p>If the model’s value contains the checkbox, check it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
      <span class="hljs-keyword">var</span> value = binding.getModelValue(),
      elValue = el.value;</pre></div></div>
            
        </li>
        
        
        <li id="section-437">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-437">&#182;</a>
              </div>
              <p>In the case of an array, we check for inclusion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(binding.options.dataType === <span class="hljs-string">'array'</span>) {
        <span class="hljs-keyword">var</span> i = index(value, elValue);
        <span class="hljs-keyword">return</span> el.checked = !!~i;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> caster = binding.getTypeCaster(binding.options.dataType);</pre></div></div>
            
        </li>
        
        
        <li id="section-438">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-438">&#182;</a>
              </div>
              <p>Otherwise we check for equality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> el.checked = caster(elValue) === caster(value);
      }
    }
  };

})();


pie.binding.integrations.radio = {</pre></div></div>
            
        </li>
        
        
        <li id="section-439">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-439">&#182;</a>
              </div>
              <p>If a radio input is checked, return it’s value.
Otherwise, return the existing value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
    <span class="hljs-keyword">var</span> existing = binding.getModelValue();
    <span class="hljs-keyword">if</span>(el.checked) <span class="hljs-keyword">return</span> el.value;
    <span class="hljs-keyword">return</span> existing;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-440">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-440">&#182;</a>
              </div>
              <p>Check a radio button if the value matches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
    <span class="hljs-keyword">var</span> value = binding.getModelValue(),
    elValue = el.value,
    caster = binding.getTypeCaster();

    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">return</span> el.checked = caster(elValue) === caster(value);
  }

};</pre></div></div>
            
        </li>
        
        
        <li id="section-441">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-441">&#182;</a>
              </div>
              <p>Set the innerTEXT of an element based on the model’s value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.binding.integrations.text = {

  getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el <span class="hljs-comment">/*, binding */</span>)</span> </span>{
    <span class="hljs-keyword">return</span> el.textContent;
  },

  setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
    <span class="hljs-keyword">var</span> value = binding.getModelValue();

    <span class="hljs-comment">/* jslint eqnull:true */</span>
    <span class="hljs-keyword">if</span>(value == <span class="hljs-literal">null</span>) value = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span> el.textContent = value;
  }

};</pre></div></div>
            
        </li>
        
        
        <li id="section-442">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-442">&#182;</a>
              </div>
              <p>Set the innerHTML of an element based on the model’s value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.binding.integrations.html = {

  getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el <span class="hljs-comment">/*, binding */</span>)</span> </span>{
    <span class="hljs-keyword">return</span> el.innerHTML;
  },

  setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
    <span class="hljs-keyword">var</span> value = binding.getModelValue();
    <span class="hljs-comment">/* jslint eqnull:true */</span>
    <span class="hljs-keyword">if</span>(value == <span class="hljs-literal">null</span>) value = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span> el.innerHTML = value;
  }

};

pie.binding.integrations.fn = {
  getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"fn integrations do not provide a dom-to-model integration. Please use the `toModel: false` option."</span>);
  },

  setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
    <span class="hljs-keyword">var</span> value = binding.getModelValue();
    <span class="hljs-keyword">return</span> binding.options.options.fn(el, value, binding);
  }
}
  pie.VERSION = <span class="hljs-string">"0.1.20150826.1"</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {</pre></div></div>
            
        </li>
        
        
        <li id="section-443">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-443">&#182;</a>
              </div>
              <p>AMD. Register as an anonymous module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    define(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> pie;
    });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">window</span>.pie = pie;
  }
})(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
<script type="text/javascript">
  var titles = Array.prototype.slice.call(document.querySelectorAll('[id^="section-"] h1'), 0);
  var html = '<li class="docco-index" id="docco-index"><div class="annotation"><ul>', a = document.createElement('a');
  a.textContent = 'Back to top';
  a.href = '#docco-index';
  a.style.color = '#cccccc';

  titles.forEach(function(title) {
    html += '<li><a href="#' + title.id + '">' + title.innerHTML.replace(/pie\s/i, '') + '</a></li>';
    title.parentNode.insertBefore(a.cloneNode(true), title);
  });

  html += "</ul></div></li>";

  var newEl = document.createElement('div');
  newEl.innerHTML = html;
  newEl = newEl.firstElementChild;

  var title = document.querySelector('#title');
  title.parentNode.insertBefore(newEl, title.nextSibling);


</script>
</body>
</html>
