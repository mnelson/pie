<!DOCTYPE html>

<html>
<head>
  <title>pie.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>pie.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>prepare sudo for pie standards
[% evaluate %], [%= interpolate %], [%- sanitize(interpolate) %]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>sudo.templateSettings = {
  evaluate:    <span class="hljs-regexp">/\[%([\s\S]+?)%\]/g</span>,
  interpolate: <span class="hljs-regexp">/\[%=([\s\S]+?)%\]/g</span>,
  <span class="hljs-built_in">escape</span>:      <span class="hljs-regexp">/\[%-([\s\S]+?)%\]/g</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>pie namespace;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">window</span>.pie = {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>native extensions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  array: {},
  date: {},
  dom: {},
  func: {},
  math: {},
  object: {},
  string: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>inheritance helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  inheritance: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>extensions to be used within pie apps.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mixins: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>service objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  services: {},

  uid: <span class="hljs-number">0</span>,

  unique: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.uid++; },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>application utilities</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  util: {},

};
pie.array.areAll = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(;i &lt; a.length; i++) {
    <span class="hljs-keyword">if</span>(!f.call(<span class="hljs-literal">null</span>, a[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};

pie.array.areAny = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(;i &lt; a.length; i++) {
    <span class="hljs-keyword">if</span>(f.call(<span class="hljs-literal">null</span>, a[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>turn arguments into an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.args = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(argumentsObject)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.prototype.slice.call(argumentsObject);
};


pie.array.avg = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">var</span> s = pie.array.sum(a), l = a.length;
  <span class="hljs-keyword">return</span> l ? (s / l) : <span class="hljs-number">0</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>remove all null or undefined values
does not remove all falsy values unless the second param is true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.compact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, removeAllFalsy)</span></span>{
  <span class="hljs-keyword">return</span> a.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{
    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">return</span> removeAllFalsy ? !!i : (i != <span class="hljs-literal">null</span>);
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>return the first item where the provided function evaluates to a truthy value.
if a function is not provided, the second argument will be assumed to be an attribute check.
pie.array.detect([1,3,4,5], function(e){ return e % 2 === 0; }) =&gt; 4
pie.array.detect([{foo: ‘bar’}, {baz: ‘foo’}], ‘baz’) =&gt; {baz: ‘foo’}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.detect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = a.length;
  <span class="hljs-keyword">for</span>(;i&lt;l;i++) {
    <span class="hljs-keyword">if</span>(pie.object.getValue(a[i], f)) {
      <span class="hljs-keyword">return</span> a[i];
    }
  }
};


pie.array.dup = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">return</span> a.slice(<span class="hljs-number">0</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>flattens an array of arrays or elements into a single depth array
pie.array.flatten([‘a’, [‘b’, ‘c’]]) =&gt; [‘a’, ‘b’, ‘c’]
you may also restrict the depth of the flattening:
pie.array.flatten([[‘a’], [‘b’, [‘c’]]], 1) =&gt; [‘a’, ‘b’, [‘c’]]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.flatten = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, depth, into)</span> </span>{
  into = into || [];

  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(a) &amp;&amp; depth !== -<span class="hljs-number">1</span>) {

    <span class="hljs-keyword">if</span>(depth != <span class="hljs-literal">null</span>) depth--;

    a.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
      pie.array.flatten(e, depth, into);
    });

  } <span class="hljs-keyword">else</span> {
    into.push(a);
  }

  <span class="hljs-keyword">return</span> into;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>return an array from a value. if the value is an array it will be returned.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.from = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.isArray(value) ? value : pie.array.compact([value], <span class="hljs-literal">false</span>);
};


pie.array.grep = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, regex)</span> </span>{
  <span class="hljs-keyword">return</span> arr.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span></span>{ <span class="hljs-keyword">return</span> regex.test(<span class="hljs-built_in">String</span>(a)); });
};


pie.array.groupBy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, groupingF)</span> </span>{
  <span class="hljs-keyword">var</span> h = {}, g;
  arr.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span></span>{

    g = pie.object.getValue(a, groupingF);

    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">if</span>(g != <span class="hljs-literal">null</span>) {
      h[g] = h[g] || [];
      h[g].push(a);
    }
  });

  <span class="hljs-keyword">return</span> h;
};


pie.array.intersect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> a.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span> </span>{ <span class="hljs-keyword">return</span> ~b.indexOf(i); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>get the last item</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.last = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr)</span> </span>{
  <span class="hljs-keyword">if</span>(arr &amp;&amp; arr.length) <span class="hljs-keyword">return</span> arr[arr.length - <span class="hljs-number">1</span>];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>return an array filled with the return values of f
if f is not a function, it will be assumed to be a key of the item.
if the resulting value is a function, it can be invoked by passing true as the second argument.
pie.array.map([“a”, “b”, “c”], function(e){ return e.toUpperCase(); }) =&gt; [“A”, “B”, “C”]
pie.array.map([“a”, “b”, “c”], ‘length’) =&gt; [1, 1, 1]
pie.array.map([0,1,2], ‘toFixed’) =&gt; [toFixed(){}, toFixed(){}, toFixed(){}]
pie.array.map([0,1,2], ‘toFixed’, true) =&gt; [“0”, “1”, “2”]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.map = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f, callInternalFunction)</span></span>{
  <span class="hljs-keyword">var</span> callingF;

  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span>(f) !== <span class="hljs-string">'function'</span>) {
    callingF = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
      <span class="hljs-keyword">var</span> ef = e[f];

      <span class="hljs-keyword">if</span>(callInternalFunction &amp;&amp; <span class="hljs-keyword">typeof</span>(ef) === <span class="hljs-string">'function'</span>)
        <span class="hljs-keyword">return</span> ef.apply(e);
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> ef;
    };
  } <span class="hljs-keyword">else</span> {
    callingF = f;
  }

  <span class="hljs-keyword">return</span> a.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> callingF(e); });
};


pie.array.remove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, o)</span> </span>{
  <span class="hljs-keyword">var</span> idx;
  <span class="hljs-keyword">while</span>(~(idx = a.indexOf(o))) {
    a.splice(idx, <span class="hljs-number">1</span>);
  }
  <span class="hljs-keyword">return</span> a;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>return an array that consists of any A elements that B does not contain</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.subtract = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> a.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span> </span>{ <span class="hljs-keyword">return</span> !~b.indexOf(i); });
};


pie.array.sum = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">var</span> s = <span class="hljs-number">0</span>;
  a.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{ s += <span class="hljs-built_in">parseFloat</span>(i); });
  <span class="hljs-keyword">return</span> s;
};


pie.array.sortBy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, sortF)</span></span>{
  <span class="hljs-keyword">var</span> aVal, bVal;
  <span class="hljs-keyword">return</span> arr.sort(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
    aVal = pie.object.getValue(a, sortF);
    bVal = pie.object.getValue(b, sortF);
    <span class="hljs-keyword">if</span>(aVal === bVal) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(aVal &lt; bVal) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  });
};


pie.array.toSentence = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, i18n)</span> </span>{
  <span class="hljs-keyword">if</span>(!arr.length) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;

  <span class="hljs-keyword">var</span> delim = i18n &amp;&amp; i18n.t(<span class="hljs-string">'sentence.delimeter'</span>, {<span class="hljs-keyword">default</span>: <span class="hljs-string">''</span>}) || <span class="hljs-string">', '</span>,
  and = i18n &amp;&amp; i18n.t(<span class="hljs-string">'sentence.and'</span>, {<span class="hljs-keyword">default</span>: <span class="hljs-string">''</span>}) || <span class="hljs-string">' and '</span>;

  <span class="hljs-keyword">if</span>(arr.length &gt; <span class="hljs-number">2</span>) arr = [arr.slice(<span class="hljs-number">0</span>,arr.length-<span class="hljs-number">1</span>).join(delim), arr.slice(arr.length-<span class="hljs-number">1</span>)];
  <span class="hljs-keyword">return</span> arr.join(and);
};


pie.array.union = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> arrs = pie.array.args(<span class="hljs-built_in">arguments</span>);
  arrs = pie.array.compact(arrs, <span class="hljs-literal">true</span>);
  arrs = pie.array.flatten(arrs);
  arrs = pie.array.unique(arrs);
  <span class="hljs-keyword">return</span> arrs;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>return unique values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.unique = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr)</span> </span>{
  <span class="hljs-keyword">return</span> arr.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, i)</span></span>{ <span class="hljs-keyword">return</span> arr.indexOf(e) === i; });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>takes a iso date string and converts to a local time representing 12:00am, on that date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.date.dateFromISO = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(isoDateString)</span> </span>{
  <span class="hljs-keyword">if</span>(!isoDateString) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> parts = isoDateString.split(<span class="hljs-regexp">/T|\s/</span>)[<span class="hljs-number">0</span>].split(<span class="hljs-string">'-'</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(parts[<span class="hljs-number">0</span>], parts[<span class="hljs-number">1</span>] - <span class="hljs-number">1</span>, parts[<span class="hljs-number">2</span>]);
};


<span class="hljs-comment">/**
 * STOLEN FROM HERE:
 * Date.parse with progressive enhancement for ISO 8601 &lt;https://github.com/csnover/js-iso8601&gt;
 * © 2011 Colin Snover &lt;http://zetafleet.com&gt;
 * Released under MIT license.
 */</span>

pie.date.timeFromISO = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

  <span class="hljs-keyword">var</span> numericKeys = [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>];

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date)</span> </span>{
    <span class="hljs-keyword">if</span>(!date) <span class="hljs-keyword">return</span> <span class="hljs-literal">NaN</span>;
    <span class="hljs-keyword">if</span>(!<span class="hljs-regexp">/T|\s/</span>.test(date)) <span class="hljs-keyword">return</span> pie.date.dateFromISO(date);

    <span class="hljs-keyword">var</span> timestamp, struct, minutesOffset = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>ES5 §15.9.4.2 states that the string should attempt to be parsed as a Date Time String Format string
before falling back to any implementation-specific date parsing, so that’s what we do, even if native
implementations could be faster
             1 YYYY                2 MM       3 DD           4 HH    5 mm       6 ss        7 msec        8 Z 9 ±    10 tzHH    11 tzmm</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> ((struct = <span class="hljs-regexp">/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/</span>.exec(date))) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>avoid NaN timestamps caused by “undefined” values being passed to Date.UTC</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, k; (k = numericKeys[i]); ++i) {
        struct[k] = +struct[k] || <span class="hljs-number">0</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>allow undefined days and months</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      struct[<span class="hljs-number">2</span>] = (+struct[<span class="hljs-number">2</span>] || <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>;
      struct[<span class="hljs-number">3</span>] = +struct[<span class="hljs-number">3</span>] || <span class="hljs-number">1</span>;

      <span class="hljs-keyword">if</span> (struct[<span class="hljs-number">8</span>] !== <span class="hljs-string">'Z'</span> &amp;&amp; struct[<span class="hljs-number">9</span>] !== <span class="hljs-literal">undefined</span>) {
        minutesOffset = struct[<span class="hljs-number">10</span>] * <span class="hljs-number">60</span> + struct[<span class="hljs-number">11</span>];

        <span class="hljs-keyword">if</span> (struct[<span class="hljs-number">9</span>] === <span class="hljs-string">'+'</span>) {
          minutesOffset = <span class="hljs-number">0</span> - minutesOffset;
        }
      }

      timestamp = <span class="hljs-built_in">Date</span>.UTC(struct[<span class="hljs-number">1</span>], struct[<span class="hljs-number">2</span>], struct[<span class="hljs-number">3</span>], struct[<span class="hljs-number">4</span>], struct[<span class="hljs-number">5</span>] + minutesOffset, struct[<span class="hljs-number">6</span>], struct[<span class="hljs-number">7</span>]);
    } <span class="hljs-keyword">else</span> {
      timestamp = <span class="hljs-literal">NaN</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(timestamp);
  };

})();</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>create an element based on the content provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.createElement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">var</span> wrap = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
  wrap.innerHTML = str;
  <span class="hljs-keyword">return</span> wrap.removeChild(wrap.firstElementChild);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Returns a function, that, as long as it continues to be invoked, will not
be triggered. The function will be called after it stops being called for
N milliseconds. If <code>immediate</code> is passed, trigger the function on the
leading edge, instead of the trailing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.func.debounce = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func, wait, immediate)</span> </span>{
  <span class="hljs-keyword">var</span> timeout;
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">this</span>, args = <span class="hljs-built_in">arguments</span>;
    <span class="hljs-keyword">var</span> later = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      timeout = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">if</span> (!immediate) func.apply(context, args);
    };
    <span class="hljs-keyword">var</span> callNow = immediate &amp;&amp; !timeout;
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
    <span class="hljs-keyword">if</span> (callNow) func.apply(context, args);
  };
};

pie.func.valueFrom = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f, binding)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> f === <span class="hljs-string">'function'</span>) <span class="hljs-keyword">return</span> f.call(binding);
  <span class="hljs-keyword">return</span> f;
};
pie.math.precision = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(number, places)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.round(number * <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, places)) / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, places);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>deletes all undefined and null values.
returns a new object less any empty key/values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.compact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, removeEmpty)</span></span>{
  <span class="hljs-keyword">var</span> b = pie.object.extend({}, a);
  <span class="hljs-built_in">Object</span>.keys(b).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    <span class="hljs-keyword">if</span>(b[k] === <span class="hljs-literal">undefined</span> || b[k] === <span class="hljs-literal">null</span> || (removeEmpty &amp;&amp; b[k].toString().length === <span class="hljs-number">0</span>)) <span class="hljs-keyword">delete</span> b[k];
  });
  <span class="hljs-keyword">return</span> b;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>deep merge</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.deepExtend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.args(<span class="hljs-built_in">arguments</span>),
      targ = args.shift(),
      obj;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn</span><span class="hljs-params">(k)</span> </span>{
    <span class="hljs-keyword">if</span>(k <span class="hljs-keyword">in</span> targ &amp;&amp; <span class="hljs-keyword">typeof</span> targ[k] === <span class="hljs-string">'object'</span>) {
      targ[k] = pie.object.deepExtend(targ[k], obj[k]);
    } <span class="hljs-keyword">else</span> {
      targ[k] = obj[k];
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>iterate over each passed in obj remaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (; args.length;) {
    obj = args.shift();
    <span class="hljs-keyword">if</span>(obj) <span class="hljs-built_in">Object</span>.keys(obj).forEach(fn);
  }
  <span class="hljs-keyword">return</span> targ;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>grab the sub-object from the provided object less the provided keys.
pie.object.except({foo: ‘bar’, biz: ‘baz’}, ‘biz’) =&gt; {‘foo’: ‘bar’}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.except = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> b = {}, args = pie.array.args(<span class="hljs-built_in">arguments</span>), a = args[<span class="hljs-number">0</span>];
  args = pie.array.flatten(args.splice(<span class="hljs-number">1</span>));
  <span class="hljs-built_in">Object</span>.keys(a).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
    <span class="hljs-keyword">if</span>(args.indexOf(k) &lt; <span class="hljs-number">0</span>) b[k] = a[k];
  });
  <span class="hljs-keyword">return</span> b;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>shallow merge</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.extend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.args(<span class="hljs-built_in">arguments</span>),
      targ = args.shift(),
      obj;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn</span><span class="hljs-params">(k)</span> </span>{
    targ[k] = obj[k];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>iterate over each passed in obj remaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (; args.length; ) {
    obj = args.shift();
    <span class="hljs-keyword">if</span>(obj) <span class="hljs-built_in">Object</span>.keys(obj).forEach(fn);
  }

  <span class="hljs-keyword">return</span> targ;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>yield each key value pair to a function
pie.object.forEach({‘foo’ : ‘bar’}, function(k,v){ console.log(k, v); });</p>
<p>=&gt; foo, bar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.forEach = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o, f)</span> </span>{
  <span class="hljs-built_in">Object</span>.keys(o).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    f(k, o[k]);
  });
};


pie.object.getPath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o, path)</span> </span>{
  <span class="hljs-keyword">return</span> sudo.getPath(path, o);
};


pie.object.getValue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o, attribute)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> attribute === <span class="hljs-string">'function'</span>)                     <span class="hljs-keyword">return</span> attribute.call(<span class="hljs-literal">null</span>, o);
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span>)                                     <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> o[attribute] === <span class="hljs-string">'function'</span>)             <span class="hljs-keyword">return</span> o[attribute].call(o);
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(o.hasOwnProperty(attribute) || attribute <span class="hljs-keyword">in</span> o)  <span class="hljs-keyword">return</span> o[attribute];
  <span class="hljs-keyword">else</span>                                                    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>does the object have the described path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.hasPath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, path)</span> </span>{
  <span class="hljs-keyword">var</span> parts = path.split(<span class="hljs-string">'.'</span>), part;
  <span class="hljs-keyword">while</span>(part = parts.shift()) {

    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">if</span>(obj != <span class="hljs-literal">null</span> &amp;&amp; obj.hasOwnProperty(part)) {
      obj = obj[part];
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};

pie.object.isObject = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(thing)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(thing) === <span class="hljs-string">'[object Object]'</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>serialize object into query string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.serialize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, removeEmpty)</span> </span>{
  <span class="hljs-keyword">if</span>(!obj) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  <span class="hljs-keyword">if</span>(removeEmpty) obj = pie.object.compact(obj, <span class="hljs-literal">true</span>);

  <span class="hljs-keyword">var</span> arr = [], keys = <span class="hljs-built_in">Object</span>.keys(obj), v;

  keys = keys.sort();

  keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
    v = obj[k];

    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(v)) {
      k = k + <span class="hljs-string">'[]'</span>;
      v.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(av)</span></span>{
        arr.push(<span class="hljs-built_in">encodeURIComponent</span>(k) + <span class="hljs-string">'='</span> + <span class="hljs-built_in">encodeURIComponent</span>(av));
      });
    } <span class="hljs-keyword">else</span> {
      arr.push(<span class="hljs-built_in">encodeURIComponent</span>(k) + <span class="hljs-string">'='</span> + <span class="hljs-built_in">encodeURIComponent</span>(v));
    }
  });

  <span class="hljs-keyword">return</span> arr.join(<span class="hljs-string">'&amp;'</span>);
};


pie.object.setPath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o, path, value)</span> </span>{
  <span class="hljs-keyword">return</span> sudo.setPath(path, value, o);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>grab a sub-object from the provided object.
pie.object.slice({foo: ‘bar’, biz: ‘baz’}, ‘biz’) =&gt; {‘biz’: ‘baz’}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.slice = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> b = {}, i = <span class="hljs-number">1</span>, arg = <span class="hljs-built_in">arguments</span>, a = arg[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(arg[<span class="hljs-number">1</span>])) {
    arg = arg[<span class="hljs-number">1</span>];
    i = <span class="hljs-number">0</span>;
  }
  <span class="hljs-keyword">for</span>(;i &lt; arg.length; i++)
    <span class="hljs-keyword">if</span>(a.hasOwnProperty(arg[i])) b[arg[i]] = a[arg[i]];
  <span class="hljs-keyword">return</span> b;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>return all the values of the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.values = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(a).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{ <span class="hljs-keyword">return</span> a[k]; });
};
pie.string.capitalize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.charAt(<span class="hljs-number">0</span>).toUpperCase() + str.slice(<span class="hljs-number">1</span>).toLowerCase();
};


pie.string.change = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.args(<span class="hljs-built_in">arguments</span>),
  str = args[<span class="hljs-number">0</span>];
  args = args.slice(<span class="hljs-number">1</span>);
  args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
    str = pie.string[m](str);
  });

  <span class="hljs-keyword">return</span> str;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>deserialize query string into object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.deserialize = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseQueryValue</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'null'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'true'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'false'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> f = <span class="hljs-built_in">parseFloat</span>(value);
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(f)) <span class="hljs-keyword">return</span> value;
    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/\./</span>.test(value)) <span class="hljs-keyword">return</span> f;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(f, <span class="hljs-number">10</span>);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, parse)</span> </span>{
    <span class="hljs-keyword">var</span> params = {}, arrRegex = <span class="hljs-regexp">/^(.+)\[\]$/</span>, idx, pieces, segments, arr, key, value;

    <span class="hljs-keyword">if</span>(!str) <span class="hljs-keyword">return</span> params;

    idx = str.indexOf(<span class="hljs-string">'?'</span>);
    <span class="hljs-keyword">if</span>(~idx) str = str.slice(idx+<span class="hljs-number">1</span>);

    pieces = str.split(<span class="hljs-string">'&amp;'</span>);
    pieces.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(piece)</span></span>{
      segments = piece.split(<span class="hljs-string">'='</span>);
      key = <span class="hljs-built_in">decodeURIComponent</span>(segments[<span class="hljs-number">0</span>] || <span class="hljs-string">''</span>);
      value = <span class="hljs-built_in">decodeURIComponent</span>(segments[<span class="hljs-number">1</span>] || <span class="hljs-string">''</span>);

      <span class="hljs-keyword">if</span>(parse) value = parseQueryValue(value);
      arr = key.match(arrRegex);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(!!arr) {
        key = arr[<span class="hljs-number">1</span>];
        params[key] = params[key] || [];
        params[key].push(value);
      } <span class="hljs-keyword">else</span> {
        params[key] = value;
      }
    });

    <span class="hljs-keyword">return</span> params;
  };
})();</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Escapes a string for HTML interpolation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.escape = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/&amp;/g</span>, <span class="hljs-string">'&amp;amp;'</span>).replace(<span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">'&amp;lt;'</span>).replace(<span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">'&amp;gt;'</span>).replace(<span class="hljs-regexp">/"/g</span>, <span class="hljs-string">'&amp;quot;'</span>).replace(<span class="hljs-regexp">/'/g</span>, <span class="hljs-string">'&amp;#x27;'</span>).replace(<span class="hljs-regexp">/\//g</span>,<span class="hljs-string">'&amp;#x2F;'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>designed to be used with the “%{expression}” placeholders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.expand = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, data)</span> </span>{
  data = data || {};
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/\%\{(.+?)\}/g</span>,
    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, key)</span> </span>{<span class="hljs-keyword">return</span> data[key];});
};


pie.string.humanize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/_id$/</span>, <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/([a-z][A-Z]|[a-z]_[a-z])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a)</span></span>{ <span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>] + <span class="hljs-string">' '</span> + a[a.length-<span class="hljs-number">1</span>]; });
};


pie.string.lowerize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.charAt(<span class="hljs-number">0</span>).toLowerCase() + str.slice(<span class="hljs-number">1</span>);
};


pie.string.modularize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/([^_])_([^_])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a, b)</span></span>{ <span class="hljs-keyword">return</span> a + b.toUpperCase(); });
};


pie.string.pluralize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/ss$/i</span>.test(str)) <span class="hljs-keyword">return</span> str + <span class="hljs-string">'es'</span>;
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/s$/i</span>.test(str)) <span class="hljs-keyword">return</span> str;
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/[a-z]$/i</span>.test(str)) <span class="hljs-keyword">return</span> str + <span class="hljs-string">'s'</span>;
  <span class="hljs-keyword">return</span> str;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>string templating</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.template = sudo.template;


pie.string.titleize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/(^| )([a-z])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a, b)</span></span>{ <span class="hljs-keyword">return</span> a + b.toUpperCase(); });
};


pie.string.underscore = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/([a-z])([A-Z])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a, b)</span></span>{ <span class="hljs-keyword">return</span> a + <span class="hljs-string">'_'</span> + b.toLowerCase(); }).toLowerCase();
};


pie.string.urlConcat = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.compact(pie.array.args(<span class="hljs-built_in">arguments</span>), <span class="hljs-literal">true</span>),
  base = args.shift(),
  query = args.join(<span class="hljs-string">'&amp;'</span>);

  <span class="hljs-keyword">if</span>(!query.length) <span class="hljs-keyword">return</span> base;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>we always throw a question mark on the end of base</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(base.indexOf(<span class="hljs-string">'?'</span>) &lt; <span class="hljs-number">0</span>) base += <span class="hljs-string">'?'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>we replace all question marks in the query with &amp;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(query.indexOf(<span class="hljs-string">'?'</span>) === <span class="hljs-number">0</span>) query = query.replace(<span class="hljs-string">'?'</span>, <span class="hljs-string">'&amp;'</span>);

  base += query;
  base = base.replace(<span class="hljs-string">'?&amp;'</span>, <span class="hljs-string">'?'</span>).replace(<span class="hljs-string">'&amp;&amp;'</span>, <span class="hljs-string">'&amp;'</span>).replace(<span class="hljs-string">'??'</span>, <span class="hljs-string">'?'</span>);
  <span class="hljs-keyword">if</span>(base.indexOf(<span class="hljs-string">'?'</span>) === base.length - <span class="hljs-number">1</span>) base = base.substr(<span class="hljs-number">0</span>, base.length - <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> base;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>A mixin to provide two way data binding between a model and form inputs.
This mixin should be used with a pie view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.mixins.bindings = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(input, value)</span> </span>{
    <span class="hljs-keyword">var</span> t = input.getAttribute(<span class="hljs-string">'type'</span>);

    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">if</span>(t === <span class="hljs-string">'checkbox'</span> || t === <span class="hljs-string">'radio'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>in the checkbox case, we could have an array of values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(value)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>this input is checked if that array contains it’s value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> input.checked = !!(~value.indexOf(input.value));</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>if the field has no value, then we just determine it’s checked state based on the truthyness of the model value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!input.hasAttribute(<span class="hljs-string">'value'</span>)) {
        <span class="hljs-keyword">return</span> input.checked = !!value;</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>otherwise, we check the input against the value and base that as our checked state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> input.checked = (input.value == value);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>normal inputs just receive the value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> input.value = value;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setValue</span><span class="hljs-params">(view, sel, value)</span> </span>{
    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, list = view.qsa(sel);
    <span class="hljs-keyword">for</span>(;i &lt; list.length; i++){
      setFieldValue(list[i], value);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdatedValue</span><span class="hljs-params">(input, currentVal)</span> </span>{
    <span class="hljs-keyword">var</span> v = input.value, t = input.getAttribute(<span class="hljs-string">'type'</span>), i;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>if it’s a checkbox</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(t === <span class="hljs-string">'checkbox'</span> || t === <span class="hljs-string">'radio'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>and we’re dealing with an array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(currentVal)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>the current index of the value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        i = currentVal.indexOf(v);</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>if we want the value to be included but it’s not, push it on</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(input.checked &amp;&amp; !~i) {
          currentVal.push(input.value);
          <span class="hljs-keyword">return</span> currentVal;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>if the value should not be included but is, splice it out.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!input.checked &amp;&amp; ~i) {
          currentVal.splice(i,<span class="hljs-number">1</span>);
          <span class="hljs-keyword">return</span> currentVal;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> currentVal;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>not an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>if the input has a value attribute use that, otherwise return a bool.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(input.hasAttribute(<span class="hljs-string">'value'</span>)) {
          <span class="hljs-keyword">return</span> input.checked ? input.value : <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> input.checked;
        }
      }
    }

    <span class="hljs-keyword">return</span> input.value;
  }


  <span class="hljs-keyword">return</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Ex: this.bind({attr: ‘name’, model: this.user});
If this.model is defined, you don’t have to pass the model.
Ex: this.model = user; this.bind({attr: ‘name’});
Here are all the options:
this.bind({
  model: this.user,
  attr: ‘name’,
  sel: ‘input[name=”user_name”]’,
  trigger: ‘keyup’,
  debounce: true
});</p>
<p>Bind currently only supports form fields. Todo: support applying to attributes, innerHTML, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    bind: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
      options = options || {};

      <span class="hljs-keyword">var</span> model = options.model || <span class="hljs-keyword">this</span>.model,
      attr = options.attr || options.attribute || <span class="hljs-literal">undefined</span>,
      sel = options.sel || <span class="hljs-string">'input[name="'</span> + attr + <span class="hljs-string">'"]'</span>,
      triggers = (options.trigger || <span class="hljs-string">'keyup change'</span>).split(<span class="hljs-string">' '</span>),
      debounce = options.debounce,
      ignore = <span class="hljs-literal">false</span>,
      toModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">var</span> value = getUpdatedValue(e.delegateTarget, model.get(attr));
        ignore = <span class="hljs-literal">true</span>;
        model.set(attr, value);
        ignore = <span class="hljs-literal">false</span>;
      },
      toElement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span> </span>{
        <span class="hljs-keyword">if</span>(ignore) <span class="hljs-keyword">return</span>;
        setValue(<span class="hljs-keyword">this</span>, sel, changes[changes.length-<span class="hljs-number">1</span>].value);
      }.bind(<span class="hljs-keyword">this</span>);

      <span class="hljs-keyword">if</span>(debounce) {
        <span class="hljs-keyword">if</span>(debounce === <span class="hljs-literal">true</span>) debounce = <span class="hljs-number">150</span>;
        toModel = <span class="hljs-built_in">Function</span>.debounce(toModel, debounce);
      }

      triggers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(trigger)</span></span>{
        <span class="hljs-keyword">this</span>.on(trigger, sel, toModel);
      }.bind(<span class="hljs-keyword">this</span>));

      <span class="hljs-keyword">this</span>.onChange(model, toElement, attr);

      <span class="hljs-keyword">this</span>._bindings = pie.array.from(<span class="hljs-keyword">this</span>._bindings);
      <span class="hljs-keyword">this</span>._bindings.push({model: model, sel: sel, attr: attr});
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>A way to initialize form fields with the values of a model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initBoundFields: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      pie.array.from(<span class="hljs-keyword">this</span>._bindings).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(binding)</span></span>{
        setValue(<span class="hljs-keyword">this</span>, binding.sel, binding.model.get(binding.attr));
      }.bind(<span class="hljs-keyword">this</span>));
    }

  };
})();
pie.mixins.inheritance = {

  _super: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.args(<span class="hljs-built_in">arguments</span>),
    name = args.shift(),
    obj = <span class="hljs-keyword">this</span>,
    curr;

    <span class="hljs-keyword">if</span>(args.length === <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-built_in">String</span>(args[<span class="hljs-number">0</span>]) === <span class="hljs-string">"[object Arguments]"</span>) args = pie.array.args(args[<span class="hljs-number">0</span>]);

    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
      curr = <span class="hljs-built_in">Object</span>.getPrototypeOf(obj);
      <span class="hljs-keyword">if</span>(!curr) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"No super method defined: "</span> + name);
      <span class="hljs-keyword">if</span>(curr === obj) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span>(curr[name] &amp;&amp; curr[name] !== <span class="hljs-keyword">this</span>[name]) {
        <span class="hljs-keyword">return</span> curr[name].apply(<span class="hljs-keyword">this</span>, args);
      } <span class="hljs-keyword">else</span> {
        obj = curr;
      }
    }
  }

};
pie.mixins.validatable = {</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>default to a model implementation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reportValidationError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, errors)</span> </span>{
    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'validationErrors.'</span> + key, errors);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>validates({name: ‘presence’});
validates({name: {presence: true}});
validates({name: [‘presence’, {format: /[a]/}]})</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validates: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> resultValidations = {}, configs, resultConfigs, test;

    <span class="hljs-keyword">this</span>.validations = <span class="hljs-keyword">this</span>.validations || {};

    <span class="hljs-built_in">Object</span>.keys(obj).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>always convert to an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      configs = pie.array.from(obj[k]);
      resultConfigs = [];

      configs.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(conf)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>if it’s a string or a function, throw it in directly, with no options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> conf === <span class="hljs-string">'string'</span>) {
          resultConfigs.push({type: conf, options: {}});</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>if it’s a function, make it a type function, then provide the function as an option</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> conf === <span class="hljs-string">'function'</span>){
          resultConfigs.push({type: <span class="hljs-string">'fn'</span>, options: {fn: conf}});</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>otherwise, we have an object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>iterate the keys, adding a validation for each</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-built_in">Object</span>.keys(conf).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(confKey)</span></span>{
            <span class="hljs-keyword">if</span> (pie.object.isObject(conf[confKey])) {
              resultConfigs.push({type: confKey, options: conf[confKey]});</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>in this case, we convert the value to an option
{presence: true} -&gt; {type: ‘presence’, {presence: true}}
{format: /.+/} -&gt; {type: ‘format’, {format: /.+/}}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> {
              resultConfigs.push({
                type: confKey,
                options: pie.object.extend({}, conf)
              });
            }
          });
        }

      });</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>append the validations to the existing ones</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.validations[k] = <span class="hljs-keyword">this</span>.validations[k] || [];
      <span class="hljs-keyword">this</span>.validations[k] = <span class="hljs-keyword">this</span>.validations[k].concat(resultConfigs);
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Invoke validateAll with a set of optional callbacks for the success case and the failure case.
this.validateAll(function(){ alert(‘Success!’); }, function(){ alert(‘Errors!’); });
validateAll will perform all registered validations, asynchronously. When all validations have completed, the callbacks
will be invoked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validateAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, success, failure)</span> </span>{
    <span class="hljs-keyword">var</span> ok = <span class="hljs-literal">true</span>,
    keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.validations),
    completeCount = keys.length,
    completed = <span class="hljs-number">0</span>,
    callback;

    <span class="hljs-keyword">if</span>(!keys.length) {
      <span class="hljs-keyword">if</span>(success) success(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>The callback which is invoked after each individual validation.
This keeps track of our progress, and when we are completed, invokes our provided callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      callback = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool)</span> </span>{
        ok = !!(ok &amp;&amp; bool);
        completed++;

        <span class="hljs-keyword">if</span>(completeCount === completed) {
          <span class="hljs-keyword">if</span>(ok &amp;&amp; success) success(<span class="hljs-literal">true</span>);
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!ok &amp;&amp; failure) failure(<span class="hljs-literal">false</span>);
        }
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>start all the validations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
        <span class="hljs-keyword">this</span>.validate(app, k, callback, callback);
      }.bind(<span class="hljs-keyword">this</span>));

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// return undefined to ensure we make our point about asynchronous validation.</span>
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>validate a specific key and optionally invoke a callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, k, success, failure)</span> </span>{
    <span class="hljs-keyword">var</span> validators = app.validator,
    validations = pie.array.from(<span class="hljs-keyword">this</span>.validations[k]),
    value = <span class="hljs-keyword">this</span>.get(k),
    valid = <span class="hljs-literal">true</span>,
    messages = [],
    completeCount = validations.length,
    completed = <span class="hljs-number">0</span>,
    validator,
    result,
    callback;

    <span class="hljs-keyword">if</span>(!validations.length) {
      <span class="hljs-keyword">if</span>(success) success(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>The callback invoked after each individual validation is run.
Keeps track of progress through our stack and updates the error keys.
Once completed, our provided callback is invoked with the result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      callback = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(validation, bool)</span> </span>{
        valid = !!(valid &amp;&amp; bool);
        completed++;

        <span class="hljs-keyword">if</span>(!bool) messages.push(validators.errorMessage(validation.type, validation.options));

        <span class="hljs-keyword">if</span>(completed === completeCount) {
          <span class="hljs-keyword">this</span>.reportValidationError(k, messages);
          <span class="hljs-keyword">if</span>(valid &amp;&amp; success) success(valid);
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!valid &amp;&amp; failure) failure(valid);
        }
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>grab the validator for each validation then invoke it.
if true or false is returned immediately, we invoke the callback otherwise we assume
the validation is running asynchronously and it will invoke the callback with the result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      validations.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(validation)</span></span>{
        validator = validators[validation.type];
        result = validator(value, validation.options, callback);
        <span class="hljs-keyword">if</span>(result === <span class="hljs-literal">true</span> || result === <span class="hljs-literal">false</span>) {
          callback(result);
        } <span class="hljs-comment">// if undefined, then the validation assumes responsibility for invoking the callback.</span>
      });

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    }
  }
};
pie.container = {

  addChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, child)</span> </span>{
    <span class="hljs-keyword">var</span> children = <span class="hljs-keyword">this</span>.children(),
    names = <span class="hljs-keyword">this</span>.childNames(),
    idx;

    children.push(child);
    idx = children.length - <span class="hljs-number">1</span>;

    names[name] = idx;
    child._indexWithinParent = idx;
    child._nameWithinParent = name;
    child.parent = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span>(<span class="hljs-string">'addedToParent'</span> <span class="hljs-keyword">in</span> child) child.addedToParent.call(child, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  addChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    pie.object.forEach(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, child)</span> </span>{
      <span class="hljs-keyword">this</span>.addChild(name, child);
    }.bind(<span class="hljs-keyword">this</span>));
  },

  childNames: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._childNames = <span class="hljs-keyword">this</span>._childNames || {};
  },

  children: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._children = <span class="hljs-keyword">this</span>._children || [];
  },

  getChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> name = obj._nameWithinParent || obj,
    idx = <span class="hljs-keyword">this</span>.childNames()[name];

    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">if</span>(idx == <span class="hljs-literal">null</span>) idx = obj;

    <span class="hljs-keyword">return</span> ~idx &amp;&amp; <span class="hljs-keyword">this</span>.children()[idx] || <span class="hljs-literal">undefined</span>;
  },

  send: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.args(<span class="hljs-built_in">arguments</span>),
    fname = args.shift(),
    obj = <span class="hljs-keyword">this</span>.parent;

    <span class="hljs-keyword">while</span>(obj &amp;&amp; !(fname <span class="hljs-keyword">in</span> obj)) {
      obj = obj.parent;
    }

    <span class="hljs-keyword">if</span>(obj) obj[fname].apply(obj, args);
  },

  removeChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> child = <span class="hljs-keyword">this</span>.getChild(obj),
    names = <span class="hljs-keyword">this</span>.childNames(),
    children = <span class="hljs-keyword">this</span>.children(),
    i;

    <span class="hljs-keyword">if</span>(child) {
      i = child._indexWithinParent;
      children.splice(i, <span class="hljs-number">1</span>);

      <span class="hljs-keyword">for</span>(;i &lt; children.length;i++) {
        children[i]._indexWithinParent = i;
        names[children[i]._nameWithinParent] = i;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>clean up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">delete</span> names[child._nameWithinParent];
      <span class="hljs-keyword">delete</span> child._indexWithinParent;
      <span class="hljs-keyword">delete</span> child._nameWithinParent;
      <span class="hljs-keyword">delete</span> child.parent;

      <span class="hljs-keyword">if</span>(<span class="hljs-string">'removedFromParent'</span> <span class="hljs-keyword">in</span> child) child.removedFromParent.call(child, <span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  removeChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> children = <span class="hljs-keyword">this</span>.children(),
    child;

    <span class="hljs-keyword">while</span>(child = children[children.length-<span class="hljs-number">1</span>]) {
      <span class="hljs-keyword">this</span>.removeChild(child);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>   <strong>Setters and Getters</strong>
   pie.model provides a basic interface for object management and observation.</p>
<p>   <em>example:</em></p>
<pre><code>   <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> pie.model();
   user.set(<span class="hljs-string">'first_name'</span>, <span class="hljs-string">'Doug'</span>);
   user.get(<span class="hljs-string">'first_name'</span>) <span class="hljs-comment">//=&gt; 'Doug'</span>
   user.sets({
     first_name: <span class="hljs-string">'Douglas'</span>,
     last_name: <span class="hljs-string">'Wilson'</span>
   });
   user.get(<span class="hljs-string">'last_name'</span>) <span class="hljs-comment">//= 'Wilson'</span>

   user.set(<span class="hljs-string">'location.city'</span>, <span class="hljs-string">'Miami'</span>)
   user.get(<span class="hljs-string">'location.city'</span>) <span class="hljs-comment">//=&gt; 'Miami'</span>
   user.get(<span class="hljs-string">'location'</span>) <span class="hljs-comment">//=&gt; {city: 'Miami'}</span>
</code></pre><p>   <strong> Observers </strong>
   Observers can be added by invoking the model’s observe() method.
   pie.model.observe() optionally accepts 2+ arguments which are used as filters for the observer.</p>
<p>   <em>example:</em></p>
<pre><code>   <span class="hljs-keyword">var</span> o = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span></span>{ <span class="hljs-built_in">console</span>.log(changes); };
   <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> pie.model();
   user.observe(o, <span class="hljs-string">'first_name'</span>);
   user.sets({first_name: <span class="hljs-string">'first'</span>, last_name: <span class="hljs-string">'last'</span>});
   <span class="hljs-comment">// =&gt; o is called and the following is logged:</span>
   [{
     name: <span class="hljs-string">'first_name'</span>,
     type: <span class="hljs-string">'new'</span>,
     oldValue:
     <span class="hljs-literal">undefined</span>,
     value: <span class="hljs-string">'first'</span>,
     object: {..}
   }]
</code></pre><p>   <strong>Computed Properties</strong></p>
<p>   pie.models can observe themselves and compute properties. The computed properties can be observed
   just like any other property.</p>
<p>   <em>example:</em></p>
<pre><code>   <span class="hljs-keyword">var</span> fullName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'first_name'</span>) + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'last_name'</span>); };
   <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> pie.model({first_name: <span class="hljs-string">'Doug'</span>, last_name: <span class="hljs-string">'Wilson'</span>});
   user.compute(<span class="hljs-string">'full_name'</span>, fullName, <span class="hljs-string">'first_name'</span>, <span class="hljs-string">'last_name'</span>);
   user.get(<span class="hljs-string">'full_name'</span>) <span class="hljs-comment">//=&gt; 'Doug Wilson'</span>
   user.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span></span>{ <span class="hljs-built_in">console</span>.log(changes); }, <span class="hljs-string">'full_name'</span>);
   user.set(<span class="hljs-string">'first_name'</span>, <span class="hljs-string">'Douglas'</span>);
   # =&gt; the observer is invoked and <span class="hljs-built_in">console</span>.log provides:
   [{
     name: <span class="hljs-string">'full_name'</span>,
     oldValue: <span class="hljs-string">'Doug Wilson'</span>,
     value: <span class="hljs-string">'Douglas Wilson'</span>,
     type: <span class="hljs-string">'update'</span>,
     object: {...}
   }]
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>

pie.model = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d, options)</span> </span>{
  <span class="hljs-keyword">this</span>.data = pie.object.extend({}, d);
  <span class="hljs-keyword">this</span>.options = options || {};
  <span class="hljs-keyword">this</span>.uid = pie.unique();
  <span class="hljs-keyword">this</span>.observations = {};
  <span class="hljs-keyword">this</span>.changeRecords = [];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Give ourselves _super functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.extend(pie.model.prototype, pie.mixins.inheritance);</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>After updates have been made we deliver our change records to our observers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.model.prototype.deliverChangeRecords = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> observers = {}, os, o, change, all;</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>grab each change record</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">while</span>(change = <span class="hljs-keyword">this</span>.changeRecords.shift()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>grab all the observers for the attribute specified by change.name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    os = pie.array.union(<span class="hljs-keyword">this</span>.observations[change.name], <span class="hljs-keyword">this</span>.observations.__all__);</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>then for each observer, build or concatenate to the array of changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span>(o = os.shift()) {
      observers[o.uid] = observers[o.uid] || {fn: o, changes: []};
      observers[o.uid].changes.push(change);
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Iterate each observer, calling it with the changes which it was subscribed for.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pie.object.forEach(observers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(uid, obj)</span> </span>{
    obj.fn.call(<span class="hljs-literal">null</span>, obj.changes);
  });

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Access the value stored at data[key]
Key can be multiple levels deep by providing a dot separated key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.model.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
  <span class="hljs-keyword">return</span> pie.object.getPath(<span class="hljs-keyword">this</span>.data, key);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Retrieve multiple values at once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.model.prototype.gets = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.args(<span class="hljs-built_in">arguments</span>), o = {};
  args = pie.array.flatten(args);
  args = pie.array.compact(args);

  args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arg)</span></span>{
    o[arg] = pie.object.getPath(<span class="hljs-keyword">this</span>.data, arg);
  }.bind(<span class="hljs-keyword">this</span>));

  <span class="hljs-keyword">return</span> pie.object.compact(o);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Register an observer and optionally filter by key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.model.prototype.observe = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* fn[, key1, key2, key3] */</span>)</span> </span>{
  <span class="hljs-keyword">var</span> keys = pie.array.args(<span class="hljs-built_in">arguments</span>),
  fn = keys.shift();

  fn.uid = fn.uid || <span class="hljs-built_in">String</span>(pie.unique());

  keys = pie.array.flatten(keys);

  <span class="hljs-keyword">if</span>(!keys.length) keys.push(<span class="hljs-string">'__all__'</span>);

  keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    <span class="hljs-keyword">this</span>.observations[k] = <span class="hljs-keyword">this</span>.observations[k] || [];
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.observations[k].indexOf(fn) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">this</span>.observations[k].push(fn);
  }.bind(<span class="hljs-keyword">this</span>));

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Set a value and trigger observers.
Optionally provide false as the third argument to skip observation.
Note: skipping observation does not stop changeRecords from accruing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.model.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, skipObservers)</span> </span>{
  <span class="hljs-keyword">var</span> change = { name: key, object: <span class="hljs-keyword">this</span>.data };

  <span class="hljs-keyword">if</span>(pie.object.hasPath(<span class="hljs-keyword">this</span>.data, key)) {
    change.type = <span class="hljs-string">'update'</span>;
    change.oldValue = pie.object.getPath(<span class="hljs-keyword">this</span>.data, key);
  } <span class="hljs-keyword">else</span> {
    change.type = <span class="hljs-string">'add'</span>;
  }

  change.value = value;
  pie.object.setPath(<span class="hljs-keyword">this</span>.data, key, value);

  <span class="hljs-keyword">this</span>.changeRecords.push(change);

  <span class="hljs-keyword">if</span>(skipObservers) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deliverChangeRecords();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Set a bunch of stuff at once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.model.prototype.sets = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, skipObservers)</span> </span>{
  pie.object.forEach(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
    <span class="hljs-keyword">this</span>.set(k, v, <span class="hljs-literal">true</span>);
  }.bind(<span class="hljs-keyword">this</span>));

  <span class="hljs-keyword">if</span>(skipObservers) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deliverChangeRecords();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Unregister an observer. Optionally for specific keys.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.model.prototype.unobserve = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* fn[, key1, key2, key3] */</span>)</span> </span>{
  <span class="hljs-keyword">var</span> keys = pie.array.args(<span class="hljs-built_in">arguments</span>),
  fn = keys.shift(),
  i;

  <span class="hljs-keyword">if</span>(!keys.length) keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.observations);

  keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
    i = <span class="hljs-keyword">this</span>.observations[k].indexOf(fn);
    <span class="hljs-keyword">if</span>(~i) <span class="hljs-keyword">this</span>.observations[k].splice(i,<span class="hljs-number">1</span>);
  }.bind(<span class="hljs-keyword">this</span>));

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Register a computed property which is accessible via <code>name</code> and defined by <code>fn</code>.
Provide all properties which invalidate the definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.model.prototype.compute = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* name, fn[, prop1, prop2 ] */</span>)</span> </span>{
  <span class="hljs-keyword">var</span> props = pie.array.args(<span class="hljs-built_in">arguments</span>),
  name = props.shift(),
  fn = props.shift();

  <span class="hljs-keyword">this</span>.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span></span>{
    <span class="hljs-keyword">this</span>.set(name, fn.call(<span class="hljs-keyword">this</span>));
  }.bind(<span class="hljs-keyword">this</span>), props);</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>initialize it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.set(name, fn.call(<span class="hljs-keyword">this</span>));
};




pie.list = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, options)</span> </span>{
  array = array || [];
  pie.model.call(<span class="hljs-keyword">this</span>, {items: array}, options);
};


pie.list.prototype = <span class="hljs-built_in">Object</span>.create(pie.model.prototype);


pie.list.prototype._normalizedIndex = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(wanted)</span> </span>{
  wanted = <span class="hljs-built_in">parseInt</span>(wanted, <span class="hljs-number">10</span>);
  <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isNaN</span>(wanted) &amp;&amp; wanted &lt; <span class="hljs-number">0</span>) wanted += <span class="hljs-keyword">this</span>.data.items.length;
  <span class="hljs-keyword">return</span> wanted;
};


pie.list.prototype._trackMutations = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(skipObservers, fn)</span> </span>{
  <span class="hljs-keyword">var</span> oldLength = <span class="hljs-keyword">this</span>.data.items.length,
  changes = [fn.call()],
  newLength = <span class="hljs-keyword">this</span>.data.items.length;

  <span class="hljs-keyword">if</span>(oldLength !== newLength) {
    changes.push({
      name: <span class="hljs-string">'length'</span>,
      type: <span class="hljs-string">'update'</span>,
      object: <span class="hljs-keyword">this</span>.data.items,
      oldValue: oldLength,
      value: newLength
    });
  }

  <span class="hljs-keyword">this</span>.changeRecords = <span class="hljs-keyword">this</span>.changeRecords.concat(changes);

  <span class="hljs-keyword">if</span>(skipObservers) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deliverChangeRecords();
};


pie.list.prototype.forEach = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>).forEach(f);
};


pie.list.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
  <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key), path;

  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(idx)) path = key;
  <span class="hljs-keyword">else</span> path = <span class="hljs-string">'items.'</span> + idx;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._super(<span class="hljs-string">'get'</span>, path);
};


pie.list.prototype.indexOf = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>).indexOf(value);
},


pie.list.prototype.insert = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, skipObservers)</span> </span>{
  <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(skipObservers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> change = {
      name: <span class="hljs-built_in">String</span>(idx),
      object: <span class="hljs-keyword">this</span>.data.items,
      type: <span class="hljs-string">'add'</span>,
      oldValue: <span class="hljs-keyword">this</span>.data.items[idx],
      value: value
    };

    <span class="hljs-keyword">this</span>.data.items.splice(idx, <span class="hljs-number">0</span>, value);

    <span class="hljs-keyword">return</span> change;
  }.bind(<span class="hljs-keyword">this</span>));
};


pie.list.prototype.length = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items.length'</span>);
};


pie.list.prototype.push = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, skipObservers)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(skipObservers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> change = {
      name: <span class="hljs-built_in">String</span>(<span class="hljs-keyword">this</span>.data.items.length),
      object: <span class="hljs-keyword">this</span>.data.items,
      type: <span class="hljs-string">'add'</span>,
      value: value,
      oldValue: <span class="hljs-literal">undefined</span>
    };

    <span class="hljs-keyword">this</span>.data.items.push(value);

    <span class="hljs-keyword">return</span> change;
  }.bind(<span class="hljs-keyword">this</span>));
};


pie.list.prototype.remove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, skipObservers)</span> </span>{
  <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(skipObservers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> change = {
      name: <span class="hljs-built_in">String</span>(idx),
      object: <span class="hljs-keyword">this</span>.data.items,
      type: <span class="hljs-string">'delete'</span>,
      oldValue: <span class="hljs-keyword">this</span>.data.items[idx],
      value: <span class="hljs-literal">undefined</span>
    };

    <span class="hljs-keyword">this</span>.data.items.splice(idx, <span class="hljs-number">1</span>);

    <span class="hljs-keyword">return</span> change;
  }.bind(<span class="hljs-keyword">this</span>));
};


pie.list.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, skipObservers)</span> </span>{
  <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key);

  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(idx)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._super(<span class="hljs-string">'set'</span>, key, value, skipObservers);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(skipObservers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> change = {
      name: <span class="hljs-built_in">String</span>(idx),
      object: <span class="hljs-keyword">this</span>.data.items,
      type: <span class="hljs-string">'update'</span>,
      oldValue: <span class="hljs-keyword">this</span>.data.items[idx]
    };

    <span class="hljs-keyword">this</span>.data.items[idx] = change.value = value;

    <span class="hljs-keyword">return</span> change;
  }.bind(<span class="hljs-keyword">this</span>));
};


pie.list.prototype.shift = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(skipObservers)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(skipObservers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> change = {
      name: <span class="hljs-string">'0'</span>,
      object: <span class="hljs-keyword">this</span>.data.items,
      type: <span class="hljs-string">'delete'</span>
    };

    change.oldValue = <span class="hljs-keyword">this</span>.data.items.shift();
    change.value = <span class="hljs-keyword">this</span>.data.items[<span class="hljs-number">0</span>];

    <span class="hljs-keyword">return</span> change;
  }.bind(<span class="hljs-keyword">this</span>));
};


pie.list.prototype.unshift = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, skipObservers)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.insert(<span class="hljs-number">0</span>, value, skipObservers);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>The, ahem, base view.
pie.view manages events delegation, provides some convenience methods, and some <form> standards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
  <span class="hljs-keyword">this</span>.app = app;
  <span class="hljs-keyword">this</span>.options = options || {};
  <span class="hljs-keyword">this</span>.el = <span class="hljs-keyword">this</span>.options.el || pie.dom.createElement(<span class="hljs-string">'&lt;div /&gt;'</span>);
  <span class="hljs-keyword">this</span>.uid = pie.unique();
  <span class="hljs-keyword">this</span>.changeCallbacks = [];
};

pie.object.extend(pie.view.prototype, pie.mixins.inheritance);
pie.object.extend(pie.view.prototype, pie.container);
pie.object.extend(pie.view.prototype, pie.mixins.bindings);</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>placeholder for default functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype.addedToParent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>all events observed using view.on() will use the unique namespace for this instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype.eventNamespace = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'view'</span>+ <span class="hljs-keyword">this</span>.uid;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>add or remove the default loading style.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype.loadingStyle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool)</span> </span>{
  <span class="hljs-keyword">if</span>(bool === <span class="hljs-literal">undefined</span>) bool = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">this</span>._loadingStyle(bool);
};


pie.view.prototype.navigationUpdated = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.children().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-string">'navigationUpdated'</span> <span class="hljs-keyword">in</span> c) c.navigationUpdated();
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Events should be observed via this .on() method. Using .on() ensures the events will be
unobserved when the view is removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype.on = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, sel, f)</span> </span>{
  <span class="hljs-keyword">var</span> ns = <span class="hljs-keyword">this</span>.eventNamespace(),
      f2 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
        <span class="hljs-keyword">if</span>(e.namespace === ns) {
          <span class="hljs-keyword">return</span> f.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
        }
      };

  e.split(<span class="hljs-string">' '</span>).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ev)</span> </span>{
    ev += <span class="hljs-string">"."</span> + ns;
    $(<span class="hljs-keyword">this</span>.el).on(ev, f2, sel);
  }.bind(<span class="hljs-keyword">this</span>));

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Observe changes to an observable, unobserving them when the view is removed.
If the object is not observable, the observable extensions will automatically
be extended in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype.onChange = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> observable = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>], args = pie.array.args(<span class="hljs-built_in">arguments</span>).slice(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span>(!(<span class="hljs-string">'observe'</span> <span class="hljs-keyword">in</span> observable)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Observable does not respond to observe"</span>);

  <span class="hljs-keyword">this</span>.changeCallbacks.push([observable, args]);
  observable.observe.apply(observable, args);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>If the first option passed is a node, it will use that as the query scope.
Return an object representing the values of fields within this.el.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype.parseFields = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> o = {}, e = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>], i = <span class="hljs-number">0</span>, n, el;

  <span class="hljs-keyword">if</span>(<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> e) {
    e = <span class="hljs-keyword">this</span>.el;
  } <span class="hljs-keyword">else</span> {
    i++;
  }

  <span class="hljs-keyword">for</span>(;i&lt;<span class="hljs-built_in">arguments</span>.length;i++) {
    n = <span class="hljs-built_in">arguments</span>[i];
    el = e.querySelector(<span class="hljs-string">'[name="'</span> + n + <span class="hljs-string">'"]:not([disabled])'</span>);
    <span class="hljs-keyword">if</span>(el) pie.object.setPath(o, n, el.value);
  }
  <span class="hljs-keyword">return</span> o;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>shortcut for this.el.querySelector</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype.qs = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(selector)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.el.querySelector(selector);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>shortcut for this.el.querySelectorAll</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype.qsa = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(selector)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.el.querySelectorAll(selector);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>clean up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype.removedFromParent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>._unobserveEvents();
  <span class="hljs-keyword">this</span>._unobserveChangeCallbacks();</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>views remove their children upon removal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.removeChildren();

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>convenience method which is useful for ajax callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype.removeLoadingStyle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">this</span>._loadingStyle(<span class="hljs-literal">false</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>release all observed events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype._unobserveEvents = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  $(<span class="hljs-keyword">this</span>.el).off(<span class="hljs-string">'*.'</span> + <span class="hljs-keyword">this</span>.eventNamespace());
  $(<span class="hljs-built_in">document</span>.body).off(<span class="hljs-string">'*.'</span> + <span class="hljs-keyword">this</span>.eventNamespace());
};</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>release all change callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype._unobserveChangeCallbacks = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> a;
  <span class="hljs-keyword">while</span>(<span class="hljs-keyword">this</span>.changeCallbacks.length) {
    a = <span class="hljs-keyword">this</span>.changeCallbacks.pop();
    a[<span class="hljs-number">0</span>].unobserve.apply(a[<span class="hljs-number">0</span>], a[<span class="hljs-number">1</span>]);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>this.el receives a loading class, specific buttons are disabled and provided with the btn-loading class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view.prototype._loadingStyle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool)</span> </span>{
  <span class="hljs-keyword">this</span>.el.classList[bool ? <span class="hljs-string">'add'</span> : <span class="hljs-string">'remove'</span>](<span class="hljs-string">'loading'</span>);
  $(<span class="hljs-keyword">this</span>.qsa(<span class="hljs-string">'.submit-container button.btn-primary, .btn-loading, .btn-loadable'</span>)).
    all(bool ? <span class="hljs-string">'classList.add'</span> : <span class="hljs-string">'classList.remove'</span>, <span class="hljs-string">'btn-loading'</span>).
    all(bool ? <span class="hljs-string">'setAttribute'</span> : <span class="hljs-string">'removeAttribute'</span>, <span class="hljs-string">'disabled'</span>, <span class="hljs-string">'disabled'</span>);
};
pie.simpleView = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">simpleView</span><span class="hljs-params">(app, options)</span> </span>{
  pie.view.call(<span class="hljs-keyword">this</span>, app, options);
};

pie.simpleView.prototype = <span class="hljs-built_in">Object</span>.create(pie.view.prototype);
pie.simpleView.prototype.constructor = pie.simpleView;

pie.simpleView.prototype.addedToParent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parent)</span> </span>{
  pie.view.prototype.addedToParent.call(<span class="hljs-keyword">this</span>, parent);

  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.autoRender &amp;&amp; <span class="hljs-keyword">this</span>.model) {
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.options.autoRender === <span class="hljs-string">'string'</span> ? <span class="hljs-keyword">this</span>.options.autoRender : <span class="hljs-string">'updated_at'</span>;
    <span class="hljs-keyword">this</span>.onChange(<span class="hljs-keyword">this</span>.model, <span class="hljs-keyword">this</span>.render.bind(<span class="hljs-keyword">this</span>), field);
  }

  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.renderOnAddedToParent) {
    <span class="hljs-keyword">this</span>.render();
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

pie.simpleView.prototype.removedFromParent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parent)</span> </span>{
  pie.view.prototype.removedFromParent.call(<span class="hljs-keyword">this</span>, parent);</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>remove our el if we still have a parent node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.el.parentNode) <span class="hljs-keyword">this</span>.el.parentNode.removeChild(<span class="hljs-keyword">this</span>.el);
}

pie.simpleView.prototype.renderData = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.model) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.model.data;
  }

  <span class="hljs-keyword">return</span> {};
};

pie.simpleView.prototype.render = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.template) {
    <span class="hljs-keyword">var</span> content = <span class="hljs-keyword">this</span>.app.template(<span class="hljs-keyword">this</span>.options.template, <span class="hljs-keyword">this</span>.renderData());
    <span class="hljs-keyword">this</span>.el.innerHTML = content;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};
pie.validator = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span> </span>{
  <span class="hljs-keyword">this</span>.app = app;
  <span class="hljs-keyword">this</span>.i18n = app.i18n;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>small utility class to handle range options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.validator.rangeOptions = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rangeOptions</span><span class="hljs-params">(app, hash)</span> </span>{
  <span class="hljs-keyword">this</span>.i18n = app.i18n;
  <span class="hljs-keyword">this</span>.rangedata = hash || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>for double casting new RangeOptions(new RangeOptions({}));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.rangedata.rangedata) <span class="hljs-keyword">this</span>.rangedata = <span class="hljs-keyword">this</span>.rangedata.rangedata ;
};

pie.validator.rangeOptions.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
  <span class="hljs-keyword">return</span> pie.func.valueFrom(<span class="hljs-keyword">this</span>.rangedata[key]);
};

pie.validator.rangeOptions.prototype.has = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
  <span class="hljs-keyword">return</span> !!(key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.rangedata);
};

pie.validator.rangeOptions.prototype.t = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.i18n.t(<span class="hljs-string">'app.validations.range_messages.'</span> + key, options);
};

pie.validator.rangeOptions.prototype.matches = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">var</span> valid = <span class="hljs-literal">true</span>;
  valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gt'</span>) || value &gt; <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gt'</span>));
  valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lt'</span>) || value &lt; <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lt'</span>));
  valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gte'</span>) || value &gt;= <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gte'</span>));
  valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lte'</span>) || value &lt;= <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lte'</span>));
  valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'eq'</span>) || value === <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eq'</span>));
  <span class="hljs-keyword">return</span> valid;
};

pie.validator.rangeOptions.prototype.message = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'eq'</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'eq'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eq'</span>)});
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">var</span> s = [<span class="hljs-string">""</span>, <span class="hljs-string">""</span>];

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gt'</span>)) s[<span class="hljs-number">0</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'gt'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gt'</span>)});
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gte'</span>)) s[<span class="hljs-number">0</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'gte'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gte'</span>)});

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lt'</span>)) s[<span class="hljs-number">1</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'lt'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lt'</span>)});
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lte'</span>)) s[<span class="hljs-number">1</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'lte'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lte'</span>)});

    <span class="hljs-keyword">return</span> pie.array.toSentence(pie.array.compact(s, <span class="hljs-literal">true</span>), <span class="hljs-keyword">this</span>.i18n).trim();
  }
};




pie.validator.prototype.errorMessage = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(validationType, validationOptions)</span> </span>{
  <span class="hljs-keyword">if</span>(validationOptions.message) <span class="hljs-keyword">return</span> validationOptions.message;

  <span class="hljs-keyword">var</span> base = <span class="hljs-keyword">this</span>.i18n.t(<span class="hljs-string">'app.validations.'</span> + validationType),
  rangeOptions = <span class="hljs-keyword">new</span> pie.validator.rangeOptions(validationOptions),
  range = rangeOptions.message();

  <span class="hljs-keyword">if</span>(!range &amp;&amp; validationType === <span class="hljs-string">'length'</span>) {
    rangeOptions = <span class="hljs-keyword">new</span> pie.validator.rangeOptions({gt: <span class="hljs-number">0</span>});
    range = rangeOptions.message();
  }

  <span class="hljs-keyword">return</span> (base + <span class="hljs-string">' '</span> + range).trim();
};


pie.validator.prototype.withStandardChecks = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options, f)</span></span>{
  <span class="hljs-keyword">if</span>(options.allowBlank &amp;&amp; !<span class="hljs-keyword">this</span>.presence(value))
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(options.unless &amp;&amp; options.unless.call())
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(options[<span class="hljs-string">'if'</span>] &amp;&amp; !options[<span class="hljs-string">'if'</span>].call())
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> f.call();
};


pie.validator.prototype.cc = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>don’t get rid of letters because we don’t want a mix of letters and numbers passing through</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> sanitized = <span class="hljs-built_in">String</span>(value).replace(<span class="hljs-regexp">/[^a-zA-Z0-9]/g</span>, <span class="hljs-string">''</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.number(sanitized) &amp;&amp;
           <span class="hljs-keyword">this</span>.length(sanitized, {gte: <span class="hljs-number">15</span>, lte: <span class="hljs-number">16</span>});
  }.bind(<span class="hljs-keyword">this</span>));
};


pie.validator.prototype.chosen = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.presence(value, options);
};


pie.validator.prototype.cvv = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.number(value) &amp;&amp;
            <span class="hljs-keyword">this</span>.length(value, {gte: <span class="hljs-number">3</span>, lte: <span class="hljs-number">4</span>});
  }.bind(<span class="hljs-keyword">this</span>));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>a date should be in the ISO format yyyy-mm-dd</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.validator.prototype.date = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
  options = options || {};
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> split = value.split(<span class="hljs-string">'-'</span>), y = split[<span class="hljs-number">0</span>], m = split[<span class="hljs-number">1</span>], d = split[<span class="hljs-number">2</span>], iso;

    <span class="hljs-keyword">if</span>(!y || !m || !d) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.length(y, {eq: <span class="hljs-number">4</span>}) &amp;&amp; <span class="hljs-keyword">this</span>.length(m, {eq: <span class="hljs-number">2</span>}) &amp;&amp; <span class="hljs-keyword">this</span>.length(d, {eq: <span class="hljs-number">2</span>})) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span>(!options.sanitized) {
      <span class="hljs-built_in">Object</span>.keys(options).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
        iso = options[k];
        iso = iso.getFullYear() + <span class="hljs-string">'-'</span> + (iso.getMonth() &lt; <span class="hljs-number">9</span> ? <span class="hljs-string">'0'</span> : <span class="hljs-string">''</span>) + (iso.getMonth() + <span class="hljs-number">1</span>) + <span class="hljs-string">'-'</span> + (iso.getDate() &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">'0'</span> : <span class="hljs-string">''</span>) + iso.getDate();
        options[k] = iso;
      });
      options.sanitized = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">var</span> ro = <span class="hljs-keyword">new</span> pie.validator.rangeOptions(options);
    <span class="hljs-keyword">return</span> ro.matches(value);

  }.bind(<span class="hljs-keyword">this</span>));
};


pie.validator.prototype.email = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">email</span><span class="hljs-params">(value, options)</span> </span>{
  options = pie.object.extend({allowBlank: <span class="hljs-literal">false</span>}, options || {});
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^.+@.+\..+$/</span>).test(value);
  });
};


pie.validator.prototype.fn = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options, cb)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">return</span> options.fn.call(<span class="hljs-literal">null</span>, value, options, cb);
  });
};


pie.validator.prototype.format = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
  options = options || {};
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> fmt = options.format || options[<span class="hljs-string">'with'</span>];

    <span class="hljs-keyword">if</span>(fmt === <span class="hljs-string">'isoDate'</span>){
      fmt = <span class="hljs-regexp">/^\d{4}\-\d{2}\-\d{2}$/</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(fmt === <span class="hljs-string">'epochs'</span>){
      fmt = <span class="hljs-regexp">/^\d{10}$/</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(fmt === <span class="hljs-string">'epochms'</span>){
      fmt = <span class="hljs-regexp">/^\d{13}$/</span>;
    }

    <span class="hljs-keyword">return</span> !!fmt.test(<span class="hljs-built_in">String</span>(value));
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>must be an integer (2.0 is ok) (good for quantities)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.validator.prototype.integer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
  <span class="hljs-keyword">return</span>  <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">return</span>  <span class="hljs-keyword">this</span>.number(value, options) &amp;&amp;
            <span class="hljs-built_in">parseInt</span>(value, <span class="hljs-number">10</span>) === <span class="hljs-built_in">parseFloat</span>(value, <span class="hljs-number">10</span>);
  }.bind(<span class="hljs-keyword">this</span>));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>min/max length of the field</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.validator.prototype.length = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">length</span><span class="hljs-params">(value, options)</span></span>{
  options = pie.object.extend({allowBlank: <span class="hljs-literal">false</span>}, options || {});

  <span class="hljs-keyword">if</span>(!(<span class="hljs-string">'gt'</span>  <span class="hljs-keyword">in</span> options)  &amp;&amp;
     !(<span class="hljs-string">'gte'</span> <span class="hljs-keyword">in</span> options)  &amp;&amp;
     !(<span class="hljs-string">'lt'</span>  <span class="hljs-keyword">in</span> options)  &amp;&amp;
     !(<span class="hljs-string">'lte'</span> <span class="hljs-keyword">in</span> options)  &amp;&amp;
     !(<span class="hljs-string">'eq'</span>  <span class="hljs-keyword">in</span> options) ){
    options.gt = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> length = <span class="hljs-built_in">String</span>(value).trim().length;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.number(length, options);
  }.bind(<span class="hljs-keyword">this</span>));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>must be some kind of number (good for money input)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.validator.prototype.number = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">number</span><span class="hljs-params">(value, options)</span></span>{
  options = options || {};

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>not using parseFloat because it accepts multiple decimals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!<span class="hljs-regexp">/^([\-])?([\d]+)?\.?[\d]+$/</span>.test(<span class="hljs-built_in">String</span>(value))) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">var</span> valid = <span class="hljs-literal">true</span>,
    number = <span class="hljs-built_in">parseFloat</span>(value),
    ro = <span class="hljs-keyword">new</span> pie.validator.rangeOptions(options);

    <span class="hljs-keyword">return</span> ro.matches(number);
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>clean out all things that are not numbers and + and get a minimum of 10 digits.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.validator.prototype.phone = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">phone</span><span class="hljs-params">(value, options)</span> </span>{
  options = pie.object.extend({allowBlank: <span class="hljs-literal">false</span>}, options || {});

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> clean = <span class="hljs-built_in">String</span>(value).replace(<span class="hljs-regexp">/[^\+\d]+/g</span>, <span class="hljs-string">''</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.length(clean, {gte: <span class="hljs-number">10</span>});
  }.bind(<span class="hljs-keyword">this</span>));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>does the value have any non-whitespace characters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.validator.prototype.presence = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">presence</span><span class="hljs-params">(value, options)</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, pie.object.extend({}, options, {allowBlank: <span class="hljs-literal">false</span>}), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">return</span> !!(value &amp;&amp; (<span class="hljs-regexp">/[^ ]/</span>).test(<span class="hljs-built_in">String</span>(value)));
  });
};


pie.validator.prototype.url = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^.+\..+$/</span>).test(value);
  });
};
pie.services.ajax = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ajax</span><span class="hljs-params">(app)</span> </span>{
  <span class="hljs-keyword">this</span>.app = app;
  <span class="hljs-keyword">this</span>.defaultAjaxOptions = {};
};</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>default ajax options. override this method to</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.ajax.prototype._defaultAjaxOptions = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> pie.object.extend({}, <span class="hljs-keyword">this</span>.defaultAjaxOptions, {
    dataType: <span class="hljs-string">'json'</span>,
    type: <span class="hljs-string">'GET'</span>,
    error: <span class="hljs-keyword">this</span>.app.errorHandler.handleXhrError
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>interface for conducting ajax requests.
app.ajax.post({
 url: ‘/login’,
 data: { email: ‘xxx’, password: ‘yyy’ },
 progress: this.progressCallback.bind(this),
 success: this.
})</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.ajax.prototype.ajax = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{

  options = pie.object.compact(options);
  options = pie.object.extend({}, <span class="hljs-keyword">this</span>._defaultAjaxOptions(), options);

  <span class="hljs-keyword">if</span>(options.extraError) {
    <span class="hljs-keyword">var</span> oldError = options.error;
    options.error = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span></span>{ oldError(xhr); options.extraError(xhr); };
  }

  <span class="hljs-keyword">var</span> app = <span class="hljs-keyword">this</span>.app, xhr = <span class="hljs-keyword">new</span> XMLHttpRequest(), url = options.url, d;

  <span class="hljs-keyword">if</span>(options.type === <span class="hljs-string">'GET'</span> &amp;&amp; options.data) {
    url = app.router.path(url, options.data);
  } <span class="hljs-keyword">else</span> {
    url = app.router.path(url);
  }

  <span class="hljs-keyword">if</span>(options.progress) {
    xhr.addEventListener(<span class="hljs-string">'progress'</span>, options.progress, <span class="hljs-literal">false</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(options.uploadProgress) {
    xhr.upload.addEventListener(<span class="hljs-string">'progress'</span>, options.uploadProgress, <span class="hljs-literal">false</span>);
  }

  xhr.open(options.type, url, <span class="hljs-literal">true</span>);

  xhr.setRequestHeader(<span class="hljs-string">'Accept'</span>, <span class="hljs-string">'application/json'</span>);
  xhr.setRequestHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/json'</span>);

  <span class="hljs-keyword">this</span>._applyCsrfToken(xhr);

  xhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(options.tracker) options.tracker(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">try</span>{
      <span class="hljs-keyword">this</span>.data = <span class="hljs-keyword">this</span>.responseText.trim().length ? <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-keyword">this</span>.responseText) : {};
    } <span class="hljs-keyword">catch</span>(err) {
      app.debug(<span class="hljs-string">"could not parse JSON response: "</span> + err);
      <span class="hljs-keyword">this</span>.data = {};
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.status &gt;= <span class="hljs-number">200</span> &amp;&amp; <span class="hljs-keyword">this</span>.status &lt; <span class="hljs-number">300</span> || <span class="hljs-keyword">this</span>.status === <span class="hljs-number">304</span>) {
      <span class="hljs-keyword">if</span>(options.dataSuccess) options.dataSuccess(<span class="hljs-keyword">this</span>.data);
      <span class="hljs-keyword">if</span>(options.success) options.success(<span class="hljs-keyword">this</span>.data, <span class="hljs-keyword">this</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(options.error){
      options.error(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">if</span>(options.complete) options.complete(<span class="hljs-keyword">this</span>);
  };

  <span class="hljs-keyword">if</span>(options.type !== <span class="hljs-string">'GET'</span>) {
    d = options.data ? (<span class="hljs-keyword">typeof</span> options.data === <span class="hljs-string">'string'</span> ? options.data : <span class="hljs-built_in">JSON</span>.stringify(pie.object.compact(options.data))) : <span class="hljs-literal">undefined</span>;
  }

  xhr.send(d);
  <span class="hljs-keyword">return</span> xhr;
};

pie.services.ajax.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
  options = pie.object.extend({type: <span class="hljs-string">'GET'</span>}, options);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options);
};

pie.services.ajax.prototype.post = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
  options = pie.object.extend({type: <span class="hljs-string">'POST'</span>}, options);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options);
};

pie.services.ajax.prototype.put = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
  options = pie.object.extend({type: <span class="hljs-string">'PUT'</span>}, options);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options);
};

pie.services.ajax.prototype.del = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
  options = pie.object.extend({type: <span class="hljs-string">'DELETE'</span>}, options);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options);
};

pie.services.ajax.prototype._applyCsrfToken = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
  <span class="hljs-keyword">var</span> tokenEl = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'meta[name="csrf-token"]'</span>),
  token = tokenEl ? tokenEl.getAttribute(<span class="hljs-string">'content'</span>) : <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span>(token) {
    xhr.setRequestHeader(<span class="hljs-string">'X-CSRF-Token'</span>, token);
  }
};
pie.services.errorHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">errorHandler</span><span class="hljs-params">(app)</span> </span>{
  <span class="hljs-keyword">this</span>.app = app;
  <span class="hljs-keyword">this</span>.responseCodeHandlers = {};
};</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>extract the “data” object out of an xhr</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.errorHandler.prototype.data = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
  <span class="hljs-keyword">return</span> xhr.data = xhr.data || (xhr.status ? <span class="hljs-built_in">JSON</span>.parse(xhr.response) : {});
};</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>extract an error message from a response. Try to extract the error message from
the xhr data diretly, or allow overriding by response code.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.errorHandler.prototype.errorMessagesFromRequest = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
  <span class="hljs-keyword">var</span> d = <span class="hljs-keyword">this</span>.data(xhr),
  errors  = pie.array.map(d.errors || [], <span class="hljs-string">'message'</span>),
  clean;

  errors = pie.array.compact(errors, <span class="hljs-literal">true</span>);
  clean   = <span class="hljs-keyword">this</span>.app.i18n.t(<span class="hljs-string">'app.errors.'</span> + xhr.status, {<span class="hljs-keyword">default</span>: errors});

  <span class="hljs-keyword">this</span>.app.debug(errors);

  <span class="hljs-keyword">return</span> pie.array.from(clean);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>find a handler for the xhr via response code or the app default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.errorHandler.prototype.handleXhrError = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{

  <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">this</span>.responseCodeHandlers[xhr.status.toString()];

  <span class="hljs-keyword">if</span>(handler) {
    handler.call(xhr, xhr);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.notifyErrors(xhr);
  }

};</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>build errors and send them to the notifier.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.errorHandler.prototype.notifyErrors = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span></span>{
  <span class="hljs-keyword">var</span> n = <span class="hljs-keyword">this</span>.app.notifier, errors = <span class="hljs-keyword">this</span>.errorMessagesFromRequest(xhr);

  <span class="hljs-keyword">if</span>(errors.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>clear all alerts when an error occurs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    n.clear();</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>delay so UI will visibly change when the same content is shown.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      n.clear(<span class="hljs-string">'error'</span>);
      n.notify(errors, <span class="hljs-string">'error'</span>, <span class="hljs-number">10000</span>);
    }, <span class="hljs-number">100</span>);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>register a response code handler
registerHandler(‘401’, myRedirectCallback);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.errorHandler.prototype.registerHandler = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(responseCode, handler)</span> </span>{
  <span class="hljs-keyword">this</span>.responseCodeHandlers[responseCode.toString()] = handler;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>provide an interface for sending errors to a bug reporting service.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.errorHandler.prototype.reportError = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, options)</span> </span>{
  options = options || {};

  <span class="hljs-keyword">if</span>(options.prefix &amp;&amp; <span class="hljs-string">'message'</span> <span class="hljs-keyword">in</span> err) {
    err.message = options.prefix + <span class="hljs-string">' '</span> + err.message;
  }

  <span class="hljs-keyword">if</span>(options.prefix &amp;&amp; <span class="hljs-string">'name'</span> <span class="hljs-keyword">in</span> err) {
    err.name = options.prefix + <span class="hljs-string">' '</span> + err.name;
  }

  <span class="hljs-keyword">this</span>._reportError(err, options);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>hook in your own error reporting service. bugsnag, airbrake, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.errorHandler.prototype._reportError = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
  <span class="hljs-keyword">this</span>.app.debug(err);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>made to be used as an instance so multiple translations could exist if we so choose.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.i18n = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">i18n</span><span class="hljs-params">(app)</span> </span>{
  <span class="hljs-keyword">this</span>.translations = {};
  <span class="hljs-keyword">this</span>.app = app;
};


pie.services.i18n.prototype._ampm = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(num)</span> </span>{
  <span class="hljs-keyword">return</span> num &gt;= <span class="hljs-number">12</span> ? <span class="hljs-string">'pm'</span> : <span class="hljs-string">'am'</span>;
};


pie.services.i18n.prototype._countAlias = {
  <span class="hljs-string">'0'</span> : <span class="hljs-string">'zero'</span>,
  <span class="hljs-string">'1'</span> : <span class="hljs-string">'one'</span>,
  <span class="hljs-string">'-1'</span> : <span class="hljs-string">'negone'</span>
};


pie.services.i18n.prototype._dayName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.day_names.'</span> + d);
};


pie.services.i18n.prototype._hour = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(h)</span> </span>{
  <span class="hljs-keyword">if</span>(h &gt; <span class="hljs-number">12</span>) h -= <span class="hljs-number">12</span>;
  <span class="hljs-keyword">if</span>(!h) h += <span class="hljs-number">12</span>;
  <span class="hljs-keyword">return</span> h;
};


pie.services.i18n.prototype._isoDate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t, convertToUtc)</span> </span>{
  <span class="hljs-keyword">if</span>(convertToUtc) t = <span class="hljs-keyword">this</span>._utc(t);
  <span class="hljs-keyword">return</span> t.getFullYear() + <span class="hljs-string">'-'</span> + <span class="hljs-keyword">this</span>._pad(t.getMonth() + <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>) + <span class="hljs-string">'-'</span> + <span class="hljs-keyword">this</span>._pad(t.getDate(), <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);
};


pie.services.i18n.prototype._isoTime = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span> </span>{
  t = <span class="hljs-keyword">this</span>._utc(t);
  <span class="hljs-keyword">return</span>  <span class="hljs-keyword">this</span>._pad(t.getHours(), <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>) + <span class="hljs-string">':'</span> +
          <span class="hljs-keyword">this</span>._pad(t.getMinutes(), <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>) + <span class="hljs-string">':'</span> +
          <span class="hljs-keyword">this</span>._pad(t.getSeconds(), <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>) + <span class="hljs-string">'.'</span> +
          <span class="hljs-keyword">this</span>._pad(t.getMilliseconds(), <span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>) +
          <span class="hljs-string">'Z'</span>;
};


pie.services.i18n.prototype._monthName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.month_names.'</span> + m);
};


pie.services.i18n.prototype._nestedTranslate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t, data)</span> </span>{
  <span class="hljs-keyword">return</span> t.replace(<span class="hljs-regexp">/\$\{([^\}]+)\}/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, path)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.translate(path, data);
  }.bind(<span class="hljs-keyword">this</span>));
},</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>assumes that dates either come in as dates, iso strings, or epoch timestamps</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.i18n.prototype._normalizedDate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">String</span>(d).match(<span class="hljs-regexp">/^\d+$/</span>)) {
    d = <span class="hljs-built_in">parseInt</span>(d, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">String</span>(d).length &lt; <span class="hljs-number">13</span>) d *= <span class="hljs-number">1000</span>;
    d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(d);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> d === <span class="hljs-string">'string'</span>) {
    d = pie.date.timeFromISO(d);
  } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>let the system parse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(d);
  }
  <span class="hljs-keyword">return</span> d;
},


pie.services.i18n.prototype._shortDayName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.short_day_names.'</span> + d) || <span class="hljs-keyword">this</span>._dayName(d).slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);
};


pie.services.i18n.prototype._shortMonthName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.short_month_names.'</span> + m) || <span class="hljs-keyword">this</span>._monthName(m).slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);
};


pie.services.i18n.prototype._pad = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(num, cnt, pad)</span> </span>{
  <span class="hljs-keyword">var</span> s = <span class="hljs-string">''</span>,
      p = cnt - num.toString().length;
  <span class="hljs-keyword">if</span>(pad === <span class="hljs-literal">undefined</span>) pad = <span class="hljs-string">' '</span>;
  <span class="hljs-keyword">while</span>(p&gt;<span class="hljs-number">0</span>){
    s += pad;
    p -= <span class="hljs-number">1</span>;
  }
  <span class="hljs-keyword">return</span> s + num.toString();
};


pie.services.i18n.prototype._timezoneAbbr = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date)</span> </span>{
  <span class="hljs-keyword">var</span> str = date &amp;&amp; date.toString();
  <span class="hljs-keyword">return</span> str &amp;&amp; str.split(<span class="hljs-regexp">/\((.*)\)/</span>)[<span class="hljs-number">1</span>];
},


pie.services.i18n.prototype._utc = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span> </span>{
  <span class="hljs-keyword">var</span> t2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(t.getTime());
  t2.setMinutes(t2.getMinutes() + t2.getTimezoneOffset());
  <span class="hljs-keyword">return</span> t2;
};


pie.services.i18n.prototype.load = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, shallow)</span> </span>{
  <span class="hljs-keyword">var</span> f = shallow ? pie.object.extend : pie.object.deepExtend;
  f.call(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>.translations, data);
};


pie.services.i18n.prototype.translate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, data)</span> </span>{
  <span class="hljs-keyword">var</span> translation = pie.object.getPath(<span class="hljs-keyword">this</span>.translations, path), count;

  <span class="hljs-keyword">if</span> (data &amp;&amp; data.hasOwnProperty(<span class="hljs-string">'count'</span>) &amp;&amp; <span class="hljs-keyword">typeof</span> translation === <span class="hljs-string">'object'</span>) {
    count = (data.count || <span class="hljs-number">0</span>).toString();
    count = <span class="hljs-keyword">this</span>._countAlias[count] || (count &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'other'</span> : <span class="hljs-string">'negother'</span>);
    translation = translation[count] === <span class="hljs-literal">undefined</span> ? translation.other : translation[count];
  }

  <span class="hljs-keyword">if</span>(!translation) {

    <span class="hljs-keyword">if</span>(data &amp;&amp; data.hasOwnProperty(<span class="hljs-string">'default'</span>)) {
      translation = data.default;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.app.debug(<span class="hljs-string">"Translation not found: "</span> + path);
      <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }
  }


  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> translation === <span class="hljs-string">'string'</span>) {

    translation = translation.indexOf(<span class="hljs-string">'${'</span>) === -<span class="hljs-number">1</span> ? translation : <span class="hljs-keyword">this</span>._nestedTranslate(translation, data);
    <span class="hljs-keyword">return</span> translation.indexOf(<span class="hljs-string">'%{'</span>) === -<span class="hljs-number">1</span> ? translation : pie.string.expand(translation, data);
  }

  <span class="hljs-keyword">return</span> translation;
};


pie.services.i18n.prototype.timeago = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t, now, scope)</span> </span>{
  t = <span class="hljs-keyword">this</span>._normalizedDate(t).getTime()  / <span class="hljs-number">1000</span>;
  now = <span class="hljs-keyword">this</span>._normalizedDate(now || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime() / <span class="hljs-number">1000</span>;

  <span class="hljs-keyword">var</span> diff = now - t, c;

  scope = scope || <span class="hljs-string">'app'</span>;

  <span class="hljs-keyword">if</span>(diff &lt; <span class="hljs-number">60</span>) { <span class="hljs-comment">// less than a minute</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.now'</span>, {count: diff});
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">3600</span>) { <span class="hljs-comment">// less than an hour</span>
    c = <span class="hljs-built_in">Math</span>.floor(diff / <span class="hljs-number">60</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.minutes'</span>, {count: c});
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86400</span>) { <span class="hljs-comment">// less than a day</span>
    c = <span class="hljs-built_in">Math</span>.floor(diff / <span class="hljs-number">3600</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.hours'</span>, {count: c});
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86400</span> * <span class="hljs-number">7</span>) { <span class="hljs-comment">// less than a week (</span>
    c = <span class="hljs-built_in">Math</span>.floor(diff / <span class="hljs-number">86400</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.days'</span>, {count: c});
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86400</span> * <span class="hljs-number">30</span>) { <span class="hljs-comment">// less than a month</span>
    c = <span class="hljs-built_in">Math</span>.floor(diff / (<span class="hljs-number">86400</span> * <span class="hljs-number">7</span>));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.weeks'</span>, {count: c});
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86500</span> * <span class="hljs-number">365.25</span>) { <span class="hljs-comment">// less than a year</span>
    c = <span class="hljs-built_in">Math</span>.floor(diff / (<span class="hljs-number">86400</span> * <span class="hljs-number">365.25</span> / <span class="hljs-number">12</span>));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.months'</span>, {count: c});
  } <span class="hljs-keyword">else</span> {
    c = <span class="hljs-built_in">Math</span>.floor(diff / (<span class="hljs-number">86400</span> * <span class="hljs-number">365.25</span>));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.years'</span>, {count: c});
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>pass in the date instance and the string ‘format’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.i18n.prototype.strftime = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date, f)</span> </span>{
  date = <span class="hljs-keyword">this</span>._normalizedDate(date);</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>named format from translations.time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(f &amp;&amp; f.charAt(<span class="hljs-number">0</span>) !== <span class="hljs-string">'%'</span>) f = <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.formats.'</span> + f);

  <span class="hljs-keyword">var</span> weekDay           = date.getDay(),
      day               = date.getDate(),
      year              = date.getFullYear(),
      month             = date.getMonth() + <span class="hljs-number">1</span>,
      hour              = date.getHours(),
      hour12            = <span class="hljs-keyword">this</span>._hour(hour),
      meridian          = <span class="hljs-keyword">this</span>._ampm(hour),
      secs              = date.getSeconds(),
      mins              = date.getMinutes(),
      offset            = date.getTimezoneOffset(),
      absOffsetHours    = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.abs(offset / <span class="hljs-number">60</span>)),
      absOffsetMinutes  = <span class="hljs-built_in">Math</span>.abs(offset) - (absOffsetHours * <span class="hljs-number">60</span>),
      timezoneoffset    = (offset &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"-"</span> : <span class="hljs-string">"+"</span>) + <span class="hljs-keyword">this</span>._pad(absOffsetHours, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>) + <span class="hljs-keyword">this</span>._pad(absOffsetMinutes, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);

  f = f.replace(<span class="hljs-string">"%a"</span>, <span class="hljs-keyword">this</span>._shortDayName(weekDay))
      .replace(<span class="hljs-string">"%A"</span>,  <span class="hljs-keyword">this</span>._dayName(weekDay))
      .replace(<span class="hljs-string">"%b"</span>,  <span class="hljs-keyword">this</span>._shortMonthName(month - <span class="hljs-number">1</span>))
      .replace(<span class="hljs-string">"%d"</span>,  <span class="hljs-keyword">this</span>._pad(day, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
      .replace(<span class="hljs-string">"%e"</span>,  <span class="hljs-keyword">this</span>._pad(day, <span class="hljs-number">2</span>, <span class="hljs-string">' '</span>))
      .replace(<span class="hljs-string">"%-d"</span>, day)
      .replace(<span class="hljs-string">"%H"</span>,  <span class="hljs-keyword">this</span>._pad(hour, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
      .replace(<span class="hljs-string">"%k"</span>,  hour)
      .replace(<span class="hljs-string">"%I"</span>,  <span class="hljs-keyword">this</span>._pad(hour12, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
      .replace(<span class="hljs-string">"%l"</span>,  hour12)
      .replace(<span class="hljs-string">"%m"</span>,  <span class="hljs-keyword">this</span>._pad(month, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
      .replace(<span class="hljs-string">"%-m"</span>, month)
      .replace(<span class="hljs-string">"%M"</span>,  <span class="hljs-keyword">this</span>._pad(mins, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
      .replace(<span class="hljs-string">"%p"</span>,  meridian.toUpperCase())
      .replace(<span class="hljs-string">"%P"</span>,  meridian)
      .replace(<span class="hljs-string">"%S"</span>,  <span class="hljs-keyword">this</span>._pad(secs, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
      .replace(<span class="hljs-string">"%-S"</span>, secs)
      .replace(<span class="hljs-string">"%w"</span>,  weekDay)
      .replace(<span class="hljs-string">"%y"</span>,  <span class="hljs-keyword">this</span>._pad(year % <span class="hljs-number">100</span>))
      .replace(<span class="hljs-string">"%Y"</span>,  year)
      .replace(<span class="hljs-string">"%z"</span>,  timezoneoffset)
      .replace(<span class="hljs-string">"%Z"</span>,  <span class="hljs-keyword">this</span>._timezoneAbbr(date));

  <span class="hljs-keyword">return</span> f;
};

pie.services.i18n.prototype.t = pie.services.i18n.prototype.translate;
pie.services.i18n.prototype.l = pie.services.i18n.prototype.strftime;
pie.services.navigator = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span> </span>{
  <span class="hljs-keyword">this</span>.app = app;
  pie.model.prototype.constructor.call(<span class="hljs-keyword">this</span>, {});
};

pie.services.navigator.prototype = <span class="hljs-built_in">Object</span>.create(pie.model.prototype);


pie.services.navigator.prototype.go = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, params, replace)</span> </span>{
  <span class="hljs-keyword">var</span> url = path;

  params = params || {};

  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'path'</span>) === path &amp;&amp; <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'query'</span>) === params) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.keys(params).length) {
    url += <span class="hljs-string">'?'</span>;
    url += $.serialize(params);
  }

  <span class="hljs-built_in">window</span>.history[replace ? <span class="hljs-string">'replaceState'</span> : <span class="hljs-string">'pushState'</span>]({}, <span class="hljs-built_in">document</span>.title, url);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.setDataFromLocation();
};


pie.services.navigator.prototype.start = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.setDataFromLocation();
};

pie.services.navigator.prototype.setDataFromLocation = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> query = <span class="hljs-built_in">window</span>.location.search.slice(<span class="hljs-number">1</span>);
  query = pie.string.deserialize(query);

  <span class="hljs-keyword">this</span>.sets({
    url: <span class="hljs-built_in">window</span>.location.href,
    path: <span class="hljs-built_in">window</span>.location.pathname,
    query: query
  });

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>notifier is a class which provides an interface for rendering page-level notifications.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.notifier = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notifier</span><span class="hljs-params">(app)</span> </span>{
  pie.view.prototype.constructor.call(<span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">this</span>.app = app;
  <span class="hljs-keyword">this</span>.notifications = {};
};

pie.services.notifier.prototype = <span class="hljs-built_in">Object</span>.create(pie.view.prototype);


pie.services.notifier.prototype.addedToParent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'.page-alert'</span>, <span class="hljs-keyword">this</span>.handleAlertClick.bind(<span class="hljs-keyword">this</span>));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>remove all alerts, potentially filtering by the type of alert.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.notifier.prototype.clear = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type)</span> </span>{
  <span class="hljs-keyword">if</span>(type) {
    <span class="hljs-keyword">var</span> nodes = <span class="hljs-keyword">this</span>.notifications[type] || [];
    <span class="hljs-keyword">while</span>(nodes.length) {
      <span class="hljs-keyword">this</span>.remove(nodes[nodes.length-<span class="hljs-number">1</span>]);
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">while</span>(<span class="hljs-keyword">this</span>.el.childNodes.length) {
      <span class="hljs-keyword">this</span>.remove(<span class="hljs-keyword">this</span>.el.childNodes[<span class="hljs-number">0</span>]);
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Show a notification or notifications.
Messages can be a string or an array of messages.
Multiple messages will be shown in the same notification, but on separate lines.
You can choose to close a notification automatically by providing <code>true</code> as the third arg.
You can provide a number in milliseconds as the autoClose value as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.notifier.prototype.notify = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(messages, type, autoClose)</span> </span>{
  type = type || <span class="hljs-string">'message'</span>;
  autoClose = <span class="hljs-keyword">this</span>.getAutoCloseTimeout(autoClose);

  messages = pie.array.from(messages);

  <span class="hljs-keyword">var</span> content = <span class="hljs-keyword">this</span>.app.template(<span class="hljs-string">'alert'</span>, {<span class="hljs-string">"type"</span> : type, <span class="hljs-string">"messages"</span>: messages});
  content = pie.dom.createElement(content);

  <span class="hljs-keyword">this</span>.notifications[type] = <span class="hljs-keyword">this</span>.notifications[type] || [];
  <span class="hljs-keyword">this</span>.notifications[type].push(content);

  content._pieNotificationType = type;
  <span class="hljs-keyword">this</span>.el.insertBefore(content, <span class="hljs-keyword">this</span>.el.firstElementChild);

  <span class="hljs-keyword">if</span>(autoClose) {
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">this</span>.remove(content);
    }.bind(<span class="hljs-keyword">this</span>), autoClose);
  }

};

pie.services.notifier.prototype.getAutoCloseTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(autoClose)</span> </span>{
  <span class="hljs-keyword">if</span>(autoClose === <span class="hljs-literal">undefined</span>) autoClose = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">if</span>(autoClose &amp;&amp; <span class="hljs-keyword">typeof</span> autoClose !== <span class="hljs-string">'number'</span>) autoClose = <span class="hljs-number">7000</span>;
  <span class="hljs-keyword">return</span> autoClose;
};

pie.services.notifier.prototype.remove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
  <span class="hljs-keyword">var</span> type = el._pieNotificationType;
  <span class="hljs-keyword">if</span>(type) {
    pie.array.remove(<span class="hljs-keyword">this</span>.notifications[type] || [], el);
  }
  $(el).remove();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>remove the alert that was clicked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.notifier.prototype.handleAlertClick = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
  <span class="hljs-keyword">this</span>.remove(e.delegateTarget);
  e.preventDefault();
};
pie.services.router = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span> </span>{
  <span class="hljs-keyword">this</span>.app = app;
  <span class="hljs-keyword">this</span>.routes = {};
  <span class="hljs-keyword">this</span>.namedRoutes = {};
};</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>get a url based on the current one but with the changes provided.
this will even catch interpolated values.
Given a named route: /things/page/:page.json
And the current path == /things/page/1.json?q=test
app.changedUrl({page: 3, q: ‘newQuery’});</p>
<h1 id="-things-page-3-json-q-newquery">=&gt; /things/page/3.json?q=newQuery</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.router.prototype.changedUrl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span> </span>{
  <span class="hljs-keyword">var</span> current = <span class="hljs-keyword">this</span>.app.parsedUrl;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.router.path(current.name || current.path, pie.object.extend({}, current.interpolations, current.query, changes));
},</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>normalize a path to be evaluated by the router</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.router.prototype.normalizePath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>ensure there’s a leading slash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(path.charAt(<span class="hljs-number">0</span>) !== <span class="hljs-string">'/'</span>) {
    path = <span class="hljs-string">'/'</span> + path;
  }

  <span class="hljs-keyword">if</span>(path.indexOf(<span class="hljs-string">'?'</span>) &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">var</span> split = path.split(<span class="hljs-string">'?'</span>);
    path = <span class="hljs-keyword">this</span>.normalizePath(split.shift());
    split.unshift(path);
    path = split.join(<span class="hljs-string">'?'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>remove trailing hashtags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(path.charAt(path.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'#'</span>) {
    path = path.substr(<span class="hljs-number">0</span>, path.length - <span class="hljs-number">1</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>remove trailing slashes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(path.charAt(path.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'/'</span>) {
    path = path.substr(<span class="hljs-number">0</span>, path.length - <span class="hljs-number">1</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>remove</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">return</span> path;
},</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>invoke to add routes to the routers routeset.
routes objects which contain a “name” key will be added as a name lookup.
you can pass a set of defaults which will be extended into each route object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.router.prototype.route = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(routes, defaults)</span></span>{
  defaults = defaults || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>remove the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._routeKeys;

  pie.object.forEach(routes, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,r)</span> </span>{

    <span class="hljs-keyword">if</span>(<span class="hljs-string">'object'</span> === <span class="hljs-keyword">typeof</span> r) {

      k = <span class="hljs-keyword">this</span>.normalizePath(k);

      <span class="hljs-keyword">this</span>.routes[k] = pie.object.extend({}, defaults, r);

      <span class="hljs-keyword">if</span>(r.hasOwnProperty(<span class="hljs-string">'name'</span>)) {
        <span class="hljs-keyword">this</span>.namedRoutes[r.name] = k;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.namedRoutes[k] = r;
    }
  }.bind(<span class="hljs-keyword">this</span>));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>will return the named path. if there is no path with that name it will return itself.
you can optionally pass a data hash and it will build the path with query params or
with path interpolation path(“/foo/bar/:id”, {id: ‘44’, q: ‘search’}) =&gt; “/foo/bar/44?q=search”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.router.prototype.path = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nameOrPath, data, interpolateOnly)</span> </span>{
  <span class="hljs-keyword">var</span> o = <span class="hljs-keyword">this</span>.namedRoutes[nameOrPath],
  s = (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> o) ? o : nameOrPath,
  usedKeys = [],
  params,
  unusedData;

  data = data || {};
  s = <span class="hljs-keyword">this</span>.normalizePath(s);

  s = s.replace(<span class="hljs-regexp">/\:([a-zA-Z0-9_]+)/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, key)</span></span>{
    usedKeys.push(key);
    <span class="hljs-keyword">if</span>(data[key] === <span class="hljs-literal">undefined</span> || data[key] === <span class="hljs-literal">null</span> || data[key].toString().length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"[PIE] missing route interpolation: "</span> + match);
    }
    <span class="hljs-keyword">return</span> data[key];
  });

  unusedData = pie.object.except(data, usedKeys);
  params = pie.object.serialize(pie.object.compact(unusedData, <span class="hljs-literal">true</span>));

  <span class="hljs-keyword">if</span>(!interpolateOnly &amp;&amp; params.length) {
    s = pie.string.urlConcat(s, params);
  }

  <span class="hljs-keyword">return</span> s;

};</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>provides the keys of the routes in a sorted order relevant for matching most descriptive to least</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.router.prototype.routeKeys = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._routeKeys) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._routeKeys;
  <span class="hljs-keyword">this</span>._routeKeys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.routes);

  <span class="hljs-keyword">var</span> ac, bc, c, d = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>sorts the route keys to be the most exact to the most generic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._routeKeys.sort(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span> </span>{
    ac = (a.match(<span class="hljs-regexp">/:/g</span>) || d).length;
    bc = (b.match(<span class="hljs-regexp">/:/g</span>) || d).length;
    c = ac - bc;
    c = c || (b.length - a.length);
    c = c || (ac &lt; bc ? <span class="hljs-number">1</span> : (ac &gt; bc ? -<span class="hljs-number">1</span> : <span class="hljs-number">0</span>));
    <span class="hljs-keyword">return</span> c;
  });

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._routeKeys;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>look at the path and determine the route which this matches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.services.router.prototype.parseUrl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{

  <span class="hljs-keyword">var</span> keys = <span class="hljs-keyword">this</span>.routeKeys(),
    i = <span class="hljs-number">0</span>,
    j, key, match, splitUrl, splitKey, query,
    interpolations, fullPath, pieces;

  pieces = path.split(<span class="hljs-string">'?'</span>);

  path = pieces.shift();
  path = <span class="hljs-keyword">this</span>.normalizePath(path);

  query = pieces.join(<span class="hljs-string">'&amp;'</span>) || <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>a trailing slash will bork stuff</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (path.length &gt; <span class="hljs-number">1</span> &amp;&amp; path[path.length - <span class="hljs-number">1</span>] === <span class="hljs-string">'/'</span>) path = path.slice(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>is there an explicit route for this path? it wins if so</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  match = <span class="hljs-keyword">this</span>.routes[path];
  interpolations = {};
  splitUrl = path.split(<span class="hljs-string">'/'</span>);

  <span class="hljs-keyword">if</span>(match) {
    match = pie.object.extend({routeKey: path}, match);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">while</span> (i &lt; keys.length &amp;&amp; !match) {
      key = keys[i];

      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.routes[key] !== <span class="hljs-string">'object'</span>) {
        i++;
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-keyword">this</span>.routes[key].regex = <span class="hljs-keyword">this</span>.routes[key].regex || <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + key.replace(<span class="hljs-regexp">/(:[^\/]+)/g</span>,<span class="hljs-string">'([^\\/]+)'</span>) + <span class="hljs-string">'$'</span>);

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.routes[key].regex.test(path)) {
        match = pie.object.extend({routeKey: key}, <span class="hljs-keyword">this</span>.routes[key]);
        splitKey = key.split(<span class="hljs-string">'/'</span>);
        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; splitKey.length; j++){
          <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/^:/</span>.test(splitKey[j])) {
            interpolations[splitKey[j].replace(<span class="hljs-regexp">/^:/</span>, <span class="hljs-string">''</span>)] = splitUrl[j];
            match[splitKey[j]] = splitUrl[j];
          }
        }
      }
      i++;
    }
  }

  query = pie.string.deserialize(query);
  fullPath = pie.array.compact([path, pie.object.serialize(query)], <span class="hljs-literal">true</span>).join(<span class="hljs-string">'?'</span>);

  <span class="hljs-keyword">return</span> pie.object.extend({
    interpolations: interpolations,
    path: path,
    query: query,
    fullPath: fullPath
  }, match);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>operator of the site. contains a router, navigator, etc with the intention of holding page context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">app</span><span class="hljs-params">(options)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>general app options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.options = pie.object.deepExtend({
    uiTarget: <span class="hljs-string">'body'</span>,
    viewNamespace: <span class="hljs-string">'lib.views'</span>,
    notificationUiTarget: <span class="hljs-string">'.notification-container'</span>
  }, options);

  <span class="hljs-keyword">var</span> classOption = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, _default)</span></span>{
    <span class="hljs-keyword">var</span> k = <span class="hljs-keyword">this</span>.options[key] || _default;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> k(<span class="hljs-keyword">this</span>);
  }.bind(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>app.i18n is the translation functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.i18n = classOption(<span class="hljs-string">'i18n'</span>, pie.services.i18n);
  <span class="hljs-keyword">this</span>.addChild(<span class="hljs-string">'i18n'</span>, <span class="hljs-keyword">this</span>.i18n);</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>app.ajax is ajax interface + app specific functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.ajax = classOption(<span class="hljs-string">'ajax'</span>, pie.services.ajax);
  <span class="hljs-keyword">this</span>.addChild(<span class="hljs-string">'ajax'</span>, <span class="hljs-keyword">this</span>.ajax);</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>app.notifier is the object responsible for showing page-level notifications, alerts, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.notifier = classOption(<span class="hljs-string">'notifier'</span>, pie.services.notifier);
  <span class="hljs-keyword">this</span>.addChild(<span class="hljs-string">'notifier'</span>, <span class="hljs-keyword">this</span>.notifier);</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>app.errorHandler is the object responsible for</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.errorHandler = classOption(<span class="hljs-string">'errorHandler'</span>, pie.services.errorHandler);
  <span class="hljs-keyword">this</span>.addChild(<span class="hljs-string">'errorHandler'</span>, <span class="hljs-keyword">this</span>.errorHandler);</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>app.router is used to determine which view should be rendered based on the url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.router = classOption(<span class="hljs-string">'router'</span>, pie.services.router);
  <span class="hljs-keyword">this</span>.addChild(<span class="hljs-string">'router'</span>, <span class="hljs-keyword">this</span>.router);</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>the only navigator which should exist in this app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.navigator = classOption(<span class="hljs-string">'navigator'</span>, pie.services.navigator);
  <span class="hljs-keyword">this</span>.addChild(<span class="hljs-string">'navigator'</span>, <span class="hljs-keyword">this</span>.navigator);</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>the validator which should be used in the context of the app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.validator = classOption(<span class="hljs-string">'validator'</span>, pie.validator);
  <span class="hljs-keyword">this</span>.addChild(<span class="hljs-string">'validator'</span>, <span class="hljs-keyword">this</span>.validator);</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>app.models is globally available. app.models is solely for page context.
this is not a singleton container or anything like that. it’s just for passing
models from one view to the next. the rendered layout may inject values here to initialize the page.
after each navigation change, this.models is reset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.models = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>app._templates should not be used. app.template() should be the public interface.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._templates = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>after a navigation change, app.parsedUrl is the new parsed route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.parsedUrl = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>the functions to invoke as part of the app’s lifecycle. see app.on().</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.eventCallbacks = {};
  <span class="hljs-keyword">this</span>.triggeredEvents = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>we observe the navigator and handle changing the context of the page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.navigator.observe(<span class="hljs-keyword">this</span>.navigationChanged.bind(<span class="hljs-keyword">this</span>), <span class="hljs-string">'url'</span>);

  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'beforeStart'</span>, <span class="hljs-keyword">this</span>.showStoredNotifications.bind(<span class="hljs-keyword">this</span>));
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'beforeStart'</span>, <span class="hljs-keyword">this</span>.setupSinglePageLinks.bind(<span class="hljs-keyword">this</span>));
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'beforeStart'</span>, <span class="hljs-keyword">this</span>.setupNotifier.bind(<span class="hljs-keyword">this</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>once the dom is loaded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-keyword">this</span>.start.bind(<span class="hljs-keyword">this</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>set a global instance which can be used as a backup within the pie library.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">window</span>.pieInstance = <span class="hljs-built_in">window</span>.pieInstance || <span class="hljs-keyword">this</span>;
};


pie.object.extend(pie.app.prototype, pie.container);</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>just in case the client wants to override the standard confirmation dialog.
eventually this could create a confirmation view and provide options to it.
the view could have more options but would always end up invoking success or failure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.confirm = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.confirm(options.text)) {
    <span class="hljs-keyword">if</span>(options.success) options.success();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span>(options.failure) options.failure();
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>print stuff if we’re not in prod.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.debug = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.env === <span class="hljs-string">'production'</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">console</span> &amp;&amp; <span class="hljs-built_in">console</span>.log) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'[PIE] '</span> + msg);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>use this to navigate. This allows us to apply app-specific navigation logic
without altering the underling navigator.
This can be called with just a path, a path with a query object, or with notification arguments.
app.go(‘/test-url’)
app.go(‘/test-url’, true) // replaces state rather than adding
app.go([‘/test-url’, {foo: ‘bar’}]) // navigates to /test-url?foo=bar
app.go(‘/test-url’, true, ‘Thanks for your interest’) // replaces state with /test-url and shows the provided notification
app.go(‘/test-url’, ‘Thanks for your interest’) // navigates to /test-url and shows the provided notification</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.go = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> args = pie.array.args(<span class="hljs-built_in">arguments</span>), path, notificationArgs, replaceState, query;

  path = args.shift();</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>arguments =&gt; ‘/test-url’, ‘?query=string’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] === <span class="hljs-string">'string'</span> &amp;&amp; args[<span class="hljs-number">0</span>].indexOf(<span class="hljs-string">'?'</span>) === <span class="hljs-number">0</span>) {
    path = <span class="hljs-keyword">this</span>.router.path(path);
    query = args.shift();
    path = pie.string.urlConcat(<span class="hljs-keyword">this</span>.router.path(path), query);</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>arguments =&gt; ‘/test-url’, {query: ‘object’}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] === <span class="hljs-string">'object'</span>) {
    path = <span class="hljs-keyword">this</span>.router.path(path, args.shift());</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>arguments =&gt; ‘/test-url’
arguments =&gt; [‘/test-url’, {query: ‘object’}]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  } <span class="hljs-keyword">else</span> {
    path = <span class="hljs-keyword">this</span>.router.path.apply(<span class="hljs-keyword">this</span>.router, pie.array.from(path));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>if the next argument is a boolean, we care about replaceState</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(args[<span class="hljs-number">0</span>] === <span class="hljs-literal">true</span> || args[<span class="hljs-number">0</span>] === <span class="hljs-literal">false</span>) {
    replaceState = args.shift();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>anything left is considered arguments for the notifier.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  notificationArgs = args;

  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.router.parseUrl(path).hasOwnProperty(<span class="hljs-string">'view'</span>)) {
    <span class="hljs-keyword">this</span>.navigator.go(path, replaceState);
    <span class="hljs-keyword">if</span>(notificationArgs &amp;&amp; notificationArgs.length) {
      <span class="hljs-keyword">this</span>.notifier.notify.apply(<span class="hljs-keyword">this</span>.notifier, notificationArgs);
    }
  } <span class="hljs-keyword">else</span> {

    <span class="hljs-keyword">if</span>(notificationArgs &amp;&amp; notificationArgs.length) {
      <span class="hljs-keyword">this</span>.store(<span class="hljs-keyword">this</span>.notifier.storageKey, notificationArgs);
    }

    <span class="hljs-built_in">window</span>.location.href = path;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>go back one page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.goBack = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">window</span>.history.back();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>callback for when a link is clicked in our app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.handleSinglePageLinkClick = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>if the link is targeting something else, let the browser take over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(e.delegateTarget.getAttribute(<span class="hljs-string">'target'</span>)) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>if the user is trying to do something beyond navigate, let the browser take over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(e.ctrlKey || e.metaKey) <span class="hljs-keyword">return</span>;


  <span class="hljs-keyword">var</span> href = e.delegateTarget.getAttribute(<span class="hljs-string">'href'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>if we’re going nowhere, somewhere else, or to an anchor on the page, let the browser take over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!href || <span class="hljs-regexp">/^(#|[a-z]+:\/\/)/</span>.test(href)) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>ensure that relative links are evaluated as relative</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(href.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'?'</span>) href = <span class="hljs-built_in">window</span>.location.pathname + href;</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>great, we can handle it. let the app decide whether to use pushstate or not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  e.preventDefault();
  <span class="hljs-keyword">this</span>.go(href);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>when we change urls
we always remove the current before instantiating the next. this ensures are views can prepare
context’s in removedFromParent before the constructor of the next view is invoked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.navigationChanged = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> target = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-keyword">this</span>.options.uiTarget),
    current  = <span class="hljs-keyword">this</span>.getChild(<span class="hljs-string">'currentView'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>let the router determine our new url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.previousUrl = <span class="hljs-keyword">this</span>.parsedUrl;
  <span class="hljs-keyword">this</span>.parsedUrl = <span class="hljs-keyword">this</span>.router.parseUrl(<span class="hljs-keyword">this</span>.navigator.get(<span class="hljs-string">'path'</span>));

  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.previousUrl !== <span class="hljs-keyword">this</span>.parsedUrl) {
    <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'urlChanged'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>not necessary for a view to exist on each page.
Maybe the entry point is server generated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.parsedUrl.view) {
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>if the view that’s in there is already loaded, don’t remove / add again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(current &amp;&amp; current._pieName === <span class="hljs-keyword">this</span>.parsedUrl.view) {
    <span class="hljs-keyword">if</span>(<span class="hljs-string">'navigationUpdated'</span> <span class="hljs-keyword">in</span> current) current.navigationUpdated();
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>remove the existing view if there is one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(current) {
    <span class="hljs-keyword">this</span>.removeChild(current);
    <span class="hljs-keyword">if</span>(current.el.parentNode) current.el.parentNode.removeChild(current.el);
    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'oldViewRemoved'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>clear any leftover notifications</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.notifier.clear();</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>use the view key of the parsedUrl to find the viewClass</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> viewClass = pie.object.getPath(<span class="hljs-built_in">window</span>, <span class="hljs-keyword">this</span>.options.viewNamespace + <span class="hljs-string">'.'</span> + <span class="hljs-keyword">this</span>.parsedUrl.view), child;</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>the instance to be added.</p>

            </div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>add the instance as our ‘currentView’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  child = <span class="hljs-keyword">new</span> viewClass(<span class="hljs-keyword">this</span>);
  child._pieName = <span class="hljs-keyword">this</span>.parsedUrl.view;
  <span class="hljs-keyword">this</span>.addChild(<span class="hljs-string">'currentView'</span>, child);
  target.appendChild(child.el);</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>remove the leftover model references</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.models = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>get us back to the top of the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">window</span>.scrollTo(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);

  <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'newViewLoaded'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>invoke fn when the event is triggered.
if futureOnly is truthy the fn will only be triggered for future events.
todo: allow once-only events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.on = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, futureOnly)</span> </span>{
  <span class="hljs-keyword">if</span>(!futureOnly &amp;&amp; ~<span class="hljs-keyword">this</span>.triggeredEvents.indexOf(event)) {
    fn();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.eventCallbacks[event] = <span class="hljs-keyword">this</span>.eventCallbacks[event] || [];
    <span class="hljs-keyword">this</span>.eventCallbacks[event].push(fn);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>reload the page without reloading the browser.
alters the current view’s _pieName to appear as invalid for the route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.refresh = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> current = <span class="hljs-keyword">this</span>.getChild(<span class="hljs-string">'currentView'</span>);
  current._pieName = <span class="hljs-string">'__remove__'</span>;
  <span class="hljs-keyword">this</span>.navigationChanged();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>safely access localStorage, passing along any errors for reporting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.retrieve = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, clear)</span> </span>{
  <span class="hljs-keyword">var</span> encoded, decoded;

  <span class="hljs-keyword">try</span>{
    encoded = <span class="hljs-built_in">window</span>.localStorage.getItem(key);
    decoded = encoded ? <span class="hljs-built_in">JSON</span>.parse(encoded) : <span class="hljs-literal">undefined</span>;
  }<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-keyword">this</span>.errorHandler.reportError(err, {prefix: <span class="hljs-string">"[caught] app#retrieve/getItem:"</span>});
  }

  <span class="hljs-keyword">try</span>{
    <span class="hljs-keyword">if</span>(clear || clear === <span class="hljs-literal">undefined</span>){
      <span class="hljs-built_in">window</span>.localStorage.removeItem(key);
    }
  }<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-keyword">this</span>.errorHandler.reportError(err, {prefix: <span class="hljs-string">"[caught] app#retrieve/removeItem:"</span>});
  }

  <span class="hljs-keyword">return</span> decoded;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>add the notifier’s el to the page if possible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.setupNotifier = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> parent = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-keyword">this</span>.options.notificationUiTarget);
  <span class="hljs-keyword">if</span>(parent) parent.appendChild(<span class="hljs-keyword">this</span>.getChild(<span class="hljs-string">'notifier'</span>).el);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>when a link is clicked, go there without a refresh if we recognize the route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.setupSinglePageLinks = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  $(<span class="hljs-built_in">document</span>.body).on(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">this</span>.handleSinglePageLinkClick.bind(<span class="hljs-keyword">this</span>), <span class="hljs-string">'a[href]'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>show any notification which have been preserved via local storage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.showStoredNotifications = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> encoded = <span class="hljs-keyword">this</span>.retrieve(<span class="hljs-keyword">this</span>.notifier.storageKey), decoded;

  <span class="hljs-keyword">if</span>(encoded) {
    decoded = <span class="hljs-built_in">JSON</span>.parse(encoded);
    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'afterStart'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">this</span>.notifier.notify.apply(<span class="hljs-keyword">this</span>.notifier, decoded);
    }.bind(<span class="hljs-keyword">this</span>));
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>start the app, apply fake navigation to the current url to get our navigation observation underway.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.start = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

  <span class="hljs-keyword">this</span>.navigator.start();

  <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'beforeStart'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>invoke a nav change event on page load.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> url = <span class="hljs-keyword">this</span>.navigator.get(<span class="hljs-string">'url'</span>);
  <span class="hljs-keyword">this</span>.navigator.data.url = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.navigator.set(<span class="hljs-string">'url'</span>, url);

  <span class="hljs-keyword">this</span>.started = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'afterStart'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>safely access localStorage, passing along any errors for reporting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.store = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, data)</span> </span>{
  <span class="hljs-keyword">try</span>{
    <span class="hljs-built_in">window</span>.localStorage.setItem(key, <span class="hljs-built_in">JSON</span>.stringify(data));
  }<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-keyword">this</span>.errorHandler.reportError(err, {prefix: <span class="hljs-string">"[caught] app#store:"</span>});
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>compile templates on demand and evaluate them with <code>data</code>.
Templates are assumed to be script tags with type=”text/pie-template”.
Once compiled, the templates are cached in this._templates for later use.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.template = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, data)</span> </span>{
  <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>._templates[name]) {

    <span class="hljs-keyword">var</span> node = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'script[id="'</span> + name + <span class="hljs-string">'"][type="text/pie-template"]'</span>);

    <span class="hljs-keyword">if</span>(node) {
      <span class="hljs-keyword">this</span>.debug(<span class="hljs-string">'Compiling and storing template: '</span> + name);
      <span class="hljs-keyword">this</span>._templates[name] = pie.string.template(node.textContent);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"[PIE] Unknown template error: "</span> + name);
    }
  }

  data = data || {};

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._templates[name](data);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>trigger an event (string) on the app.
any callbacks associated with that event will be invoked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app.prototype.trigger = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.triggeredEvents.indexOf(event) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>.triggeredEvents.push(event);
  }

  (<span class="hljs-keyword">this</span>.eventCallbacks[event] || []).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span></span>{
    f();
  });
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
