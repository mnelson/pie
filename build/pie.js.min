window.pie={array:{},date:{},dom:{},func:{},math:{},object:{},string:{},mixins:{},services:{},pieId:1,unique:function(){return String(pie.pieId++)},setUid:function(e){return e.pieId=e.pieId||pie.unique()},inherit:function(){var e=pie.array.args(arguments),t=e.shift(),i=e.shift();return t.prototype=Object.create(i.prototype),t.prototype.constructor=t,t.prototype._super||pie.extend(t.prototype,pie.mixins.inheritance),e.length&&pie.extend(t.prototype,e),t},extend:function(){var e=pie.array.args(arguments),t=e.shift();e=pie.array.compact(pie.array.flatten(e),!0),e.forEach(function(e){pie.object.merge(t,e)})},util:function(){var e={};return e.a=pie.array,e.d=pie.date,e.$=pie.dom,e.f=pie.func,e.m=pie.math,e.o=pie.object,e.s=pie.string,e.x=pie.mixins,e.unique=pie.unique,e.setUid=pie.setUid,e.inherit=pie.inherit,e.extend=pie.extend,e}},pie.array.areAll=function(e,t){for(var i=0;i<e.length;i++)if(!t.call(null,e[i]))return!1;return!0},pie.array.areAny=function(e,t){for(var i=0;i<e.length;i++)if(t.call(null,e[i]))return!0;return!1},pie.array.change=function(){var e=pie.array.args(arguments),t=e.shift();return e.forEach(function(e){t=pie.array[e](t)}),t},pie.array.args=function(e){return Array.prototype.slice.call(e)},pie.array.avg=function(e){var t=pie.array.sum(e),i=e.length;return i?t/i:0},pie.array.compact=function(e,t){return e.filter(function(e){return t?!!e:null!=e})},pie.array.detect=function(e,t){for(var i=0,r=e.length;r>i;i++)if(pie.object.getValue(e[i],t))return e[i]},pie.array.detectLast=function(e,t){for(var i=e.length-1,r=0;i>=r;i--)if(pie.object.getValue(e[i],t))return e[i]},pie.array.dup=function(e){return e.slice(0)},pie.array.flatten=function(e,t,i){return i=i||[],Array.isArray(e)&&-1!==t?(null!=t&&t--,e.forEach(function(e){pie.array.flatten(e,t,i)})):i.push(e),i},pie.array.from=function(e){return Array.isArray(e)?e:e instanceof NodeList||e instanceof HTMLCollection?Array.prototype.slice.call(e,0):pie.array.compact([e],!1)},pie.array.grep=function(e,t){return e.filter(function(e){return t.test(String(e))})},pie.array.groupBy=function(e,t){var i,r={};return e.forEach(function(e){i=pie.object.getValue(e,t),null!=i&&(r[i]=r[i]||[],r[i].push(e))}),r},pie.array.intersect=function(e,t){return e.filter(function(e){return~t.indexOf(e)})},pie.array.last=function(e){return e&&e.length?e[e.length-1]:void 0},pie.array.map=function(e,t,i){var r;return r="function"!=typeof t?function(e){var r=e[t];return i&&"function"==typeof r?r.apply(e):r}:t,e.map(function(e){return r(e)})},pie.array.remove=function(e,t){for(var i;~(i=e.indexOf(t));)e.splice(i,1);return e},pie.array.subtract=function(e,t){return e.filter(function(e){return!~t.indexOf(e)})},pie.array.sum=function(e){var t=0;return e.forEach(function(e){t+=parseFloat(e)}),t},pie.array.sortBy=function(e,t){var i,r;return e.sort(function(e,n){return i=pie.object.getValue(e,t),r=pie.object.getValue(n,t),i===r?0:r>i?-1:1})},pie.array.toSentence=function(e,t){if(!e.length)return"";var i=t&&t.t("sentence.delimeter",{"default":""})||", ",r=t&&t.t("sentence.and",{"default":""})||" and ";return e.length>2&&(e=[e.slice(0,e.length-1).join(i),e.slice(e.length-1)]),e.join(r)},pie.array.union=function(){var e=pie.array.args(arguments);return e=pie.array.compact(e,!0),e=pie.array.flatten(e),e=pie.array.unique(e)},pie.array.unique=function(e){return e.filter(function(t,i){return e.indexOf(t)===i})},pie.date.dateFromISO=function(e){if(!e)return null;var t=e.split(/T|\s/)[0].split("-");return new Date(t[0],t[1]-1,t[2])},pie.date.now=function(){return(new Date).getTime()},pie.date.timeFromISO=function(){var e=[1,4,5,6,7,10,11];return function(t){if(!t)return 0/0;if(!/T|\s/.test(t))return pie.date.dateFromISO(t);var i,r,n=0;if(r=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(t)){for(var o,a=0;o=e[a];++a)r[o]=+r[o]||0;r[2]=(+r[2]||1)-1,r[3]=+r[3]||1,"Z"!==r[8]&&void 0!==r[9]&&(n=60*r[10]+r[11],"+"===r[9]&&(n=0-n)),i=Date.UTC(r[1],r[2],r[3],r[4],r[5]+n,r[6],r[7])}else i=0/0;return new Date(i)}}(),pie.dom._all=function(e,t){var i,r,n,o,a=pie.array.from(e[0]),s=e[1].split("."),p=Array.prototype.slice.call(e,2),c=s[s.length-1],h=/=$/.test(c);return h&&(c=c.substr(0,c.length-1)),t&&(i=[]),a.forEach(function(e){for(n=0;n<s.length-1;n++)r=e[s[n]],e=pie.func.valueFrom(r);h?o=e[c]=p[0]:(r=e[c],o=pie.func.valueFrom(r,e,p)),t&&i.push(o)}),t?i:void 0},pie.dom.all=function(){return pie.dom._all(arguments,!1)},pie.dom.getAll=function(){return pie.dom._all(arguments,!0)},pie.dom.createElement=function(e){var t=document.createElement("div");return t.innerHTML=e,t.removeChild(t.firstElementChild)},pie.dom.cache=function(){return pie.elementCache=pie.elementCache||new pie.cache,pie.elementCache},pie.dom.remove=function(e){pie.setUid(e),pie.dom.cache().del("element-"+e.pieId),e.parentNode&&e.parentNode.removeChild(e)},pie.dom.off=function(e,t,i,r,n){var o,a,s,p=t.split(".");pie.setUid(e),t=p.shift(),o=p.join("."),a="*"===t,s=pie.dom.cache().getOrSet("element-"+e.pieId+".dom-events",{}),(a?Object.keys(s):[t]).forEach(function(t){pie.array.from(s[t]).forEach(function(a,p,c){n||"focus"!==t&&"blur"!==t||!a.sel||(n=!0),o&&o!==a.ns||i&&i!==a.fn||r&&r!==a.sel||n!==a.cap||(e.removeEventListener(t,a.cb,a.cap),delete c[p]),s[t]=pie.array.compact(pie.array.from(s[t]))})})},pie.dom.on=function(e,t,i,r,n){var o,a,s,p=t.split(".");return t=p.shift(),a=p.join("."),pie.setUid(e),n||"focus"!==t&&"blur"!==t||!r||(n=!0),s=pie.dom.cache().getOrSet("element-"+e.pieId+".dom-events",{}),s[t]=s[t]||[],o=function(t){var n,o;a&&(t.namespace=a),r?(o=pie.array.from(e.querySelectorAll(r)),n=pie.array.detect(o,function(e){return e===t.target||e.contains(t.target)}),n&&(t.delegateTarget=n,i.call(n,t))):i.call(e,t)},s[t].push({ns:a,sel:r,cb:o,fn:i,cap:n}),e.addEventListener(t,o,n),o},pie.dom.trigger=function(e,t){var i=document.createEvent("Event");return i.initEvent(t,!0,!0),e.dispatchEvent(i)},pie.func.debounce=function(e,t,i){var r,n,o,a,s,p=function(){var c=pie.date.now()-a;t>c&&c>0?r=setTimeout(p,t-c):(r=null,i||(s=e.apply(o,n),r||(o=n=null)))};return function(){o=this,n=arguments,a=pie.date.now();var c=i&&!r;return r||(r=setTimeout(p,t)),c&&(s=e.apply(o,n),o=n=null),s}},pie.func.valueFrom=function(e,t,i){return"function"==typeof e?e.apply(t,i):e},pie.func.async=function(e,t,i){var r,n=e.length,o=0;return e.length?(r=function(){o++,i&&i.apply(null,arguments),o===n&&t()},void e.forEach(function(e){e(r)})):void t()},pie.math.precision=function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},pie.object.compact=function(e,t){var i=pie.object.merge({},e);return Object.keys(i).forEach(function(e){(void 0===i[e]||null===i[e]||t&&0===i[e].toString().length)&&delete i[e]}),i},pie.object.deepMerge=function(){function e(e){r[e]=e in r&&"object"==typeof r[e]?pie.object.deepMerge(r[e],t[e]):t[e]}for(var t,i=pie.array.args(arguments),r=i.shift();i.length;)t=i.shift(),t&&Object.keys(t).forEach(e);return r},pie.object.except=function(){var e={},t=pie.array.args(arguments),i=t[0];return t=pie.array.flatten(t.splice(1)),Object.keys(i).forEach(function(r){t.indexOf(r)<0&&(e[r]=i[r])}),e},pie.object.merge=function(){function e(e){r[e]=t[e]}for(var t,i=pie.array.args(arguments),r=i.shift();i.length;)t=i.shift(),t&&Object.keys(t).forEach(e);return r},pie.object.forEach=function(e,t){Object.keys(e).forEach(function(i){t(i,e[i])})},pie.object.getPath=function(e,t){for(var i,r=t.split(".");r.length;){if(!e)return e;if(i=r.shift(),!r.length)return e[i];e=e[i]}return e},pie.object.getValue=function(e,t){return"function"==typeof t?t.call(null,e):null==e?void 0:"function"==typeof e[t]?e[t].call(e):e.hasOwnProperty(t)||t in e?e[t]:void 0},pie.object.hasPath=function(e,t){for(var i,r=t.split(".");i=r.shift();){if(null==e||!e.hasOwnProperty(i))return!1;e=e[i]}return!0},pie.object.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},pie.object.serialize=function(e,t){var i,r,n,o=[],a=/\[\]$/;return i=function(e,i){i=pie.func.valueFrom(i),(!t||a.test(e)||null!=i&&i.toString().length)&&o.push(encodeURIComponent(e)+"="+encodeURIComponent(String(i)))},r=function(e){o.push(encodeURIComponent(e)+"=")},n=function(e,t,i){Array.isArray(t)?t.forEach(function(t){n(e+"[]",t,i)}):pie.object.isObject(t)?Object.keys(t).sort().forEach(function(r){n(e+"["+r+"]",t[r],i)}):i(e,t)},Object.keys(e).sort().forEach(function(t){n(t,e[t],i)}),o.join("&")},pie.object.setPath=function(e,t,i){for(var r,n=t.split(".");n.length;)r=n.shift(),n.length?e=e[r]?e[r]:e[r]={}:e[r]=i},pie.object.slice=function(){var e={},t=1,i=arguments,r=i[0];for(Array.isArray(i[1])&&(i=i[1],t=0);t<i.length;t++)r.hasOwnProperty(i[t])&&(e[i[t]]=r[i[t]]);return e},pie.object.values=function(e){return Object.keys(e).map(function(t){return e[t]})},pie.string.capitalize=function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},pie.string.change=function(){var e=pie.array.args(arguments),t=e.shift();return e.forEach(function(e){t=pie.string[e](t)}),t},pie.string.deserialize=function(){function e(e){if("undefined"===e)return void 0;if("null"===e)return null;if("true"===e)return!0;if("false"===e)return!1;var t=parseFloat(e);return isNaN(t)?e:/\./.test(e)?t:parseInt(t,10)}function t(e,t,i){var r,n,o,a=e.split("["),s=/^\[(.+)?\]$/;for(e=a.shift(),a=a.map(function(e){return"["+e}),o=i;n=a.shift();)r=n.match(s),r[1]?(o[e]=o[e]||{},o=o[e],e=r[1]):(o[e]=o[e]||[],o=o[e],e=o.length);return o[e]=t,i}return function(i,r){var n,o,a,s,p,c={};return i?(n=i.indexOf("?"),~n&&(i=i.slice(n+1)),o=i.split("&"),o.forEach(function(i){a=i.split("="),s=decodeURIComponent(a[0]||""),p=decodeURIComponent(a[1]||""),r&&(p=e(p)),t(s,p,c)}),c):c}}(),pie.string.escape=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},pie.string.expand=function(e,t){return t=t||{},e.replace(/\%\{(.+?)\}/g,function(e,i){return t[i]})},pie.string.humanize=function(e){return e.replace(/_id$/,"").replace(/([a-z][A-Z]|[a-z]_[a-z])/g,function(e,t){return t[0]+" "+t[t.length-1]})},pie.string.lowerize=function(e){return e.charAt(0).toLowerCase()+e.slice(1)},pie.string.modularize=function(e){return e.replace(/([^_])_([^_])/g,function(e,t,i){return t+i.toUpperCase()})},pie.string.pluralize=function(e,t){return 1===t?e:/ss$/i.test(e)?e+"es":/s$/i.test(e)?e:/[a-z]$/i.test(e)?e+"s":e},pie.string.template=function(e){return new Function("data","var p=[]; with(data){p.push('"+e.replace(/[\r\t\n]/g," ").replace(/'(?=[^%]*%\])/g,"	").split("'").join("\\'").split("	").join("'").replace(/\[%=(.+?)%\]/g,"',$1,'").replace(/\[%-(.+?)%\]/g,"',pie.string.escape($1),'").split("[%").join("');").split("%]").join("p.push('")+"');}return p.join('');")},pie.string.titleize=function(e){return e.replace(/(^| )([a-z])/g,function(e,t,i){return t+i.toUpperCase()})},pie.string.underscore=function(e){return e.replace(/([a-z])([A-Z])/g,function(e,t,i){return t+"_"+i.toLowerCase()}).toLowerCase()},pie.string.urlConcat=function(){var e=pie.array.compact(pie.array.args(arguments),!0),t=e.shift(),i=e.join("&");return i.length?(t.indexOf("?")<0&&(t+="?"),0===i.indexOf("?")&&(i=i.replace("?","&")),t+=i,t=t.replace("?&","?").replace("&&","&").replace("??","?"),t.indexOf("?")===t.length-1&&(t=t.substr(0,t.length-1)),t):t},pie.mixins.bindings=function(){function e(e,t){var i=e.getAttribute("type");return"checkbox"===i||"radio"===i?e.checked=Array.isArray(t)?!!~t.indexOf(e.value):e.hasAttribute("value")?e.value==t:!!t:e.value=t}function t(t,i,r){for(var n=0,o=t.qsa(i);n<o.length;n++)e(o[n],r)}function i(e,t){var i,r=e.value,n=e.getAttribute("type");return"checkbox"===n||"radio"===n?Array.isArray(t)?(i=t.indexOf(r),e.checked&&!~i?(t.push(e.value),t):!e.checked&&~i?(t.splice(i,1),t):t):e.hasAttribute("value")?e.checked?e.value:null:e.checked:e.value}return{bind:function(e){e=e||{};var r=e.model||this.model,n=e.attr||e.attribute||void 0,o=e.sel||'input[name="'+n+'"]',a=(e.trigger||"keyup change").split(" "),s=e.debounce,p=!1,c=function(e){var t=i(e.delegateTarget,r.get(n));p=!0,r.set(n,t),p=!1},h=function(e){p||t(this,o,e[e.length-1].value)}.bind(this);s&&(s===!0&&(s=150),c=Function.debounce(c,s)),a.forEach(function(e){this.on(e,o,c)}.bind(this)),this.onChange(r,h,n),this._bindings=pie.array.from(this._bindings),this._bindings.push({model:r,sel:o,attr:n})},initBoundFields:function(){pie.array.from(this._bindings).forEach(function(e){t(this,e.sel,e.model.get(e.attr))}.bind(this))}}}(),pie.mixins.container={addChild:function(e,t){var i,r=this.children(),n=this.childNames();return r.push(t),i=r.length-1,n[e]=i,t._indexWithinParent=i,t._nameWithinParent=e,t.parent=this,"addedToParent"in t&&t.addedToParent.call(t),this},addChildren:function(e){pie.object.forEach(e,function(e,t){this.addChild(e,t)}.bind(this))},childNames:function(){return this._childNames=this._childNames||{}},children:function(){return this._children=this._children||[]},getChild:function(e){var t=e._nameWithinParent||e,i=this.childNames()[t];return null==i&&(i=e),~i&&this.children()[i]||void 0},bubble:function(){for(var e=pie.array.args(arguments),t=e.shift(),i=this.parent;i&&!(t in i);)i=i.parent;i&&i[t].apply(i,e)},removeChild:function(e){var t,i=this.getChild(e),r=this.childNames(),n=this.children();if(i){for(t=i._indexWithinParent,n.splice(t,1);t<n.length;t++)n[t]._indexWithinParent=t,r[n[t]._nameWithinParent]=t;delete r[i._nameWithinParent],delete i._indexWithinParent,delete i._nameWithinParent,delete i.parent,"removedFromParent"in i&&i.removedFromParent.call(i,this)}return this},removeChildren:function(){for(var e,t=this.children();e=t[t.length-1];)this.removeChild(e);return this}},pie.mixins.externalResources={loadExternalResources:function(){var e,t=pie.array.args(arguments),i=t.pop();return t=pie.array.change(t,"flatten","compact"),e=t.map(function(e){return function(t){this.app.resources.load(e,t)}.bind(this)}.bind(this)),void pie.func.async(e,i)}},pie.mixins.inheritance={_super:function(){var e,t=pie.array.args(arguments),i=t.shift(),r=this;for(1===t.length&&"[object Arguments]"===String(t[0])&&(t=pie.array.args(t[0]));;){if(e=Object.getPrototypeOf(r),!e)throw new Error("No super method defined: "+i);if(e===r)return;if(e[i]&&e[i]!==this[i])return e[i].apply(this,t);r=e}}},pie.mixins.validatable={reportValidationError:function(e,t){this.set("validationErrors."+e,t)},validates:function(e,t){var i,r;this.validations=this.validations||{},Object.keys(e).forEach(function(n){i=pie.array.from(e[n]),r=[],i.forEach(function(e){"string"==typeof e?r.push({type:e,options:{}}):"function"==typeof e?r.push({type:"fn",options:{fn:e}}):Object.keys(e).forEach(function(t){r.push(pie.object.isObject(e[t])?{type:t,options:e[t]}:{type:t,options:pie.object.merge({},e)})})}),this.validations[n]=this.validations[n]||[],this.validations[n]=this.validations[n].concat(r),t&&this.observe(function(){this.validate(n)}.bind(this),n)}.bind(this))},validateAll:function(e){var t,i=!0,r=Object.keys(this.validations),n=function(){return void(e&&e(i))},o=function(e){i=!(!i||!e)};return r.length?(t=r.map(function(e){return function(t){return this.validate(e,t)}.bind(this)}.bind(this)),void pie.func.async(t,n,o)):n()},validate:function(e,t){var i,r=this.app.validator,n=pie.array.from(this.validations[e]),o=this.get(e),a=!0,s=[],p=function(e,t){a=!(!a||!t),t||s.push(r.errorMessage(e.type,e.options))},c=function(){return this.reportValidationError(e,s),void(t&&t(a))}.bind(this);return n.length?(i=n.map(function(e){return function(t){var i=r[e.type],n=function(i){t(e,i)},a=i.call(r,o,e.options,n);(a===!0||a===!1)&&t(e,a)}}),void pie.func.async(i,c,p)):c()}},pie.model=function(e,t){this.data=pie.object.merge({},e),this.options=t||{},this.app=this.options.app||window.app,this.observations={},this.changeRecords=[],pie.setUid(this)},pie.extend(pie.model.prototype,pie.mixins.inheritance),pie.model.prototype.deliverChangeRecords=function(){for(var e,t,i,r={};i=this.changeRecords.shift();)for(e=pie.array.union(this.observations[i.name],this.observations.__all__);t=e.shift();)r[t.pieId]=r[t.pieId]||{fn:t,changes:[]},r[t.pieId].changes.push(i);return pie.object.forEach(r,function(e,t){t.fn.call(null,t.changes)}),this},pie.model.prototype.get=function(e){return pie.object.getPath(this.data,e)},pie.model.prototype.gets=function(){var e=pie.array.args(arguments),t={};return e=pie.array.flatten(e),e=pie.array.compact(e),e.forEach(function(e){t[e]=pie.object.getPath(this.data,e)}.bind(this)),pie.object.compact(t)},pie.model.prototype.observe=function(){var e=pie.array.args(arguments),t=e.shift();return pie.setUid(t),e=pie.array.flatten(e),e.length||e.push("__all__"),e.forEach(function(e){this.observations[e]=this.observations[e]||[],this.observations[e].indexOf(t)<0&&this.observations[e].push(t)}.bind(this)),this},pie.model.prototype.set=function(e,t,i){var r={name:e,object:this.data};return pie.object.hasPath(this.data,e)?(r.type="update",r.oldValue=pie.object.getPath(this.data,e)):r.type="add",r.value=t,pie.object.setPath(this.data,e,t),this.changeRecords.push(r),i?this:this.deliverChangeRecords()},pie.model.prototype.sets=function(e,t){return pie.object.forEach(e,function(e,t){this.set(e,t,!0)}.bind(this)),t?this:this.deliverChangeRecords()},pie.model.prototype.unobserve=function(){var e,t=pie.array.args(arguments),i=t.shift();return t.length||(t=Object.keys(this.observations)),t.forEach(function(t){e=this.observations[t].indexOf(i),~e&&this.observations[t].splice(e,1)}.bind(this)),this},pie.model.prototype.compute=function(){var e=pie.array.args(arguments),t=e.shift(),i=e.shift();this.observe(function(){this.set(t,i.call(this))}.bind(this),e),this.set(t,i.call(this))},pie.cache=function(e,t){pie.model.prototype.constructor.call(this,e,t)},pie.inherit(pie.cache,pie.model),pie.cache.prototype.del=function(e){this.set(e,void 0)},pie.cache.prototype.expire=function(e,t){var i=this.get(e);return void 0===i?!1:(this.set(e,i,{ttl:t}),!0)},pie.cache.prototype.get=function(e){var t=pie.model.prototype.get.call(this,e);return t?t.expiresAt&&t.expiresAt<=this.currentTime()?void this.set(e,void 0):t.data:void 0},pie.cache.prototype.getOrSet=function(e,t,i){var r=this.get(e);return void 0!==r?r:(this.set(e,t,i),t)},pie.cache.prototype.set=function(e,t,i){if(void 0===t)pie.model.prototype.set.call(this,e,void 0);else{var r=this.wrap(t,i);pie.model.prototype.set.call(this,e,r)}},pie.cache.prototype.wrap=function(e,t){t=t||{};var i=t.expiresAt||t.expiresIn||t.ttl;return i&&(i instanceof Date&&(i=i.getTime()),"string"==typeof i&&(i=/^\d+$/.test(i)?parseInt(i,10):pie.date.timeFromISO(i).getTime()),String(i).length<13&&(i=this.currentTime()+i)),{data:e,expiresAt:i}},pie.cache.prototype.currentTime=function(){return pie.date.now()},pie.list=function(e,t){e=e||[],pie.model.call(this,{items:e},t)},pie.inherit(pie.list,pie.model),pie.list.prototype._normalizedIndex=function(e){return e=parseInt(e,10),!isNaN(e)&&0>e&&(e+=this.data.items.length),e},pie.list.prototype._trackMutations=function(e,t){var i=this.data.items.length,r=[t.call()],n=this.data.items.length;return i!==n&&r.push({name:"length",type:"update",object:this.data.items,oldValue:i,value:n}),this.changeRecords=this.changeRecords.concat(r),e?this:this.deliverChangeRecords()},pie.list.prototype.forEach=function(e){return this.get("items").forEach(e)},pie.list.prototype.get=function(e){var t,i=this._normalizedIndex(e);return t=isNaN(i)?e:"items."+i,this._super("get",t)},pie.list.prototype.indexOf=function(e){return this.get("items").indexOf(e)},pie.list.prototype.insert=function(e,t,i){var r=this._normalizedIndex(e);return this._trackMutations(i,function(){var e={name:String(r),object:this.data.items,type:"add",oldValue:this.data.items[r],value:t};return this.data.items.splice(r,0,t),e}.bind(this))},pie.list.prototype.length=function(){return this.get("items.length")},pie.list.prototype.push=function(e,t){return this._trackMutations(t,function(){var t={name:String(this.data.items.length),object:this.data.items,type:"add",value:e,oldValue:void 0};return this.data.items.push(e),t}.bind(this))},pie.list.prototype.remove=function(e,t){var i=this._normalizedIndex(e);return this._trackMutations(t,function(){var e={name:String(i),object:this.data.items,type:"delete",oldValue:this.data.items[i],value:void 0};return this.data.items.splice(i,1),e}.bind(this))},pie.list.prototype.set=function(e,t,i){var r=this._normalizedIndex(e);return isNaN(r)?this._super("set",e,t,i):this._trackMutations(i,function(){var e={name:String(r),object:this.data.items,type:"update",oldValue:this.data.items[r]};return this.data.items[r]=e.value=t,e}.bind(this))},pie.list.prototype.shift=function(e){return this._trackMutations(e,function(){var e={name:"0",object:this.data.items,type:"delete"};return e.oldValue=this.data.items.shift(),e.value=this.data.items[0],e}.bind(this))},pie.list.prototype.unshift=function(e,t){return this.insert(0,e,t)},pie.view=function(e){this.options=e||{},this.app=this.options.app||window.app,this.el=this.options.el||pie.dom.createElement("<div />"),this.changeCallbacks=[],pie.setUid(this),this.options.init&&this.init()},pie.extend(pie.view.prototype,pie.mixins.inheritance),pie.extend(pie.view.prototype,pie.mixins.container),pie.view.prototype.addedToParent=function(){this.init()},pie.view.prototype.init=function(e){return this.isInit?this:(e&&e(),this.isInit=!0,this)},pie.view.prototype.eventNamespace=function(){return"view"+this.pieId},pie.view.prototype.navigationUpdated=function(){this.children().forEach(function(e){"navigationUpdated"in e&&e.navigationUpdated()})},pie.view.prototype.on=function(e,t,i){var r=this.eventNamespace(),n=function(e){return e.namespace===r?i.apply(this,arguments):void 0};return e.split(" ").forEach(function(e){e+="."+r,pie.dom.on(this.el,e,n,t)}.bind(this)),this},pie.view.prototype.onChange=function(){var e=arguments[0],t=pie.array.args(arguments).slice(1);if(!("observe"in e))throw new Error("Observable does not respond to observe");this.changeCallbacks.push([e,t]),e.observe.apply(e,t)},pie.view.prototype.qs=function(e){return this.el.querySelector(e)},pie.view.prototype.qsa=function(e){return this.el.querySelectorAll(e)},pie.view.prototype.removedFromParent=function(){return this._unobserveEvents(),this._unobserveChangeCallbacks(),this.removeChildren(),this},pie.view.prototype._unobserveEvents=function(){pie.dom.off(this.el,"*."+this.eventNamespace()),pie.dom.off(document.body,"*."+this.eventNamespace())},pie.view.prototype._unobserveChangeCallbacks=function(){for(var e;this.changeCallbacks.length;)e=this.changeCallbacks.pop(),e[0].unobserve.apply(e[0],e[1])},pie.activeView=function(e){pie.view.call(this,e)},pie.inherit(pie.activeView,pie.view,pie.mixins.externalResources,pie.mixins.validatable),pie.activeView.prototype.init=function(e){pie.view.prototype.init.call(this,function(){this.loadExternalResources(this.options.resources,function(){if(e&&e(),this.options.autoRender&&this.model){var t="string"==typeof this.options.autoRender?this.options.autoRender:"updated_at";this.onChange(this.model,this.render.bind(this),t)}this.options.renderOnInit&&this.render()}.bind(this))}.bind(this))},pie.activeView.prototype.loadingStyle=function(e){void 0===e&&(e=!0),this._loadingStyle(e)},pie.activeView.prototype.parseFields=function(){var e,t,i={},r=arguments[0],n=0;for("string"==typeof r?r=this.el:n++;n<arguments.length;n++)e=arguments[n],t=r.querySelector('[name="'+e+'"]:not([disabled])'),t&&pie.object.setPath(i,e,t.value);return i},pie.activeView.prototype.removedFromParent=function(e){pie.view.prototype.removedFromParent.call(this,e),this.el.parentNode&&this.el.parentNode.removeChild(this.el)},pie.activeView.prototype.removeLoadingStyle=function(){this._loadingStyle(!1)},pie.activeView.prototype.renderData=function(){return this.model?this.model.data:{}},pie.activeView.prototype.render=function(){if(this.options.template){var e=this.app.template(this.options.template,this.renderData());this.el.innerHTML=e}return this},pie.activeView.prototype._loadingStyle=function(e){this.el.classList[e?"add":"remove"]("loading");var t=this.qsa(".submit-container button.btn-primary, .btn-loading, .btn-loadable");pie.dom.all(t,e?"classList.add":"classList.remove","btn-loading"),pie.dom.all(t,e?"setAttribute":"removeAttribute","disabled","disabled")},pie.validator=function(e){this.app=e||window.app,this.i18n=e.i18n},pie.validator.rangeOptions=function(e,t){this.i18n=e.i18n,this.rangedata=t||{},this.rangedata.rangedata&&(this.rangedata=this.rangedata.rangedata)},pie.validator.rangeOptions.prototype.get=function(e){return pie.func.valueFrom(this.rangedata[e])},pie.validator.rangeOptions.prototype.has=function(e){return!!(e in this.rangedata)},pie.validator.rangeOptions.prototype.t=function(e,t){return this.i18n.t("app.validations.range_messages."+e,t)},pie.validator.rangeOptions.prototype.matches=function(e){var t=!0;return t=t&&(!this.has("gt")||e>this.get("gt")),t=t&&(!this.has("lt")||e<this.get("lt")),t=t&&(!this.has("gte")||e>=this.get("gte")),t=t&&(!this.has("lte")||e<=this.get("lte")),t=t&&(!this.has("eq")||e===this.get("eq"))},pie.validator.rangeOptions.prototype.message=function(){if(this.has("eq"))return this.t("eq",{count:this.get("eq")});var e=["",""];return this.has("gt")?e[0]+=this.t("gt",{count:this.get("gt")}):this.has("gte")&&(e[0]+=this.t("gte",{count:this.get("gte")})),this.has("lt")?e[1]+=this.t("lt",{count:this.get("lt")}):this.has("lte")&&(e[1]+=this.t("lte",{count:this.get("lte")})),pie.array.toSentence(pie.array.compact(e,!0),this.i18n).trim()},pie.validator.prototype.errorMessage=function(e,t){if(t.message)return t.message;var i=this.i18n.t("app.validations."+e),r=new pie.validator.rangeOptions(this.app,t),n=r.message();return n||"length"!==e||(r=new pie.validator.rangeOptions(this.app,{gt:0}),n=r.message()),(i+" "+n).trim()},pie.validator.prototype.withStandardChecks=function(e,t,i){return t=t||{},t.allowBlank&&!this.presence(e)?!0:t.unless&&t.unless.call()?!0:t["if"]&&!t["if"].call()?!0:i.call()},pie.validator.prototype.cc=function(e,t){return this.withStandardChecks(e,t,function(){var t=String(e).replace(/[^a-zA-Z0-9]/g,"");return this.number(t)&&this.length(t,{gte:15,lte:16})}.bind(this))},pie.validator.prototype.chosen=function(e,t){return this.presence(e,t)},pie.validator.prototype.cvv=function(e,t){return this.withStandardChecks(e,t,function(){return this.number(e)&&this.length(e,{gte:3,lte:4})}.bind(this))},pie.validator.prototype.date=function(e,t){return t=t||{},this.withStandardChecks(e,t,function(){var i,r=e.split("-"),n=r[0],o=r[1],a=r[2];if(!n||!o||!a)return!1;if(!this.length(n,{eq:4})&&this.length(o,{eq:2})&&this.length(a,{eq:2}))return!1;t.sanitized||(Object.keys(t).forEach(function(e){i=t[e],i=this.app.i18n.l(i,"isoDate"),t[e]=i}),t.sanitized=!0);var s=new pie.validator.rangeOptions(this.app,t);return s.matches(e)}.bind(this))},pie.validator.prototype.email=function(e,t){return t=pie.object.merge({allowBlank:!1},t||{}),this.withStandardChecks(e,t,function(){return/^.+@.+\..+$/.test(e)})},pie.validator.prototype.fn=function(e,t,i){return this.withStandardChecks(e,t,function(){return t.fn.call(null,e,t,i)})},pie.validator.prototype.format=function(e,t){return t=t||{},this.withStandardChecks(e,t,function(){var i=t.format||t["with"];return"isoDate"===i?i=/^\d{4}\-\d{2}\-\d{2}$/:"epochs"===i?i=/^\d{10}$/:"epochms"===i&&(i=/^\d{13}$/),!!i.test(String(e))})},pie.validator.prototype.integer=function(e,t){return this.withStandardChecks(e,t,function(){return this.number(e,t)&&parseInt(e,10)===parseFloat(e,10)}.bind(this))},pie.validator.prototype.length=function(e,t){return t=pie.object.merge({allowBlank:!1},t),"gt"in t||"gte"in t||"lt"in t||"lte"in t||"eq"in t||(t.gt=0),this.withStandardChecks(e,t,function(){var i=String(e).trim().length;return this.number(i,t)}.bind(this))},pie.validator.prototype.number=function(e,t){return t=t||{},this.withStandardChecks(e,t,function(){if(!/^([\-])?([\d]+)?\.?[\d]+$/.test(String(e)))return!1;var i=parseFloat(e),r=new pie.validator.rangeOptions(this.app,t);return r.matches(i)})},pie.validator.prototype.phone=function(e,t){return t=pie.object.merge({allowBlank:!1},t||{}),this.withStandardChecks(e,t,function(){var t=String(e).replace(/[^\+\d]+/g,"");return this.length(t,{gte:10})}.bind(this))},pie.validator.prototype.presence=function(e,t){return this.withStandardChecks(e,pie.object.merge({},t,{allowBlank:!1}),function(){return!(!e||!/[^ ]/.test(String(e)))})},pie.validator.prototype.url=function(e,t){return this.withStandardChecks(e,t,function(){return/^.+\..+$/.test(e)})},pie.services.ajax=function(e){this.app=e,this.defaultAjaxOptions={}},pie.services.ajax.prototype._defaultAjaxOptions=function(){return pie.object.merge({},this.defaultAjaxOptions,{dataType:"json",type:"GET",error:this.app.errorHandler.handleXhrError})},pie.services.ajax.prototype.ajax=function(e){if(e=pie.object.compact(e),e=pie.object.merge({},this._defaultAjaxOptions(),e),e.extraError){var t=e.error;e.error=function(i){t(i),e.extraError(i)}}var i,r=this.app,n=new XMLHttpRequest,o=e.url;return o="GET"===e.type&&e.data?r.router.path(o,e.data):r.router.path(o),e.progress?n.addEventListener("progress",e.progress,!1):e.uploadProgress&&n.upload.addEventListener("progress",e.uploadProgress,!1),n.open(e.type,o,!0),n.setRequestHeader("Accept","application/json"),n.setRequestHeader("Content-Type","application/json"),this._applyCsrfToken(n),n.onload=function(){e.tracker&&e.tracker(this);try{this.data=this.responseText.trim().length?JSON.parse(this.responseText):{}}catch(t){r.debug("could not parse JSON response: "+t),this.data={}}this.status>=200&&this.status<300||304===this.status?(e.dataSuccess&&e.dataSuccess(this.data),e.success&&e.success(this.data,this)):e.error&&e.error(this),e.complete&&e.complete(this)},"GET"!==e.type&&(i=e.data?"string"==typeof e.data?e.data:JSON.stringify(pie.object.compact(e.data)):void 0),n.send(i),n},pie.services.ajax.prototype.get=function(e){return e=pie.object.merge({type:"GET"},e),this.ajax(e)},pie.services.ajax.prototype.post=function(e){return e=pie.object.merge({type:"POST"},e),this.ajax(e)},pie.services.ajax.prototype.put=function(e){return e=pie.object.merge({type:"PUT"},e),this.ajax(e)},pie.services.ajax.prototype.del=function(e){return e=pie.object.merge({type:"DELETE"},e),this.ajax(e)},pie.services.ajax.prototype._applyCsrfToken=function(e){var t=document.querySelector('meta[name="csrf-token"]'),i=t?t.getAttribute("content"):null;i&&e.setRequestHeader("X-CSRF-Token",i)},pie.services.errorHandler=function(e){this.app=e,this.responseCodeHandlers={}},pie.services.errorHandler.prototype.data=function(e){return e.data=e.data||(e.status?JSON.parse(e.response):{})},pie.services.errorHandler.prototype.errorMessagesFromRequest=function(e){var t,i=this.data(e),r=pie.array.map(i.errors||[],"message");return r=pie.array.compact(r,!0),t=this.app.i18n.t("app.errors."+e.status,{"default":r}),this.app.debug(r),pie.array.from(t)},pie.services.errorHandler.prototype.handleXhrError=function(e){var t=this.responseCodeHandlers[e.status.toString()];t?t.call(e,e):this.notifyErrors(e)},pie.services.errorHandler.prototype.notifyErrors=function(e){var t=this.app.notifier,i=this.errorMessagesFromRequest(e);i.length&&(t.clear(),setTimeout(function(){t.clear("error"),t.notify(i,"error",1e4)},100))},pie.services.errorHandler.prototype.registerHandler=function(e,t){this.responseCodeHandlers[e.toString()]=t},pie.services.errorHandler.prototype.reportError=function(e,t){t=t||{},t.prefix&&"message"in e&&(e.message=t.prefix+" "+e.message),t.prefix&&"name"in e&&(e.name=t.prefix+" "+e.name),this._reportError(e,t)},pie.services.errorHandler.prototype._reportError=function(e){this.app.debug(e)},pie.services.i18n=function(e){this.translations=pie.object.merge({},pie.services.i18n.defaultTranslations),this.app=e},pie.services.i18n.defaultTranslations={app:{timeago:{now:"just now",minutes:{one:"%{count} minute ago",other:"%{count} minutes ago"},hours:{one:"%{count} hour ago",other:"%{count} hours ago"},days:{one:"%{count} day ago",other:"%{count} days ago"},weeks:{one:"%{count} week ago",other:"%{count} weeks ago"},months:{one:"%{count} month ago",other:"%{count} months ago"},years:{one:"%{count} year ago",other:"%{count} years ago"}},time:{formats:{isoDate:"%Y-%m-%d",isoTime:"%Y-%m-%dT%H:%M:%S.%L%:z",shortDate:"%m/%d/%Y",longDate:"%B %-do, %Y"},meridiems:{am:"am",pm:"pm"},ordinals:{o0:"th",o1:"st",o2:"nd",o3:"rd",o4:"th",o5:"th",o6:"th",o7:"th",o8:"th",o9:"th"},day_names:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_day_names:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],month_names:["January","February","March","April","May","June","July","August","September","October","November","December"],short_month_names:["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"]}}},pie.services.i18n.prototype._ampm=function(e){return this.t("app.time.meridiems."+(e>=12?"pm":"am"))
},pie.services.i18n.prototype._countAlias={0:"zero",1:"one","-1":"negone"},pie.services.i18n.prototype._dayName=function(e){return this.t("app.time.day_names."+e)},pie.services.i18n.prototype._hour=function(e){return e>12&&(e-=12),e||(e+=12),e},pie.services.i18n.prototype._monthName=function(e){return this.t("app.time.month_names."+e)},pie.services.i18n.prototype._nestedTranslate=function(e,t){return e.replace(/\$\{([^\}]+)\}/,function(e,i){return this.translate(i,t)}.bind(this))},pie.services.i18n.prototype._normalizedDate=function(e){return String(e).match(/^\d+$/)?(e=parseInt(e,10),String(e).length<13&&(e*=1e3),e=new Date(e)):e="string"==typeof e?pie.date.timeFromISO(e):new Date(e),e},pie.services.i18n.prototype._shortDayName=function(e){return this.t("app.time.short_day_names."+e)||this._dayName(e).slice(0,3)},pie.services.i18n.prototype._shortMonthName=function(e){return this.t("app.time.short_month_names."+e)||this._monthName(e).slice(0,3)},pie.services.i18n.prototype._pad=function(e,t,i){var r="",n=t-e.toString().length;for(void 0===i&&(i=" ");n>0;)r+=i,n-=1;return r+e.toString()},pie.services.i18n.prototype._ordinal=function(e){var t=e%100;return t=t>=11&&13>=t?0:e%10,this.t("app.time.ordinals.o"+t)},pie.services.i18n.prototype._timezoneAbbr=function(e){var t=e&&e.toString();return t&&t.split(/\((.*)\)/)[1]},pie.services.i18n.prototype._utc=function(e){var t=new Date(e.getTime());return t.setMinutes(t.getMinutes()+t.getTimezoneOffset()),t},pie.services.i18n.prototype.load=function(e,t){var i=t?pie.object.merge:pie.object.deepMerge;i.call(null,this.translations,e)},pie.services.i18n.prototype.translate=function(e,t){var i,r=pie.object.getPath(this.translations,e);if(t&&t.hasOwnProperty("count")&&"object"==typeof r&&(i=(t.count||0).toString(),i=this._countAlias[i]||(i>0?"other":"negother"),r=void 0===r[i]?r.other:r[i]),!r){if(!t||!t.hasOwnProperty("default"))return this.app.debug("Translation not found: "+e),"";r=pie.func.valueFrom(t.default)}return"string"==typeof r?(r=-1===r.indexOf("${")?r:this._nestedTranslate(r,t),-1===r.indexOf("%{")?r:pie.string.expand(r,t)):r},pie.services.i18n.prototype.timeago=function(e,t,i){e=this._normalizedDate(e).getTime()/1e3,t=this._normalizedDate(t||new Date).getTime()/1e3;var r,n=t-e;return i=i||"app",60>n?this.t(i+".timeago.now",{count:n}):3600>n?(r=Math.floor(n/60),this.t(i+".timeago.minutes",{count:r})):86400>n?(r=Math.floor(n/3600),this.t(i+".timeago.hours",{count:r})):604800>n?(r=Math.floor(n/86400),this.t(i+".timeago.days",{count:r})):2592e3>n?(r=Math.floor(n/604800),this.t(i+".timeago.weeks",{count:r})):31594125>n?(r=Math.floor(n/2629800),this.t(i+".timeago.months",{count:r})):(r=Math.floor(n/31557600),this.t(i+".timeago.years",{count:r}))},pie.services.i18n.prototype.strftime=function(e,t){e=this._normalizedDate(e),~t.indexOf("%")||(t=this.t("app.time.formats."+t));var i=e.getDay(),r=e.getDate(),n=e.getFullYear(),o=e.getMonth()+1,a=e.getHours(),s=this._hour(a),p=this._ampm(a),c=e.getSeconds(),h=e.getMinutes(),u=e.getMilliseconds(),l=e.getTimezoneOffset(),d=Math.floor(Math.abs(l/60)),f=Math.abs(l)-60*d,g=(l>0?"-":"+")+this._pad(d,2,"0")+this._pad(f,2,"0");return t=t.replace("%a",this._shortDayName(i)).replace("%A",this._dayName(i)).replace("%B",this._monthName(o-1)).replace("%b",this._shortMonthName(o-1)).replace("%d",this._pad(r,2,"0")).replace("%e",this._pad(r,2," ")).replace("%-do",r+this._ordinal(r)).replace("%-d",r).replace("%H",this._pad(a,2,"0")).replace("%k",this._pad(a,2," ")).replace("%-H",a).replace("%-k",a).replace("%I",this._pad(s,2,"0")).replace("%l",s).replace("%m",this._pad(o,2,"0")).replace("%-m",o).replace("%M",this._pad(h,2,"0")).replace("%p",p.toUpperCase()).replace("%P",p).replace("%S",this._pad(c,2,"0")).replace("%-S",c).replace("%L",this._pad(u,3,"0")).replace("%-L",u).replace("%w",i).replace("%y",this._pad(n%100)).replace("%Y",n).replace("%z",g).replace("%:z",g.slice(0,3)+":"+g.slice(3)).replace("%Z",this._timezoneAbbr(e))},pie.services.i18n.prototype.t=pie.services.i18n.prototype.translate,pie.services.i18n.prototype.l=pie.services.i18n.prototype.strftime,pie.services.navigator=function(e){this.app=e,pie.model.prototype.constructor.call(this,{})},pie.inherit(pie.services.navigator,pie.model),pie.services.navigator.prototype.go=function(e,t,i){var r=e;return t=t||{},this.get("path")===e&&this.get("query")===t?this:(Object.keys(t).length&&(r+="?",r+=pie.object.serialize(t)),window.history[i?"replaceState":"pushState"]({},document.title,r),this.setDataFromLocation())},pie.services.navigator.prototype.start=function(){return this.setDataFromLocation()},pie.services.navigator.prototype.setDataFromLocation=function(){var e=window.location.search.slice(1);return e=pie.string.deserialize(e),this.sets({url:window.location.href,path:window.location.pathname,query:e}),this},pie.services.notifier=function(e,t){pie.view.prototype.constructor.call(this,pie.object.merge({app:e},t)),this.notifications={}},pie.inherit(pie.services.notifier,pie.view),pie.services.notifier.prototype.init=function(){this.on("click",".page-alert",this.handleAlertClick.bind(this))},pie.services.notifier.prototype.clear=function(e){if(e)for(var t=this.notifications[e]||[];t.length;)this.remove(t[t.length-1]);else for(;this.el.childNodes.length;)this.remove(this.el.childNodes[0])},pie.services.notifier.prototype.notify=function(e,t,i){t=t||"message",i=this.getAutoCloseTimeout(i),e=pie.array.from(e);var r=this.app.template("alert",{type:t,messages:e});r=pie.dom.createElement(r),this.notifications[t]=this.notifications[t]||[],this.notifications[t].push(r),r._pieNotificationType=t,this.el.insertBefore(r,this.el.firstElementChild),i&&setTimeout(function(){this.remove(r)}.bind(this),i)},pie.services.notifier.prototype.getAutoCloseTimeout=function(e){return void 0===e&&(e=!0),e&&"number"!=typeof e&&(e=7e3),e},pie.services.notifier.prototype.remove=function(e){var t=e._pieNotificationType;t&&pie.array.remove(this.notifications[t]||[],e),pie.dom.remove(e)},pie.services.notifier.prototype.handleAlertClick=function(e){this.remove(e.delegateTarget),e.preventDefault()},pie.services.resources=function(e){this.app=e,this.loaded={},this.srcMap={}},pie.services.resources.prototype.define=function(e,t){this.srcMap[e]=t},pie.services.resources.prototype.load=function(e,t){if(e=this.srcMap[e]||e,this.loaded[e]===!0)return t&&t(),!0;if(this.loaded[e])this.loaded[e].push(t);else{this.loaded[e]=[t];var i=document.createElement("script");i.async=!0,i.onload=function(){console.log("loaded "+e),pie.array.map(pie.array.compact(this.loaded[e]),"call",!0),this.loaded[e]=!0}.bind(this),document.querySelector("head").appendChild(i),i.src=e}return!1},pie.services.router=function(e){this.app=e,this.routes={},this.namedRoutes={}},pie.services.router.prototype.changedUrl=function(e){var t=this.app.parsedUrl;return this.router.path(t.name||t.path,pie.object.merge({},t.interpolations,t.query,e))},pie.services.router.prototype.normalizePath=function(e){if("/"!==e.charAt(0)&&(e="/"+e),e.indexOf("?")>0){var t=e.split("?");e=this.normalizePath(t.shift()),t.unshift(e),e=t.join("?")}return"#"===e.charAt(e.length-1)&&(e=e.substr(0,e.length-1)),"/"===e.charAt(e.length-1)&&(e=e.substr(0,e.length-1)),e},pie.services.router.prototype.route=function(e,t){t=t||{},delete this._routeKeys,pie.object.forEach(e,function(e,i){"object"==typeof i?(e=this.normalizePath(e),this.routes[e]=pie.object.merge({},t,i),i.hasOwnProperty("name")&&(this.namedRoutes[i.name]=e)):this.namedRoutes[e]=i}.bind(this))},pie.services.router.prototype.path=function(e,t,i){var r,n,o=this.namedRoutes[e],a="string"==typeof o?o:e,s=[];return t=t||{},a=this.normalizePath(a),a=a.replace(/\:([a-zA-Z0-9_]+)/g,function(e,i){if(s.push(i),void 0===t[i]||null===t[i]||0===t[i].toString().length)throw new Error("[PIE] missing route interpolation: "+e);return t[i]}),n=pie.object.except(t,s),r=pie.object.serialize(pie.object.compact(n,!0)),!i&&r.length&&(a=pie.string.urlConcat(a,r)),a},pie.services.router.prototype.routeKeys=function(){if(this._routeKeys)return this._routeKeys;this._routeKeys=Object.keys(this.routes);var e,t,i,r=[];return this._routeKeys.sort(function(n,o){return e=(n.match(/:/g)||r).length,t=(o.match(/:/g)||r).length,i=e-t,i=i||o.length-n.length,i=i||(t>e?1:e>t?-1:0)}),this._routeKeys},pie.services.router.prototype.parseUrl=function(e,t){var i,r,n,o,a,s,p,c,h,u=this.routeKeys(),l=0;if(h=e.split("?"),e=h.shift(),e=this.normalizePath(e),s=h.join("&")||"",e.length>1&&"/"===e[e.length-1]&&(e=e.slice(0,-1)),n=this.routes[e],p={},o=e.split("/"),n)n=pie.object.merge({routeKey:e},n);else for(;l<u.length&&!n;)if(r=u[l],"object"==typeof this.routes[r]){if(this.routes[r].regex=this.routes[r].regex||new RegExp("^"+r.replace(/(:[^\/]+)/g,"([^\\/]+)")+"$"),this.routes[r].regex.test(e))for(n=pie.object.merge({routeKey:r},this.routes[r]),a=r.split("/"),i=0;i<a.length;i++)/^:/.test(a[i])&&(p[a[i].replace(/^:/,"")]=o[i],n[a[i]]=o[i]);l++}else l++;return s=pie.string.deserialize(s,t),t&&(p=pie.string.deserialize(pie.object.serialize(p),t)),c=pie.array.compact([e,pie.object.serialize(s)],!0).join("?"),pie.object.merge({interpolations:p,query:s,data:pie.object.merge({},p,s),path:e,fullPath:c},n)},pie.app=function(e){this.options=pie.object.deepMerge({uiTarget:"body",viewNamespace:"lib.views",notificationUiTarget:".notification-container"},e);var t=function(e,t){var i=this.options[e]||t;return new i(this)}.bind(this);this.i18n=t("i18n",pie.services.i18n),this.addChild("i18n",this.i18n),this.ajax=t("ajax",pie.services.ajax),this.addChild("ajax",this.ajax),this.notifier=t("notifier",pie.services.notifier),this.addChild("notifier",this.notifier),this.errorHandler=t("errorHandler",pie.services.errorHandler),this.addChild("errorHandler",this.errorHandler),this.router=t("router",pie.services.router),this.addChild("router",this.router),this.resources=t("resources",pie.services.resources),this.addChild("resources",this.resources),this.navigator=t("navigator",pie.services.navigator),this.addChild("navigator",this.navigator),this.validator=t("validator",pie.validator),this.addChild("validator",this.validator),this.models={},this._templates={},this.parsedUrl={},this.eventCallbacks={},this.triggeredEvents=[],this.navigator.observe(this.navigationChanged.bind(this),"url"),this.on("beforeStart",this.showStoredNotifications.bind(this)),this.on("beforeStart",this.setupSinglePageLinks.bind(this)),this.on("beforeStart",this.setupNotifier.bind(this)),document.addEventListener("DOMContentLoaded",this.start.bind(this)),window.pieInstance=window.pieInstance||this},pie.extend(pie.app.prototype,pie.mixins.container),pie.app.prototype.confirm=function(e){window.confirm(e.text)?e.success&&e.success():e.failure&&e.failure()},pie.app.prototype.debug=function(e){"production"!==this.env&&console&&console.log&&console.log("[PIE] "+e)},pie.app.prototype.go=function(){var e,t,i,r,n=pie.array.args(arguments);e=n.shift(),"string"==typeof n[0]&&0===n[0].indexOf("?")?(e=this.router.path(e),r=n.shift(),e=pie.string.urlConcat(this.router.path(e),r)):e="object"==typeof n[0]?this.router.path(e,n.shift()):this.router.path.apply(this.router,pie.array.from(e)),(n[0]===!0||n[0]===!1)&&(i=n.shift()),t=n,this.router.parseUrl(e).hasOwnProperty("view")?(this.navigator.go(e,i),t&&t.length&&this.notifier.notify.apply(this.notifier,t)):(t&&t.length&&this.store(this.notifier.storageKey,t),window.location.href=e)},pie.app.prototype.goBack=function(){window.history.back()},pie.app.prototype.handleSinglePageLinkClick=function(e){if(!e.delegateTarget.getAttribute("target")&&!e.ctrlKey&&!e.metaKey){var t=e.delegateTarget.getAttribute("href");t&&!/^(#|[a-z]+:\/\/)/.test(t)&&("?"===t.charAt(0)&&(t=window.location.pathname+t),e.preventDefault(),this.go(t))}},pie.app.prototype.navigationChanged=function(){var e=document.querySelector(this.options.uiTarget),t=this.getChild("currentView");if(this.previousUrl=this.parsedUrl,this.parsedUrl=this.router.parseUrl(this.navigator.get("path")),this.previousUrl!==this.parsedUrl&&this.trigger("urlChanged"),this.parsedUrl.view){if(t&&t._pieName===this.parsedUrl.view)return void("navigationUpdated"in t&&t.navigationUpdated());t&&(this.removeChild(t),t.el.parentNode&&t.el.parentNode.removeChild(t.el),this.on("oldViewRemoved")),this.notifier.clear();var i,r=pie.object.getPath(window,this.options.viewNamespace+"."+this.parsedUrl.view);i=new r(this),i._pieName=this.parsedUrl.view,this.addChild("currentView",i),e.appendChild(i.el),this.models={},window.scrollTo(0,0),this.trigger("newViewLoaded")}},pie.app.prototype.on=function(e,t,i){!i&&~this.triggeredEvents.indexOf(e)?t():(this.eventCallbacks[e]=this.eventCallbacks[e]||[],this.eventCallbacks[e].push(t))},pie.app.prototype.refresh=function(){var e=this.getChild("currentView");e._pieName="__remove__",this.navigationChanged()},pie.app.prototype.retrieve=function(e,t){var i,r;try{i=window.localStorage.getItem(e),r=i?JSON.parse(i):void 0}catch(n){this.errorHandler.reportError(n,{prefix:"[caught] app#retrieve/getItem:"})}try{(t||void 0===t)&&window.localStorage.removeItem(e)}catch(n){this.errorHandler.reportError(n,{prefix:"[caught] app#retrieve/removeItem:"})}return r},pie.app.prototype.setupNotifier=function(){var e=document.querySelector(this.options.notificationUiTarget);e&&e.appendChild(this.getChild("notifier").el)},pie.app.prototype.setupSinglePageLinks=function(){pie.dom.on(document.body,"click",this.handleSinglePageLinkClick.bind(this),"a[href]")},pie.app.prototype.showStoredNotifications=function(){var e,t=this.retrieve(this.notifier.storageKey);t&&(e=JSON.parse(t),this.on("afterStart",function(){this.notifier.notify.apply(this.notifier,e)}.bind(this)))},pie.app.prototype.start=function(){this.navigator.start(),this.trigger("beforeStart");var e=this.navigator.get("url");this.navigator.data.url=null,this.navigator.set("url",e),this.started=!0,this.trigger("afterStart")},pie.app.prototype.store=function(e,t){try{window.localStorage.setItem(e,JSON.stringify(t))}catch(i){this.errorHandler.reportError(i,{prefix:"[caught] app#store:"})}},pie.app.prototype.template=function(e,t){if(!this._templates[e]){var i=document.querySelector('script[id="'+e+'"][type="text/pie-template"]');if(!i)throw new Error("[PIE] Unknown template error: "+e);this.debug("Compiling and storing template: "+e),this._templates[e]=pie.string.template(i.textContent)}return t=t||{},this._templates[e](t)},pie.app.prototype.trigger=function(e){this.triggeredEvents.indexOf(e)<0&&this.triggeredEvents.push(e),(this.eventCallbacks[e]||[]).forEach(function(e){e()})};